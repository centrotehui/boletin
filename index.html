<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Bolet√≠n Tehui</title>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com?v=3.4.0"></script>
  <!-- Microsoft Authentication Library (MSAL) para OneDrive -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <!-- SheetJS para leer archivos Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    .animate-pulse-soft { animation: pulse-soft 2s ease-in-out infinite; }
    
    @media print {
      /* Ocultar elementos no imprimibles */
      .no-print { display: none !important; }
      
      /* Reset general */
      * { box-sizing: border-box; }
      html, body { 
        width: 100%; 
        height: 100%;
        margin: 0; 
        padding: 0;
        background: white !important; 
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      /* Configuraci√≥n de p√°gina - Landscape para libro */
      @page { 
        size: 11in 8.5in landscape;
        margin: 0.2in;
      }
      
      /* Contenedor principal */
      .print-wrapper {
        width: 100% !important;
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
        background: white !important;
      }
      
      /* ====== PORTADA ====== */
      .print-portada {
        width: 100% !important;
        height: 7.9in !important;
        page-break-after: always !important;
        padding: 0.15in !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      .print-portada .grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        height: 100% !important;
        gap: 0 !important;
      }
      
      .print-portada .grid > div {
        overflow: hidden !important;
        min-width: 0 !important;
        height: 100% !important;
      }
      
      .print-portada p, .print-portada div, .print-portada span {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 100% !important;
      }
      
      .print-portada img { 
        max-width: 120px !important;
        height: auto !important;
      }
      
      /* ====== BOLET√çN ====== */
      .print-boletin {
        width: 100% !important;
        height: 7.9in !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* Header */
      .print-boletin-header {
        padding: 5px 10px !important;
        border-bottom: 2px solid #333 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
      }
      .print-boletin-header img {
        width: 45px !important;
        height: auto !important;
      }
      .print-boletin-header p {
        margin: 0 !important;
      }
      
      /* Info estudiante */
      .print-estudiante-info {
        padding: 4px 10px !important;
        border-bottom: 1px solid #333 !important;
        font-size: 8pt !important;
      }
      
      /* Tabla - CRECE para llenar el espacio */
      .print-tabla-container {
        flex: 1 !important;
        overflow: hidden !important;
      }
      
      .print-tabla-notas {
        width: 100% !important;
        border-collapse: collapse !important;
        table-layout: fixed !important;
        font-size: 6.5pt !important;
      }
      
      .print-tabla-notas th,
      .print-tabla-notas td {
        border: 1px solid #666 !important;
        padding: 2px 1px !important;
        text-align: center !important;
        vertical-align: middle !important;
      }
      
      .print-tabla-notas th {
        background-color: #e5e7eb !important;
        font-weight: bold !important;
        font-size: 5.5pt !important;
      }
      
      .print-tabla-notas tbody td {
        font-size: 7pt !important;
      }
      
      .print-tabla-notas .col-asignatura {
        width: 11% !important;
        text-align: left !important;
        padding-left: 3px !important;
        font-size: 6.5pt !important;
        font-weight: 500 !important;
      }
      
      .print-tabla-notas .col-profesor {
        width: 5% !important;
        font-size: 5.5pt !important;
      }
      
      .print-tabla-notas .col-nota {
        width: 2.3% !important;
      }
      
      .print-tabla-notas .col-rec {
        width: 2.3% !important;
        background-color: #fef3c7 !important;
      }
      
      .print-tabla-notas .col-promedio {
        width: 2.5% !important;
        background-color: #dbeafe !important;
        font-weight: bold !important;
      }
      
      .print-tabla-notas .col-final {
        width: 3% !important;
        background-color: #d1fae5 !important;
        font-weight: bold !important;
        font-size: 7pt !important;
      }
      
      .print-tabla-notas .col-rf {
        width: 3% !important;
        background-color: #fef3c7 !important;
        font-weight: bold !important;
        font-size: 7pt !important;
      }
      
      /* Observaciones */
      .print-observaciones {
        padding: 4px 8px !important;
        border-top: 1px solid #333 !important;
        font-size: 7pt !important;
      }
      
      /* Footer: Escala, Leyenda, Asistencia - 3 columnas */
      .print-footer-section {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1.3fr !important;
        gap: 10px !important;
        padding: 6px 8px !important;
        border-top: 1px solid #333 !important;
        font-size: 6pt !important;
      }
      
      .print-footer-section table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 5.5pt !important;
      }
      
      .print-footer-section th,
      .print-footer-section td {
        border: 1px solid #888 !important;
        padding: 1px !important;
      }
      
      /* Firmas - m√°s espacio arriba */
      .print-firmas-section {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 40px !important;
        padding: 12px 40px 8px 40px !important;
        border-top: 1px solid #333 !important;
      }
      
      .print-firma-box {
        text-align: center !important;
        padding-top: 20px !important;
      }
      
      .print-firma-box div {
        border-top: 1px solid #333 !important;
        padding-top: 4px !important;
        font-size: 7pt !important;
        font-weight: bold !important;
      }
    }
    
    /* Estilos base para vista previa en pantalla */
    .print-page-preview {
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }
    
    input:focus-visible, button:focus-visible, select:focus-visible {
      outline: 3px solid #3b82f6;
      outline-offset: 2px;
    }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // ==================== CONSTANTES ====================
    const MATERIAS_DEFAULT = Object.freeze([
      'Lengua Espa√±ola', 'Matem√°tica', 'Ciencias Sociales', 
      'Ciencias de la Naturaleza', 'Moral y C√≠vica', 'Educaci√≥n F√≠sica',
      'Formaci√≥n Integral Humana y Religiosa', 'Ingl√©s', 'Artes Visuales', 'M√∫sica'
    ]);

    const NIVELES = Object.freeze(['Inicial', 'Primario', 'Secundario']);
    
    const GRADOS_PRIMARIO = Object.freeze(['1ro', '2do', '3ro', '4to', '5to', '6to']);
    
    // Convierte nivel a su forma para usar con grado: "Primario" -> "Primaria"
    const nivelParaGrado = (nivel) => {
      const map = { 'Primario': 'Primaria', 'Secundario': 'Secundaria', 'Inicial': 'Inicial' };
      return map[nivel] || nivel;
    };
    
    const ESCALA_NUMERICA = Object.freeze([
      { rango: '89-100', descripcion: 'Desempe√±o destacado al finalizar el a√±o escolar' },
      { rango: '77-88', descripcion: 'Desempe√±o logrado al finalizar el a√±o escolar' },
      { rango: '65-76', descripcion: 'Desempe√±o en proceso al finalizar el a√±o escolar' },
      { rango: 'Menos de 65', descripcion: 'Desempe√±o insuficiente al finalizar el a√±o escolar' }
    ]);

    // Datos del Centro Educativo (editables en configuraci√≥n)
    const DATOS_CENTRO_DEFAULT = {
      nombre: 'Centro Educativo Tehui',
      codigo: '',
      tanda: 'Extendida',
      telefono: '',
      distrito: '',
      regional: '',
      provincia: 'Santiago',
      municipio: 'Santiago de los Caballeros'
    };

    const NOTA_MIN = 0;
    const NOTA_MAX = 100;
    const STORAGE_PREFIX = 'tehui_v3_';
    const AUTO_SAVE_DELAY = 2000;
    const TARDANZAS_POR_AUSENCIA = 3; // 3 tardanzas = 1 ausencia
    
    // ==================== CONFIGURACI√ìN DE ADMINISTRADORES ====================
    // Correos de administradores que pueden ver todos los datos
    const ADMIN_EMAILS = [
      'info@tehui.onmicrosoft.com',      // Cuenta principal del centro
      'admin@tehui.onmicrosoft.com',     // Administrador
      'director@tehui.onmicrosoft.com',  // Director/a
      'direccion@tehui.onmicrosoft.com'  // Direcci√≥n
    ];
    
    // Verificar si un email es administrador
    const esAdministrador = (email) => {
      if (!email) return false;
      const emailLower = email.toLowerCase();
      return ADMIN_EMAILS.some(admin => emailLower.includes(admin.toLowerCase().split('@')[0]));
    };
    
    // ==================== CONFIGURACI√ìN MICROSOFT/ONEDRIVE ====================
    const MSAL_CONFIG = {
      auth: {
        clientId: '2133c50e-ffb4-4793-af2b-385d451b997b', // Tu Client ID de Azure
        authority: 'https://login.microsoftonline.com/tehui.onmicrosoft.com', // Tenant espec√≠fico de Tehui
        redirectUri: window.location.origin + window.location.pathname
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: true
      }
    };
    
    const GRAPH_SCOPES = ['User.Read', 'Files.ReadWrite', 'Files.ReadWrite.All'];
    const ONEDRIVE_FOLDER = 'BoletinTehui'; // Carpeta en OneDrive
    const SHARED_FOLDER = 'BoletinTehui_Compartido'; // Carpeta compartida para todos
    
    // Inicializar MSAL
    let msalInstance = null;
    try {
      msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
    } catch (e) {
      console.log('MSAL no disponible, usando modo local');
    }
    
    // ==================== FUNCIONES DE ONEDRIVE ====================
    const getAccessToken = async () => {
      if (!msalInstance) return null;
      try {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length === 0) return null;
        
        const response = await msalInstance.acquireTokenSilent({
          scopes: GRAPH_SCOPES,
          account: accounts[0]
        });
        return response.accessToken;
      } catch (e) {
        console.error('Error obteniendo token:', e);
        return null;
      }
    };
    
    const loginMicrosoft = async () => {
      if (!msalInstance) {
        throw new Error('Microsoft login no disponible');
      }
      try {
        const response = await msalInstance.loginPopup({
          scopes: GRAPH_SCOPES
        });
        return response.account;
      } catch (e) {
        console.error('Error en login Microsoft:', e);
        throw e;
      }
    };
    
    const logoutMicrosoft = async () => {
      if (!msalInstance) return;
      try {
        await msalInstance.logoutPopup();
      } catch (e) {
        console.error('Error en logout:', e);
      }
    };
    
    // Crear carpeta en OneDrive si no existe
    const crearCarpetaOneDrive = async (token) => {
      try {
        // Verificar si existe
        const checkResponse = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${ONEDRIVE_FOLDER}`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (checkResponse.status === 404) {
          // Crear carpeta
          await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: ONEDRIVE_FOLDER,
              folder: {},
              '@microsoft.graph.conflictBehavior': 'fail'
            })
          });
        }
        return true;
      } catch (e) {
        console.error('Error creando carpeta:', e);
        return false;
      }
    };
    
    // Guardar datos en OneDrive
    const guardarEnOneDrive = async (nombreArchivo, datos) => {
      const token = await getAccessToken();
      if (!token) return false;
      
      try {
        await crearCarpetaOneDrive(token);
        
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${ONEDRIVE_FOLDER}/${nombreArchivo}:/content`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(datos)
          }
        );
        return response.ok;
      } catch (e) {
        console.error('Error guardando en OneDrive:', e);
        return false;
      }
    };
    
    // Leer datos de OneDrive
    const leerDeOneDrive = async (nombreArchivo) => {
      const token = await getAccessToken();
      if (!token) return null;
      
      try {
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${ONEDRIVE_FOLDER}/${nombreArchivo}:/content`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) return null;
        return await response.json();
      } catch (e) {
        console.error('Error leyendo de OneDrive:', e);
        return null;
      }
    };
    
    // Listar archivos en la carpeta de OneDrive
    const listarArchivosOneDrive = async () => {
      const token = await getAccessToken();
      if (!token) return [];
      
      try {
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${ONEDRIVE_FOLDER}:/children`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) return [];
        const data = await response.json();
        return data.value || [];
      } catch (e) {
        console.error('Error listando archivos:', e);
        return [];
      }
    };
    
    // ==================== FUNCIONES DE ADMINISTRADOR ====================
    // Guardar datos en carpeta compartida (para que admin pueda ver)
    const guardarEnCarpetaCompartida = async (maestraEmail, nombreArchivo, datos) => {
      const token = await getAccessToken();
      if (!token) return false;
      
      try {
        // Crear carpeta de la maestra dentro de la compartida
        const carpetaMaestra = maestraEmail.split('@')[0].replace(/[^a-zA-Z0-9]/g, '_');
        
        // Crear carpeta compartida si no existe
        await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: SHARED_FOLDER,
            folder: {},
            '@microsoft.graph.conflictBehavior': 'fail'
          })
        }).catch(() => {}); // Ignorar si ya existe
        
        // Crear subcarpeta de la maestra
        await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${SHARED_FOLDER}:/children`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: carpetaMaestra,
            folder: {},
            '@microsoft.graph.conflictBehavior': 'fail'
          })
        }).catch(() => {});
        
        // Guardar archivo
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${SHARED_FOLDER}/${carpetaMaestra}/${nombreArchivo}:/content`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(datos)
          }
        );
        return response.ok;
      } catch (e) {
        console.error('Error guardando en carpeta compartida:', e);
        return false;
      }
    };
    
    // Obtener lista de usuarios de la organizaci√≥n (para admin)
    const obtenerUsuariosOrganizacion = async () => {
      const token = await getAccessToken();
      if (!token) return [];
      
      try {
        const response = await fetch(
          'https://graph.microsoft.com/v1.0/users?$select=displayName,mail,userPrincipalName',
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) return [];
        const data = await response.json();
        return data.value || [];
      } catch (e) {
        console.error('Error obteniendo usuarios:', e);
        return [];
      }
    };
    
    // Leer carpeta compartida (para admin)
    const leerCarpetaCompartida = async () => {
      const token = await getAccessToken();
      if (!token) return [];
      
      try {
        // Listar carpetas de maestras
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${SHARED_FOLDER}:/children`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) return [];
        const data = await response.json();
        return data.value || [];
      } catch (e) {
        console.error('Error leyendo carpeta compartida:', e);
        return [];
      }
    };
    
    // Leer todos los estudiantes de una maestra (para admin)
    const leerEstudiantesDeMaestra = async (carpetaMaestra) => {
      const token = await getAccessToken();
      if (!token) return [];
      
      try {
        // Listar archivos en la carpeta de la maestra
        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/drive/root:/${SHARED_FOLDER}/${carpetaMaestra}:/children`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        
        if (!response.ok) return [];
        const archivos = await response.json();
        
        // Leer cada archivo de estudiante
        const estudiantes = [];
        for (const archivo of (archivos.value || [])) {
          if (archivo.name.startsWith('estudiante_')) {
            try {
              const contentResponse = await fetch(
                `https://graph.microsoft.com/v1.0/me/drive/items/${archivo.id}/content`,
                { headers: { 'Authorization': `Bearer ${token}` } }
              );
              if (contentResponse.ok) {
                const estudiante = await contentResponse.json();
                estudiante._maestra = carpetaMaestra;
                estudiantes.push(estudiante);
              }
            } catch (e) {
              console.error('Error leyendo estudiante:', e);
            }
          }
        }
        return estudiantes;
      } catch (e) {
        console.error('Error leyendo estudiantes de maestra:', e);
        return [];
      }
    };
    
    // ==================== SISTEMA DE SEGURIDAD ====================
    const SECURITY_CONFIG = {
      MAX_LOGIN_ATTEMPTS: 3,
      LOCKOUT_TIME: 15 * 60 * 1000, // 15 minutos
      SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutos de inactividad
      ENCRYPTION_KEY: 'TEHUI_SEC_2024_CLAVE_MAESTRA'
    };
    
    // Encriptaci√≥n simple pero efectiva
    const encriptar = (texto, clave) => {
      if (!texto) return '';
      let resultado = '';
      for (let i = 0; i < texto.length; i++) {
        resultado += String.fromCharCode(texto.charCodeAt(i) ^ clave.charCodeAt(i % clave.length));
      }
      return btoa(resultado);
    };
    
    const desencriptar = (textoEncriptado, clave) => {
      if (!textoEncriptado) return '';
      try {
        const texto = atob(textoEncriptado);
        let resultado = '';
        for (let i = 0; i < texto.length; i++) {
          resultado += String.fromCharCode(texto.charCodeAt(i) ^ clave.charCodeAt(i % clave.length));
        }
        return resultado;
      } catch {
        return '';
      }
    };
    
    // Hash simple para contrase√±as
    const hashPassword = (password) => {
      let hash = 0;
      const str = password + SECURITY_CONFIG.ENCRYPTION_KEY;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return btoa(hash.toString() + '_' + str.length);
    };
    
    // Guardar datos encriptados
    const guardarSeguro = (key, data) => {
      const jsonData = JSON.stringify(data);
      const encrypted = encriptar(jsonData, SECURITY_CONFIG.ENCRYPTION_KEY);
      localStorage.setItem(STORAGE_PREFIX + 'sec_' + key, encrypted);
    };
    
    // Leer datos encriptados
    const leerSeguro = (key) => {
      const encrypted = localStorage.getItem(STORAGE_PREFIX + 'sec_' + key);
      if (!encrypted) return null;
      try {
        const decrypted = desencriptar(encrypted, SECURITY_CONFIG.ENCRYPTION_KEY);
        return JSON.parse(decrypted);
      } catch {
        return null;
      }
    };
    
    // Componente de Login
    const LoginScreen = ({ onLogin, onRegister }) => {
      const [modo, setModo] = useState('login'); // 'login' o 'register'
      const [usuario, setUsuario] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [intentos, setIntentos] = useState(0);
      const [bloqueado, setBloqueado] = useState(false);
      const [tiempoRestante, setTiempoRestante] = useState(0);
      
      useEffect(() => {
        // Verificar si est√° bloqueado
        const lockData = localStorage.getItem(STORAGE_PREFIX + 'lockout');
        if (lockData) {
          const lockTime = parseInt(lockData);
          const ahora = Date.now();
          if (ahora < lockTime) {
            setBloqueado(true);
            setTiempoRestante(Math.ceil((lockTime - ahora) / 1000));
          } else {
            localStorage.removeItem(STORAGE_PREFIX + 'lockout');
          }
        }
      }, []);
      
      useEffect(() => {
        if (bloqueado && tiempoRestante > 0) {
          const timer = setInterval(() => {
            setTiempoRestante(t => {
              if (t <= 1) {
                setBloqueado(false);
                localStorage.removeItem(STORAGE_PREFIX + 'lockout');
                setIntentos(0);
                return 0;
              }
              return t - 1;
            });
          }, 1000);
          return () => clearInterval(timer);
        }
      }, [bloqueado, tiempoRestante]);
      
      const handleLogin = (e) => {
        e.preventDefault();
        if (bloqueado) return;
        
        const usuarios = leerSeguro('usuarios') || {};
        const userData = usuarios[usuario.toLowerCase()];
        
        if (!userData || userData.passwordHash !== hashPassword(password)) {
          const nuevosIntentos = intentos + 1;
          setIntentos(nuevosIntentos);
          
          if (nuevosIntentos >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
            const lockUntil = Date.now() + SECURITY_CONFIG.LOCKOUT_TIME;
            localStorage.setItem(STORAGE_PREFIX + 'lockout', lockUntil.toString());
            setBloqueado(true);
            setTiempoRestante(Math.ceil(SECURITY_CONFIG.LOCKOUT_TIME / 1000));
            setError(`Demasiados intentos. Sistema bloqueado por 15 minutos.`);
          } else {
            setError(`Usuario o contrase√±a incorrectos. Intentos restantes: ${SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS - nuevosIntentos}`);
          }
          return;
        }
        
        // Login exitoso
        const session = {
          usuario: usuario.toLowerCase(),
          nombre: userData.nombre,
          loginTime: Date.now(),
          lastActivity: Date.now()
        };
        guardarSeguro('session', session);
        onLogin(session);
      };
      
      const handleRegister = (e) => {
        e.preventDefault();
        
        if (password.length < 6) {
          setError('La contrase√±a debe tener al menos 6 caracteres');
          return;
        }
        
        if (password !== confirmPassword) {
          setError('Las contrase√±as no coinciden');
          return;
        }
        
        const usuarios = leerSeguro('usuarios') || {};
        
        if (usuarios[usuario.toLowerCase()]) {
          setError('Este usuario ya existe');
          return;
        }
        
        usuarios[usuario.toLowerCase()] = {
          nombre: usuario,
          passwordHash: hashPassword(password),
          creado: Date.now()
        };
        
        guardarSeguro('usuarios', usuarios);
        
        // Auto login
        const session = {
          usuario: usuario.toLowerCase(),
          nombre: usuario,
          loginTime: Date.now(),
          lastActivity: Date.now()
        };
        guardarSeguro('session', session);
        onLogin(session);
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-teal-600 via-teal-700 to-slate-800 flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
            {/* Logo */}
            <div className="text-center mb-8">
              <div className="w-20 h-20 bg-teal-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                <span className="text-4xl">üìö</span>
              </div>
              <h1 className="text-2xl font-bold text-slate-800">Sistema Bolet√≠n Tehui</h1>
              <p className="text-slate-500 text-sm mt-1">Centro Educativo de Formaci√≥n Integral</p>
            </div>
            
            {bloqueado ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                  <span className="text-3xl">üîí</span>
                </div>
                <h2 className="text-xl font-bold text-red-600 mb-2">Sistema Bloqueado</h2>
                <p className="text-slate-600 mb-4">Demasiados intentos fallidos</p>
                <div className="text-3xl font-mono font-bold text-red-600">
                  {Math.floor(tiempoRestante / 60)}:{(tiempoRestante % 60).toString().padStart(2, '0')}
                </div>
                <p className="text-sm text-slate-500 mt-2">Tiempo restante para desbloquear</p>
              </div>
            ) : (
              <>
                {/* Tabs */}
                <div className="flex mb-6 bg-slate-100 rounded-xl p-1">
                  <button
                    onClick={() => { setModo('login'); setError(''); }}
                    className={`flex-1 py-2.5 rounded-lg font-medium transition-all ${modo === 'login' ? 'bg-white shadow text-teal-600' : 'text-slate-500'}`}
                  >
                    Iniciar Sesi√≥n
                  </button>
                  <button
                    onClick={() => { setModo('register'); setError(''); }}
                    className={`flex-1 py-2.5 rounded-lg font-medium transition-all ${modo === 'register' ? 'bg-white shadow text-teal-600' : 'text-slate-500'}`}
                  >
                    Registrarse
                  </button>
                </div>
                
                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl mb-4 text-sm">
                    ‚ö†Ô∏è {error}
                  </div>
                )}
                
                <form onSubmit={modo === 'login' ? handleLogin : handleRegister}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Usuario</label>
                      <input
                        type="text"
                        value={usuario}
                        onChange={e => setUsuario(e.target.value)}
                        className="w-full border-2 border-slate-200 rounded-xl px-4 py-3 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 transition-all"
                        placeholder="Ingrese su usuario"
                        required
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Contrase√±a</label>
                      <input
                        type="password"
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                        className="w-full border-2 border-slate-200 rounded-xl px-4 py-3 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 transition-all"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                      />
                    </div>
                    
                    {modo === 'register' && (
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Confirmar Contrase√±a</label>
                        <input
                          type="password"
                          value={confirmPassword}
                          onChange={e => setConfirmPassword(e.target.value)}
                          className="w-full border-2 border-slate-200 rounded-xl px-4 py-3 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 transition-all"
                          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                          required
                        />
                      </div>
                    )}
                    
                    <button
                      type="submit"
                      className="w-full bg-teal-600 text-white py-3 rounded-xl font-semibold hover:bg-teal-700 transition-all shadow-lg hover:shadow-xl"
                    >
                      {modo === 'login' ? 'üîê Iniciar Sesi√≥n' : '‚ú® Crear Cuenta'}
                    </button>
                  </div>
                </form>
                
                {/* Separador */}
                <div className="flex items-center my-6">
                  <div className="flex-1 border-t border-slate-200"></div>
                  <span className="px-4 text-sm text-slate-400">o contin√∫a con</span>
                  <div className="flex-1 border-t border-slate-200"></div>
                </div>
                
                {/* Bot√≥n Microsoft */}
                <button
                  onClick={async () => {
                    try {
                      setError('');
                      const account = await loginMicrosoft();
                      if (account) {
                        const session = {
                          usuario: account.username,
                          nombre: account.name || account.username.split('@')[0],
                          loginTime: Date.now(),
                          lastActivity: Date.now(),
                          microsoft: true,
                          email: account.username
                        };
                        guardarSeguro('session', session);
                        onLogin(session);
                      }
                    } catch (e) {
                      setError('Error al iniciar sesi√≥n con Microsoft. Verifica tu conexi√≥n.');
                    }
                  }}
                  className="w-full bg-white border-2 border-slate-200 text-slate-700 py-3 rounded-xl font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center gap-3"
                >
                  <svg className="w-5 h-5" viewBox="0 0 21 21">
                    <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
                    <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
                    <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
                    <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
                  </svg>
                  Iniciar con Microsoft
                </button>
                
                <p className="text-center text-xs text-slate-400 mt-4">
                  ‚òÅÔ∏è Con Microsoft tus datos se guardan en OneDrive
                </p>
              </>
            )}
            
            <p className="text-center text-xs text-slate-400 mt-6">
              üîí Datos protegidos con encriptaci√≥n
            </p>
          </div>
        </div>
      );
    };

    // ==================== UTILIDADES ====================
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    // ==================== FUNCIONES DE CREACI√ìN DE DATOS ESTANDARIZADOS ====================
    
    // Crear estructura de per√≠odo vac√≠a estandarizada
    const crearPeriodoVacio = () => ({
      c: '', p: '', e: '', rc: '', rp: '', re: ''
    });
    
    // Crear estructura de materia estandarizada
    const crearMateriaEstandar = (nombre, profesor) => ({
      nombre: nombre || '',
      profesor: profesor || '',
      p1: crearPeriodoVacio(),
      p2: crearPeriodoVacio(),
      p3: crearPeriodoVacio(),
      p4: crearPeriodoVacio(),
      rf: ''
    });
    
    // Crear array completo de materias
    const crearMateriasCompletas = (profPorMateria, aula) => {
      profPorMateria = profPorMateria || {};
      aula = aula || '';
      
      return MATERIAS_DEFAULT.map(nombreMateria => {
        let profesor = '';
        
        if (profPorMateria[aula]) {
          profesor = profPorMateria[aula][nombreMateria] || '';
          
          if (!profesor) {
            const alternativas = {
              'Formaci√≥n Integral Humana y Religiosa': ['Formaci√≥n Humana y Religiosa', 'Formaci√≥n Humana', 'FIHR'],
              'Ciencias de la Naturaleza': ['Ciencias Naturales', 'C. Naturales'],
              'Educaci√≥n F√≠sica': ['Ed. F√≠sica', 'E. F√≠sica'],
              'Artes Visuales': ['Arte', 'Artes']
            };
            
            const alts = alternativas[nombreMateria];
            if (alts) {
              for (let i = 0; i < alts.length; i++) {
                if (profPorMateria[aula][alts[i]]) {
                  profesor = profPorMateria[aula][alts[i]];
                  break;
                }
              }
            }
          }
        }
        
        return crearMateriaEstandar(nombreMateria, profesor);
      });
    };
    
    // Crear estructura de asistencia estandarizada
    const crearAsistenciaEstandar = () => ({
      p1: { asistencia: '', ausencia: '', tardanza: '' },
      p2: { asistencia: '', ausencia: '', tardanza: '' },
      p3: { asistencia: '', ausencia: '', tardanza: '' },
      p4: { asistencia: '', ausencia: '', tardanza: '' }
    });
    
    // Crear estructura de observaciones estandarizada
    const crearObservacionesEstandar = () => ({
      p1: '', p2: '', p3: '', p4: ''
    });
    
    // Normalizar una materia existente
    const normalizarMateria = (materia) => {
      if (!materia) return crearMateriaEstandar('Sin nombre', '');
      
      const normalizada = {
        nombre: materia.nombre || 'Sin nombre',
        profesor: materia.profesor || '',
        rf: materia.rf || '',
        p1: crearPeriodoVacio(),
        p2: crearPeriodoVacio(),
        p3: crearPeriodoVacio(),
        p4: crearPeriodoVacio()
      };
      
      ['p1', 'p2', 'p3', 'p4'].forEach(per => {
        const perData = materia[per] || materia[per.toUpperCase()];
        
        if (perData && typeof perData === 'object') {
          if ('calificacion' in perData) {
            normalizada[per] = {
              c: perData.calificacion || '',
              p: '', e: '', rc: '', rp: '', re: ''
            };
          } else {
            normalizada[per] = {
              c: perData.c || '',
              p: perData.p || '',
              e: perData.e || '',
              rc: perData.rc || '',
              rp: perData.rp || '',
              re: perData.re || ''
            };
          }
        }
      });
      
      return normalizada;
    };
    
    // Crear estudiante completo estandarizado
    const crearEstudianteEstandar = (datos) => {
      datos = datos || {};
      const currentYear = new Date().getFullYear();
      const id = datos.id || STORAGE_PREFIX + 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
      
      const grado = datos.grado || '1ro';
      const seccion = datos.seccion || 'A';
      const aula = datos.aula || (grado + ' ' + seccion);
      
      let materias;
      if (datos.materias && datos.materias.length === 10) {
        materias = datos.materias.map(function(m) { return normalizarMateria(m); });
      } else {
        materias = crearMateriasCompletas(datos.profPorMateria, aula);
      }
      
      return {
        id: id,
        matricula: datos.matricula || ('EST-' + Date.now().toString().slice(-6)),
        nombre: (datos.nombre || '').trim(),
        grado: grado,
        seccion: seccion,
        nivel: datos.nivel || 'Primario',
        aula: aula,
        aulaId: datos.aulaId || '',
        periodoEscolar: datos.periodoEscolar || (currentYear + '-' + (currentYear + 1)),
        maestraTitular: datos.maestraTitular || '',
        profesorTitular: datos.profesorTitular || datos.maestraTitular || '',
        materias: materias,
        asistencia: datos.asistencia || crearAsistenciaEstandar(),
        observaciones: datos.observaciones || crearObservacionesEstandar(),
        infoAvance: datos.infoAvance || crearObservacionesEstandar(),
        situacion: datos.situacion || '',
        condicionFinal: datos.condicionFinal || '',
        observacionPortada: datos.observacionPortada || '',
        foto: datos.foto || null,
        fechaNacimiento: datos.fechaNacimiento || '',
        lugarNacimiento: datos.lugarNacimiento || '',
        nacionalidad: datos.nacionalidad || 'Dominicana',
        sexo: datos.sexo || '',
        nombrePadre: datos.nombrePadre || '',
        nombreMadre: datos.nombreMadre || '',
        telefonoContacto: datos.telefonoContacto || '',
        direccion: datos.direccion || '',
        ultimaModificacion: datos.ultimaModificacion || new Date().toISOString()
      };
    };
    
    // Validar y normalizar estudiante completo
    const normalizarEstudiante = (estudiante, aulas, profPorMateria) => {
      estudiante = estudiante || {};
      aulas = aulas || [];
      profPorMateria = profPorMateria || {};
      
      let modificado = false;
      const normalizado = deepClone(estudiante);
      
      if (!normalizado.id) {
        normalizado.id = STORAGE_PREFIX + 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        modificado = true;
      }
      
      if (!normalizado.matricula) {
        normalizado.matricula = 'EST-' + Date.now().toString().slice(-6);
        modificado = true;
      }
      
      if (!normalizado.nombre) {
        normalizado.nombre = 'Sin nombre';
        modificado = true;
      }
      
      const gradosValidos = ['1ro', '2do', '3ro', '4to', '5to', '6to'];
      if (!normalizado.grado || gradosValidos.indexOf(normalizado.grado) === -1) {
        normalizado.grado = '1ro';
        modificado = true;
      }
      
      const seccionesValidas = ['A', 'B', 'C', 'D', 'E'];
      if (!normalizado.seccion || seccionesValidas.indexOf(normalizado.seccion.toUpperCase()) === -1) {
        normalizado.seccion = 'A';
        modificado = true;
      } else {
        normalizado.seccion = normalizado.seccion.toUpperCase();
      }
      
      if (!normalizado.nivel || ['Inicial', 'Primario', 'Secundario'].indexOf(normalizado.nivel) === -1) {
        normalizado.nivel = 'Primario';
        modificado = true;
      }
      
      if (!normalizado.aula) {
        normalizado.aula = normalizado.grado + ' ' + normalizado.seccion;
        modificado = true;
      }
      
      if (!normalizado.maestraTitular && aulas.length > 0) {
        const aulaData = aulas.find(function(a) { return a.nombre === normalizado.aula; });
        if (aulaData && aulaData.maestraTitular) {
          normalizado.maestraTitular = aulaData.maestraTitular;
          normalizado.profesorTitular = aulaData.maestraTitular;
          modificado = true;
        }
      }
      
      if (!normalizado.periodoEscolar) {
        const year = new Date().getFullYear();
        normalizado.periodoEscolar = year + '-' + (year + 1);
        modificado = true;
      }
      
      if (!normalizado.materias || !Array.isArray(normalizado.materias) || normalizado.materias.length === 0) {
        normalizado.materias = crearMateriasCompletas(profPorMateria, normalizado.aula);
        modificado = true;
      } else {
        const materiasExistentes = {};
        normalizado.materias.forEach(function(m) { materiasExistentes[m.nombre] = true; });
        
        MATERIAS_DEFAULT.forEach(function(nombreMateria) {
          if (!materiasExistentes[nombreMateria]) {
            normalizado.materias.push(crearMateriaEstandar(nombreMateria, ''));
            modificado = true;
          }
        });
        
        normalizado.materias = normalizado.materias.map(function(mat) {
          return normalizarMateria(mat);
        });
      }
      
      if (!normalizado.asistencia || typeof normalizado.asistencia !== 'object') {
        normalizado.asistencia = crearAsistenciaEstandar();
        modificado = true;
      }
      
      if (!normalizado.observaciones || typeof normalizado.observaciones !== 'object') {
        if (typeof normalizado.obs === 'string') {
          normalizado.observaciones = { p1: normalizado.obs, p2: '', p3: '', p4: '' };
          delete normalizado.obs;
        } else {
          normalizado.observaciones = crearObservacionesEstandar();
        }
        modificado = true;
      }
      
      if (!normalizado.infoAvance) {
        normalizado.infoAvance = crearObservacionesEstandar();
        modificado = true;
      }
      
      var camposOpcionales = ['situacion', 'condicionFinal', 'observacionPortada', 'foto', 
        'fechaNacimiento', 'lugarNacimiento', 'nacionalidad', 'sexo', 
        'nombrePadre', 'nombreMadre', 'telefonoContacto', 'direccion'];
      
      camposOpcionales.forEach(function(campo) {
        if (normalizado[campo] === undefined) {
          normalizado[campo] = campo === 'nacionalidad' ? 'Dominicana' : (campo === 'foto' ? null : '');
          modificado = true;
        }
      });
      
      return { normalizado: normalizado, modificado: modificado };
    };

    const esNotaValida = (valor) => {
      if (valor === '' || valor === null || valor === undefined) return true;
      const num = parseFloat(valor);
      return !isNaN(num) && num >= NOTA_MIN && num <= NOTA_MAX;
    };

    const formatearNota = (valor) => {
      if (valor === '' || valor === null || valor === undefined) return '';
      const num = parseFloat(valor);
      if (isNaN(num)) return '';
      return Math.max(NOTA_MIN, Math.min(NOTA_MAX, Math.round(num))).toString();
    };

    // Calcular nota efectiva de un per√≠odo para una competencia (considera recuperaci√≥n)
    const calcNotaEfectivaPeriodo = (materia, periodo, competencia) => {
      const nota = materia[periodo][competencia];
      const recuperacion = materia[periodo][`r${competencia}`]; // rc, rp, re
      
      const notaNum = nota !== '' && !isNaN(parseFloat(nota)) ? parseFloat(nota) : null;
      const recNum = recuperacion !== '' && !isNaN(parseFloat(recuperacion)) ? parseFloat(recuperacion) : null;
      
      if (notaNum === null && recNum === null) return null;
      if (notaNum === null) return recNum;
      if (recNum === null) return notaNum;
      
      // Si hay recuperaci√≥n, tomar el mayor
      return Math.max(notaNum, recNum);
    };

    // Calcular promedio de una competencia (C1, C2 o C3) para una materia
    const calcPromedioCompetencia = (materia, competencia) => {
      const notas = [];
      ['p1', 'p2', 'p3', 'p4'].forEach(per => {
        const notaEfectiva = calcNotaEfectivaPeriodo(materia, per, competencia);
        if (notaEfectiva !== null) {
          notas.push(notaEfectiva);
        }
      });
      if (notas.length === 0) return '';
      return Math.round(notas.reduce((a, b) => a + b, 0) / notas.length);
    };

    // Calcular calificaci√≥n final del √°rea
    const calcCalificacionFinalArea = (materia) => {
      const c1 = calcPromedioCompetencia(materia, 'c');
      const c2 = calcPromedioCompetencia(materia, 'p');
      const c3 = calcPromedioCompetencia(materia, 'e');
      
      const promedios = [];
      if (c1 !== '') promedios.push(c1);
      if (c2 !== '') promedios.push(c2);
      if (c3 !== '') promedios.push(c3);
      
      if (promedios.length === 0) return '';
      return Math.round(promedios.reduce((a, b) => a + b, 0) / promedios.length);
    };

    // Calificaci√≥n final considerando recuperaci√≥n
    const calcCalificacionFinalConRecuperacion = (materia) => {
      const calArea = calcCalificacionFinalArea(materia);
      if (calArea === '') return '';
      
      const rf = parseFloat(materia.rf) || 0;
      return rf > 0 ? Math.max(calArea, rf) : calArea;
    };

    // ==================== COMPONENTE MODAL ====================
    function Modal({ isOpen, onClose, onConfirm, title, message, type = 'confirm' }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in" onClick={e => e.stopPropagation()}>
            <h3 id="modal-title" className="text-xl font-bold text-slate-800 mb-3">{title}</h3>
            <p className="text-slate-600 mb-6">{message}</p>
            <div className="flex gap-3 justify-end">
              {type === 'confirm' && (
                <button onClick={onClose} className="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-100 transition-colors font-medium">Cancelar</button>
              )}
              <button onClick={() => { onConfirm(); onClose(); }} className={`px-4 py-2 rounded-lg text-white font-medium transition-colors ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : type === 'success' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                {type === 'alert' ? 'Aceptar' : 'Confirmar'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ==================== COMPONENTE TOAST ====================
    function Toast({ message, type = 'success', isVisible, onClose }) {
      useEffect(() => {
        if (isVisible) {
          const timer = setTimeout(onClose, 3000);
          return () => clearTimeout(timer);
        }
      }, [isVisible, onClose]);
      if (!isVisible) return null;
      const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
      const colors = { success: 'bg-emerald-600', error: 'bg-red-600', info: 'bg-blue-600' };
      return (
        <div className={`fixed bottom-6 right-6 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in z-50`}>
          <span className="text-xl font-bold">{icons[type]}</span>
          <span className="font-medium">{message}</span>
        </div>
      );
    }

    // ==================== COMPONENTE INPUT DE NOTA ====================
    function InputNota({ value, onChange, placeholder, destacado = false, label, id, compact = false }) {
      const [error, setError] = useState(false);
      const [localValue, setLocalValue] = useState(value);

      useEffect(() => { setLocalValue(value); }, [value]);

      const handleChange = (e) => {
        const val = e.target.value;
        setLocalValue(val);
        if (val === '' || esNotaValida(val)) {
          setError(false);
          onChange(formatearNota(val));
        } else {
          setError(true);
        }
      };

      const handleBlur = () => {
        if (localValue !== '' && !esNotaValida(localValue)) {
          setLocalValue(value);
          setError(false);
        }
      };

      return (
        <div className="relative">
          {label && <label htmlFor={id} className="sr-only">{label}</label>}
          <input
            id={id}
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            placeholder={placeholder}
            value={localValue}
            onChange={handleChange}
            onBlur={handleBlur}
            maxLength="3"
            aria-invalid={error}
            className={`w-full border rounded px-1 py-1 text-center transition-all duration-200 mono
              ${compact ? 'text-xs' : 'text-sm'}
              ${destacado ? 'border-amber-400 bg-amber-50' : 'border-slate-300'}
              ${error ? 'border-red-500 bg-red-50 ring-2 ring-red-200' : 'hover:border-slate-400'}
              focus:ring-2 focus:ring-blue-400 focus:border-transparent`}
          />
        </div>
      );
    }

    // ==================== COMPONENTE PRINCIPAL ====================
    function App() {
      const [usuario, setUsuario] = useState(null);
      const [mostrarLogin, setMostrarLogin] = useState(true);
      const [estudiantes, setEstudiantes] = useState([]);
      const [actual, setActual] = useState(null);
      const [vista, setVista] = useState(false);
      const [modal, setModal] = useState({ isOpen: false, title: '', message: '', type: 'confirm', onConfirm: () => {} });
      const [toast, setToast] = useState({ isVisible: false, message: '', type: 'success' });
      
      // Estados para b√∫squeda y filtros
      const [busqueda, setBusqueda] = useState('');
      const [filtroGrado, setFiltroGrado] = useState('');
      const [filtroAula, setFiltroAula] = useState(''); // Filtro por aula
      
      // Estado para auto-guardado
      const [autoGuardando, setAutoGuardando] = useState(false);
      const [ultimoGuardado, setUltimoGuardado] = useState(null);
      const autoSaveTimeoutRef = React.useRef(null);
      
      // Estados para gesti√≥n de profesores
      const [vistaConfig, setVistaConfig] = useState(false);
      const [profesores, setProfesores] = useState([]);
      const [asignaciones, setAsignaciones] = useState({}); // { materia: profesorId }
      const [nuevoProfNombre, setNuevoProfNombre] = useState('');
      const [nuevoProfIniciales, setNuevoProfIniciales] = useState('');
      
      // Estados para gesti√≥n de aulas
      const [aulas, setAulas] = useState([]);
      const [vistaAulas, setVistaAulas] = useState(false);
      
      // Estados para panel de administrador
      const [vistaAdmin, setVistaAdmin] = useState(false);
      const [maestrasDisponibles, setMaestrasDisponibles] = useState([]);
      const [estudiantesAdmin, setEstudiantesAdmin] = useState([]);
      const [maestraSeleccionada, setMaestraSeleccionada] = useState('');
      const [cargandoAdmin, setCargandoAdmin] = useState(false);
      
      // Estados para m√≥dulo de estudiantes
      const [tabActiva, setTabActiva] = useState('estudiantes');
      const [nuevoEstNombre, setNuevoEstNombre] = useState('');
      const [nuevoEstMatricula, setNuevoEstMatricula] = useState('');
      const [nuevoEstAula, setNuevoEstAula] = useState('');
      
      // Datos del centro educativo
      const [datosCentro, setDatosCentro] = useState(DATOS_CENTRO_DEFAULT);

      const mostrarToast = useCallback((message, type = 'success') => {
        setToast({ isVisible: true, message, type });
      }, []);

      const mostrarModal = useCallback((title, message, type, onConfirm) => {
        setModal({ isOpen: true, title, message, type, onConfirm: onConfirm || (() => {}) });
      }, []);
      
      // Cargar profesores y asignaciones desde localStorage
      const cargarProfesores = useCallback((nombreUsuario) => {
        try {
          const profKey = `${STORAGE_PREFIX}${nombreUsuario}_profesores`;
          const asigKey = `${STORAGE_PREFIX}${nombreUsuario}_asignaciones`;
          const profData = localStorage.getItem(profKey);
          const asigData = localStorage.getItem(asigKey);
          setProfesores(profData ? JSON.parse(profData) : []);
          setAsignaciones(asigData ? JSON.parse(asigData) : {});
        } catch (e) {
          console.error('Error al cargar profesores:', e);
          setProfesores([]);
          setAsignaciones({});
        }
      }, []);
      
      // Guardar profesores
      const guardarProfesores = useCallback((profs) => {
        if (!usuario) return;
        const profKey = `${STORAGE_PREFIX}${usuario}_profesores`;
        localStorage.setItem(profKey, JSON.stringify(profs));
        setProfesores(profs);
      }, [usuario]);
      
      // Guardar asignaciones
      const guardarAsignaciones = useCallback((asig) => {
        if (!usuario) return;
        const asigKey = `${STORAGE_PREFIX}${usuario}_asignaciones`;
        localStorage.setItem(asigKey, JSON.stringify(asig));
        setAsignaciones(asig);
      }, [usuario]);
      
      // Cargar aulas
      const cargarAulas = useCallback((nombreUsuario) => {
        try {
          const aulasKey = `${STORAGE_PREFIX}${nombreUsuario}_aulas`;
          const aulasData = localStorage.getItem(aulasKey);
          setAulas(aulasData ? JSON.parse(aulasData) : []);
        } catch (e) {
          console.error('Error al cargar aulas:', e);
          setAulas([]);
        }
      }, []);
      
      // Cargar datos del centro
      const cargarDatosCentro = useCallback((nombreUsuario) => {
        try {
          const centroKey = `${STORAGE_PREFIX}${nombreUsuario}_centro`;
          const centroData = localStorage.getItem(centroKey);
          setDatosCentro(centroData ? JSON.parse(centroData) : DATOS_CENTRO_DEFAULT);
        } catch (e) {
          console.error('Error al cargar datos del centro:', e);
          setDatosCentro(DATOS_CENTRO_DEFAULT);
        }
      }, []);
      
      // Guardar datos del centro
      const guardarDatosCentro = useCallback((datos) => {
        if (!usuario) return;
        const centroKey = `${STORAGE_PREFIX}${usuario}_centro`;
        localStorage.setItem(centroKey, JSON.stringify(datos));
        setDatosCentro(datos);
      }, [usuario]);
      
      // Guardar aulas
      const guardarAulas = useCallback((aulasData) => {
        if (!usuario) return;
        const aulasKey = `${STORAGE_PREFIX}${usuario}_aulas`;
        localStorage.setItem(aulasKey, JSON.stringify(aulasData));
        setAulas(aulasData);
      }, [usuario]);
      
      // Agregar aula
      const agregarAula = useCallback((grado, seccion, profesorTitularId, nivel) => {
        const nuevaAula = {
          id: `aula_${Date.now()}`,
          grado,
          seccion: seccion.toUpperCase(),
          nivel: nivel || 'Primario',
          profesorTitular: profesorTitularId,
          nombre: `${grado} "${seccion.toUpperCase()}"` // Ej: "3ro A"
        };
        guardarAulas([...aulas, nuevaAula]);
        mostrarToast(`Aula ${nuevaAula.nombre} creada`, 'success');
        return nuevaAula;
      }, [aulas, guardarAulas, mostrarToast]);
      
      // Eliminar aula
      const eliminarAula = useCallback((id) => {
        const aula = aulas.find(a => a.id === id);
        mostrarModal('Eliminar Aula', `¬øEst√°s seguro de eliminar el aula ${aula?.nombre}? Los estudiantes asignados quedar√°n sin aula.`, 'danger', () => {
          guardarAulas(aulas.filter(a => a.id !== id));
          // Limpiar aula de estudiantes
          const prefix = `${STORAGE_PREFIX}${usuario}_est_`;
          const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
          keys.forEach(k => {
            try {
              const est = JSON.parse(localStorage.getItem(k));
              if (est.aulaId === id) {
                est.aulaId = '';
                est.profesorTitular = '';
                localStorage.setItem(k, JSON.stringify(est));
              }
            } catch (e) {}
          });
          if (filtroAula === id) setFiltroAula('');
          cargarDatos(usuario);
          mostrarToast('Aula eliminada', 'info');
        });
      }, [aulas, guardarAulas, usuario, filtroAula, mostrarModal, mostrarToast]);
      
      // Obtener nombre del aula
      const getNombreAula = useCallback((aulaId) => {
        const aula = aulas.find(a => a.id === aulaId);
        return aula ? aula.nombre : '';
      }, [aulas]);
      
      // Obtener profesor titular del aula
      const getProfesorTitularAula = useCallback((aulaId) => {
        const aula = aulas.find(a => a.id === aulaId);
        if (!aula || !aula.profesorTitular) return null;
        return profesores.find(p => p.id === aula.profesorTitular);
      }, [aulas, profesores]);
      
      // Agregar profesor
      const agregarProfesor = useCallback(() => {
        if (!nuevoProfNombre.trim()) {
          mostrarToast('Ingresa el nombre del profesor', 'error');
          return;
        }
        const iniciales = nuevoProfIniciales.trim() || nuevoProfNombre.trim().split(' ').map(p => p[0]).join('').toUpperCase().substring(0, 3);
        const nuevoProf = {
          id: `prof_${Date.now()}`,
          nombre: nuevoProfNombre.trim(),
          iniciales: iniciales.toUpperCase()
        };
        guardarProfesores([...profesores, nuevoProf]);
        setNuevoProfNombre('');
        setNuevoProfIniciales('');
        mostrarToast('Profesor agregado', 'success');
      }, [nuevoProfNombre, nuevoProfIniciales, profesores, guardarProfesores, mostrarToast]);
      
      // Eliminar profesor
      const eliminarProfesor = useCallback((id) => {
        mostrarModal('Eliminar Profesor', '¬øEst√°s seguro de eliminar este profesor?', 'danger', () => {
          const nuevosProfs = profesores.filter(p => p.id !== id);
          guardarProfesores(nuevosProfs);
          // Limpiar asignaciones de este profesor
          const nuevasAsig = { ...asignaciones };
          Object.keys(nuevasAsig).forEach(mat => {
            if (nuevasAsig[mat] === id) delete nuevasAsig[mat];
          });
          guardarAsignaciones(nuevasAsig);
          mostrarToast('Profesor eliminado', 'info');
        });
      }, [profesores, asignaciones, guardarProfesores, guardarAsignaciones, mostrarModal, mostrarToast]);
      
      // Estado para editar profesor
      const [editandoProfesor, setEditandoProfesor] = useState(null);
      const [editNombre, setEditNombre] = useState('');
      const [editIniciales, setEditIniciales] = useState('');
      
      // Iniciar edici√≥n de profesor
      const iniciarEdicion = useCallback((prof) => {
        setEditandoProfesor(prof.id);
        setEditNombre(prof.nombre);
        setEditIniciales(prof.iniciales);
      }, []);
      
      // Guardar edici√≥n de profesor
      const guardarEdicion = useCallback(() => {
        if (!editNombre.trim()) {
          mostrarToast('El nombre no puede estar vac√≠o', 'error');
          return;
        }
        const inicialesFinales = editIniciales.trim() || editNombre.trim().split(' ').map(p => p[0]).join('').toUpperCase().substring(0, 3);
        const profAnterior = profesores.find(p => p.id === editandoProfesor);
        const inicialesAnteriores = profAnterior?.iniciales;
        
        const nuevosProfs = profesores.map(p => 
          p.id === editandoProfesor 
            ? { ...p, nombre: editNombre.trim(), iniciales: inicialesFinales.toUpperCase() }
            : p
        );
        guardarProfesores(nuevosProfs);
        
        // Actualizar iniciales en estudiantes existentes si cambiaron
        if (inicialesAnteriores && inicialesAnteriores !== inicialesFinales.toUpperCase()) {
          const prefix = `${STORAGE_PREFIX}${usuario}_est_`;
          const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
          keys.forEach(k => {
            try {
              const est = JSON.parse(localStorage.getItem(k));
              let modificado = false;
              est.materias.forEach(mat => {
                if (mat.profesor === inicialesAnteriores) {
                  mat.profesor = inicialesFinales.toUpperCase();
                  modificado = true;
                }
              });
              if (modificado) {
                localStorage.setItem(k, JSON.stringify(est));
              }
            } catch (e) {}
          });
        }
        
        setEditandoProfesor(null);
        setEditNombre('');
        setEditIniciales('');
        mostrarToast('Profesor actualizado', 'success');
      }, [editandoProfesor, editNombre, editIniciales, profesores, guardarProfesores, usuario, mostrarToast]);
      
      // Cancelar edici√≥n
      const cancelarEdicion = useCallback(() => {
        setEditandoProfesor(null);
        setEditNombre('');
        setEditIniciales('');
      }, []);
      
      // Asignar profesor a materia Y actualizar estudiantes existentes
      const asignarProfesor = useCallback((materia, profesorId) => {
        const nuevasAsig = { ...asignaciones };
        if (profesorId) {
          nuevasAsig[materia] = profesorId;
        } else {
          delete nuevasAsig[materia];
        }
        guardarAsignaciones(nuevasAsig);
        
        // Actualizar el profesor en todos los estudiantes existentes para esta materia
        const prof = profesorId ? profesores.find(p => p.id === profesorId) : null;
        const inicialesProf = prof ? prof.iniciales : '';
        
        // Mapeo de nombres antiguos a nuevos para compatibilidad
        const nombresEquivalentes = {
          'Moral y C√≠vica': ['Moral y C√≠vica', 'Educaci√≥n Art√≠stica'],
          'Artes Visuales': ['Artes Visuales', 'Arte']
        };
        const nombresABuscar = nombresEquivalentes[materia] || [materia];
        
        const prefix = `${STORAGE_PREFIX}${usuario}_est_`;
        const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
        keys.forEach(k => {
          try {
            const est = JSON.parse(localStorage.getItem(k));
            let modificado = false;
            est.materias.forEach(mat => {
              if (nombresABuscar.includes(mat.nombre)) {
                mat.profesor = inicialesProf;
                modificado = true;
              }
            });
            if (modificado) {
              localStorage.setItem(k, JSON.stringify(est));
            }
          } catch (e) {
            console.error('Error actualizando estudiante:', e);
          }
        });
        
        // Actualizar el estudiante actual si est√° abierto
        if (actual) {
          setActual(prev => {
            const nuevo = deepClone(prev);
            nuevo.materias.forEach(mat => {
              if (nombresABuscar.includes(mat.nombre)) {
                mat.profesor = inicialesProf;
              }
            });
            return nuevo;
          });
        }
        
        // Recargar datos
        cargarDatos(usuario);
      }, [asignaciones, guardarAsignaciones, profesores, usuario, actual, cargarDatos]);
      
      // Obtener iniciales del profesor asignado a una materia
      const getProfesorMateria = useCallback((materia) => {
        const profId = asignaciones[materia];
        if (!profId) return '';
        const prof = profesores.find(p => p.id === profId);
        return prof ? prof.iniciales : '';
      }, [asignaciones, profesores]);
      
      // Seleccionar estudiante y sincronizar profesores seg√∫n asignaciones
      const seleccionarEstudiante = useCallback((estudiante) => {
        // Normalizar estudiante antes de mostrarlo
        const { normalizado, modificado } = normalizarEstudiante(
          estudiante, 
          aulas,
          {} // profPorMateria vac√≠o, se usar√°n asignaciones
        );
        
        // Sincronizar profesores seg√∫n asignaciones actuales
        let profModificado = false;
        normalizado.materias.forEach(mat => {
          const profId = asignaciones[mat.nombre];
          if (profId) {
            const prof = profesores.find(p => p.id === profId);
            if (prof && mat.profesor !== prof.iniciales) {
              mat.profesor = prof.iniciales;
              profModificado = true;
            }
          }
        });
        
        // Si hubo cambios, guardar en localStorage
        if (modificado || profModificado) {
          localStorage.setItem(normalizado.id, JSON.stringify(normalizado));
          console.log(`‚úÖ Estudiante normalizado: ${normalizado.nombre}`);
        }
        
        setActual(normalizado);
      }, [asignaciones, profesores, aulas]);

      // ============================================================
      // SISTEMA DE VALIDACI√ìN Y AUTO-CORRECCI√ìN DE DATOS
      // ============================================================
      
      // Funci√≥n principal de validaci√≥n y correcci√≥n de estudiante
      // Usa la funci√≥n global normalizarEstudiante y agrega reportes
      const validarYCorregirEstudiante = useCallback((estudiante, aulas = [], profesoresLista = []) => {
        const errores = [];
        const correcciones = [];
        
        // Usar funci√≥n global de normalizaci√≥n
        const { normalizado, modificado } = normalizarEstudiante(estudiante, aulas, {});
        
        // Reportar correcciones realizadas
        if (!estudiante.id) correcciones.push('ID generado');
        if (!estudiante.matricula) correcciones.push('Matr√≠cula generada');
        if (!estudiante.grado) correcciones.push('Grado asignado');
        if (!estudiante.seccion) correcciones.push('Secci√≥n asignada');
        if (!estudiante.aula) correcciones.push('Aula generada');
        if (!estudiante.materias || estudiante.materias.length === 0) correcciones.push('Materias creadas (10)');
        if (!estudiante.asistencia) correcciones.push('Asistencia inicializada');
        if (!estudiante.observaciones) correcciones.push('Observaciones inicializadas');
        
        // Validar nombre
        if (!normalizado.nombre || normalizado.nombre === 'Sin nombre') {
          errores.push('Nombre inv√°lido o vac√≠o');
        }
        
        return { 
          corregido: normalizado, 
          modificado, 
          errores, 
          correcciones,
          esValido: errores.length === 0
        };
      }, []);
      
      // Funci√≥n para validar y corregir TODOS los estudiantes del sistema
      const validarTodosLosEstudiantes = useCallback((nombreUsuario) => {
        console.log('üîç Iniciando validaci√≥n de todos los estudiantes...');
        
        const prefix = `${STORAGE_PREFIX}${nombreUsuario}_est_`;
        const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
        const aulas = leerSeguro(`${STORAGE_PREFIX}${nombreUsuario}_aulas`) || [];
        const profesoresLista = leerSeguro(`${STORAGE_PREFIX}${nombreUsuario}_profesores`) || [];
        
        let totalCorregidos = 0;
        let totalErrores = 0;
        const resumen = [];
        
        keys.forEach(key => {
          try {
            const estudiante = JSON.parse(localStorage.getItem(key));
            const { corregido, modificado, errores, correcciones } = validarYCorregirEstudiante(estudiante, aulas, profesoresLista);
            
            if (modificado) {
              localStorage.setItem(key, JSON.stringify(corregido));
              totalCorregidos++;
              console.log(`‚úÖ Corregido: ${corregido.nombre}`, correcciones);
            }
            
            if (errores.length > 0) {
              totalErrores += errores.length;
              console.warn(`‚ö†Ô∏è Errores en ${corregido.nombre}:`, errores);
              resumen.push({ nombre: corregido.nombre, errores });
            }
          } catch (e) {
            console.error(`‚ùå Error procesando ${key}:`, e);
            totalErrores++;
          }
        });
        
        console.log(`üèÅ Validaci√≥n completada: ${totalCorregidos} corregidos, ${totalErrores} errores`);
        
        return { totalCorregidos, totalErrores, resumen };
      }, [validarYCorregirEstudiante]);
      
      // Funci√≥n para reparar datos corruptos
      const repararDatosCorruptos = useCallback((nombreUsuario) => {
        console.log('üîß Iniciando reparaci√≥n de datos...');
        
        const prefix = `${STORAGE_PREFIX}${nombreUsuario}_est_`;
        const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
        
        let eliminados = 0;
        let reparados = 0;
        
        keys.forEach(key => {
          try {
            const data = localStorage.getItem(key);
            
            // Intentar parsear
            let estudiante;
            try {
              estudiante = JSON.parse(data);
            } catch (parseError) {
              // Dato corrupto, eliminar
              localStorage.removeItem(key);
              eliminados++;
              console.log(`üóëÔ∏è Eliminado (corrupto): ${key}`);
              return;
            }
            
            // Verificar que tenga datos m√≠nimos
            if (!estudiante || !estudiante.nombre) {
              localStorage.removeItem(key);
              eliminados++;
              console.log(`üóëÔ∏è Eliminado (sin datos): ${key}`);
              return;
            }
            
            // Reparar si es posible
            const { corregido, modificado } = validarYCorregirEstudiante(estudiante);
            if (modificado) {
              localStorage.setItem(key, JSON.stringify(corregido));
              reparados++;
            }
          } catch (e) {
            console.error(`Error en ${key}:`, e);
          }
        });
        
        console.log(`üîß Reparaci√≥n completada: ${reparados} reparados, ${eliminados} eliminados`);
        return { reparados, eliminados };
      }, [validarYCorregirEstudiante]);
      
      // Funci√≥n de migraci√≥n (wrapper para compatibilidad)
      const migrarEstudiante = (estudiante, aulas = []) => {
        const { normalizado, modificado } = normalizarEstudiante(estudiante, aulas, {});
        return { migrado: normalizado, modificado };
      };

      const cargarDatos = useCallback((nombreUsuario) => {
        try {
          const prefix = `${STORAGE_PREFIX}${nombreUsuario}_est_`;
          const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
          
          // Cargar aulas para asignar maestras titulares
          const aulasKey = `${STORAGE_PREFIX}${nombreUsuario}_aulas`;
          const aulasData = localStorage.getItem(aulasKey);
          const aulas = aulasData ? JSON.parse(aulasData) : [];
          
          const data = keys.map(k => {
            try { 
              const est = JSON.parse(localStorage.getItem(k));
              
              // Aplicar normalizaci√≥n completa usando la funci√≥n unificada
              const { migrado, modificado } = migrarEstudiante(est, aulas);
              
              if (modificado) {
                localStorage.setItem(k, JSON.stringify(migrado));
                console.log(`‚úÖ Normalizado: ${migrado.nombre}`);
              }
              
              return migrado;
            } catch (e) { 
              console.error(`‚ùå Error procesando ${k}:`, e);
              return null; 
            }
          }).filter(Boolean).sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
          
          setEstudiantes(data);
          console.log(`üìö Cargados ${data.length} estudiantes`);
        } catch (e) {
          console.error('Error al cargar datos:', e);
          setEstudiantes([]);
        }
      }, []);

      // Control de inactividad para cierre de sesi√≥n autom√°tico
      const [ultimaActividad, setUltimaActividad] = useState(Date.now());
      
      useEffect(() => {
        const actualizarActividad = () => setUltimaActividad(Date.now());
        window.addEventListener('mousemove', actualizarActividad);
        window.addEventListener('keydown', actualizarActividad);
        window.addEventListener('click', actualizarActividad);
        
        const verificarInactividad = setInterval(() => {
          if (usuario && (Date.now() - ultimaActividad > SECURITY_CONFIG.SESSION_TIMEOUT)) {
            cerrarSesion();
            mostrarToast('Sesi√≥n cerrada por inactividad', 'info');
          }
        }, 60000); // Verificar cada minuto
        
        return () => {
          window.removeEventListener('mousemove', actualizarActividad);
          window.removeEventListener('keydown', actualizarActividad);
          window.removeEventListener('click', actualizarActividad);
          clearInterval(verificarInactividad);
        };
      }, [usuario, ultimaActividad]);

      // Verificar sesi√≥n al cargar
      useEffect(() => {
        const session = leerSeguro('session');
        if (session && session.usuario) {
          // Verificar que no haya expirado (24 horas m√°ximo)
          if (Date.now() - session.loginTime < 24 * 60 * 60 * 1000) {
            setUsuario(session.usuario);
            setMostrarLogin(false);
            
            // Ejecutar validaci√≥n autom√°tica de datos
            console.log('üîÑ Ejecutando validaci√≥n autom√°tica de datos...');
            const { totalCorregidos, totalErrores } = validarTodosLosEstudiantes(session.usuario);
            if (totalCorregidos > 0) {
              console.log(`‚úÖ Auto-correcci√≥n: ${totalCorregidos} estudiantes corregidos`);
            }
            
            cargarDatos(session.usuario);
            cargarProfesores(session.usuario);
            cargarAulas(session.usuario);
            cargarDatosCentro(session.usuario);
          } else {
            // Sesi√≥n expirada
            localStorage.removeItem(STORAGE_PREFIX + 'sec_session');
          }
        }
      }, [cargarDatos, cargarProfesores, cargarAulas, cargarDatosCentro, validarTodosLosEstudiantes]);
      
      // Auto-guardado
      useEffect(() => {
        if (!actual || !usuario) return;
        
        if (autoSaveTimeoutRef.current) {
          clearTimeout(autoSaveTimeoutRef.current);
        }
        
        autoSaveTimeoutRef.current = setTimeout(() => {
          setAutoGuardando(true);
          try {
            const dataToSave = deepClone(actual);
            dataToSave.ultimaModificacion = new Date().toISOString();
            localStorage.setItem(actual.id, JSON.stringify(dataToSave));
            setUltimoGuardado(new Date());
            cargarDatos(usuario);
          } catch (e) {
            console.error('Error en auto-guardado:', e);
          }
          setTimeout(() => setAutoGuardando(false), 500);
        }, AUTO_SAVE_DELAY);
        
        return () => {
          if (autoSaveTimeoutRef.current) {
            clearTimeout(autoSaveTimeoutRef.current);
          }
        };
      }, [actual, usuario, cargarDatos]);
      
      // Filtrar estudiantes
      const estudiantesFiltrados = useMemo(() => {
        return estudiantes.filter(est => {
          const matchBusqueda = !busqueda || 
            `${est.nombre || ''} ${est.matricula || ''}`.toLowerCase().includes(busqueda.toLowerCase());
          const matchGrado = !filtroGrado || est.grado === filtroGrado;
          const matchAula = !filtroAula || est.aulaId === filtroAula;
          return matchBusqueda && matchGrado && matchAula;
        });
      }, [estudiantes, busqueda, filtroGrado, filtroAula]);

      const handleLogin = useCallback((session) => {
        setUsuario(session.usuario);
        setMostrarLogin(false);
        cargarDatos(session.usuario);
        cargarProfesores(session.usuario);
        cargarAulas(session.usuario);
        cargarDatosCentro(session.usuario);
        mostrarToast(`¬°Bienvenido/a, ${session.nombre}!`, 'success');
        
        // Si es login de Microsoft, mostrar mensaje de OneDrive
        if (session.microsoft) {
          setTimeout(() => {
            mostrarToast('‚òÅÔ∏è Conectado con OneDrive', 'info');
          }, 2000);
        }
      }, [cargarDatos, cargarProfesores, cargarAulas, cargarDatosCentro, mostrarToast]);
      
      // Cerrar sesi√≥n
      const cerrarSesion = useCallback(async () => {
        // Si es sesi√≥n de Microsoft, cerrar tambi√©n ah√≠
        const session = leerSeguro('session');
        if (session?.microsoft) {
          try {
            await logoutMicrosoft();
          } catch (e) {
            console.log('Error en logout Microsoft:', e);
          }
        }
        localStorage.removeItem(STORAGE_PREFIX + 'sec_session');
        setUsuario(null);
        setMostrarLogin(true);
        setActual(null);
        setEstudiantes([]);
      }, []);

      const handleLogout = useCallback(() => {
        mostrarModal('Cerrar Sesi√≥n', '¬øEst√°s seguro de que deseas cerrar sesi√≥n?', 'confirm', () => {
          cerrarSesion();
          setBusqueda('');
          setFiltroGrado('');
          setFiltroAula('');
          setProfesores([]);
          setAsignaciones({});
          setAulas([]);
          setVistaConfig(false);
          setVistaAulas(false);
        });
      }, [mostrarModal, cerrarSesion]);

      const crearEstudiante = useCallback(() => {
        const id = `${STORAGE_PREFIX}${usuario}_est_${Date.now()}`;
        const currentYear = new Date().getFullYear();
        
        // Si hay un aula seleccionada, usar sus datos
        const aulaSeleccionada = filtroAula ? aulas.find(a => a.id === filtroAula) : null;
        const profTitular = aulaSeleccionada?.profesorTitular || '';
        
        const nuevoEstudiante = {
          id,
          matricula: '',
          nombre: '',
          grado: aulaSeleccionada?.grado || '1ro',
          nivel: aulaSeleccionada?.nivel || 'Primario',
          periodoEscolar: `${currentYear}-${currentYear + 1}`,
          aulaId: filtroAula || '', // ID del aula asignada
          profesorTitular: profTitular, // ID del profesor titular (del aula)
          materias: MATERIAS_DEFAULT.map(nombre => {
            // Buscar si hay un profesor asignado a esta materia
            const profId = asignaciones[nombre];
            const prof = profId ? profesores.find(p => p.id === profId) : null;
            return {
              nombre,
              profesor: prof ? prof.iniciales : '',
              p1: { c: '', p: '', e: '', rc: '', rp: '', re: '' },
              p2: { c: '', p: '', e: '', rc: '', rp: '', re: '' },
              p3: { c: '', p: '', e: '', rc: '', rp: '', re: '' },
              p4: { c: '', p: '', e: '', rc: '', rp: '', re: '' },
              rf: ''
            };
          }),
          asistencia: {
            p1: { asistencia: '', ausencia: '', tardanza: '' },
            p2: { asistencia: '', ausencia: '', tardanza: '' },
            p3: { asistencia: '', ausencia: '', tardanza: '' },
            p4: { asistencia: '', ausencia: '', tardanza: '' }
          },
          observaciones: {
            p1: '',
            p2: '',
            p3: '',
            p4: ''
          }
        };
        setActual(nuevoEstudiante);
      }, [usuario, asignaciones, profesores, filtroAula, aulas]);

      const guardarEstudiante = useCallback(async () => {
        if (!actual) return;
        try {
          const dataToSave = deepClone(actual);
          localStorage.setItem(actual.id, JSON.stringify(dataToSave));
          cargarDatos(usuario);
          
          // Si est√° conectado con Microsoft, sincronizar con OneDrive
          const session = leerSeguro('session');
          if (session?.microsoft) {
            const nombreArchivo = `estudiante_${actual.id.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
            
            // Guardar en carpeta personal
            const guardadoEnNube = await guardarEnOneDrive(nombreArchivo, dataToSave);
            
            // Tambi√©n guardar en carpeta compartida (para que admin pueda ver)
            await guardarEnCarpetaCompartida(session.email, nombreArchivo, dataToSave);
            
            if (guardadoEnNube) {
              mostrarToast('Guardado en local y OneDrive ‚òÅÔ∏è', 'success');
            } else {
              mostrarToast('Guardado localmente (sin conexi√≥n a OneDrive)', 'success');
            }
          } else {
            mostrarToast('Estudiante guardado correctamente', 'success');
          }
        } catch (e) {
          console.error('Error al guardar:', e);
          mostrarToast('Error al guardar los datos', 'error');
        }
      }, [actual, usuario, cargarDatos, mostrarToast]);

      const eliminarEstudiante = useCallback((id) => {
        mostrarModal('Eliminar Estudiante', '¬øEst√°s seguro de que deseas eliminar este estudiante?', 'danger', () => {
          localStorage.removeItem(id);
          cargarDatos(usuario);
          if (actual?.id === id) setActual(null);
          mostrarToast('Estudiante eliminado', 'info');
        });
      }, [usuario, actual, cargarDatos, mostrarModal, mostrarToast]);

      // Sincronizar todo con OneDrive
      const sincronizarConOneDrive = useCallback(async () => {
        const session = leerSeguro('session');
        if (!session?.microsoft) {
          mostrarToast('Debes iniciar sesi√≥n con Microsoft para sincronizar', 'error');
          return;
        }
        
        try {
          mostrarToast('Sincronizando con OneDrive...', 'info');
          
          // Guardar todos los estudiantes
          for (const est of estudiantes) {
            const nombreArchivo = `estudiante_${est.id.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
            await guardarEnOneDrive(nombreArchivo, est);
          }
          
          // Guardar configuraci√≥n (profesores, aulas, centro)
          await guardarEnOneDrive('config_profesores.json', profesores);
          await guardarEnOneDrive('config_aulas.json', aulas);
          await guardarEnOneDrive('config_centro.json', datosCentro);
          await guardarEnOneDrive('config_asignaciones.json', asignaciones);
          
          mostrarToast('‚úÖ Todo sincronizado con OneDrive', 'success');
        } catch (e) {
          console.error('Error sincronizando:', e);
          mostrarToast('Error al sincronizar con OneDrive', 'error');
        }
      }, [estudiantes, profesores, aulas, datosCentro, asignaciones, mostrarToast]);

      const exportarDatos = useCallback(() => {
        try {
          const datos = { version: '2.0', usuario, estudiantes, fecha: new Date().toISOString() };
          const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `respaldo-tehui-${usuario}-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          mostrarToast('Respaldo exportado correctamente', 'success');
        } catch (e) {
          mostrarToast('Error al exportar los datos', 'error');
        }
      }, [usuario, estudiantes, mostrarToast]);

      const importarDatos = useCallback((e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        const fileName = file.name.toLowerCase();
        const reader = new FileReader();
        
        // Si es archivo Excel (.xlsx, .xls)
        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          reader.onload = (ev) => {
            try {
              const data = new Uint8Array(ev.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              const sheetNames = workbook.SheetNames;
              console.log('üìÅ Hojas encontradas:', sheetNames);
              
              // ========== PASO 1: Leer todas las hojas ==========
              
              // 1.1 Leer hoja de Estudiantes
              const estSheet = workbook.Sheets['Estudiantes'] || workbook.Sheets[sheetNames[0]];
              const estData = XLSX.utils.sheet_to_json(estSheet, { header: 1 });
              const estHeaders = estData[0];
              const estRows = estData.slice(1).filter(row => row[0]);
              
              console.log('üìã Estudiantes encontrados:', estRows.length);
              console.log('üìã Headers:', estHeaders);
              
              // 1.2 Leer hoja de Maestras Titulares
              const maestrasPorAula = {};
              if (workbook.Sheets['Maestras Titulares']) {
                const titData = XLSX.utils.sheet_to_json(workbook.Sheets['Maestras Titulares'], { header: 1 });
                titData.slice(1).forEach(row => {
                  if (row[0]) {
                    const aula = String(row[0]).trim();
                    const maestra = String(row[3] || '').trim();
                    maestrasPorAula[aula] = maestra;
                  }
                });
                console.log('üë©‚Äçüè´ Maestras Titulares:', maestrasPorAula);
              }
              
              // 1.3 Leer hoja de Profesores por Materia
              const profPorMateria = {};
              if (workbook.Sheets['Profesores por Materia']) {
                const matSheet = workbook.Sheets['Profesores por Materia'];
                const matData = XLSX.utils.sheet_to_json(matSheet, { header: 1 });
                const matHeaders = matData[0];
                console.log('üìö Headers de materias:', matHeaders);
                
                matData.slice(1).forEach(row => {
                  if (row[0]) {
                    const aula = String(row[0]).trim();
                    profPorMateria[aula] = {};
                    for (let i = 1; i < matHeaders.length; i++) {
                      const materia = String(matHeaders[i]).trim();
                      const profesor = String(row[i] || '').trim();
                      profPorMateria[aula][materia] = profesor;
                    }
                  }
                });
                console.log('üìö Profesores por Materia:', profPorMateria);
              }
              
              if (estRows.length === 0) {
                mostrarToast('No se encontraron estudiantes en el archivo', 'error');
                return;
              }
              
              // ========== PASO 2: Obtener estudiantes existentes ==========
              const estudiantesExistentes = new Map();
              for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`${STORAGE_PREFIX}${usuario}_est_`)) {
                  try {
                    const est = JSON.parse(localStorage.getItem(key));
                    // Indexar por nombre normalizado
                    const nombreNorm = String(est.nombre || '').trim().toUpperCase()
                      .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    estudiantesExistentes.set(nombreNorm, { key, data: est });
                    // Tambi√©n indexar por matr√≠cula si existe
                    if (est.matricula) {
                      estudiantesExistentes.set(`MAT:${est.matricula}`, { key, data: est });
                    }
                  } catch (e) {
                    console.error('Error leyendo estudiante:', key, e);
                  }
                }
              }
              console.log('üíæ Estudiantes existentes en sistema:', estudiantesExistentes.size / 2);
              
              // ========== PASO 3: Funci√≥n para crear materias con profesores (usa funci√≥n global) ==========
              const crearMateriasConProfesoresLocal = (aula) => {
                return crearMateriasCompletas(profPorMateria, aula);
              };
              
              // ========== PASO 4: Procesar cada estudiante ==========
              let nuevos = 0;
              let actualizados = 0;
              const estudiantesParaGuardar = [];
              
              estRows.forEach((row, idx) => {
                const nombre = String(row[0] || '').trim();
                const matricula = row[1] ? String(row[1]).trim() : '';
                const grado = String(row[2] || '1ro').trim();
                const seccion = String(row[3] || 'A').trim();
                const nivel = String(row[4] || 'Primario').trim();
                
                // Determinar aula
                let aula = '';
                if (row[5] && String(row[5]).trim()) {
                  aula = String(row[5]).trim();
                } else {
                  aula = `${grado} ${seccion}`;
                }
                
                // Determinar maestra titular
                let maestraTitular = '';
                if (row[6] && String(row[6]).trim()) {
                  maestraTitular = String(row[6]).trim();
                } else if (maestrasPorAula[aula]) {
                  maestraTitular = maestrasPorAula[aula];
                }
                
                // Crear materias con profesores asignados usando funci√≥n estandarizada
                const materiasNuevas = crearMateriasConProfesoresLocal(aula);
                
                // Buscar si ya existe
                const nombreNorm = nombre.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                let existente = estudiantesExistentes.get(nombreNorm);
                if (!existente && matricula) {
                  existente = estudiantesExistentes.get(`MAT:${matricula}`);
                }
                
                if (existente) {
                  // ACTUALIZAR estudiante existente
                  actualizados++;
                  const estExistente = existente.data;
                  
                  // Fusionar materias: mantener calificaciones existentes, actualizar profesores
                  const materiasFusionadas = materiasNuevas.map(matNueva => {
                    const matExistente = estExistente.materias?.find(m => m.nombre === matNueva.nombre);
                    if (matExistente) {
                      // Normalizar la materia existente y fusionar con nueva
                      const matNormalizada = normalizarMateria(matExistente);
                      return {
                        ...matNormalizada,
                        profesor: matNueva.profesor || matNormalizada.profesor
                      };
                    }
                    return matNueva;
                  });
                  
                  // Crear estudiante usando funci√≥n estandarizada
                  const estActualizado = crearEstudianteEstandar({
                    ...estExistente,
                    id: estExistente.id,
                    nombre: nombre,
                    matricula: matricula || estExistente.matricula,
                    grado: grado,
                    seccion: seccion,
                    nivel: nivel,
                    aula: aula,
                    maestraTitular: maestraTitular,
                    materias: materiasFusionadas
                  });
                  estActualizado._storageKey = existente.key;
                  
                  estudiantesParaGuardar.push(estActualizado);
                } else {
                  // CREAR nuevo estudiante usando funci√≥n estandarizada
                  nuevos++;
                  const nuevoId = `${STORAGE_PREFIX}${usuario}_est_${Date.now()}_${idx}_${Math.random().toString(36).substr(2, 5)}`;
                  
                  const nuevoEst = crearEstudianteEstandar({
                    id: nuevoId,
                    nombre: nombre,
                    matricula: matricula || `EST-${String(idx + 1).padStart(3, '0')}`,
                    grado: grado,
                    seccion: seccion,
                    nivel: nivel,
                    aula: aula,
                    maestraTitular: maestraTitular,
                    materias: materiasNuevas
                  });
                  nuevoEst._storageKey = nuevoId;
                  
                  estudiantesParaGuardar.push(nuevoEst);
                }
              });
              
              // ========== PASO 5: Verificar asignaci√≥n de materias ==========
              console.log('=== VERIFICACI√ìN DE MATERIAS ===');
              const muestraEst = estudiantesParaGuardar[0];
              if (muestraEst) {
                console.log(`Estudiante: ${muestraEst.nombre}`);
                console.log(`Aula: ${muestraEst.aula}`);
                console.log(`Maestra Titular: ${muestraEst.maestraTitular}`);
                console.log('Materias:');
                muestraEst.materias.forEach(m => {
                  const estado = m.profesor ? '‚úÖ' : '‚ö†Ô∏è';
                  console.log(`  ${estado} ${m.nombre}: ${m.profesor || 'SIN ASIGNAR'}`);
                });
              }
              
              // ========== PASO 6: Recopilar profesores √∫nicos ==========
              const profesoresUnicos = new Set();
              Object.values(maestrasPorAula).forEach(m => m && profesoresUnicos.add(m));
              Object.values(profPorMateria).forEach(materias => {
                Object.values(materias).forEach(p => p && profesoresUnicos.add(p));
              });
              
              // ========== PASO 7: Mostrar resumen y confirmar ==========
              const resumen = `üìä RESUMEN DE IMPORTACI√ìN

üìö ESTUDIANTES: ${estRows.length}
   ‚Ä¢ ${nuevos} nuevos (se agregar√°n)
   ‚Ä¢ ${actualizados} existentes (se actualizar√°n)

üè´ AULAS: ${Object.keys(maestrasPorAula).length}
üë®‚Äçüè´ PROFESORES: ${profesoresUnicos.size}
üìñ MATERIAS: 10 por estudiante

‚úÖ Cada estudiante tendr√° sus materias con los profesores asignados seg√∫n su aula.
‚úÖ Las calificaciones existentes se mantendr√°n.

¬øDesea continuar?`;
              
              mostrarModal('Importar Datos', resumen, 'confirm', () => {
                // ========== PASO 8: Crear/Actualizar aulas PRIMERO ==========
                const aulasExistentes = leerSeguro(`${STORAGE_PREFIX}${usuario}_aulas`) || [];
                const aulasMap = new Map(); // nombre -> aula object
                
                // Indexar aulas existentes
                aulasExistentes.forEach(a => {
                  aulasMap.set(a.nombre, a);
                });
                
                // Crear aulas nuevas y actualizar existentes
                let aulasNuevas = 0;
                Object.entries(maestrasPorAula).forEach(([nombreAula, maestra]) => {
                  if (aulasMap.has(nombreAula)) {
                    // Actualizar maestra titular
                    const aulaExistente = aulasMap.get(nombreAula);
                    aulaExistente.maestraTitular = maestra;
                  } else {
                    // Crear aula nueva
                    const nuevaAula = {
                      id: `aula_${Date.now()}_${Math.random().toString(36).substr(2, 5)}_${aulasNuevas}`,
                      nombre: nombreAula,
                      maestraTitular: maestra,
                      grado: nombreAula.split(' ')[0] || '1ro',
                      seccion: nombreAula.split(' ')[1] || 'A',
                      nivel: 'Primario'
                    };
                    aulasMap.set(nombreAula, nuevaAula);
                    aulasNuevas++;
                  }
                });
                
                // Guardar aulas
                const aulasFinales = Array.from(aulasMap.values());
                guardarSeguro(`${STORAGE_PREFIX}${usuario}_aulas`, aulasFinales);
                console.log(`‚úÖ Aulas: ${aulasNuevas} nuevas, ${aulasFinales.length} total`);
                
                // ========== PASO 9: Asignar aulaId a estudiantes y guardar ==========
                estudiantesParaGuardar.forEach(est => {
                  const key = est._storageKey;
                  delete est._storageKey;
                  
                  // Buscar el aula por nombre y asignar aulaId
                  if (est.aula && aulasMap.has(est.aula)) {
                    est.aulaId = aulasMap.get(est.aula).id;
                  }
                  
                  localStorage.setItem(key, JSON.stringify(est));
                });
                console.log(`‚úÖ ${estudiantesParaGuardar.length} estudiantes guardados con aulaId asignado`);
                
                // ========== PASO 10: Guardar profesores ==========
                const profExistentes = leerSeguro(`${STORAGE_PREFIX}${usuario}_profesores`) || [];
                const profExistentesNorm = new Set(profExistentes.map(p => 
                  String(p.nombre).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                ));
                
                let profNuevos = 0;
                const profFinales = [...profExistentes];
                
                profesoresUnicos.forEach(nombre => {
                  const nombreNorm = String(nombre).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                  if (!profExistentesNorm.has(nombreNorm)) {
                    profFinales.push({
                      id: `prof_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                      nombre: nombre,
                      cedula: '',
                      cargo: 'Docente',
                      area: ''
                    });
                    profNuevos++;
                  }
                });
                
                guardarSeguro(`${STORAGE_PREFIX}${usuario}_profesores`, profFinales);
                console.log(`‚úÖ Profesores: ${profNuevos} nuevos, ${profFinales.length} total`);
                
                // ========== PASO 11: Recargar y notificar ==========
                cargarDatos(usuario);
                cargarAulas(usuario);
                
                mostrarToast(`‚úÖ Importaci√≥n completada:
‚Ä¢ ${nuevos} estudiantes nuevos
‚Ä¢ ${actualizados} estudiantes actualizados
‚Ä¢ ${profNuevos} profesores agregados
‚Ä¢ ${aulasNuevas} aulas creadas/actualizadas`, 'success');
                
                console.log('üéâ IMPORTACI√ìN COMPLETADA EXITOSAMENTE');
              });
              
            } catch (err) {
              console.error('‚ùå Error al leer Excel:', err);
              mostrarToast('Error al leer el archivo Excel: ' + err.message, 'error');
            }
          };
          reader.readAsArrayBuffer(file);
        } 
        // Si es archivo JSON
        else if (fileName.endsWith('.json')) {
          reader.onload = (ev) => {
            try {
              const datos = JSON.parse(ev.target.result);
              if (!datos.estudiantes || !Array.isArray(datos.estudiantes)) {
                mostrarToast('Archivo JSON inv√°lido', 'error');
                return;
              }
              mostrarModal('Importar Datos', `¬øDeseas importar ${datos.estudiantes.length} estudiante(s)?`, 'confirm', () => {
                datos.estudiantes.forEach((est, idx) => {
                  const nuevoId = `${STORAGE_PREFIX}${usuario}_est_${Date.now()}_${idx}`;
                  const nuevo = deepClone({ ...est, id: nuevoId });
                  localStorage.setItem(nuevoId, JSON.stringify(nuevo));
                });
                cargarDatos(usuario);
                mostrarToast(`${datos.estudiantes.length} estudiante(s) importado(s)`, 'success');
              });
            } catch (err) {
              mostrarToast('Error al leer el archivo JSON', 'error');
            }
          };
          reader.readAsText(file);
        } else {
          mostrarToast('Formato no soportado. Use .xlsx o .json', 'error');
        }
        
        e.target.value = '';
      }, [usuario, cargarDatos, mostrarModal, mostrarToast]);

      const actualizarNota = useCallback((indiceMateria, periodo, campo, valor) => {
        setActual(prev => {
          if (!prev) return prev;
          const nuevo = deepClone(prev);
          nuevo.materias[indiceMateria][periodo][campo] = valor;
          return nuevo;
        });
      }, []);

      const actualizarCampoMateria = useCallback((indiceMateria, campo, valor) => {
        setActual(prev => {
          if (!prev) return prev;
          const nuevo = deepClone(prev);
          nuevo.materias[indiceMateria][campo] = valor;
          return nuevo;
        });
      }, []);

      const actualizarEstudiante = useCallback((campo, valor) => {
        setActual(prev => prev ? { ...prev, [campo]: valor } : prev);
      }, []);

      const actualizarAsistencia = useCallback((periodo, campo, valor) => {
        setActual(prev => {
          if (!prev) return prev;
          const nuevo = deepClone(prev);
          if (!nuevo.asistencia) {
            nuevo.asistencia = {
              p1: { asistencia: '', ausencia: '', tardanza: '' },
              p2: { asistencia: '', ausencia: '', tardanza: '' },
              p3: { asistencia: '', ausencia: '', tardanza: '' },
              p4: { asistencia: '', ausencia: '', tardanza: '' }
            };
          }
          nuevo.asistencia[periodo][campo] = valor;
          return nuevo;
        });
      }, []);

      // Calcular porcentajes de asistencia por per√≠odo y anual (3 tardanzas = 1 ausencia)
      const calcPorcentajeAsistencia = useCallback(() => {
        const emptyResult = { 
          p1: { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' },
          p2: { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' },
          p3: { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' },
          p4: { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' },
          anual: { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' }
        };
        
        if (!actual?.asistencia) return emptyResult;
        
        let totalAsistAnual = 0, totalAusAnual = 0, totalTardAnual = 0;
        const resultado = {};
        
        ['p1', 'p2', 'p3', 'p4'].forEach(p => {
          const asist = parseFloat(actual.asistencia[p]?.asistencia) || 0;
          const ausDirectas = parseFloat(actual.asistencia[p]?.ausencia) || 0;
          const tardanzas = parseFloat(actual.asistencia[p]?.tardanza) || 0;
          
          // Calcular ausencias por tardanzas (3 tardanzas = 1 ausencia)
          const ausPorTardanzas = Math.floor(tardanzas / TARDANZAS_POR_AUSENCIA);
          const ausenciasTotal = ausDirectas + ausPorTardanzas;
          
          const totalPeriodo = asist + ausenciasTotal;
          
          if (totalPeriodo > 0) {
            resultado[p] = {
              asistencia: Math.round((asist / totalPeriodo) * 100) + '%',
              ausencia: Math.round((ausenciasTotal / totalPeriodo) * 100) + '%',
              ausPorTard: ausPorTardanzas,
              ausTotal: ausenciasTotal
            };
            totalAsistAnual += asist;
            totalAusAnual += ausenciasTotal;
            totalTardAnual += tardanzas;
          } else {
            resultado[p] = { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' };
          }
        });
        
        // Calcular anual
        const totalAnual = totalAsistAnual + totalAusAnual;
        const ausPorTardAnual = Math.floor(totalTardAnual / TARDANZAS_POR_AUSENCIA);
        
        if (totalAnual > 0) {
          resultado.anual = {
            asistencia: Math.round((totalAsistAnual / totalAnual) * 100) + '%',
            ausencia: Math.round((totalAusAnual / totalAnual) * 100) + '%',
            ausPorTard: ausPorTardAnual,
            ausTotal: totalAusAnual
          };
        } else {
          resultado.anual = { asistencia: '', ausencia: '', ausPorTard: 0, ausTotal: '' };
        }
        
        return resultado;
      }, [actual]);

      // ==================== PANTALLA DE LOGIN ====================
      if (mostrarLogin) {
        return (
          <>
            <LoginScreen onLogin={handleLogin} />
            <Modal {...modal} onClose={() => setModal(m => ({ ...m, isOpen: false }))} />
            <Toast {...toast} onClose={() => setToast(t => ({ ...t, isVisible: false }))} />
          </>
        );
      }

      // ==================== VISTA DE IMPRESI√ìN ====================
      if (vista && actual) {
        const porcentajes = calcPorcentajeAsistencia();
        return (
          <div className="print-wrapper bg-slate-100 min-h-screen">
            {/* Botones de control - NO SE IMPRIMEN */}
            <div className="no-print p-4 bg-white shadow-md mb-4 flex flex-wrap gap-3 items-center sticky top-0 z-50">
              <button onClick={() => setVista(false)} className="px-5 py-2.5 bg-slate-700 text-white rounded-xl hover:bg-slate-800 transition-colors font-medium flex items-center gap-2">
                <span>‚Üê</span> Volver a Edici√≥n
              </button>
              <button onClick={() => window.print()} className="px-5 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium flex items-center gap-2">
                <span>üñ®Ô∏è</span> Imprimir Bolet√≠n
              </button>
              <span className="text-sm text-slate-500 ml-4">Vista previa del bolet√≠n de: <strong>{actual.nombre}</strong></span>
            </div>
            
            {/* ========== P√ÅGINA 1: PORTADA (Formato MINERD Oficial) ========== */}
            <div className="print-portada bg-white mx-auto mb-6 print-page-preview" style={{maxWidth: '100%', height: '100%'}}>
              <div className="grid grid-cols-2 h-full">
                {/* Columna izquierda: Firmas, Situaci√≥n y Observaciones */}
                <div className="flex flex-col border-r-2 border-teal-500 h-full" style={{overflow: 'hidden'}}>
                  {/* Encabezado de firmas */}
                  <div className="bg-teal-600 text-white text-center py-2 font-bold text-sm">
                    FIRMA DEL PADRE, MADRE O TUTOR
                  </div>
                  
                  {/* Per√≠odos de Reporte */}
                  <div className="p-3 border-b border-slate-300" style={{fontSize: '10px'}}>
                    <p className="font-semibold text-slate-700 mb-2">Per√≠odos de Reporte de Calificaciones</p>
                    <div className="space-y-3">
                      <div className="flex items-end">
                        <span className="text-slate-600 w-28">Ago ‚Äì Sept ‚Äì Oct</span>
                        <span className="flex-1 border-b border-slate-400"></span>
                      </div>
                      <div className="flex items-end">
                        <span className="text-slate-600 w-28">Nov ‚Äì Dic ‚Äì Ene</span>
                        <span className="flex-1 border-b border-slate-400"></span>
                      </div>
                      <div className="flex items-end">
                        <span className="text-slate-600 w-28">Feb ‚Äì Mar</span>
                        <span className="flex-1 border-b border-slate-400"></span>
                      </div>
                      <div className="flex items-end">
                        <span className="text-slate-600 w-28">Abr ‚Äì May ‚Äì Jun</span>
                        <span className="flex-1 border-b border-slate-400"></span>
                      </div>
                    </div>
                  </div>
                  
                  {/* SITUACI√ìN DEL ESTUDIANTE - Solo para 3ro en adelante */}
                  {['3ro', '4to', '5to', '6to'].includes(actual.grado) && (
                    <div className="border-2 border-slate-400 m-2 p-1" style={{fontSize: '8px'}}>
                      <div className="bg-slate-100 text-center font-bold py-1 mb-1 border border-slate-300" style={{fontSize: '7px'}}>
                        SITUACI√ìN DEL/DE LA ESTUDIANTE
                      </div>
                      <div className="grid grid-cols-3 gap-1 text-center mb-1">
                        <div className="border border-slate-300 p-1">
                          <p className="font-medium" style={{fontSize: '7px'}}>Promovido/a</p>
                          <div className="h-4 border border-slate-300 mt-1 bg-white flex items-center justify-center">
                            {actual.situacion === 'promovido' && '‚úì'}
                          </div>
                        </div>
                        <div className="border border-slate-300 p-1">
                          <p className="font-medium" style={{fontSize: '7px'}}>Aplazado/a</p>
                          <div className="h-4 border border-slate-300 mt-1 bg-white flex items-center justify-center">
                            {actual.situacion === 'aplazado' && '‚úì'}
                          </div>
                        </div>
                        <div className="border border-slate-300 p-1">
                          <p className="font-medium" style={{fontSize: '7px'}}>Repitente</p>
                          <div className="h-4 border border-slate-300 mt-1 bg-white flex items-center justify-center">
                            {actual.situacion === 'repitente' && '‚úì'}
                          </div>
                        </div>
                      </div>
                      <div className="border border-slate-300 p-1">
                        <p className="font-medium" style={{fontSize: '7px'}}>Condici√≥n final del/de la estudiante:</p>
                        <p className="text-slate-700" style={{fontSize: '7px', minHeight: '12px'}}>{actual.condicionFinal || ''}</p>
                      </div>
                    </div>
                  )}
                  
                  {/* Informaci√≥n sobre nivel de avance - Solo texto digital */}
                  <div className="flex-1 border-2 border-slate-400 m-2 p-3" style={{overflow: 'hidden'}}>
                    <p className="font-bold text-slate-700 mb-2" style={{fontSize: '10px'}}>
                      Informaci√≥n sobre el nivel de avance de los aprendizajes y los apoyos que necesita para la mejora de sus aprendizajes.
                    </p>
                    <div style={{fontSize: '10px', lineHeight: '1.6', color: '#334155'}}>
                      <p style={{wordBreak: 'break-word', overflowWrap: 'break-word', whiteSpace: 'pre-wrap'}}>
                        {actual.observacionPortada || ''}
                      </p>
                    </div>
                  </div>
                  
                  {/* Slogan y Firmas al pie */}
                  <div className="mt-auto">
                    <p className="text-center text-lg font-bold italic text-teal-600 py-2">¬°Educando en valores con calidad!</p>
                    <div className="grid grid-cols-2 gap-6 px-4 pb-3">
                      <div className="text-center">
                        <div className="border-b border-slate-400 mb-1 h-10"></div>
                        <p style={{fontSize: '9px'}} className="text-slate-600">Maestro(a) Encargado(a) del grado</p>
                      </div>
                      <div className="text-center">
                        <div className="border-b border-slate-400 mb-1 h-10"></div>
                        <p style={{fontSize: '9px'}} className="text-slate-600">Director(a) del Centro Educativo</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Columna derecha: Datos del Centro y Estudiante */}
                <div className="flex flex-col h-full" style={{minWidth: 0, overflow: 'hidden'}}>
                  {/* Logo MINERD oficial - M√°s grande, leyenda m√°s cerca */}
                  <div className="text-center pt-2 pb-0">
                    <img src="MINERD.png" alt="Ministerio de Educaci√≥n" style={{width: '190px', height: 'auto', margin: '0 auto'}} />
                    <p style={{fontSize: '9px', marginTop: '2px'}} className="text-slate-600">Viceministerio de Servicios T√©cnicos y Pedag√≥gicos</p>
                    <p style={{fontSize: '9px', marginTop: '0px'}} className="text-slate-600">Direcci√≥n General de Educaci√≥n Primaria</p>
                  </div>
                  
                  {/* T√≠tulo INFORME DE APRENDIZAJE - Reducido */}
                  <div className="text-center py-1">
                    <h1 className="text-xl font-bold text-teal-600 italic">INFORME DE APRENDIZAJE</h1>
                  </div>
                  
                  {/* Logo del Centro - M√°s grande */}
                  <div className="flex flex-col items-center py-1">
                    <img src="Centro_TEHUI.png" alt="Centro Educativo Tehui" style={{width: '100px', height: 'auto'}} />
                  </div>
                  
                  {/* Grado y Nivel - Reducido */}
                  <div className="text-center py-1">
                    <p className="text-lg font-bold text-slate-800">{(() => {
                      const gradosTexto = {
                        '1ro': 'PRIMER', '2do': 'SEGUNDO', '3ro': 'TERCER',
                        '4to': 'CUARTO', '5to': 'QUINTO', '6to': 'SEXTO'
                      };
                      return (gradosTexto[actual.grado] || actual.grado?.toUpperCase() || '') + ' GRADO';
                    })()}</p>
                    <p className="text-base text-teal-600 font-semibold">NIVEL {actual.nivel?.toUpperCase() || 'PRIMARIO'}</p>
                  </div>
                  
                  {/* Datos del estudiante - M√ÅS GRANDES */}
                  <div className="flex-1 px-4 py-2" style={{fontSize: '13px', lineHeight: '1.9'}}>
                    <div className="py-0.5">
                      <span className="text-slate-600">A√±o escolar: </span>
                      <span className="font-bold text-slate-800">{actual.periodoEscolar || '____-____'}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Secci√≥n: </span>
                      <span className="font-bold text-slate-800">{(() => {
                        const aula = aulas.find(a => a.id === actual.aulaId);
                        return aula?.seccion || '___';
                      })()}</span>
                      <span className="text-slate-600 ml-8">N√∫mero de orden: </span>
                      <span className="font-bold text-slate-800">{actual.numeroOrden || '___'}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Nombre(s): </span>
                      <span className="font-bold text-slate-800">{actual.nombre?.split(' ').slice(0, 2).join(' ') || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Apellido(s): </span>
                      <span className="font-bold text-slate-800">{actual.nombre?.split(' ').slice(2).join(' ') || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">ID estudiante <span className="text-slate-400" style={{fontSize: '11px'}}>(SIGERD)</span>: </span>
                      <span className="font-bold text-slate-800">{actual.idSigerd || actual.matricula || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Docente: </span>
                      <span className="font-bold text-slate-800">{actual.profesorTitular ? profesores.find(p => p.id === actual.profesorTitular)?.nombre || '' : ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Centro educativo: </span>
                      <span className="font-bold text-slate-800">{datosCentro.nombre}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">C√≥digo del centro: </span>
                      <span className="font-bold text-slate-800">{datosCentro.codigo || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Tanda: </span>
                      <span className="font-bold text-slate-800">{datosCentro.tanda}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Tel√©fono del centro: </span>
                      <span className="font-bold text-slate-800">{datosCentro.telefono || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Distrito educativo: </span>
                      <span className="font-bold text-slate-800">{datosCentro.distrito || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Regional de educaci√≥n: </span>
                      <span className="font-bold text-slate-800">{datosCentro.regional || ''}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Provincia: </span>
                      <span className="font-bold text-slate-800">{datosCentro.provincia}</span>
                    </div>
                    <div className="py-0.5">
                      <span className="text-slate-600">Municipio: </span>
                      <span className="font-bold text-slate-800">{datosCentro.municipio}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* ========== P√ÅGINA 2: CALIFICACIONES ========== */}
            <div className="print-boletin bg-white mx-auto print-page-preview" style={{maxWidth: '100%'}}>
              {/* Header */}
              <div className="print-boletin-header flex items-center justify-between p-3 border-b-2 border-slate-300 bg-slate-50">
                <div className="flex items-center gap-3">
                  <img src="Centro_TEHUI.png" alt="Logo" className="w-12 h-auto" />
                  <div>
                    <p className="font-bold text-slate-800 text-sm">CENTRO EDUCATIVO TEHUI</p>
                    <p className="text-xs text-slate-500">Bolet√≠n de Calificaciones</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="font-bold text-slate-800 text-sm">NIVEL {actual.nivel?.toUpperCase() || 'PRIMARIO'}</p>
                  <p className="text-xs text-slate-600">A√±o Escolar {actual.periodoEscolar}</p>
                </div>
              </div>

              {/* Datos del estudiante */}
              <div className="print-estudiante-info grid grid-cols-5 gap-3 p-3 border-b border-slate-200 bg-blue-50">
                <div><span className="font-semibold text-slate-600">Matr√≠cula:</span> <span className="mono font-bold">{actual.matricula || '‚Äî'}</span></div>
                <div className="col-span-2"><span className="font-semibold text-slate-600">Estudiante:</span> <span className="font-bold">{actual.nombre}</span></div>
                <div><span className="font-semibold text-slate-600">Grado:</span> <span className="font-bold">{actual.grado}</span></div>
                <div><span className="font-semibold text-slate-600">Docente Titular:</span> <span className="font-bold">{actual.profesorTitular ? profesores.find(p => p.id === actual.profesorTitular)?.nombre || '‚Äî' : '‚Äî'}</span></div>
              </div>

              {/* Tabla de calificaciones */}
              <div className="print-tabla-container" style={{overflowX: 'auto'}}>
                <table className="print-tabla-notas w-full border-collapse" style={{fontSize: '7px', tableLayout: 'fixed'}}>
                  <thead>
                    <tr style={{backgroundColor: '#e5e7eb'}}>
                      <th rowSpan={3} className="col-asignatura border border-slate-400 p-1 text-left font-bold">ASIGNATURAS</th>
                      <th rowSpan={3} className="col-profesor border border-slate-400 p-1 font-bold">PROF.</th>
                      <th colSpan={24} className="border border-slate-400 p-1 font-bold" style={{backgroundColor: '#cbd5e1'}}>COMPETENCIAS FUNDAMENTALES</th>
                      <th colSpan={3} rowSpan={2} className="border border-slate-400 p-1 font-bold" style={{backgroundColor: '#dbeafe'}}>Prom. Comp.</th>
                      <th rowSpan={3} className="col-final border border-slate-400 p-1 font-bold" style={{backgroundColor: '#d1fae5'}}>CF</th>
                      <th rowSpan={3} className="col-rf border border-slate-400 p-1 font-bold" style={{backgroundColor: '#fef3c7'}}>RF</th>
                    </tr>
                    <tr style={{backgroundColor: '#f1f5f9'}}>
                      <th colSpan={8} className="border border-slate-400 p-1" style={{color: '#1d4ed8'}}>Comunicativa (C1)</th>
                      <th colSpan={8} className="border border-slate-400 p-1" style={{color: '#7c3aed'}}>Pensamiento L√≥gico (C2)</th>
                      <th colSpan={8} className="border border-slate-400 p-1" style={{color: '#059669'}}>√âtica y Ciudadan√≠a (C3)</th>
                    </tr>
                    <tr style={{backgroundColor: '#f8fafc', fontSize: '6px'}}>
                      {/* Generar headers P1,R,P2,R... para cada competencia */}
                      {[0,1,2].map(comp => (
                        <React.Fragment key={comp}>
                          <th className="col-nota border border-slate-400 p-0">P1</th>
                          <th className="col-rec border border-slate-400 p-0">R</th>
                          <th className="col-nota border border-slate-400 p-0">P2</th>
                          <th className="col-rec border border-slate-400 p-0">R</th>
                          <th className="col-nota border border-slate-400 p-0">P3</th>
                          <th className="col-rec border border-slate-400 p-0">R</th>
                          <th className="col-nota border border-slate-400 p-0">P4</th>
                          <th className="col-rec border border-slate-400 p-0">R</th>
                        </React.Fragment>
                      ))}
                      <th className="col-promedio border border-slate-400 p-0">C1</th>
                      <th className="col-promedio border border-slate-400 p-0">C2</th>
                      <th className="col-promedio border border-slate-400 p-0">C3</th>
                    </tr>
                  </thead>
                  <tbody>
                    {actual.materias.map((m, i) => (
                      <tr key={i} style={{backgroundColor: i % 2 === 0 ? '#ffffff' : '#f8fafc'}}>
                        <td className="col-asignatura border border-slate-400 p-1 font-medium">{m.nombre}</td>
                        <td className="col-profesor border border-slate-400 p-0 text-center">{m.profesor}</td>
                        {/* C1: Comunicativa */}
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p1.c}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p1.rc}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p2.c}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p2.rc}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p3.c}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p3.rc}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p4.c}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p4.rc}</td>
                        {/* C2: Pensamiento */}
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p1.p}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p1.rp}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p2.p}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p2.rp}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p3.p}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p3.rp}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p4.p}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p4.rp}</td>
                        {/* C3: √âtica */}
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p1.e}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p1.re}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p2.e}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p2.re}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p3.e}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p3.re}</td>
                        <td className="col-nota border border-slate-400 p-0 text-center mono">{m.p4.e}</td>
                        <td className="col-rec border border-slate-400 p-0 text-center mono">{m.p4.re}</td>
                        {/* Promedios por competencia */}
                        <td className="col-promedio border border-slate-400 p-0 text-center font-bold mono">{calcPromedioCompetencia(m, 'c')}</td>
                        <td className="col-promedio border border-slate-400 p-0 text-center font-bold mono">{calcPromedioCompetencia(m, 'p')}</td>
                        <td className="col-promedio border border-slate-400 p-0 text-center font-bold mono">{calcPromedioCompetencia(m, 'e')}</td>
                        {/* Calificaci√≥n Final y Recuperaci√≥n */}
                        <td className="col-final border border-slate-400 p-0 text-center font-bold mono">{calcCalificacionFinalArea(m)}</td>
                        <td className="col-rf border border-slate-400 p-0 text-center font-bold mono">{m.rf}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Footer: Escala, Leyenda, Asistencia - 3 columnas */}
              <div className="print-footer-section" style={{gridTemplateColumns: '1fr 1fr 1.3fr'}}>
                {/* Escala */}
                <div>
                  <p className="font-bold mb-1" style={{fontSize: '7px'}}>ESCALA DE CALIFICACIONES</p>
                  <table className="w-full border-collapse">
                    <tbody>
                      {ESCALA_NUMERICA.map((e, i) => (
                        <tr key={i}>
                          <td className="border border-slate-400 p-0.5 text-center font-bold" style={{width: '30%', fontSize: '6px'}}>{e.rango}</td>
                          <td className="border border-slate-400 p-0.5" style={{fontSize: '5.5px'}}>{e.descripcion}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* Leyenda */}
                <div>
                  <p className="font-bold mb-1" style={{fontSize: '7px'}}>LEYENDA</p>
                  <div style={{fontSize: '6px', lineHeight: '1.4'}}>
                    <p><strong>P1-P4:</strong> Per√≠odos 1 al 4</p>
                    <p><strong style={{color: '#b45309'}}>R:</strong> Calificaci√≥n de Recuperaci√≥n</p>
                    <p><strong style={{color: '#1d4ed8'}}>C1:</strong> Competencia Comunicativa</p>
                    <p><strong style={{color: '#7c3aed'}}>C2:</strong> Pensamiento L√≥gico</p>
                    <p><strong style={{color: '#059669'}}>C3:</strong> √âtica y Ciudadan√≠a</p>
                    <p><strong>CF:</strong> Calificaci√≥n Final</p>
                    <p><strong style={{color: '#b45309'}}>RF:</strong> Recuperaci√≥n Final</p>
                    <p style={{marginTop: '2px', borderTop: '1px solid #ccc', paddingTop: '2px'}}><strong style={{backgroundColor: '#fef3c7'}}>Aus.T:</strong> Ausencias Totales (3 tardanzas = 1 ausencia)</p>
                  </div>
                </div>

                {/* Asistencia */}
                <div>
                  <div className="text-center mb-1 p-1 bg-slate-100 rounded">
                    <p className="font-bold" style={{fontSize: '7px'}}>RESUMEN DE ASISTENCIA</p>
                    <p style={{fontSize: '6px', color: '#b45309', fontWeight: 'bold'}}>Seg√∫n Ordenanza 02-2016 MINERD</p>
                  </div>
                  <table className="w-full border-collapse" style={{fontSize: '6px'}}>
                    <thead>
                      <tr style={{backgroundColor: '#e5e7eb'}}>
                        <th className="border border-slate-400 p-0.5">Per.</th>
                        <th className="border border-slate-400 p-0.5">Asist.</th>
                        <th className="border border-slate-400 p-0.5">Aus.</th>
                        <th className="border border-slate-400 p-0.5">Tard.</th>
                        <th className="border border-slate-400 p-0.5" style={{backgroundColor: '#fef3c7'}}>Aus.T</th>
                        <th className="border border-slate-400 p-0.5">%Asist</th>
                        <th className="border border-slate-400 p-0.5">%Aus</th>
                      </tr>
                    </thead>
                    <tbody>
                      {['p1', 'p2', 'p3', 'p4'].map((p, i) => (
                        <tr key={p}>
                          <td className="border border-slate-400 p-0.5 text-center font-medium">P{i + 1}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono">{actual.asistencia?.[p]?.asistencia || ''}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono">{actual.asistencia?.[p]?.ausencia || ''}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono">{actual.asistencia?.[p]?.tardanza || ''}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono font-bold" style={{backgroundColor: '#fef3c7'}}>{porcentajes[p]?.ausTotal || ''}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono" style={{color: '#059669'}}>{porcentajes[p]?.asistencia || ''}</td>
                          <td className="border border-slate-400 p-0.5 text-center mono" style={{color: '#dc2626'}}>{porcentajes[p]?.ausencia || ''}</td>
                        </tr>
                      ))}
                      <tr style={{backgroundColor: '#dbeafe'}}>
                        <td className="border border-slate-400 p-0.5 text-center font-bold">Anual</td>
                        <td colSpan={3} className="border border-slate-400 p-0.5 text-center font-bold">TOTAL</td>
                        <td className="border border-slate-400 p-0.5 text-center font-bold" style={{backgroundColor: '#fef3c7'}}>{porcentajes.anual?.ausTotal || '‚Äî'}</td>
                        <td className="border border-slate-400 p-0.5 text-center font-bold" style={{color: '#059669'}}>{porcentajes.anual?.asistencia || '‚Äî'}</td>
                        <td className="border border-slate-400 p-0.5 text-center font-bold" style={{color: '#dc2626'}}>{porcentajes.anual?.ausencia || '‚Äî'}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Observaciones y Leyenda de Profesores */}
              <div className="p-2 border-t border-slate-300" style={{fontSize: '8px'}}>
                <div className="grid grid-cols-3 gap-3">
                  {/* Observaciones */}
                  <div className="col-span-2">
                    <p className="font-bold mb-2" style={{fontSize: '8px'}}>OBSERVACIONES POR PER√çODO:</p>
                    <div className="grid grid-cols-2 gap-2">
                      {['p1', 'p2', 'p3', 'p4'].map((per, idx) => (
                        <div key={per} className="border border-slate-300 p-1.5 bg-slate-50 rounded" style={{minHeight: '22px', lineHeight: '1.4'}}>
                          <span className="font-bold text-slate-700">P{idx + 1}:</span> <span style={{wordBreak: 'break-word'}}>{actual.observaciones?.[per] || '‚Äî'}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Leyenda de Profesores */}
                  <div>
                    <p className="font-bold mb-2" style={{fontSize: '8px'}}>PROFESORES (SIGLAS):</p>
                    <div className="border border-slate-300 rounded bg-purple-50 p-2" style={{fontSize: '7px', lineHeight: '1.5'}}>
                      {(() => {
                        // Obtener profesores √∫nicos usados en este bolet√≠n
                        const siglasUsadas = [...new Set(actual.materias.map(m => m.profesor).filter(Boolean))];
                        const profsUsados = profesores.filter(p => siglasUsadas.includes(p.iniciales));
                        
                        if (profsUsados.length === 0) {
                          return <p className="text-slate-400">No hay profesores asignados</p>;
                        }
                        
                        return profsUsados.map((prof, idx) => (
                          <p key={prof.id}>
                            <strong className="text-purple-700">{prof.iniciales}:</strong> {prof.nombre}
                          </p>
                        ));
                      })()}
                    </div>
                  </div>
                </div>
              </div>

              {/* Firmas - Orden: Director, Docente, Padre */}
              <div className="print-firmas-section">
                <div className="print-firma-box">
                  <div>DIRECTOR(A)</div>
                </div>
                <div className="print-firma-box">
                  <div>DOCENTE TITULAR</div>
                </div>
                <div className="print-firma-box">
                  <div>PADRE, MADRE O TUTOR(A)</div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ==================== VISTA DE GESTI√ìN DE ESTUDIANTES Y AULAS ====================
      if (vistaAulas) {
        const crearEstudianteRapido = () => {
          if (!nuevoEstNombre.trim()) {
            mostrarToast('Ingresa el nombre del estudiante', 'error');
            return;
          }
          
          const aula = aulas.find(a => a.id === nuevoEstAula);
          const id = `${STORAGE_PREFIX}${usuario}_est_${Date.now()}`;
          
          // Crear profesores por materia desde asignaciones
          const profPorMateria = {};
          const aulaName = aula?.nombre || '';
          if (aulaName) {
            profPorMateria[aulaName] = {};
            MATERIAS_DEFAULT.forEach(nombreMat => {
              const profId = asignaciones[nombreMat];
              const prof = profId ? profesores.find(p => p.id === profId) : null;
              if (prof) {
                profPorMateria[aulaName][nombreMat] = prof.iniciales || prof.nombre;
              }
            });
          }
          
          // Usar funci√≥n estandarizada para crear estudiante
          const nuevoEstudiante = crearEstudianteEstandar({
            id: id,
            matricula: nuevoEstMatricula.trim(),
            nombre: nuevoEstNombre.trim(),
            grado: aula?.grado || '1ro',
            seccion: aula?.seccion || 'A',
            nivel: aula?.nivel || 'Primario',
            aula: aulaName,
            aulaId: nuevoEstAula,
            maestraTitular: aula?.profesorTitular || aula?.maestraTitular || '',
            profPorMateria: profPorMateria
          });
          
          localStorage.setItem(id, JSON.stringify(nuevoEstudiante));
          cargarDatos(usuario);
          setNuevoEstNombre('');
          setNuevoEstMatricula('');
          mostrarToast(`Estudiante "${nuevoEstudiante.nombre}" creado${aula ? ` en ${aula.nombre}` : ''}`, 'success');
        };
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4 md:p-6">
            <div className="max-w-6xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div className="flex justify-between items-center flex-wrap gap-4">
                  <div>
                    <h1 className="text-2xl font-extrabold text-slate-800">üìö Gesti√≥n de Estudiantes y Aulas</h1>
                    <p className="text-slate-500">Crea estudiantes, aulas y as√≠gnalos en un solo lugar</p>
                  </div>
                  <button onClick={() => setVistaAulas(false)} className="bg-slate-600 text-white px-5 py-2.5 rounded-xl hover:bg-slate-700 transition-all font-medium flex items-center gap-2">
                    <span>‚Üê</span> Volver a Calificaciones
                  </button>
                </div>
                
                {/* Tabs */}
                <div className="flex gap-2 mt-6 border-b border-slate-200">
                  <button 
                    onClick={() => setTabActiva('estudiantes')}
                    className={`px-4 py-2 font-medium transition-all ${tabActiva === 'estudiantes' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    üë• Estudiantes ({estudiantes.length})
                  </button>
                  <button 
                    onClick={() => setTabActiva('aulas')}
                    className={`px-4 py-2 font-medium transition-all ${tabActiva === 'aulas' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    üè´ Aulas ({aulas.length})
                  </button>
                  <button 
                    onClick={() => setTabActiva('centro')}
                    className={`px-4 py-2 font-medium transition-all ${tabActiva === 'centro' ? 'text-orange-600 border-b-2 border-orange-600' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    üèõÔ∏è Datos del Centro
                  </button>
                </div>
              </div>

              {/* TAB: CENTRO EDUCATIVO */}
              {tabActiva === 'centro' && (
                <div className="bg-white rounded-2xl shadow-xl p-6">
                  <h2 className="text-xl font-bold text-slate-800 mb-4">üèõÔ∏è Configuraci√≥n del Centro Educativo</h2>
                  <p className="text-slate-500 mb-6">Estos datos aparecer√°n en la portada de todos los boletines</p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Nombre del Centro</label>
                      <input
                        type="text"
                        value={datosCentro.nombre}
                        onChange={e => guardarDatosCentro({...datosCentro, nombre: e.target.value})}
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">C√≥digo del Centro</label>
                      <input
                        type="text"
                        value={datosCentro.codigo}
                        onChange={e => guardarDatosCentro({...datosCentro, codigo: e.target.value})}
                        placeholder="Ej: 09-12345"
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500 font-mono"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Tanda</label>
                      <select
                        value={datosCentro.tanda}
                        onChange={e => guardarDatosCentro({...datosCentro, tanda: e.target.value})}
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      >
                        <option value="Matutina">Matutina</option>
                        <option value="Vespertina">Vespertina</option>
                        <option value="Extendida">Extendida</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Tel√©fono del Centro</label>
                      <input
                        type="text"
                        value={datosCentro.telefono}
                        onChange={e => guardarDatosCentro({...datosCentro, telefono: e.target.value})}
                        placeholder="Ej: 809-555-1234"
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Distrito Educativo</label>
                      <input
                        type="text"
                        value={datosCentro.distrito}
                        onChange={e => guardarDatosCentro({...datosCentro, distrito: e.target.value})}
                        placeholder="Ej: 09-05"
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Regional de Educaci√≥n</label>
                      <input
                        type="text"
                        value={datosCentro.regional}
                        onChange={e => guardarDatosCentro({...datosCentro, regional: e.target.value})}
                        placeholder="Ej: 09 - Santiago"
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Provincia</label>
                      <input
                        type="text"
                        value={datosCentro.provincia}
                        onChange={e => guardarDatosCentro({...datosCentro, provincia: e.target.value})}
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-600 mb-1">Municipio</label>
                      <input
                        type="text"
                        value={datosCentro.municipio}
                        onChange={e => guardarDatosCentro({...datosCentro, municipio: e.target.value})}
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-orange-500"
                      />
                    </div>
                  </div>
                  
                  <div className="mt-6 p-4 bg-orange-50 rounded-xl border border-orange-200">
                    <p className="text-sm text-orange-700">
                      üí° <strong>Nota:</strong> Estos datos se guardan autom√°ticamente y se mostrar√°n en la portada de los boletines de todos los estudiantes.
                    </p>
                  </div>
                </div>
              )}

              {/* TAB: ESTUDIANTES */}
              {tabActiva === 'estudiantes' && (
                <div className="space-y-6">
                  {/* Formulario para crear estudiante */}
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-xl font-bold text-slate-800 mb-4">‚ûï Crear Nuevo Estudiante</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Nombre Completo *</label>
                        <input
                          type="text"
                          value={nuevoEstNombre}
                          onChange={e => setNuevoEstNombre(e.target.value)}
                          placeholder="Ej: Juan P√©rez Garc√≠a"
                          className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Matr√≠cula</label>
                        <input
                          type="text"
                          value={nuevoEstMatricula}
                          onChange={e => setNuevoEstMatricula(e.target.value)}
                          placeholder="Ej: 2025-001"
                          className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500 font-mono"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Asignar a Aula</label>
                        <select
                          value={nuevoEstAula}
                          onChange={e => setNuevoEstAula(e.target.value)}
                          className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500"
                        >
                          <option value="">‚Äî Sin aula (asignar despu√©s) ‚Äî</option>
                          {aulas.map(a => {
                            const prof = profesores.find(p => p.id === a.profesorTitular);
                            return (
                              <option key={a.id} value={a.id}>
                                {a.nombre} {prof ? `(${prof.iniciales})` : ''}
                              </option>
                            );
                          })}
                        </select>
                      </div>
                      <div className="flex items-end">
                        <button
                          onClick={crearEstudianteRapido}
                          className="w-full bg-emerald-600 text-white py-2 px-4 rounded-lg hover:bg-emerald-700 font-bold transition-all flex items-center justify-center gap-2"
                        >
                          <span>+</span> Crear Estudiante
                        </button>
                      </div>
                    </div>
                    {aulas.length === 0 && (
                      <p className="text-amber-600 text-sm mt-3">
                        üí° Tip: Crea aulas primero en la pesta√±a "Aulas" para poder asignar estudiantes directamente
                      </p>
                    )}
                  </div>

                  {/* Lista de estudiantes con asignaci√≥n */}
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-slate-800">üìã Lista de Estudiantes</h2>
                      <div className="text-sm text-slate-500">
                        <span className="text-emerald-600 font-bold">{estudiantes.filter(e => e.aulaId).length}</span> asignados | 
                        <span className="text-amber-600 font-bold ml-1">{estudiantes.filter(e => !e.aulaId).length}</span> sin aula
                      </div>
                    </div>
                    
                    {estudiantes.length === 0 ? (
                      <div className="text-center py-12 text-slate-400">
                        <p className="text-4xl mb-3">üë•</p>
                        <p>No hay estudiantes registrados</p>
                        <p className="text-sm mt-1">Usa el formulario de arriba para crear el primero</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {estudiantes.map((est, idx) => {
                          const aulaEst = aulas.find(a => a.id === est.aulaId);
                          const profTitular = est.profesorTitular ? profesores.find(p => p.id === est.profesorTitular) : null;
                          return (
                            <details key={est.id} className="border border-slate-200 rounded-xl overflow-hidden group">
                              <summary className={`p-4 cursor-pointer hover:bg-slate-50 flex items-center justify-between ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`}>
                                <div className="flex items-center gap-4">
                                  <span className="text-slate-400 font-mono text-sm w-6">{idx + 1}</span>
                                  <div>
                                    <p className="font-semibold text-slate-800">{est.nombre || 'Sin nombre'}</p>
                                    <p className="text-xs text-slate-500">
                                      {aulaEst ? `${aulaEst.nombre} - ${est.grado} de ${est.nivel === 'Primario' ? 'Primaria' : est.nivel}` : 'Sin aula asignada'}
                                      {est.idSigerd && ` ‚Ä¢ ID: ${est.idSigerd}`}
                                    </p>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3">
                                  {est.aulaId ? (
                                    <span className="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded-full">Asignado</span>
                                  ) : (
                                    <span className="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full">Sin aula</span>
                                  )}
                                  <span className="text-slate-400 group-open:rotate-180 transition-transform">‚ñº</span>
                                </div>
                              </summary>
                              
                              <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                  {/* Nombre */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Nombre Completo</label>
                                    <input
                                      type="text"
                                      value={est.nombre || ''}
                                      onChange={(e) => {
                                        const estActualizado = {...est, nombre: e.target.value};
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                      }}
                                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500"
                                    />
                                  </div>
                                  
                                  {/* ID SIGERD */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">ID SIGERD</label>
                                    <input
                                      type="text"
                                      value={est.idSigerd || ''}
                                      onChange={(e) => {
                                        const estActualizado = {...est, idSigerd: e.target.value};
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                      }}
                                      placeholder="N√∫mero de identificaci√≥n"
                                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm font-mono focus:border-indigo-500"
                                    />
                                  </div>
                                  
                                  {/* Matr√≠cula */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Matr√≠cula Interna</label>
                                    <input
                                      type="text"
                                      value={est.matricula || ''}
                                      onChange={(e) => {
                                        const estActualizado = {...est, matricula: e.target.value};
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                      }}
                                      placeholder="Ej: 2025-001"
                                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm font-mono focus:border-indigo-500"
                                    />
                                  </div>
                                  
                                  {/* N√∫mero de Orden */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">N√∫mero de Orden</label>
                                    <input
                                      type="text"
                                      value={est.numeroOrden || ''}
                                      onChange={(e) => {
                                        const estActualizado = {...est, numeroOrden: e.target.value};
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                      }}
                                      placeholder="Ej: 1, 2, 3..."
                                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-center focus:border-indigo-500"
                                    />
                                  </div>
                                  
                                  {/* Aula */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Aula Asignada</label>
                                    <select
                                      value={est.aulaId || ''}
                                      onChange={(e) => {
                                        const aulaId = e.target.value;
                                        const aula = aulas.find(a => a.id === aulaId);
                                        const estActualizado = {
                                          ...est,
                                          aulaId: aulaId,
                                          grado: aula?.grado || est.grado,
                                          nivel: aula?.nivel || est.nivel,
                                          profesorTitular: aula?.profesorTitular || ''
                                        };
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                        mostrarToast(aulaId ? `Asignado a ${aula?.nombre}` : 'Removido del aula', 'success');
                                      }}
                                      className={`w-full border-2 rounded-lg px-3 py-2 text-sm ${est.aulaId ? 'border-emerald-300 bg-emerald-50' : 'border-amber-300 bg-amber-50'}`}
                                    >
                                      <option value="">‚Äî Sin aula ‚Äî</option>
                                      {aulas.map(a => <option key={a.id} value={a.id}>{a.nombre}</option>)}
                                    </select>
                                  </div>
                                  
                                  {/* Per√≠odo Escolar */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Per√≠odo Escolar</label>
                                    <input
                                      type="text"
                                      value={est.periodoEscolar || ''}
                                      onChange={(e) => {
                                        const estActualizado = {...est, periodoEscolar: e.target.value};
                                        localStorage.setItem(est.id, JSON.stringify(estActualizado));
                                        cargarDatos(usuario);
                                      }}
                                      placeholder="Ej: 2025-2026"
                                      className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500"
                                    />
                                  </div>
                                  
                                  {/* Profesor Titular */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Profesor Titular</label>
                                    <p className="px-3 py-2 bg-slate-100 rounded-lg text-sm text-slate-600">
                                      {profTitular ? profTitular.nombre : '‚Äî Asignar aula primero ‚Äî'}
                                    </p>
                                  </div>
                                  
                                  {/* Grado/Nivel */}
                                  <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">Grado / Nivel</label>
                                    <p className="px-3 py-2 bg-slate-100 rounded-lg text-sm text-slate-600">
                                      {est.grado ? `${est.grado} de ${est.nivel === 'Primario' ? 'Primaria' : est.nivel}` : '‚Äî Asignar aula ‚Äî'}
                                    </p>
                                  </div>
                                </div>
                                
                                {/* Bot√≥n eliminar */}
                                <div className="mt-4 pt-4 border-t border-slate-200 flex justify-end">
                                  <button
                                    onClick={() => eliminarEstudiante(est.id)}
                                    className="text-red-600 hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg transition-all text-sm font-medium flex items-center gap-2"
                                  >
                                    üóëÔ∏è Eliminar Estudiante
                                  </button>
                                </div>
                              </div>
                            </details>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* TAB: AULAS */}
              {tabActiva === 'aulas' && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Crear aula */}
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-xl font-bold text-slate-800 mb-4">‚ûï Crear Nueva Aula</h2>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      const grado = formData.get('grado');
                      const seccion = formData.get('seccion');
                      const profesor = formData.get('profesor');
                      const nivel = formData.get('nivel');
                      
                      if (!grado || !seccion) {
                        mostrarToast('Selecciona grado y secci√≥n', 'error');
                        return;
                      }
                      
                      const existe = aulas.some(a => a.grado === grado && a.seccion === seccion.toUpperCase());
                      if (existe) {
                        mostrarToast('Esta aula ya existe', 'error');
                        return;
                      }
                      
                      agregarAula(grado, seccion, profesor, nivel);
                      e.target.reset();
                    }} className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Nivel</label>
                        <select name="nivel" className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500">
                          {NIVELES.map(n => <option key={n} value={n}>{n}</option>)}
                        </select>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-slate-600 mb-1">Grado *</label>
                          <select name="grado" required className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500">
                            <option value="">Seleccionar...</option>
                            {GRADOS_PRIMARIO.map(g => <option key={g} value={g}>{g}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-600 mb-1">Secci√≥n *</label>
                          <select name="seccion" required className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500">
                            <option value="">Seleccionar...</option>
                            {['A', 'B', 'C', 'D', 'E', 'F'].map(s => <option key={s} value={s}>{s}</option>)}
                          </select>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-600 mb-1">Profesor/a Titular</label>
                        <select name="profesor" className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-indigo-500">
                          <option value="">‚Äî Sin asignar ‚Äî</option>
                          {profesores.map(p => <option key={p.id} value={p.id}>{p.nombre} ({p.iniciales})</option>)}
                        </select>
                        {profesores.length === 0 && (
                          <p className="text-xs text-amber-600 mt-1">üí° Agrega profesores en el bot√≥n "Profesores"</p>
                        )}
                      </div>
                      <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold transition-all">
                        + Crear Aula
                      </button>
                    </form>
                  </div>

                  {/* Lista de aulas */}
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-xl font-bold text-slate-800 mb-4">üìã Aulas Creadas</h2>
                    {aulas.length === 0 ? (
                      <div className="text-center py-12 text-slate-400">
                        <p className="text-4xl mb-3">üè´</p>
                        <p>No hay aulas creadas</p>
                      </div>
                    ) : (
                      <div className="space-y-3 max-h-[400px] overflow-y-auto">
                        {aulas.map(aula => {
                          const prof = profesores.find(p => p.id === aula.profesorTitular);
                          const estudiantesAula = estudiantes.filter(e => e.aulaId === aula.id);
                          return (
                            <div key={aula.id} className="border-2 border-slate-200 rounded-xl p-4 hover:border-indigo-300 transition-all">
                              <div className="flex justify-between items-start">
                                <div className="flex-1">
                                  <p className="font-bold text-lg text-indigo-700">{aula.nombre}</p>
                                  <p className="text-sm text-slate-500">{aula.nivel}</p>
                                  {prof ? (
                                    <p className="text-sm text-slate-600 mt-1">üë®‚Äçüè´ {prof.nombre} ({prof.iniciales})</p>
                                  ) : (
                                    <p className="text-sm text-amber-500 mt-1">‚ö†Ô∏è Sin profesor</p>
                                  )}
                                  <p className="text-xs text-emerald-600 font-medium mt-2">
                                    üë• {estudiantesAula.length} estudiante{estudiantesAula.length !== 1 ? 's' : ''}
                                  </p>
                                </div>
                                <button onClick={() => eliminarAula(aula.id)} className="text-red-500 hover:text-red-700 p-2 rounded-lg">
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
            
            <Modal {...modal} onClose={() => setModal(m => ({ ...m, isOpen: false }))} />
            <Toast {...toast} onClose={() => setToast(t => ({ ...t, isVisible: false }))} />
          </div>
        );
      }
      
      // ==================== VISTA DE PANEL DE ADMINISTRADOR ====================
      if (vistaAdmin) {
        const session = leerSeguro('session');
        const esAdmin = session?.microsoft && esAdministrador(session.email);
        
        // Funci√≥n para cargar maestras
        const cargarMaestras = async () => {
          setCargandoAdmin(true);
          try {
            const carpetas = await leerCarpetaCompartida();
            setMaestrasDisponibles(carpetas.filter(c => c.folder));
          } catch (e) {
            console.error('Error cargando maestras:', e);
          }
          setCargandoAdmin(false);
        };
        
        // Funci√≥n para cargar estudiantes de una maestra
        const cargarEstudiantesDeMaestra = async (carpeta) => {
          setCargandoAdmin(true);
          setMaestraSeleccionada(carpeta);
          try {
            const estudiantes = await leerEstudiantesDeMaestra(carpeta);
            setEstudiantesAdmin(estudiantes);
          } catch (e) {
            console.error('Error cargando estudiantes:', e);
          }
          setCargandoAdmin(false);
        };
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4 md:p-6">
            <div className="max-w-6xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h1 className="text-2xl font-extrabold text-slate-800 flex items-center gap-3">
                      <span className="text-3xl">üëë</span> Panel de Administraci√≥n
                    </h1>
                    <p className="text-slate-500">Accede a todos los datos de las maestras</p>
                  </div>
                  <button onClick={() => setVistaAdmin(false)} className="bg-slate-600 text-white px-5 py-2.5 rounded-xl hover:bg-slate-700 transition-all font-medium flex items-center gap-2">
                    <span>‚Üê</span> Volver
                  </button>
                </div>
              </div>
              
              {!esAdmin ? (
                <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                  <div className="w-20 h-20 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span className="text-4xl">üö´</span>
                  </div>
                  <h2 className="text-xl font-bold text-red-600 mb-2">Acceso Denegado</h2>
                  <p className="text-slate-600 mb-4">Solo los administradores pueden acceder a este panel.</p>
                  <p className="text-sm text-slate-400">Tu cuenta: {session?.email || 'No identificada'}</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  {/* Lista de Maestras */}
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                      <span>üë©‚Äçüè´</span> Maestras
                    </h2>
                    
                    <button 
                      onClick={cargarMaestras}
                      className="w-full bg-blue-600 text-white py-2.5 rounded-xl hover:bg-blue-700 transition-all font-medium mb-4"
                    >
                      {cargandoAdmin ? '‚è≥ Cargando...' : 'üîÑ Cargar Maestras'}
                    </button>
                    
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {maestrasDisponibles.length === 0 ? (
                        <p className="text-slate-400 text-center py-4">Haz clic en "Cargar Maestras" para ver la lista</p>
                      ) : (
                        maestrasDisponibles.map((maestra, idx) => (
                          <button
                            key={idx}
                            onClick={() => cargarEstudiantesDeMaestra(maestra.name)}
                            className={`w-full text-left p-3 rounded-xl transition-all ${
                              maestraSeleccionada === maestra.name 
                                ? 'bg-blue-100 border-2 border-blue-500' 
                                : 'bg-slate-50 hover:bg-slate-100 border-2 border-transparent'
                            }`}
                          >
                            <p className="font-medium text-slate-800">{maestra.name}</p>
                            <p className="text-xs text-slate-400">Carpeta de datos</p>
                          </button>
                        ))
                      )}
                    </div>
                  </div>
                  
                  {/* Lista de Estudiantes */}
                  <div className="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                      <span>üë®‚Äçüéì</span> Estudiantes 
                      {maestraSeleccionada && <span className="text-blue-600">de {maestraSeleccionada}</span>}
                    </h2>
                    
                    {cargandoAdmin ? (
                      <div className="text-center py-8">
                        <div className="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p className="text-slate-500">Cargando estudiantes...</p>
                      </div>
                    ) : estudiantesAdmin.length === 0 ? (
                      <div className="text-center py-8">
                        <span className="text-4xl">üìÇ</span>
                        <p className="text-slate-400 mt-2">Selecciona una maestra para ver sus estudiantes</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead>
                            <tr className="bg-slate-100">
                              <th className="text-left p-3 rounded-tl-xl font-semibold text-slate-600">Nombre</th>
                              <th className="text-center p-3 font-semibold text-slate-600">Grado</th>
                              <th className="text-center p-3 font-semibold text-slate-600">Secci√≥n</th>
                              <th className="text-center p-3 rounded-tr-xl font-semibold text-slate-600">Matr√≠cula</th>
                            </tr>
                          </thead>
                          <tbody>
                            {estudiantesAdmin.map((est, idx) => (
                              <tr key={idx} className="border-b border-slate-100 hover:bg-slate-50">
                                <td className="p-3 font-medium text-slate-800">{est.nombre || 'Sin nombre'}</td>
                                <td className="p-3 text-center">{est.grado}</td>
                                <td className="p-3 text-center">{est.seccion || '-'}</td>
                                <td className="p-3 text-center font-mono text-sm">{est.matricula || '-'}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        <p className="text-sm text-slate-400 mt-4 text-center">
                          Total: {estudiantesAdmin.length} estudiantes
                        </p>
                      </div>
                    )}
                  </div>
                  
                  {/* Herramientas de Mantenimiento */}
                  <div className="lg:col-span-3 bg-white rounded-2xl shadow-xl p-6 mt-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                      <span>üîß</span> Herramientas de Mantenimiento
                    </h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      {/* Validar Datos */}
                      <div className="bg-blue-50 rounded-xl p-4">
                        <h3 className="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                          <span>üîç</span> Validar Datos
                        </h3>
                        <p className="text-sm text-blue-600 mb-3">
                          Revisa y corrige campos faltantes o inv√°lidos.
                        </p>
                        <button 
                          onClick={() => {
                            const { totalCorregidos, totalErrores, resumen } = validarTodosLosEstudiantes(usuario);
                            cargarDatos(usuario);
                            mostrarToast(
                              `‚úÖ Validaci√≥n completada:\n‚Ä¢ ${totalCorregidos} estudiantes corregidos\n‚Ä¢ ${totalErrores} errores encontrados`,
                              totalErrores > 0 ? 'warning' : 'success'
                            );
                          }}
                          className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all font-medium"
                        >
                          Ejecutar Validaci√≥n
                        </button>
                      </div>
                      
                      {/* Reparar Datos */}
                      <div className="bg-amber-50 rounded-xl p-4">
                        <h3 className="font-semibold text-amber-800 mb-2 flex items-center gap-2">
                          <span>üîß</span> Reparar Datos
                        </h3>
                        <p className="text-sm text-amber-600 mb-3">
                          Elimina registros corruptos e irrecuperables.
                        </p>
                        <button 
                          onClick={() => {
                            mostrarModal(
                              'Reparar Datos',
                              '¬øEst√° seguro de ejecutar la reparaci√≥n? Esto eliminar√° registros irrecuperables.',
                              'confirm',
                              () => {
                                const { reparados, eliminados } = repararDatosCorruptos(usuario);
                                cargarDatos(usuario);
                                mostrarToast(
                                  `üîß Reparaci√≥n completada:\n‚Ä¢ ${reparados} reparados\n‚Ä¢ ${eliminados} eliminados`,
                                  'success'
                                );
                              }
                            );
                          }}
                          className="w-full bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition-all font-medium"
                        >
                          Ejecutar Reparaci√≥n
                        </button>
                      </div>
                      
                      {/* Asignar Materias */}
                      <div className="bg-emerald-50 rounded-xl p-4">
                        <h3 className="font-semibold text-emerald-800 mb-2 flex items-center gap-2">
                          <span>üìö</span> Asignar Materias
                        </h3>
                        <p className="text-sm text-emerald-600 mb-3">
                          Crea las 10 materias para estudiantes sin ellas.
                        </p>
                        <button 
                          onClick={() => {
                            const aulasData = leerSeguro(`${STORAGE_PREFIX}${usuario}_aulas`) || [];
                            let asignados = 0;
                            
                            estudiantes.forEach(est => {
                              if (!est.materias || est.materias.length === 0) {
                                const { corregido, modificado } = validarYCorregirEstudiante(est, aulasData);
                                if (modificado) {
                                  localStorage.setItem(est.id, JSON.stringify(corregido));
                                  asignados++;
                                }
                              }
                            });
                            
                            cargarDatos(usuario);
                            mostrarToast(`üìö ${asignados} estudiantes actualizados con materias`, 'success');
                          }}
                          className="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700 transition-all font-medium"
                        >
                          Asignar Materias
                        </button>
                      </div>
                      
                      {/* NUEVO: Asignar Aulas */}
                      <div className="bg-indigo-50 rounded-xl p-4">
                        <h3 className="font-semibold text-indigo-800 mb-2 flex items-center gap-2">
                          <span>üè´</span> Asignar Aulas
                        </h3>
                        <p className="text-sm text-indigo-600 mb-3">
                          Asigna aulaId a estudiantes seg√∫n su grado/secci√≥n.
                        </p>
                        <button 
                          onClick={() => {
                            const aulasData = leerSeguro(`${STORAGE_PREFIX}${usuario}_aulas`) || [];
                            let asignados = 0;
                            let aulasCreadas = 0;
                            
                            // Crear mapa de aulas por nombre
                            const aulasMap = new Map();
                            aulasData.forEach(a => aulasMap.set(a.nombre, a));
                            
                            // Procesar estudiantes sin aulaId
                            estudiantes.forEach(est => {
                              if (!est.aulaId) {
                                // Determinar nombre del aula
                                let nombreAula = est.aula;
                                if (!nombreAula && est.grado && est.seccion) {
                                  nombreAula = est.grado + ' ' + est.seccion;
                                }
                                
                                if (nombreAula) {
                                  // Buscar o crear aula
                                  let aula = aulasMap.get(nombreAula);
                                  
                                  if (!aula) {
                                    // Crear aula nueva
                                    aula = {
                                      id: 'aula_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                                      nombre: nombreAula,
                                      grado: est.grado || nombreAula.split(' ')[0] || '1ro',
                                      seccion: est.seccion || nombreAula.split(' ')[1] || 'A',
                                      nivel: est.nivel || 'Primario',
                                      maestraTitular: est.maestraTitular || ''
                                    };
                                    aulasMap.set(nombreAula, aula);
                                    aulasCreadas++;
                                  }
                                  
                                  // Asignar aulaId al estudiante
                                  est.aulaId = aula.id;
                                  est.aula = nombreAula;
                                  localStorage.setItem(est.id, JSON.stringify(est));
                                  asignados++;
                                }
                              }
                            });
                            
                            // Guardar aulas si se crearon nuevas
                            if (aulasCreadas > 0) {
                              const aulasFinales = Array.from(aulasMap.values());
                              guardarSeguro(`${STORAGE_PREFIX}${usuario}_aulas`, aulasFinales);
                              cargarAulas(usuario);
                            }
                            
                            cargarDatos(usuario);
                            mostrarToast(`üè´ Asignaci√≥n completada:\n‚Ä¢ ${asignados} estudiantes con aula asignada\n‚Ä¢ ${aulasCreadas} aulas creadas`, 'success');
                          }}
                          className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-all font-medium"
                        >
                          Asignar Aulas
                        </button>
                      </div>
                    </div>
                    
                    {/* Segunda fila de herramientas */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                      {/* Sincronizar Profesores */}
                      <div className="bg-purple-50 rounded-xl p-4">
                        <h3 className="font-semibold text-purple-800 mb-2 flex items-center gap-2">
                          <span>üë®‚Äçüè´</span> Sincronizar Profesores
                        </h3>
                        <p className="text-sm text-purple-600 mb-3">
                          Actualiza profesores en materias seg√∫n aula asignada.
                        </p>
                        <button 
                          onClick={() => {
                            const aulasData = leerSeguro(`${STORAGE_PREFIX}${usuario}_aulas`) || [];
                            let actualizados = 0;
                            
                            estudiantes.forEach(est => {
                              if (est.aulaId && est.materias) {
                                const aula = aulasData.find(a => a.id === est.aulaId);
                                if (aula && aula.maestraTitular) {
                                  let modificado = false;
                                  
                                  // Asignar maestra titular a materias base
                                  const materiasBase = ['Lengua Espa√±ola', 'Matem√°tica', 'Ciencias Sociales', 'Ciencias de la Naturaleza'];
                                  est.materias.forEach(mat => {
                                    if (materiasBase.includes(mat.nombre) && !mat.profesor) {
                                      mat.profesor = aula.maestraTitular;
                                      modificado = true;
                                    }
                                  });
                                  
                                  if (!est.maestraTitular) {
                                    est.maestraTitular = aula.maestraTitular;
                                    modificado = true;
                                  }
                                  
                                  if (modificado) {
                                    localStorage.setItem(est.id, JSON.stringify(est));
                                    actualizados++;
                                  }
                                }
                              }
                            });
                            
                            cargarDatos(usuario);
                            mostrarToast(`üë®‚Äçüè´ ${actualizados} estudiantes con profesores actualizados`, 'success');
                          }}
                          className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-all font-medium"
                        >
                          Sincronizar
                        </button>
                      </div>
                      
                      {/* Limpiar Duplicados */}
                      <div className="bg-rose-50 rounded-xl p-4">
                        <h3 className="font-semibold text-rose-800 mb-2 flex items-center gap-2">
                          <span>üßπ</span> Limpiar Duplicados
                        </h3>
                        <p className="text-sm text-rose-600 mb-3">
                          Elimina estudiantes duplicados por nombre.
                        </p>
                        <button 
                          onClick={() => {
                            mostrarModal(
                              'Limpiar Duplicados',
                              '¬øEliminar estudiantes con nombre duplicado? Se mantendr√° el que tenga m√°s datos.',
                              'confirm',
                              () => {
                                const nombreMap = new Map();
                                let eliminados = 0;
                                
                                // Agrupar por nombre normalizado
                                estudiantes.forEach(est => {
                                  const nombreNorm = (est.nombre || '').toUpperCase().trim();
                                  if (!nombreMap.has(nombreNorm)) {
                                    nombreMap.set(nombreNorm, []);
                                  }
                                  nombreMap.get(nombreNorm).push(est);
                                });
                                
                                // Procesar duplicados
                                nombreMap.forEach((lista, nombre) => {
                                  if (lista.length > 1) {
                                    // Ordenar por cantidad de datos (el m√°s completo primero)
                                    lista.sort((a, b) => {
                                      const datosA = (a.materias?.length || 0) + (a.aulaId ? 1 : 0) + (a.matricula ? 1 : 0);
                                      const datosB = (b.materias?.length || 0) + (b.aulaId ? 1 : 0) + (b.matricula ? 1 : 0);
                                      return datosB - datosA;
                                    });
                                    
                                    // Eliminar todos excepto el primero
                                    for (let i = 1; i < lista.length; i++) {
                                      localStorage.removeItem(lista[i].id);
                                      eliminados++;
                                    }
                                  }
                                });
                                
                                cargarDatos(usuario);
                                mostrarToast(`üßπ ${eliminados} duplicados eliminados`, 'success');
                              }
                            );
                          }}
                          className="w-full bg-rose-600 text-white py-2 rounded-lg hover:bg-rose-700 transition-all font-medium"
                        >
                          Limpiar
                        </button>
                      </div>
                      
                      {/* Exportar Respaldo */}
                      <div className="bg-cyan-50 rounded-xl p-4">
                        <h3 className="font-semibold text-cyan-800 mb-2 flex items-center gap-2">
                          <span>üíæ</span> Respaldo Completo
                        </h3>
                        <p className="text-sm text-cyan-600 mb-3">
                          Descarga respaldo de todos los datos del sistema.
                        </p>
                        <button 
                          onClick={() => {
                            const respaldo = {
                              fecha: new Date().toISOString(),
                              version: '3.0',
                              usuario: usuario,
                              estudiantes: estudiantes,
                              profesores: profesores,
                              aulas: aulas,
                              datosCentro: datosCentro
                            };
                            
                            const blob = new Blob([JSON.stringify(respaldo, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `respaldo_tehui_${new Date().toISOString().split('T')[0]}.json`;
                            a.click();
                            URL.revokeObjectURL(url);
                            
                            mostrarToast('üíæ Respaldo descargado exitosamente', 'success');
                          }}
                          className="w-full bg-cyan-600 text-white py-2 rounded-lg hover:bg-cyan-700 transition-all font-medium"
                        >
                          Descargar
                        </button>
                      </div>
                      
                      {/* Reparaci√≥n Completa */}
                      <div className="bg-slate-100 rounded-xl p-4 border-2 border-dashed border-slate-300">
                        <h3 className="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                          <span>‚ö°</span> Reparaci√≥n Completa
                        </h3>
                        <p className="text-sm text-slate-600 mb-3">
                          Ejecuta todas las reparaciones autom√°ticamente.
                        </p>
                        <button 
                          onClick={() => {
                            mostrarModal(
                              'Reparaci√≥n Completa',
                              '¬øEjecutar todas las herramientas de reparaci√≥n?\n\n1. Validar datos\n2. Asignar aulas\n3. Asignar materias\n4. Sincronizar profesores',
                              'confirm',
                              () => {
                                let resumen = [];
                                
                                // 1. Validar datos
                                const { totalCorregidos } = validarTodosLosEstudiantes(usuario);
                                resumen.push(`‚Ä¢ ${totalCorregidos} datos corregidos`);
                                
                                // 2. Asignar aulas
                                const aulasData = leerSeguro(`${STORAGE_PREFIX}${usuario}_aulas`) || [];
                                const aulasMap = new Map();
                                aulasData.forEach(a => aulasMap.set(a.nombre, a));
                                
                                let aulasAsignadas = 0;
                                estudiantes.forEach(est => {
                                  if (!est.aulaId) {
                                    const nombreAula = est.aula || (est.grado + ' ' + est.seccion);
                                    let aula = aulasMap.get(nombreAula);
                                    if (!aula) {
                                      aula = {
                                        id: 'aula_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                                        nombre: nombreAula,
                                        grado: est.grado || '1ro',
                                        seccion: est.seccion || 'A',
                                        nivel: est.nivel || 'Primario',
                                        maestraTitular: est.maestraTitular || ''
                                      };
                                      aulasMap.set(nombreAula, aula);
                                    }
                                    est.aulaId = aula.id;
                                    est.aula = nombreAula;
                                    localStorage.setItem(est.id, JSON.stringify(est));
                                    aulasAsignadas++;
                                  }
                                });
                                resumen.push(`‚Ä¢ ${aulasAsignadas} aulas asignadas`);
                                
                                // Guardar aulas
                                guardarSeguro(`${STORAGE_PREFIX}${usuario}_aulas`, Array.from(aulasMap.values()));
                                
                                // 3 y 4 se hacen con cargarDatos que normaliza
                                cargarDatos(usuario);
                                cargarAulas(usuario);
                                
                                mostrarToast(`‚ö° Reparaci√≥n completa:\n${resumen.join('\n')}`, 'success');
                              }
                            );
                          }}
                          className="w-full bg-slate-700 text-white py-2 rounded-lg hover:bg-slate-800 transition-all font-medium"
                        >
                          Ejecutar Todo
                        </button>
                      </div>
                    </div>
                    
                    {/* Estad√≠sticas */}
                    <div className="mt-6 p-4 bg-slate-50 rounded-xl">
                      <h3 className="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                        <span>üìä</span> Estad√≠sticas del Sistema
                      </h3>
                      <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-2xl font-bold text-blue-600">{estudiantes.length}</p>
                          <p className="text-sm text-slate-500">Estudiantes</p>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-2xl font-bold text-purple-600">{profesores.length}</p>
                          <p className="text-sm text-slate-500">Profesores</p>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-2xl font-bold text-emerald-600">{aulas.length}</p>
                          <p className="text-sm text-slate-500">Aulas</p>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-2xl font-bold text-indigo-600">
                            {estudiantes.filter(e => e.aulaId).length}
                          </p>
                          <p className="text-sm text-slate-500">Con Aula</p>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-2xl font-bold text-amber-600">
                            {estudiantes.filter(e => e.materias && e.materias.length > 0).length}
                          </p>
                          <p className="text-sm text-slate-500">Con Materias</p>
                        </div>
                      </div>
                      
                      {/* Alertas de problemas */}
                      {(estudiantes.filter(e => !e.aulaId).length > 0 || estudiantes.filter(e => !e.materias || e.materias.length === 0).length > 0) && (
                        <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <p className="text-sm font-medium text-amber-800 flex items-center gap-2">
                            <span>‚ö†Ô∏è</span> Problemas detectados:
                          </p>
                          <ul className="text-sm text-amber-700 mt-2 space-y-1">
                            {estudiantes.filter(e => !e.aulaId).length > 0 && (
                              <li>‚Ä¢ {estudiantes.filter(e => !e.aulaId).length} estudiantes sin aula asignada</li>
                            )}
                            {estudiantes.filter(e => !e.materias || e.materias.length === 0).length > 0 && (
                              <li>‚Ä¢ {estudiantes.filter(e => !e.materias || e.materias.length === 0).length} estudiantes sin materias</li>
                            )}
                          </ul>
                          <p className="text-xs text-amber-600 mt-2">Use "Reparaci√≥n Completa" para solucionar autom√°ticamente.</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <Modal {...modal} onClose={() => setModal(m => ({ ...m, isOpen: false }))} />
            <Toast {...toast} onClose={() => setToast(t => ({ ...t, isVisible: false }))} />
          </div>
        );
      }
      
      // ==================== VISTA DE CONFIGURACI√ìN DE PROFESORES ====================
      if (vistaConfig) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4 md:p-6">
            <div className="max-w-4xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h1 className="text-2xl font-extrabold text-slate-800">Gesti√≥n de Profesores</h1>
                    <p className="text-slate-500">Configura los profesores y as√≠gnalos a las materias</p>
                  </div>
                  <button onClick={() => setVistaConfig(false)} className="bg-slate-600 text-white px-5 py-2.5 rounded-xl hover:bg-slate-700 transition-all font-medium flex items-center gap-2">
                    <span>‚Üê</span> Volver
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Panel de Profesores */}
                <div className="bg-white rounded-2xl shadow-xl p-6">
                  <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span>üë®‚Äçüè´</span> Lista de Profesores
                  </h2>
                  
                  {/* Formulario para agregar */}
                  <div className="bg-slate-50 rounded-xl p-4 mb-4">
                    <h3 className="font-semibold text-slate-700 mb-3">Agregar Profesor</h3>
                    <div className="space-y-3">
                      <input
                        type="text"
                        value={nuevoProfNombre}
                        onChange={(e) => setNuevoProfNombre(e.target.value)}
                        placeholder="Nombre completo del profesor"
                        className="w-full border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all"
                      />
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={nuevoProfIniciales}
                          onChange={(e) => setNuevoProfIniciales(e.target.value.toUpperCase())}
                          placeholder="Iniciales (ej: JPS)"
                          maxLength="4"
                          className="w-32 border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all uppercase"
                        />
                        <button
                          onClick={agregarProfesor}
                          className="flex-1 bg-purple-600 text-white rounded-lg py-2 hover:bg-purple-700 transition-all font-medium"
                        >
                          + Agregar
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  {/* Lista de profesores */}
                  <div className="space-y-2 max-h-80 overflow-y-auto">
                    {profesores.length === 0 ? (
                      <p className="text-slate-400 text-center py-8">No hay profesores registrados</p>
                    ) : (
                      profesores.map(prof => (
                        <div key={prof.id} className="bg-slate-50 rounded-lg p-3 hover:bg-slate-100 transition-all">
                          {editandoProfesor === prof.id ? (
                            /* Modo edici√≥n */
                            <div className="space-y-2">
                              <input
                                type="text"
                                value={editNombre}
                                onChange={(e) => setEditNombre(e.target.value)}
                                placeholder="Nombre completo"
                                className="w-full border-2 border-purple-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20"
                                autoFocus
                              />
                              <div className="flex gap-2">
                                <input
                                  type="text"
                                  value={editIniciales}
                                  onChange={(e) => setEditIniciales(e.target.value.toUpperCase())}
                                  placeholder="Iniciales"
                                  maxLength="4"
                                  className="w-20 border-2 border-purple-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 uppercase"
                                />
                                <button
                                  onClick={guardarEdicion}
                                  className="flex-1 bg-green-600 text-white rounded-lg py-2 text-sm hover:bg-green-700 transition-all"
                                >
                                  ‚úì Guardar
                                </button>
                                <button
                                  onClick={cancelarEdicion}
                                  className="px-3 bg-slate-300 text-slate-700 rounded-lg py-2 text-sm hover:bg-slate-400 transition-all"
                                >
                                  ‚úï
                                </button>
                              </div>
                            </div>
                          ) : (
                            /* Modo visualizaci√≥n */
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-3">
                                <span className="w-10 h-10 bg-purple-100 text-purple-700 rounded-full flex items-center justify-center font-bold text-sm">
                                  {prof.iniciales}
                                </span>
                                <span className="font-medium text-slate-700">{prof.nombre}</span>
                              </div>
                              <div className="flex gap-1">
                                <button
                                  onClick={() => iniciarEdicion(prof)}
                                  className="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition-all"
                                  aria-label="Editar profesor"
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                  </svg>
                                </button>
                                <button
                                  onClick={() => eliminarProfesor(prof.id)}
                                  className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all"
                                  aria-label="Eliminar profesor"
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </div>
                </div>

                {/* Panel de Asignaciones */}
                <div className="bg-white rounded-2xl shadow-xl p-6">
                  <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span>üìö</span> Asignar Profesores a Materias
                  </h2>
                  
                  {profesores.length === 0 ? (
                    <div className="text-center py-12 text-slate-400">
                      <p className="text-4xl mb-3">üë®‚Äçüè´</p>
                      <p>Primero agrega profesores para poder asignarlos a las materias</p>
                    </div>
                  ) : (
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {MATERIAS_DEFAULT.map(materia => (
                        <div key={materia} className="flex items-center justify-between bg-slate-50 rounded-lg p-3">
                          <span className="font-medium text-slate-700 text-sm flex-1">{materia}</span>
                          <select
                            value={asignaciones[materia] || ''}
                            onChange={(e) => asignarProfesor(materia, e.target.value)}
                            className="border-2 border-slate-200 rounded-lg px-3 py-1.5 text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all min-w-[180px]"
                          >
                            <option value="">‚Äî Sin asignar ‚Äî</option>
                            {profesores.map(prof => (
                              <option key={prof.id} value={prof.id}>
                                {prof.iniciales} - {prof.nombre}
                              </option>
                            ))}
                          </select>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Resumen */}
                  {profesores.length > 0 && (
                    <div className="mt-4 pt-4 border-t border-slate-200">
                      <p className="text-sm text-slate-500">
                        <strong className="text-slate-700">{Object.keys(asignaciones).length}</strong> de {MATERIAS_DEFAULT.length} materias asignadas
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            <Modal {...modal} onClose={() => setModal(m => ({ ...m, isOpen: false }))} />
            <Toast {...toast} onClose={() => setToast(t => ({ ...t, isVisible: false }))} />
          </div>
        );
      }

      // ==================== PANTALLA PRINCIPAL ====================
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4 md:p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <header className="bg-white rounded-2xl shadow-xl p-6 mb-6 animate-fade-in">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div className="flex items-center gap-4">
                  <img src="Centro_TEHUI.png" alt="Centro Educativo Tehui" className="w-16 h-16 object-contain rounded-xl shadow-lg" />
                  <div>
                    <h1 className="text-2xl md:text-3xl font-extrabold text-slate-800">Sistema de Bolet√≠n de Notas</h1>
                    <p className="text-blue-600 font-semibold">"Educando en Valores con calidad"</p>
                    <p className="text-sm text-slate-500 mt-1">üë§ Usuario: <strong>{usuario}</strong></p>
                  </div>
                </div>
                <nav className="flex flex-wrap gap-2">
                  {/* Bot√≥n de Admin solo para administradores */}
                  {leerSeguro('session')?.microsoft && esAdministrador(leerSeguro('session')?.email) && (
                    <button onClick={() => setVistaAdmin(true)} className="bg-amber-600 text-white px-4 py-2.5 rounded-xl hover:bg-amber-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-amber-500/20">
                      <span>üëë</span> Panel Admin
                    </button>
                  )}
                  <button onClick={() => setVistaAulas(true)} className="bg-indigo-600 text-white px-4 py-2.5 rounded-xl hover:bg-indigo-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                    <span>üìö</span> Estudiantes
                  </button>
                  <button onClick={() => setVistaConfig(true)} className="bg-purple-600 text-white px-4 py-2.5 rounded-xl hover:bg-purple-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-purple-500/20">
                    <span>üë®‚Äçüè´</span> Profesores
                  </button>
                  <button onClick={exportarDatos} className="bg-emerald-600 text-white px-4 py-2.5 rounded-xl hover:bg-emerald-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-emerald-500/20">
                    <span>üíæ</span> Exportar
                  </button>
                  <label className="bg-blue-600 text-white px-4 py-2.5 rounded-xl hover:bg-blue-700 cursor-pointer transition-all font-medium flex items-center gap-2 shadow-lg shadow-blue-500/20">
                    <span>üì•</span> Importar
                    <input type="file" accept=".json,.xlsx,.xls" onChange={importarDatos} className="sr-only" />
                  </label>
                  {leerSeguro('session')?.microsoft && (
                    <button onClick={sincronizarConOneDrive} className="bg-sky-600 text-white px-4 py-2.5 rounded-xl hover:bg-sky-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-sky-500/20">
                      <span>‚òÅÔ∏è</span> Sincronizar
                    </button>
                  )}
                  <div className={`flex items-center gap-2 px-3 py-2 rounded-xl border ${leerSeguro('session')?.microsoft ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200'}`}>
                    <span className={leerSeguro('session')?.microsoft ? 'text-blue-600' : 'text-green-600'}>
                      {leerSeguro('session')?.microsoft ? '‚òÅÔ∏è' : 'üîí'}
                    </span>
                    <span className={`text-sm font-medium ${leerSeguro('session')?.microsoft ? 'text-blue-700' : 'text-green-700'}`}>
                      {leerSeguro('session')?.microsoft ? leerSeguro('session')?.nombre : usuario}
                    </span>
                    {leerSeguro('session')?.microsoft && (
                      <span className="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">OneDrive</span>
                    )}
                  </div>
                  <button onClick={handleLogout} className="bg-red-600 text-white px-4 py-2.5 rounded-xl hover:bg-red-700 transition-all font-medium flex items-center gap-2">
                    <span>üö™</span> Salir
                  </button>
                </nav>
              </div>
            </header>

            {/* Contenido principal */}
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
              {/* Panel de estudiantes */}
              <aside className="bg-white rounded-2xl shadow-xl p-5 animate-fade-in" style={{animationDelay: '0.1s'}}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-slate-800">Estudiantes</h2>
                  <button onClick={crearEstudiante} className="bg-emerald-600 text-white p-2.5 rounded-xl hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-500/20" aria-label="Agregar nuevo estudiante">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                  </button>
                </div>
                
                {/* Barra de b√∫squeda */}
                <div className="mb-3">
                  <div className="relative">
                    <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                      type="text"
                      value={busqueda}
                      onChange={(e) => setBusqueda(e.target.value)}
                      placeholder="Buscar estudiante..."
                      className="w-full pl-9 pr-8 py-2 border-2 border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
                    />
                    {busqueda && (
                      <button onClick={() => setBusqueda('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Filtro por aula */}
                <div className="mb-3">
                  <select
                    value={filtroAula}
                    onChange={(e) => {
                      setFiltroAula(e.target.value);
                      // Si selecciona un aula, limpiar filtro de grado
                      if (e.target.value) setFiltroGrado('');
                    }}
                    className="w-full border-2 border-indigo-200 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all bg-indigo-50"
                  >
                    <option value="">üè´ Todas las aulas</option>
                    {aulas.map(a => {
                      const prof = profesores.find(p => p.id === a.profesorTitular);
                      return (
                        <option key={a.id} value={a.id}>
                          {a.nombre} {prof ? `(${prof.iniciales})` : ''}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                {/* Filtro por grado */}
                <div className="mb-4">
                  <select
                    value={filtroGrado}
                    onChange={(e) => setFiltroGrado(e.target.value)}
                    className="w-full border-2 border-slate-200 rounded-xl px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
                    disabled={!!filtroAula}
                  >
                    <option value="">Todos los grados</option>
                    {GRADOS_PRIMARIO.map(g => <option key={g} value={g}>{g}</option>)}
                  </select>
                </div>
                
                {/* Contador de resultados */}
                <div className="flex justify-between items-center mb-3 text-xs text-slate-500">
                  <span>{estudiantesFiltrados.length} de {estudiantes.length} estudiantes</span>
                  {(busqueda || filtroGrado || filtroAula) && (
                    <button onClick={() => { setBusqueda(''); setFiltroGrado(''); setFiltroAula(''); }} className="text-blue-600 hover:text-blue-700 font-medium">
                      Limpiar filtros
                    </button>
                  )}
                </div>
                
                <div className="space-y-2 max-h-[calc(100vh-450px)] overflow-y-auto pr-1">
                  {estudiantesFiltrados.length === 0 ? (
                    <div className="text-center py-10 text-slate-400">
                      {estudiantes.length === 0 ? (
                        <>
                          <p className="text-sm">No hay estudiantes</p>
                          <p className="text-xs mt-1">Haz clic en + para agregar</p>
                        </>
                      ) : (
                        <>
                          <p className="text-sm">No se encontraron resultados</p>
                          <p className="text-xs mt-1">Prueba con otros filtros</p>
                        </>
                      )}
                    </div>
                  ) : (
                    estudiantesFiltrados.map((e, idx) => {
                      const aulaEst = aulas.find(a => a.id === e.aulaId);
                      return (
                        <div key={e.id} className={`p-4 border-2 rounded-xl transition-all cursor-pointer animate-slide-in ${actual?.id === e.id ? 'bg-blue-50 border-blue-400 shadow-md' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'}`} style={{animationDelay: `${idx * 0.05}s`}}>
                          <div onClick={() => seleccionarEstudiante(e)} role="button" tabIndex={0}>
                            <p className="font-semibold text-slate-800">{e.nombre || 'Sin nombre'}</p>
                            <p className="text-sm text-slate-500">
                              {aulaEst ? (
                                <span className="text-indigo-600 font-medium">{aulaEst.nombre}</span>
                              ) : (
                                <span>{e.grado || 'Sin grado'} de {nivelParaGrado(e.nivel) || ''}</span>
                              )}
                            </p>
                            {e.matricula && <p className="text-xs text-slate-400 mono mt-1">{e.matricula}</p>}
                          </div>
                          <button onClick={(ev) => { ev.stopPropagation(); eliminarEstudiante(e.id); }} className="text-red-500 hover:text-red-700 text-sm mt-3 flex items-center gap-1 transition-colors">
                            <span>üóëÔ∏è</span> Eliminar
                          </button>
                        </div>
                      );
                    })
                  )}
                </div>
              </aside>

              {/* Panel de edici√≥n */}
              <main className="lg:col-span-3 bg-white rounded-2xl shadow-xl p-6 animate-fade-in" style={{animationDelay: '0.2s'}}>
                {!actual ? (
                  <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                    <p className="text-lg">Selecciona o crea un estudiante</p>
                    <p className="text-sm mt-1">para comenzar a editar sus calificaciones</p>
                  </div>
                ) : (
                  <>
                    {/* Barra de acciones */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 pb-6 border-b border-slate-200">
                      <div>
                        <h2 className="text-2xl font-bold text-slate-800">Datos del Estudiante</h2>
                        {/* Indicador de auto-guardado */}
                        <div className="flex items-center gap-2 mt-1">
                          {autoGuardando ? (
                            <span className="inline-flex items-center gap-1.5 text-xs text-blue-600">
                              <svg className="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                              Guardando...
                            </span>
                          ) : ultimoGuardado ? (
                            <span className="inline-flex items-center gap-1.5 text-xs text-emerald-600">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                              Guardado autom√°tico
                            </span>
                          ) : null}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={guardarEstudiante} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-blue-500/20">
                          <span>üíæ</span> Guardar
                        </button>
                        <button onClick={() => setVista(true)} className="bg-violet-600 text-white px-5 py-2.5 rounded-xl hover:bg-violet-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-violet-500/20">
                          <span>üëÅÔ∏è</span> Vista Previa
                        </button>
                      </div>
                    </div>

                    {/* Datos b√°sicos */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                      <div>
                        <label htmlFor="matricula" className="block text-sm font-semibold text-slate-600 mb-1.5">Matr√≠cula o ID</label>
                        <input id="matricula" placeholder="Ej: 2025-001" value={actual.matricula} onChange={e => actualizarEstudiante('matricula', e.target.value)} className="w-full border-2 border-slate-200 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all mono" />
                      </div>
                      <div className="sm:col-span-2">
                        <label htmlFor="nombre" className="block text-sm font-semibold text-slate-600 mb-1.5">Nombre(s) y apellido(s)</label>
                        <input id="nombre" placeholder="Nombre completo del alumno" value={actual.nombre} onChange={e => actualizarEstudiante('nombre', e.target.value)} className="w-full border-2 border-slate-200 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all" />
                      </div>
                      <div>
                        <label htmlFor="grado" className="block text-sm font-semibold text-slate-600 mb-1.5">Grado</label>
                        <select id="grado" value={actual.grado || '1ro'} onChange={e => actualizarEstudiante('grado', e.target.value)} className="w-full border-2 border-slate-200 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all">
                          {GRADOS_PRIMARIO.map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                      </div>
                      <div>
                        <label htmlFor="nivel" className="block text-sm font-semibold text-slate-600 mb-1.5">Nivel</label>
                        <select id="nivel" value={actual.nivel || 'Primario'} onChange={e => actualizarEstudiante('nivel', e.target.value)} className="w-full border-2 border-slate-200 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all">
                          {NIVELES.map(n => <option key={n} value={n}>{n}</option>)}
                        </select>
                      </div>
                    </div>

                    {/* Per√≠odo Escolar */}
                    <div className="mb-6">
                      <label htmlFor="periodoEscolar" className="block text-sm font-semibold text-slate-600 mb-1.5">Per√≠odo Escolar (A√±o Escolar)</label>
                      <input id="periodoEscolar" placeholder="Ej: 2025-2026" value={actual.periodoEscolar || ''} onChange={e => actualizarEstudiante('periodoEscolar', e.target.value)} className="w-full sm:w-48 border-2 border-slate-200 rounded-xl px-4 py-2.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all mono" />
                    </div>

                    {/* Aula Asignada */}
                    <div className="mb-6 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                      <label htmlFor="aulaId" className="block text-sm font-semibold text-indigo-700 mb-1.5">üè´ Aula Asignada</label>
                      <select 
                        id="aulaId"
                        value={actual.aulaId || ''} 
                        onChange={e => {
                          const aulaId = e.target.value;
                          const aula = aulas.find(a => a.id === aulaId);
                          // Actualizar aula, grado, nivel y profesor titular
                          setActual(prev => ({
                            ...prev,
                            aulaId: aulaId,
                            grado: aula?.grado || prev.grado,
                            nivel: aula?.nivel || prev.nivel,
                            profesorTitular: aula?.profesorTitular || ''
                          }));
                        }} 
                        className="w-full sm:w-80 border-2 border-indigo-300 rounded-xl px-4 py-2.5 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all bg-white"
                      >
                        <option value="">‚Äî Sin aula asignada ‚Äî</option>
                        {aulas.map(aula => {
                          const prof = profesores.find(p => p.id === aula.profesorTitular);
                          return (
                            <option key={aula.id} value={aula.id}>
                              {aula.nombre} - {aula.nivel} {prof ? `(${prof.nombre})` : ''}
                            </option>
                          );
                        })}
                      </select>
                      {aulas.length === 0 && (
                        <p className="text-xs text-amber-600 mt-1">
                          üí° Crea aulas en el bot√≥n "Aulas" del men√∫
                        </p>
                      )}
                      
                      {/* Mostrar info del aula seleccionada */}
                      {actual.aulaId && (() => {
                        const aula = aulas.find(a => a.id === actual.aulaId);
                        const prof = aula ? profesores.find(p => p.id === aula.profesorTitular) : null;
                        return aula ? (
                          <div className="mt-2 text-sm text-indigo-600">
                            <p><strong>Grado:</strong> {aula.grado} de {nivelParaGrado(aula.nivel)} | <strong>Nivel:</strong> {aula.nivel}</p>
                            {prof && <p><strong>Docente Titular:</strong> {prof.nombre} ({prof.iniciales})</p>}
                          </div>
                        ) : null;
                      })()}
                    </div>

                    {/* Materias */}
                    <div className="space-y-4 max-h-[calc(100vh-520px)] overflow-y-auto pr-2">
                      {actual.materias.map((m, i) => (
                        <details key={i} className="group border-2 border-slate-200 rounded-2xl overflow-hidden hover:border-slate-300 transition-all" open={i === 0}>
                          <summary className="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-white cursor-pointer list-none">
                            <div className="flex items-center gap-4">
                              <span className="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-700 rounded-lg text-sm font-bold">{i + 1}</span>
                              <span className="font-bold text-slate-800">{m.nombre}</span>
                              {calcCalificacionFinalConRecuperacion(m) !== '' && (
                                <span className={`px-2.5 py-1 rounded-lg text-sm font-bold mono ${m.rf ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                  {calcCalificacionFinalConRecuperacion(m)}
                                  {m.rf && <span className="ml-1 text-xs">(R)</span>}
                                </span>
                              )}
                            </div>
                            <svg className="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                          </summary>
                          
                          <div className="p-4 bg-white border-t border-slate-100">
                            <div className="mb-4">
                              <label className="block text-sm font-medium text-slate-600 mb-1">Profesor</label>
                              <div className="flex gap-2 items-center">
                                <select 
                                  value={m.profesor || ''} 
                                  onChange={e => actualizarCampoMateria(i, 'profesor', e.target.value)} 
                                  className="flex-1 sm:w-1/2 border-2 border-slate-200 rounded-xl px-4 py-2 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all"
                                >
                                  <option value="">‚Äî Seleccionar profesor ‚Äî</option>
                                  {profesores.map(prof => (
                                    <option key={prof.id} value={prof.iniciales}>
                                      {prof.iniciales} - {prof.nombre}
                                    </option>
                                  ))}
                                </select>
                                {asignaciones[m.nombre] && !m.profesor && (
                                  <button
                                    onClick={() => {
                                      const prof = profesores.find(p => p.id === asignaciones[m.nombre]);
                                      if (prof) actualizarCampoMateria(i, 'profesor', prof.iniciales);
                                    }}
                                    className="text-xs bg-purple-100 text-purple-700 px-3 py-2 rounded-lg hover:bg-purple-200 transition-all"
                                    title="Usar profesor asignado por defecto"
                                  >
                                    Usar asignado
                                  </button>
                                )}
                              </div>
                              {profesores.length === 0 && (
                                <p className="text-xs text-amber-600 mt-1">
                                  üí° Agrega profesores en el bot√≥n "Profesores" del men√∫
                                </p>
                              )}
                            </div>
                            
                            {/* Grid de competencias */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                              {/* Comunicativa */}
                              <div className="border-2 border-blue-200 rounded-xl overflow-hidden">
                                <div className="bg-blue-500 text-white text-center py-2 font-bold text-sm">Comunicativa (C1)</div>
                                <div className="p-3">
                                  <div className="grid grid-cols-4 gap-2 mb-2">
                                    {['p1', 'p2', 'p3', 'p4'].map((per, pi) => (
                                      <div key={per} className="text-center">
                                        <label className="block text-xs text-slate-500 mb-1 font-semibold">P{pi + 1}</label>
                                        <InputNota id={`${i}-${per}-c`} value={m[per].c} onChange={val => actualizarNota(i, per, 'c', val)} compact />
                                        <div className="mt-1">
                                          <label className="block text-[10px] text-amber-600">Rec</label>
                                          <InputNota id={`${i}-${per}-rc`} value={m[per].rc || ''} onChange={val => actualizarNota(i, per, 'rc', val)} compact destacado />
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                                <div className="bg-blue-50 p-2 text-center border-t border-blue-200">
                                  <span className="text-xs text-blue-600">Promedio C1:</span>
                                  <span className="ml-2 font-bold text-blue-800 mono">{calcPromedioCompetencia(m, 'c') || '‚Äî'}</span>
                                </div>
                              </div>

                              {/* Pensamiento */}
                              <div className="border-2 border-violet-200 rounded-xl overflow-hidden">
                                <div className="bg-violet-500 text-white text-center py-2 font-bold text-sm">Pensamiento L√≥gico (C2)</div>
                                <div className="p-3">
                                  <div className="grid grid-cols-4 gap-2 mb-2">
                                    {['p1', 'p2', 'p3', 'p4'].map((per, pi) => (
                                      <div key={per} className="text-center">
                                        <label className="block text-xs text-slate-500 mb-1 font-semibold">P{pi + 1}</label>
                                        <InputNota id={`${i}-${per}-p`} value={m[per].p} onChange={val => actualizarNota(i, per, 'p', val)} compact />
                                        <div className="mt-1">
                                          <label className="block text-[10px] text-amber-600">Rec</label>
                                          <InputNota id={`${i}-${per}-rp`} value={m[per].rp || ''} onChange={val => actualizarNota(i, per, 'rp', val)} compact destacado />
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                                <div className="bg-violet-50 p-2 text-center border-t border-violet-200">
                                  <span className="text-xs text-violet-600">Promedio C2:</span>
                                  <span className="ml-2 font-bold text-violet-800 mono">{calcPromedioCompetencia(m, 'p') || '‚Äî'}</span>
                                </div>
                              </div>

                              {/* √âtica */}
                              <div className="border-2 border-emerald-200 rounded-xl overflow-hidden">
                                <div className="bg-emerald-500 text-white text-center py-2 font-bold text-sm">√âtica y Ciudadan√≠a (C3)</div>
                                <div className="p-3">
                                  <div className="grid grid-cols-4 gap-2 mb-2">
                                    {['p1', 'p2', 'p3', 'p4'].map((per, pi) => (
                                      <div key={per} className="text-center">
                                        <label className="block text-xs text-slate-500 mb-1 font-semibold">P{pi + 1}</label>
                                        <InputNota id={`${i}-${per}-e`} value={m[per].e} onChange={val => actualizarNota(i, per, 'e', val)} compact />
                                        <div className="mt-1">
                                          <label className="block text-[10px] text-amber-600">Rec</label>
                                          <InputNota id={`${i}-${per}-re`} value={m[per].re || ''} onChange={val => actualizarNota(i, per, 're', val)} compact destacado />
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                                <div className="bg-emerald-50 p-2 text-center border-t border-emerald-200">
                                  <span className="text-xs text-emerald-600">Promedio C3:</span>
                                  <span className="ml-2 font-bold text-emerald-800 mono">{calcPromedioCompetencia(m, 'e') || '‚Äî'}</span>
                                </div>
                              </div>
                            </div>

                            {/* Calificaci√≥n final y recuperaci√≥n */}
                            <div className="mt-4 p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                              <div className="text-center sm:text-left">
                                <p className="text-sm font-medium text-slate-600">Calificaci√≥n Final del √Årea</p>
                                <p className="text-3xl font-extrabold text-slate-800 mono">{calcCalificacionFinalArea(m) || '‚Äî'}</p>
                              </div>
                              <div className="flex items-center gap-3">
                                <label className="text-sm font-semibold text-amber-700">Recuperaci√≥n Final</label>
                                <input type="text" inputMode="numeric" value={m.rf} onChange={e => actualizarCampoMateria(i, 'rf', formatearNota(e.target.value))} className="border-2 border-amber-400 rounded-xl px-4 py-2 text-center w-20 bg-amber-50 focus:ring-4 focus:ring-amber-400/20 font-bold mono" maxLength="3" />
                              </div>
                              {m.rf && (
                                <div className="text-center sm:text-right">
                                  <p className="text-sm font-medium text-emerald-600">Nota Final c/Rec</p>
                                  <p className="text-2xl font-extrabold text-emerald-700 mono">{calcCalificacionFinalConRecuperacion(m)}</p>
                                </div>
                              )}
                            </div>
                          </div>
                        </details>
                      ))}
                    </div>

                    {/* Asistencia */}
                    <div className="mt-6 border-2 border-slate-200 rounded-xl p-4">
                      <h3 className="font-bold text-slate-800 mb-4">Resumen de Asistencia del Estudiante</h3>
                      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        {['p1', 'p2', 'p3', 'p4'].map((per, i) => (
                          <div key={per} className="border border-slate-200 rounded-lg p-3">
                            <p className="font-semibold text-center text-slate-700 mb-2">Per√≠odo {i + 1}</p>
                            <div className="space-y-2">
                              <div>
                                <label className="text-xs text-slate-500">Asistencia</label>
                                <input type="text" inputMode="numeric" value={actual.asistencia?.[per]?.asistencia || ''} onChange={e => actualizarAsistencia(per, 'asistencia', e.target.value)} className="w-full border border-slate-300 rounded px-2 py-1 text-center text-sm mono" placeholder="0" />
                              </div>
                              <div>
                                <label className="text-xs text-slate-500">Ausencia</label>
                                <input type="text" inputMode="numeric" value={actual.asistencia?.[per]?.ausencia || ''} onChange={e => actualizarAsistencia(per, 'ausencia', e.target.value)} className="w-full border border-slate-300 rounded px-2 py-1 text-center text-sm mono" placeholder="0" />
                              </div>
                              <div>
                                <label className="text-xs text-slate-500">Tardanzas</label>
                                <input type="text" inputMode="numeric" value={actual.asistencia?.[per]?.tardanza || ''} onChange={e => actualizarAsistencia(per, 'tardanza', e.target.value)} className="w-full border border-slate-300 rounded px-2 py-1 text-center text-sm mono" placeholder="0" />
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Observaciones por Per√≠odo */}
                    <div className="mt-6">
                      <h4 className="text-sm font-semibold text-slate-600 mb-3">Observaciones por Per√≠odo</h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {['p1', 'p2', 'p3', 'p4'].map((periodo, idx) => (
                          <div key={periodo}>
                            <label htmlFor={`obs-${periodo}`} className="block text-xs font-medium text-slate-500 mb-1">
                              Per√≠odo {idx + 1}
                            </label>
                            <textarea 
                              id={`obs-${periodo}`} 
                              value={actual.observaciones?.[periodo] || ''} 
                              onChange={e => {
                                setActual(prev => ({
                                  ...prev,
                                  observaciones: {
                                    ...prev.observaciones,
                                    [periodo]: e.target.value
                                  }
                                }));
                              }} 
                              className="w-full border-2 border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all resize-none" 
                              rows="7" 
                              placeholder={`Observaciones del per√≠odo ${idx + 1}...`} 
                            />
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Situaci√≥n del Estudiante - Solo para 3ro en adelante */}
                    {['3ro', '4to', '5to', '6to'].includes(actual.grado) && (
                      <div className="mt-6 p-4 bg-teal-50 rounded-xl border border-teal-200">
                        <h4 className="text-sm font-semibold text-teal-700 mb-3 flex items-center gap-2">
                          üìã Situaci√≥n del Estudiante
                          <span className="text-xs font-normal text-teal-500">(Aparece en la portada - Solo 3ro a 6to - Final del a√±o escolar)</span>
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-xs font-medium text-teal-600 mb-2">Situaci√≥n Final</label>
                            <select
                              value={actual.situacion || ''}
                              onChange={e => setActual(prev => ({...prev, situacion: e.target.value}))}
                              className="w-full border-2 border-teal-200 rounded-lg px-3 py-2 text-sm focus:border-teal-500 bg-white"
                            >
                              <option value="">‚Äî Sin definir ‚Äî</option>
                              <option value="promovido">‚úì Promovido/a</option>
                              <option value="aplazado">‚ö† Aplazado/a</option>
                              <option value="repitente">‚úó Repitente</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-teal-600 mb-1">Condici√≥n Final del Estudiante</label>
                            <input 
                              type="text" 
                              value={actual.condicionFinal || ''} 
                              onChange={e => setActual(prev => ({...prev, condicionFinal: e.target.value}))}
                              className="w-full border-2 border-teal-200 rounded-lg px-3 py-2 text-sm focus:border-teal-500 bg-white" 
                              placeholder="Ej: Pasa a 4to grado..."
                            />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Informaci√≥n sobre nivel de avance - Final del a√±o escolar */}
                    <div className="mt-6 p-4 bg-purple-50 rounded-xl border border-purple-200">
                      <h4 className="text-sm font-semibold text-purple-700 mb-3 flex items-center gap-2">
                        üìÑ Informaci√≥n sobre Nivel de Avance
                        <span className="text-xs font-normal text-purple-500">(Se coloca al final del a√±o escolar - Aparece en la portada)</span>
                      </h4>
                      <p className="text-xs text-purple-600 mb-3">
                        Informaci√≥n sobre el nivel de avance de los aprendizajes y los apoyos que necesita para la mejora de sus aprendizajes.
                      </p>
                      <textarea 
                        value={actual.observacionPortada || ''} 
                        onChange={e => setActual(prev => ({...prev, observacionPortada: e.target.value}))}
                        className="w-full border-2 border-purple-200 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all resize-none bg-white" 
                        rows="4" 
                        placeholder="Observaciones finales del estudiante para el a√±o escolar..."
                      />
                    </div>
                  </>
                )}
              </main>
            </div>
          </div>

          <Modal {...modal} onClose={() => setModal(m => ({ ...m, isOpen: false }))} />
          <Toast {...toast} onClose={() => setToast(t => ({ ...t, isVisible: false }))} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>

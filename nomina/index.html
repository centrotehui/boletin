<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Nómina Tehui v3.83 - Profesional RD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Bibliotecas para 2FA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- EmailJS para envío de códigos por correo -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colores institucionales Centro Educativo Tehui */
            --primary: #1565C0; --primary-light: #1E88E5; --primary-dark: #0D47A1;
            --secondary: #FF9800; --accent: #4CAF50;
            --tehui-red: #E53935; --tehui-yellow: #FDD835; --tehui-green: #43A047; --tehui-blue: #42A5F5; --tehui-orange: #FB8C00;
            --bg-main: #f5f7fa; --bg-card: #ffffff; --bg-sidebar: linear-gradient(180deg, #1565C0 0%, #0D47A1 100%);
            --text-primary: #1a1f24; --text-secondary: #5c6975; --text-muted: #8b95a1;
            --border: #e0e4e8; --border-light: #f0f2f5;
            --success: #43A047; --warning: #FDD835; --danger: #E53935; --info: #42A5F5; --purple: #7E57C2;
            --shadow: 0 2px 8px rgba(21, 101, 192, 0.08); --shadow-md: 0 4px 16px rgba(21, 101, 192, 0.12);
            --radius: 8px; --radius-lg: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-main); color: var(--text-primary); font-size: 13px; line-height: 1.5; }
        
        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: var(--bg-sidebar); position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); }
        .logo { display: flex; align-items: center; gap: 12px; color: white; }
        .logo-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: white; padding: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .logo-icon img { width: 100%; height: 100%; object-fit: contain; }
        .logo h1 { font-size: 13px; font-weight: 700; line-height: 1.3; }
        .logo span { font-size: 10px; color: rgba(255,255,255,0.7); display: block; margin-top: 2px; }
        
        .nav { padding: 12px 8px; }
        .nav-group { margin-bottom: 16px; }
        .nav-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); padding: 0 10px; margin-bottom: 6px; }
        .nav-item { display: flex; align-items: center; gap: 8px; padding: 9px 12px; border-radius: 8px; color: rgba(255,255,255,0.75); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; margin-bottom: 2px; }
        .nav-item:hover { background: rgba(255,255,255,0.12); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.2); color: white; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
        .nav-badge { background: var(--tehui-red); color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; margin-left: auto; font-weight: 600; }
        
        .main { flex: 1; margin-left: 240px; overflow-x: hidden; }
        .topbar { background: var(--bg-card); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .topbar-left h2 { font-size: 16px; font-weight: 700; }
        .topbar-left p { font-size: 11px; color: var(--text-secondary); }
        .topbar-right { display: flex; gap: 8px; }
        .page { padding: 16px 20px; overflow-x: auto; }
        
        /* Buttons - Colores Tehui */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-light), var(--primary)); color: white; box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
        .btn-secondary { background: white; color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-main); border-color: var(--primary-light); }
        .btn-success { background: linear-gradient(135deg, var(--tehui-green), #388E3C); color: white; box-shadow: 0 2px 8px rgba(67, 160, 71, 0.3); }
        .btn-success:hover { transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(135deg, var(--tehui-red), #C62828); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--tehui-yellow), #F9A825); color: #333; }
        .btn-info { background: linear-gradient(135deg, var(--tehui-blue), #1E88E5); color: white; }
        .btn-purple { background: linear-gradient(135deg, var(--purple), #5E35B1); color: white; }
        .btn-orange { background: linear-gradient(135deg, var(--tehui-orange), #EF6C00); color: white; box-shadow: 0 2px 8px rgba(251, 140, 0, 0.3); }
        .btn-sm { padding: 6px 10px; font-size: 11px; }
        .btn-xs { padding: 4px 8px; font-size: 10px; }
        .btn-icon { padding: 6px; width: 30px; height: 30px; }
        .btn-group { display: flex; gap: 4px; }
        
        /* Cards */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border-light); margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .card-body { padding: 16px; overflow: auto; }
        .card-footer { padding: 12px 16px; border-top: 1px solid var(--border-light); background: var(--bg-main); }
        
        /* Stats - Colores Tehui */
        .stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 16px; }
        .stat { background: var(--bg-card); border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-light); transition: all 0.2s; }
        .stat:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .stat-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .stat-icon.green { background: linear-gradient(135deg, rgba(67,160,71,0.15), rgba(67,160,71,0.05)); color: var(--tehui-green); }
        .stat-icon.blue { background: linear-gradient(135deg, rgba(66,165,245,0.15), rgba(66,165,245,0.05)); color: var(--tehui-blue); }
        .stat-icon.orange { background: linear-gradient(135deg, rgba(251,140,0,0.15), rgba(251,140,0,0.05)); color: var(--tehui-orange); }
        .stat-icon.red { background: linear-gradient(135deg, rgba(229,57,53,0.15), rgba(229,57,53,0.05)); color: var(--tehui-red); }
        .stat-icon.purple { background: linear-gradient(135deg, rgba(126,87,194,0.15), rgba(126,87,194,0.05)); color: var(--purple); }
        .stat-icon.yellow { background: linear-gradient(135deg, rgba(253,216,53,0.2), rgba(253,216,53,0.05)); color: #F9A825; }
        .stat-label { font-size: 10px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .stat-value { font-size: 20px; font-weight: 800; color: var(--text-primary); }
        .stat-sub { font-size: 10px; color: var(--text-muted); margin-top: 3px; }
        
        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px 10px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); background: var(--bg-main); border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        tr:hover td { background: rgba(0,0,0,0.01); }
        .sticky-col { position: sticky; left: 0; background: var(--bg-card); z-index: 1; }
        
        .emp-cell { display: flex; align-items: center; gap: 8px; min-width: 180px; }
        .emp-avatar { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-light), var(--primary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 10px; flex-shrink: 0; }
        .emp-name { font-weight: 600; font-size: 11px; white-space: nowrap; }
        .emp-sub { font-size: 9px; color: var(--text-muted); }
        
        .badge { display: inline-flex; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; }
        .badge-success { background: rgba(25,135,84,0.1); color: var(--success); }
        .badge-warning { background: rgba(255,193,7,0.15); color: #997404; }
        .badge-danger { background: rgba(220,53,69,0.1); color: var(--danger); }
        .badge-info { background: rgba(13,202,240,0.1); color: #055160; }
        .badge-purple { background: rgba(111,66,193,0.1); color: var(--purple); }
        .badge-secondary { background: var(--bg-main); color: var(--text-secondary); }
        
        .money { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .money.pos { color: var(--success); }
        .money.neg { color: var(--danger); }
        
        .actions { display: flex; gap: 3px; }
        .action-btn { width: 24px; height: 24px; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--bg-main); color: var(--text-secondary); transition: all 0.15s; }
        .action-btn:hover { background: var(--primary-light); color: white; }
        .action-btn.danger:hover { background: var(--danger); }
        .action-btn svg { width: 12px; height: 12px; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .form-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .form-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .form-group { }
        .form-group.full { grid-column: 1 / -1; }
        .form-group.span-2 { grid-column: span 2; }
        .form-group.span-3 { grid-column: span 3; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .form-control { width: 100%; padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: inherit; transition: border-color 0.15s; }
        .form-control:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(25,135,84,0.1); }
        .form-control.sm { padding: 5px 8px; font-size: 11px; }
        .form-help { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
        .form-row { display: flex; gap: 8px; align-items: flex-end; }
        
        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal.md { max-width: 650px; }
        .modal.lg { max-width: 850px; }
        .modal.xl { max-width: 1100px; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-size: 14px; font-weight: 700; }
        .modal-close { width: 28px; height: 28px; border-radius: 6px; border: none; background: var(--bg-main); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 8px; background: var(--bg-main); flex-shrink: 0; }
        
        /* Tabs */
        .tabs { display: flex; gap: 2px; background: var(--bg-main); padding: 3px; border-radius: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .tab { padding: 6px 12px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-radius: 4px; transition: all 0.15s; white-space: nowrap; }
        .tab:hover { color: var(--primary); }
        .tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }
        
        /* Config */
        .config-section { border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .config-title { font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .config-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border-light); font-size: 11px; }
        .config-row:last-child { border-bottom: none; }
        .config-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; text-align: right; font-family: 'JetBrains Mono', monospace; }
        
        /* Alert */
        .alert { padding: 10px 12px; border-radius: 6px; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px; font-size: 11px; }
        .alert svg { flex-shrink: 0; width: 14px; height: 14px; margin-top: 1px; }
        .alert-info { background: rgba(13,202,240,0.1); border: 1px solid rgba(13,202,240,0.2); color: #055160; }
        .alert-warning { background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.2); color: #664d03; }
        .alert-success { background: rgba(25,135,84,0.1); border: 1px solid rgba(25,135,84,0.2); color: var(--success); }
        .alert-danger { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.2); color: var(--danger); }
        
        /* Inline input */
        .inline-input { padding: 3px 5px; border: 1px solid var(--border); border-radius: 3px; font-size: 10px; width: 55px; text-align: right; font-family: 'JetBrains Mono', monospace; }
        .inline-input:focus { outline: none; border-color: var(--primary-light); }
        
        /* Summary */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
        .summary-box { background: var(--bg-main); border-radius: 8px; padding: 12px; }
        .summary-title { font-size: 10px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px dashed var(--border); }
        .summary-row:last-child { border-bottom: none; font-weight: 700; padding-top: 6px; margin-top: 4px; border-top: 2px solid var(--border); font-size: 11px; }
        
        .dept-row { background: linear-gradient(90deg, rgba(15,81,50,0.05), transparent); }
        .dept-row td { font-weight: 700; color: var(--primary); border-bottom: 2px solid var(--primary-light); }
        
        /* Progress */
        .progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-light); border-radius: 2px; }
        
        /* Empty */
        .empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; }
        .empty h3 { font-size: 14px; margin-bottom: 4px; color: var(--text-primary); }
        .empty p { font-size: 12px; }
        
        /* SVG size control */
        svg { max-width: 100%; height: auto; }
        .card-body svg:not(.stat-icon svg):not(.action-btn svg) { width: 16px; height: 16px; }
        .card-header svg { width: 16px; height: 16px; }
        .stat-icon svg { width: 18px; height: 18px; }
        
        /* Toast */
        .toasts { position: fixed; bottom: 16px; right: 16px; z-index: 2000; }
        .toast { padding: 10px 14px; border-radius: 8px; background: var(--bg-card); box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 8px; margin-top: 8px; min-width: 220px; font-size: 12px; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.warning { border-left: 3px solid var(--warning); }
        
        /* Loading */
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* SharePoint connection styles */
        .sp-connected { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .sp-disconnected { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
        .sync-spin { animation: spin 1s linear infinite; }
        
        /* Search */
        .search-wrap { position: relative; margin-bottom: 12px; }
        .search-input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 14px; height: 14px; }
        
        .filters { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
        .filter { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); transition: all 0.15s; }
        .filter:hover { border-color: var(--primary-light); color: var(--primary); }
        .filter.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Print */
        .print-only { display: none; }
        /* Volante - Nuevo Layout Optimizado */
        .volante { border: 1px solid #333; padding: 12px; margin-bottom: 15px; page-break-inside: avoid; font-size: 10px; }
        .volante-top { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 6px; margin-bottom: 8px; }
        .volante-empresa-info strong { font-size: 12px; display: block; }
        .volante-empresa-info span { font-size: 8px; color: #666; }
        .volante-tipo { text-align: right; }
        .volante-tipo strong { font-size: 11px; display: block; }
        .volante-tipo span { font-size: 9px; color: #444; }
        .volante-nombre-grande { font-size: 16px; font-weight: bold; padding: 6px 0; border-bottom: 1px solid #ccc; margin-bottom: 6px; }
        .volante-datos-linea { display: flex; gap: 20px; background: #f5f5f5; padding: 6px 10px; margin-bottom: 8px; border-radius: 4px; }
        .volante-datos-linea div { flex: 1; }
        .volante-datos-linea label { font-size: 8px; color: #666; text-transform: uppercase; }
        .volante-datos-linea span { font-weight: 600; font-size: 10px; }
        .volante-detalle { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px; }
        .volante-seccion h4 { font-size: 10px; background: #e0e0e0; padding: 4px 6px; margin-bottom: 4px; }
        .volante-linea { display: flex; justify-content: space-between; padding: 2px 4px; font-size: 9px; border-bottom: 1px dotted #ccc; }
        .volante-linea:last-child { border-bottom: none; }
        .volante-linea.total { background: #f0f0f0; font-weight: bold; border-top: 1px solid #333; margin-top: 4px; padding-top: 4px; }
        .volante-pie { display: flex; align-items: flex-end; gap: 15px; margin-top: 10px; }
        .volante-firma-box { flex: 1; text-align: center; }
        .volante-firma-box .volante-firma-linea { border-top: 1px solid #333; margin-bottom: 2px; height: 20px; }
        .volante-firma-box span { font-size: 8px; color: #666; }
        .volante-neto-box { flex: 1.5; background: #333; color: white; padding: 8px; text-align: center; border-radius: 4px; border: 2px solid #000; }
        .volante-neto-box label { font-size: 8px; opacity: 0.9; display: block; }
        .volante-neto-box span { font-size: 18px; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        
        /* Responsive */
        @media (max-width: 1400px) { .stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .stats { grid-template-columns: repeat(2, 1fr); } .form-grid { grid-template-columns: repeat(2, 1fr); } .summary-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; } .stats { grid-template-columns: 1fr; } .form-grid { grid-template-columns: 1fr; } }
        
        @media print {
            /* Ocultar todo excepto área de impresión */
            body * { visibility: hidden; }
            
            /* Hacer visible el área de impresión y todos sus ancestros */
            .print-area, .print-area * { 
                visibility: visible !important; 
            }
            
            /* Hacer visible el modal si contiene print-area */
            .modal-backdrop:has(.print-area),
            .modal-backdrop:has(.print-area) * {
                visibility: visible !important;
            }
            
            .print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0;
                padding: 10px;
            }
            
            /* Excepción: cuando se imprimen volantes, el print-area NO debe ser absolute */
            body.printing-volantes .print-area {
                position: relative !important;
                top: auto !important;
                left: auto !important;
            }
            
            .no-print { display: none !important; }
            
            /* Evitar páginas en blanco */
            html, body {
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Evitar páginas en blanco al final del documento */
            html::after, body::after {
                content: none !important;
                display: none !important;
            }
            
            /* Eliminar cualquier espacio extra al final */
            .print-area:last-child {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
            
            /* Nómina: evitar saltos de página innecesarios */
            .print-area table {
                page-break-inside: auto !important;
            }
            .print-area tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            .print-area thead {
                display: table-header-group !important;
            }
            .print-area tfoot {
                display: table-footer-group !important;
            }
            
            /* Ocultar elementos de la interfaz */
            .sidebar, .toasts, .loading, header, nav, footer {
                display: none !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            
            /* Modal: ocultar decoración pero mostrar contenido */
            .modal-backdrop {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            .modal {
                position: relative !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: white !important;
                transform: none !important;
            }
            
            .modal-header, .modal-footer {
                display: none !important;
            }
            
            .modal-body {
                padding: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .app, .main {
                display: block !important;
                min-height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Por defecto: landscape para tablas de nómina */
            @page { 
                margin: 5mm; 
                size: letter landscape;
            }
            
            /* Forzar impresión en blanco y negro */
            .print-area, .print-area * { 
                color: #000 !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Contenedor de volantes sin espacio extra */
            .volantes-container,
            .print-area {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Fondos claros para impresión */
            .print-area table { background: #fff !important; }
            .print-area th { background: #e0e0e0 !important; color: #000 !important; border: 1px solid #000 !important; }
            .print-area td { border: 1px solid #999 !important; background: #fff !important; }
            .print-area tr:nth-child(even) td { background: #f5f5f5 !important; }
            
            /* Cuando hay volantes, cambiar a portrait */
            .print-area:has(.volante) {
                break-before: auto;
            }
            
            /* ========== VOLANTES - FORZAR 3 POR PÁGINA ========== */
            /* Usar portrait para volantes */
            .volante {
                page: volantes;
            }
            @page volantes {
                margin: 2mm 3mm;
                size: letter portrait;
            }
            
            /* Carta portrait: 279mm - 4mm márgenes = 275mm. 3 volantes = 91mm c/u */
            .volante { 
                border: 1px solid #000 !important; 
                background: #fff !important; 
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin: 0 !important;
                margin-bottom: 1mm !important;
                padding: 1.5mm 2.5mm !important;
                width: 100% !important;
                box-sizing: border-box !important;
                height: 89mm !important;
                max-height: 89mm !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Primer volante sin margen superior */
            .volante:first-child {
                margin-top: 0 !important;
            }
            
            /* Header compacto */
            .volante-top { 
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                border-bottom: 1px solid #000 !important; 
                padding-bottom: 0.8mm !important;
                margin-bottom: 0.8mm !important;
                flex-shrink: 0 !important;
            }
            .volante-empresa-info strong { font-size: 9px !important; display: block !important; }
            .volante-empresa-info span { font-size: 6px !important; color: #333 !important; }
            .volante-tipo { text-align: right !important; }
            .volante-tipo strong { font-size: 8px !important; display: block !important; }
            .volante-tipo span { font-size: 6px !important; }
            
            /* Nombre del empleado */
            .volante-nombre-grande { 
                font-size: 12px !important; 
                font-weight: bold !important; 
                padding: 0.8mm 0 !important;
                border-bottom: 1px solid #999 !important;
                margin-bottom: 0.8mm !important;
                flex-shrink: 0 !important;
            }
            
            /* Datos en línea horizontal */
            .volante-datos-linea { 
                display: flex !important;
                gap: 2mm !important;
                background: #f0f0f0 !important;
                padding: 0.8mm 1.5mm !important;
                margin-bottom: 1mm !important;
                flex-shrink: 0 !important;
            }
            .volante-datos-linea div { flex: 1 !important; }
            .volante-datos-linea label { font-size: 5px !important; color: #555 !important; text-transform: uppercase !important; }
            .volante-datos-linea span { font-size: 8px !important; font-weight: 600 !important; }
            
            /* Detalle de ingresos y deducciones */
            .volante-detalle { 
                gap: 2mm !important; 
                margin-bottom: 0.5mm !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                flex: 1 !important;
                min-height: 0 !important;
                overflow: hidden !important;
            }
            .volante-seccion { 
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            .volante-seccion h4 { 
                font-size: 7px !important; 
                padding: 0.4mm 1mm !important; 
                margin-bottom: 0.4mm !important;
                background: #e0e0e0 !important;
                border: 1px solid #999 !important;
                font-weight: bold !important;
                flex-shrink: 0 !important;
            }
            .volante-linea { 
                font-size: 8px !important; 
                padding: 0.3mm 0.8mm !important;
                display: flex !important;
                justify-content: space-between !important;
            }
            .volante-linea.total { 
                margin-top: auto !important; 
                padding: 0.6mm 0.8mm !important;
                font-weight: bold !important;
                border-top: 1px solid #333 !important;
                font-size: 8px !important;
                background: #e8e8e8 !important;
            }
            
            /* Ausencias más visibles */
            .volante-ausencias {
                background: #f5f5f5 !important;
                font-weight: 600 !important;
            }
            
            /* Pie: Firmas + NETO en una fila */
            .volante-pie {
                display: flex !important;
                align-items: flex-end !important;
                gap: 1.5mm !important;
                margin-top: auto !important;
                padding-top: 0.5mm !important;
                flex-shrink: 0 !important;
            }
            .volante-firma-box {
                flex: 1 !important;
                text-align: center !important;
            }
            .volante-firma-box .volante-firma-linea {
                border-top: 1px solid #333 !important;
                height: 4mm !important;
                margin-bottom: 0.3mm !important;
            }
            .volante-firma-box span {
                font-size: 5px !important;
                color: #333 !important;
            }
            .volante-neto-box {
                flex: 1.2 !important;
                background: #d0d0d0 !important;
                border: 1px solid #000 !important;
                padding: 0.8mm !important;
                text-align: center !important;
            }
            .volante-neto-box label {
                font-size: 5px !important;
                font-weight: bold !important;
                display: block !important;
            }
            .volante-neto-box span {
                font-size: 10px !important;
                font-weight: bold !important;
            }
            
            /* Salto de página después de cada 3 volantes */
            .volante:nth-child(3n) {
                page-break-after: always !important;
                break-after: page !important;
                margin-bottom: 0 !important;
            }
            /* No salto después del último */
            .volante:last-child {
                page-break-after: auto !important;
                break-after: auto !important;
                margin-bottom: 0 !important;
            }
            
            /* Neto destacado sin color */
            .neto-print { background: #d0d0d0 !important; font-weight: bold !important; border: 2px solid #000 !important; }
            
            /* Cuando se imprimen volantes desde el modal */
            body.printing-volantes * {
                visibility: hidden;
            }
            
            body.printing-volantes .modal-backdrop {
                visibility: visible !important;
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            body.printing-volantes .modal {
                visibility: visible !important;
                position: relative !important;
                box-shadow: none !important;
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            body.printing-volantes .modal-header,
            body.printing-volantes .modal-footer {
                display: none !important;
                visibility: hidden !important;
            }
            
            body.printing-volantes .modal-body {
                visibility: visible !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 10px !important;
                height: auto !important;
            }
            
            body.printing-volantes .modal-body .print-area {
                visibility: visible !important;
                position: relative !important;
                top: auto !important;
                left: auto !important;
                width: 100% !important;
            }
            
            body.printing-volantes .modal-body .print-area *,
            body.printing-volantes .volante,
            body.printing-volantes .volante *,
            body.printing-volantes .volante-header,
            body.printing-volantes .volante-header *,
            body.printing-volantes .volante-empleado,
            body.printing-volantes .volante-empleado *,
            body.printing-volantes .volante-detalle,
            body.printing-volantes .volante-detalle *,
            body.printing-volantes .volante-seccion,
            body.printing-volantes .volante-seccion *,
            body.printing-volantes .volante-neto,
            body.printing-volantes .volante-neto *,
            body.printing-volantes .volante-firmas,
            body.printing-volantes .volante-firmas * {
                visibility: visible !important;
            }
            
            body.printing-volantes .volante {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 20px !important;
            }
            
            /* ========== ESTILOS IMPRESIÓN CHECKLIST PAGOS POR BANCO ========== */
            
            /* Ocultar todo con visibility */
            body.printing-checklist * {
                visibility: hidden !important;
            }
            
            /* Mostrar el contenido del checklist */
            body.printing-checklist .modal-backdrop,
            body.printing-checklist .modal,
            body.printing-checklist .modal-body,
            body.printing-checklist .print-pagos-banco,
            body.printing-checklist .print-pagos-banco * {
                visibility: visible !important;
            }
            
            body.printing-checklist .modal-backdrop {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                padding: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            body.printing-checklist .modal {
                position: relative !important;
                max-width: 100% !important;
                width: 100% !important;
                max-height: none !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                transform: none !important;
            }
            
            body.printing-checklist .modal-header,
            body.printing-checklist .modal-footer {
                display: none !important;
            }
            
            body.printing-checklist .modal-body {
                padding: 5mm !important;
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            body.printing-checklist .print-pagos-banco {
                font-size: 11px !important;
                width: 100% !important;
            }
            
            body.printing-checklist .print-pagos-banco table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            
            body.printing-checklist .print-pagos-banco th,
            body.printing-checklist .print-pagos-banco td {
                border: 1px solid #333 !important;
                padding: 5px 8px !important;
                font-size: 10px !important;
                background: white !important;
            }
            
            body.printing-checklist .print-pagos-banco th {
                font-weight: bold !important;
                font-size: 9px !important;
            }
            
            /* Quitar todos los colores de fondo */
            body.printing-checklist .print-pagos-banco div[style*="background"] {
                background: white !important;
                color: #000 !important;
                border: 1px solid #333 !important;
            }
            
            body.printing-checklist .print-pagos-banco span[style*="color"] {
                color: #000 !important;
            }
            
            /* Checkbox */
            body.printing-checklist .print-pagos-banco div[style*="border: 2px solid"] {
                border: 2px solid #000 !important;
                background: white !important;
            }
            
            /* Ocultar nota de EPSON en impresión */
            body.printing-checklist .no-print {
                display: none !important;
                visibility: hidden !important;
            }
            
            @page {
                margin: 5mm !important;
                size: letter landscape !important;
            }
        }
        
        /* ========== ESTILOS IMPRESIÓN CENTRO DE REPORTES ========== */
        @media print {
            body.printing-reportes * {
                visibility: hidden !important;
            }
            
            body.printing-reportes .modal-backdrop,
            body.printing-reportes .modal,
            body.printing-reportes .modal-body,
            body.printing-reportes .reporte-print-area,
            body.printing-reportes .reporte-print-area * {
                visibility: visible !important;
            }
            
            body.printing-reportes .modal-backdrop {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                padding: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            body.printing-reportes .modal {
                position: relative !important;
                max-width: 100% !important;
                width: 100% !important;
                max-height: none !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                transform: none !important;
            }
            
            body.printing-reportes .modal-header,
            body.printing-reportes .modal-footer,
            body.printing-reportes .reporte-selector,
            body.printing-reportes .no-print {
                display: none !important;
            }
            
            body.printing-reportes .modal-body {
                padding: 5mm !important;
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            body.printing-reportes .reporte-print-area {
                font-size: 9px !important;
                width: 100% !important;
            }
            
            body.printing-reportes .reporte-print-area table {
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: auto !important;
            }
            
            body.printing-reportes .reporte-print-area tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            body.printing-reportes .reporte-print-area th,
            body.printing-reportes .reporte-print-area td {
                border: 1px solid #333 !important;
                padding: 3px 5px !important;
                font-size: 8px !important;
            }
            
            body.printing-reportes .reporte-print-area th {
                background: #e0e0e0 !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body.printing-reportes .reporte-seccion {
                page-break-inside: avoid !important;
                margin-bottom: 10px !important;
            }
            
            body.printing-reportes .reporte-firmas {
                page-break-inside: avoid !important;
                margin-top: 20px !important;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// =====================================================
// CONFIGURACIÓN DE SHAREPOINT
// =====================================================
const SHAREPOINT_CONFIG = {
    clientId: '2133c50e-ffb4-4793-af2b-385d451b997b', // Client ID de Azure de Tehui
    authority: 'https://login.microsoftonline.com/tehui.onmicrosoft.com', // Tenant de Tehui
    redirectUri: 'https://centrotehui.github.io/boletin/nomina/index.html', // URI fijo registrado en Azure
    scopes: ['User.Read', 'Sites.ReadWrite.All', 'Files.ReadWrite.All'],
    siteName: 'SistemaBoletinTehui',
    siteUrl: 'tehui.sharepoint.com:/sites/SistemaNomina',
    listas: {
        empleados: 'NominaEmpleados',
        prestamos: 'NominaPrestamos',
        licencias: 'NominaLicencias',
        nominas: 'NominaNominas',
        config: 'NominaConfig'
    },
    enabled: true
};

// Cargar MSAL dinámicamente
const loadMSAL = () => {
    return new Promise((resolve, reject) => {
        if (window.msal) { resolve(window.msal); return; }
        const script = document.createElement('script');
        script.src = 'https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js';
        script.onload = () => resolve(window.msal);
        script.onerror = reject;
        document.head.appendChild(script);
    });
};

let msalInstance = null;
let currentAccount = null;

const initMSAL = async () => {
    if (msalInstance) return msalInstance;
    try {
        const msal = await loadMSAL();
        msalInstance = new msal.PublicClientApplication({
            auth: {
                clientId: SHAREPOINT_CONFIG.clientId,
                authority: SHAREPOINT_CONFIG.authority,
                redirectUri: SHAREPOINT_CONFIG.redirectUri
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        });
        await msalInstance.initialize();
        
        // Manejar respuesta de redirección
        try {
            const response = await msalInstance.handleRedirectPromise();
            if (response) {
                currentAccount = response.account;
            }
        } catch (e) {
            console.log('No redirect response');
        }
        
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) currentAccount = accounts[0];
        return msalInstance;
    } catch (e) {
        console.error('Error inicializando MSAL:', e);
        return null;
    }
};

const loginMicrosoft = async () => {
    try {
        const instance = await initMSAL();
        if (!instance) return null;
        
        // Si ya hay una cuenta activa, retornarla sin abrir popup
        if (currentAccount) {
            console.log('Ya hay cuenta activa:', currentAccount.username);
            return currentAccount;
        }
        
        // Verificar si ya hay cuentas en cache
        const accounts = instance.getAllAccounts();
        if (accounts.length > 0) {
            currentAccount = accounts[0];
            console.log('Cuenta encontrada en cache:', currentAccount.username);
            return currentAccount;
        }
        
        // Solo abrir popup si no hay cuenta
        const response = await instance.loginPopup({ scopes: SHAREPOINT_CONFIG.scopes });
        currentAccount = response.account;
        return response.account;
    } catch (e) {
        // Manejar error de interacción en progreso
        if (e.errorCode === 'interaction_in_progress') {
            console.log('Interacción en progreso, esperando...');
            // Esperar un momento y verificar si hay cuenta
            await new Promise(resolve => setTimeout(resolve, 1000));
            const instance = await initMSAL();
            if (instance) {
                const accounts = instance.getAllAccounts();
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    return currentAccount;
                }
            }
            return null;
        }
        console.error('Error en login:', e);
        return null;
    }
};

const logoutMicrosoft = async () => {
    try {
        const instance = await initMSAL();
        if (instance && currentAccount) {
            await instance.logoutPopup({ account: currentAccount });
            currentAccount = null;
        }
    } catch (e) {
        console.error('Error en logout:', e);
    }
};

const getAccessToken = async () => {
    try {
        const instance = await initMSAL();
        if (!instance || !currentAccount) return null;
        const response = await instance.acquireTokenSilent({
            scopes: SHAREPOINT_CONFIG.scopes,
            account: currentAccount
        });
        return response.accessToken;
    } catch (e) {
        try {
            const instance = await initMSAL();
            const response = await instance.acquireTokenPopup({ scopes: SHAREPOINT_CONFIG.scopes });
            return response.accessToken;
        } catch (e2) {
            console.error('Error obteniendo token:', e2);
            return null;
        }
    }
};

const getSharePointSiteId = async (token) => {
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_CONFIG.siteUrl}`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (!response.ok) return null;
        const data = await response.json();
        return data.id;
    } catch (e) {
        console.error('Error obteniendo siteId:', e);
        return null;
    }
};

const getOrCreateList = async (token, siteId, listName, columns) => {
    try {
        // Buscar lista existente - cargar todas y buscar en JavaScript
        const searchResponse = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$top=100`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (searchResponse.ok) {
            const data = await searchResponse.json();
            const existingList = data.value?.find(list => list.displayName === listName);
            if (existingList) return existingList.id;
        }
        
        // Crear lista si no existe
        const createResponse = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists`,
            {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    displayName: listName,
                    columns: columns,
                    list: { template: 'genericList' }
                })
            }
        );
        if (createResponse.ok) {
            const newList = await createResponse.json();
            return newList.id;
        }
        return null;
    } catch (e) {
        console.error('Error con lista:', e);
        return null;
    }
};

// Columnas para cada lista
const COLUMNAS_EMPLEADOS = [
    { name: 'Cedula', text: {} },
    { name: 'Departamento', text: {} },
    { name: 'Cargo', text: {} },
    { name: 'SalarioBase', number: {} },
    { name: 'FechaIngreso', dateTime: {} },
    { name: 'Activo', boolean: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_PRESTAMOS = [
    { name: 'EmpleadoId', number: {} },
    { name: 'Monto', number: {} },
    { name: 'Cuotas', number: {} },
    { name: 'Saldo', number: {} },
    { name: 'Activo', boolean: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_LICENCIAS = [
    { name: 'EmpleadoId', number: {} },
    { name: 'Tipo', text: {} },
    { name: 'FechaInicio', dateTime: {} },
    { name: 'FechaFin', dateTime: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_NOMINAS = [
    { name: 'Periodo', text: {} },
    { name: 'FechaGeneracion', dateTime: {} },
    { name: 'TotalNeto', number: {} },
    { name: 'Estado', text: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_CONFIG = [
    { name: 'TipoConfig', text: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

// Cache para evitar múltiples llamadas
let _spCache = { siteId: null, lists: {}, lastToken: null };

// Sincronización MASIVA - guarda todo en un solo registro
const sincronizarTodoSP = async (empleados, prestamos, licencias, nominas, config, catalogos) => {
    if (!SHAREPOINT_CONFIG.enabled) return { success: false, error: 'SharePoint no habilitado' };
    const token = await getAccessToken();
    if (!token) return { success: false, error: 'No hay token de acceso' };
    
    try {
        console.log('🚀 Iniciando sincronización masiva...');
        
        // Obtener siteId (con caché)
        if (!_spCache.siteId || _spCache.lastToken !== token) {
            console.log('🔍 Obteniendo siteId...');
            _spCache.siteId = await getSharePointSiteId(token);
            _spCache.lastToken = token;
        }
        const siteId = _spCache.siteId;
        if (!siteId) return { success: false, error: 'No se pudo obtener siteId' };
        console.log('✅ SiteId:', siteId);
        
        // Obtener listId de Config (usaremos esta lista para el backup completo)
        if (!_spCache.lists.config) {
            console.log('🔍 Obteniendo lista de configuración...');
            _spCache.lists.config = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.config, COLUMNAS_CONFIG);
        }
        const listId = _spCache.lists.config;
        if (!listId) return { success: false, error: 'No se pudo obtener listId' };
        console.log('✅ ListId:', listId);
        
        // Preparar todos los datos en un solo objeto
        const backupCompleto = {
            version: '3.47',
            fecha: new Date().toISOString(),
            datos: {
                empleados: empleados || [],
                prestamos: prestamos || [],
                licencias: licencias || [],
                nominas: nominas || [],
                config: config || {},
                catalogos: catalogos || {}
            },
            stats: {
                empleados: empleados?.length || 0,
                prestamos: prestamos?.length || 0,
                licencias: licencias?.length || 0,
                nominas: nominas?.length || 0
            }
        };
        
        console.log('📦 Datos preparados:', backupCompleto.stats);
        
        const campos = {
            fields: {
                Title: 'BackupCompleto',
                DatosJSON: JSON.stringify(backupCompleto)
            }
        };
        
        // Buscar si ya existe el backup
        console.log('🔍 Buscando backup existente...');
        const allItemsUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=100`;
        const allResp = await fetch(allItemsUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const allData = await allResp.json();
        
        const existingBackup = allData.value?.find(item => item.fields?.Title === 'BackupCompleto');
        
        if (existingBackup) {
            // Actualizar
            console.log('📝 Actualizando backup existente...');
            const updateResp = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items/${existingBackup.id}`,
                { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
            if (!updateResp.ok) {
                const errorText = await updateResp.text();
                console.error('❌ Error actualizando:', errorText);
                return { success: false, error: `Error ${updateResp.status}: ${errorText}` };
            }
            console.log('✅ Backup actualizado correctamente');
        } else {
            // Crear nuevo
            console.log('📝 Creando nuevo backup...');
            const createResp = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`,
                { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
            if (!createResp.ok) {
                const errorText = await createResp.text();
                console.error('❌ Error creando:', errorText);
                return { success: false, error: `Error ${createResp.status}: ${errorText}` };
            }
            console.log('✅ Backup creado correctamente');
        }
        
        return { success: true, stats: backupCompleto.stats };
    } catch (e) {
        console.error('❌ Error en sincronización:', e);
        return { success: false, error: e.message };
    }
};

// Cargar TODO desde SharePoint
const cargarTodoSP = async () => {
    if (!SHAREPOINT_CONFIG.enabled) return null;
    const token = await getAccessToken();
    if (!token) return null;
    
    try {
        console.log('📥 Cargando datos desde SharePoint...');
        
        if (!_spCache.siteId || _spCache.lastToken !== token) {
            _spCache.siteId = await getSharePointSiteId(token);
            _spCache.lastToken = token;
        }
        const siteId = _spCache.siteId;
        if (!siteId) return null;
        
        if (!_spCache.lists.config) {
            _spCache.lists.config = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.config, COLUMNAS_CONFIG);
        }
        const listId = _spCache.lists.config;
        if (!listId) return null;
        
        const allItemsUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=100`;
        const resp = await fetch(allItemsUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) return null;
        
        const data = await resp.json();
        const backupItem = data.value?.find(item => item.fields?.Title === 'BackupCompleto');
        
        if (backupItem && backupItem.fields?.DatosJSON) {
            const backup = JSON.parse(backupItem.fields.DatosJSON);
            console.log('✅ Datos cargados:', backup.stats);
            return backup.datos;
        }
        
        return null;
    } catch (e) {
        console.error('❌ Error cargando datos:', e);
        return null;
    }
};

// Funciones CRUD SharePoint (mantenidas por compatibilidad pero no usadas)
const guardarEmpleadoSP = async (empleado) => { return true; };
const guardarPrestamoSP = async (prestamo) => { return true; };
const guardarNominaSP = async (nomina) => { return true; };
const guardarConfigSP = async (tipo, datos) => { return true; };
const cargarEmpleadosSP = async () => { return []; };
const cargarPrestamosSP = async () => { return []; };
const cargarNominasSP = async () => { return []; };
const cargarConfigSP = async (tipo) => { return null; };

// =====================================================
// CONFIGURACIÓN INICIAL - LEYES LABORALES RD 2025
// =====================================================
const CONFIG_DEFAULT = {
    tss: {
        afpEmpleado: 2.87, sfsEmpleado: 3.04,
        afpEmpleador: 7.10, sfsEmpleador: 7.09,
        infotep: 1.00, riesgoLaboral: 1.15,
        topeAfp: 485070, topeSfs: 485070,
        pdssPerCapita: 1715.46  // RD$ 1,715.46 mensual por dependiente adicional en SFS
    },
    isr: [
        { min: 0, max: 416220, tasa: 0, fijo: 0 },
        { min: 416220.01, max: 624329, tasa: 15, fijo: 0 },
        { min: 624329.01, max: 867123, tasa: 20, fijo: 31216.35 },
        { min: 867123.01, max: Infinity, tasa: 25, fijo: 79775.15 }
    ],
    general: {
        diasMes: 23.83,
        salarioMinimo: 21000,
        horasExtra35: 35,  // Horas 9-44 semanal
        horasExtra100: 100, // Más de 44, feriados, domingos
        vacacionesDias: 14,
        regaliaMes: 12
    },
    empresa: {
        nombre: 'Centro Educativo de Formación Integral Tehui',
        rnc: '133-03246-5',
        direccion: 'Carretera Don Pedro No. 140, Esq. Las Orquideas',
        telefono: '809-000-0000',
        representante: 'GRUPO PAIDOS, SRL'
    },
    liquidacion: {
        preavisoMeses: { 3: 7, 6: 14, 12: 28 }, // días según antigüedad en meses
        cesantiaDias: { 3: 6, 6: 13, 12: 21, 60: 23 } // días por año según antigüedad
    }
};

// Valores predeterminados para configuración (se pueden modificar en Mantenimiento)
const DEPARTAMENTOS_DEFAULT = ['ADMINISTRACION', 'ASISTENTE', 'DOCENTE', 'MAESTRA INTEGRADORA', 'PROFESOR', 'PSICOLOGIA', 'MANTENIMIENTO', 'COCINA', 'TRANSPORTE', 'SEGURIDAD'];
const BANCOS_DEFAULT = ['Banco Popular Dominicano', 'BHD León', 'Banreservas', 'Scotiabank', 'Banco Santa Cruz', 'Banco Promerica', 'Asociación Popular', 'Banco BDI', 'Banco Caribe', 'Banco Vimenca'];
const TIPOS_CONTRATO_DEFAULT = ['Indefinido', 'Temporal', 'Por Obra', 'Pasantía', 'Prueba'];
const TIPOS_LICENCIA_DEFAULT = ['Maternidad', 'Paternidad', 'Médica', 'Sin Sueldo', 'Duelo', 'Matrimonio', 'Vacaciones'];
const TIPOS_REMUNERACION_DEFAULT = ['Normal', 'Trabajador ocasional (no fijo)', 'Asalariado por hora/día/semana'];
const CARGOS_DEFAULT = ['Docente', 'Asistente', 'Administrativa', 'Psicóloga', 'Mantenimiento', 'Representante', 'Coordinador', 'Director', 'Secretaria', 'Conserje'];
const MESES = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

// =====================================================
// FUNCIONES DE CÁLCULO
// =====================================================
const round2 = n => Math.round(n * 100) / 100;
const formatMoney = n => new Intl.NumberFormat('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
const formatDate = d => d ? new Date(d).toLocaleDateString('es-DO') : '-';
const getInitials = name => name?.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() || '??';
const calcularEdad = (fechaNacimiento) => {
    if (!fechaNacimiento) return null;
    const hoy = new Date();
    const nacimiento = new Date(fechaNacimiento);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();
    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }
    return edad;
};

// Función para eliminar duplicados de nóminas (mantiene la más reciente por código)
const eliminarDuplicadosNominas = (nominas) => {
    if (!nominas || !Array.isArray(nominas)) return [];
    const mapa = new Map();
    // Ordenar por fecha de proceso (más reciente primero) para mantener la última versión
    const ordenadas = [...nominas].sort((a, b) => {
        const fechaA = new Date(a.fechaProceso || a.fechaModificacion || 0);
        const fechaB = new Date(b.fechaProceso || b.fechaModificacion || 0);
        return fechaB - fechaA;
    });
    // Mantener solo la primera ocurrencia (la más reciente)
    ordenadas.forEach(n => {
        if (n.codigo && !mapa.has(n.codigo)) {
            mapa.set(n.codigo, n);
        } else if (!n.codigo) {
            // Para borradores sin código, usar el id
            mapa.set(n.id, n);
        }
    });
    return Array.from(mapa.values());
};

const calcularAntiguedad = (fechaIngreso) => {
    if (!fechaIngreso) return { años: 0, meses: 0, dias: 0 };
    const inicio = new Date(fechaIngreso);
    const hoy = new Date();
    let años = hoy.getFullYear() - inicio.getFullYear();
    let meses = hoy.getMonth() - inicio.getMonth();
    let dias = hoy.getDate() - inicio.getDate();
    if (dias < 0) { meses--; dias += 30; }
    if (meses < 0) { años--; meses += 12; }
    return { años, meses: años * 12 + meses, dias };
};

const calcularTSS = (salario, config) => {
    const topeAfp = Math.min(salario, config.tss.topeAfp);
    const topeSfs = Math.min(salario, config.tss.topeSfs);
    return {
        afpEmp: round2(topeAfp * config.tss.afpEmpleado / 100),
        sfsEmp: round2(topeSfs * config.tss.sfsEmpleado / 100),
        afpPat: round2(topeAfp * config.tss.afpEmpleador / 100),
        sfsPat: round2(topeSfs * config.tss.sfsEmpleador / 100),
        infotep: round2(salario * config.tss.infotep / 100),
        riesgo: round2(salario * config.tss.riesgoLaboral / 100)
    };
};

const calcularISR = (salarioAnualNeto, config) => {
    // En RD los dependientes NO afectan el ISR
    for (const t of config.isr) {
        if (salarioAnualNeto >= t.min && salarioAnualNeto <= t.max) {
            if (t.tasa === 0) return 0;
            return round2((((salarioAnualNeto - t.min) * t.tasa / 100) + t.fijo) / 12);
        }
    }
    return 0;
};

const calcularSalarioDiario = (salarioMensual, config) => round2(salarioMensual / config.general.diasMes);
const calcularSalarioHora = (salarioMensual, config) => round2(calcularSalarioDiario(salarioMensual, config) / 8);

const calcularHorasExtras = (salarioMensual, horas35, horas100, config) => {
    const salarioHora = calcularSalarioHora(salarioMensual, config);
    const extra35 = round2(horas35 * salarioHora * (1 + config.general.horasExtra35 / 100));
    const extra100 = round2(horas100 * salarioHora * (1 + config.general.horasExtra100 / 100));
    return { extra35, extra100, total: round2(extra35 + extra100) };
};

const calcularVacaciones = (salarioMensual, diasVacaciones, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    return round2(salarioDiario * diasVacaciones);
};

const calcularRegalia = (salarioPromedio, mesesTrabajados) => {
    // Regalía = (Salario promedio / 12) * meses trabajados en el año
    return round2((salarioPromedio / 12) * Math.min(mesesTrabajados, 12));
};

const calcularPreaviso = (salarioMensual, mesesAntiguedad, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    let dias = 0;
    if (mesesAntiguedad >= 12) dias = 28;
    else if (mesesAntiguedad >= 6) dias = 14;
    else if (mesesAntiguedad >= 3) dias = 7;
    return { dias, monto: round2(salarioDiario * dias) };
};

const calcularCesantia = (salarioMensual, mesesAntiguedad, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    let diasPorAño = 0;
    if (mesesAntiguedad >= 60) diasPorAño = 23;
    else if (mesesAntiguedad >= 12) diasPorAño = 21;
    else if (mesesAntiguedad >= 6) diasPorAño = 13;
    else if (mesesAntiguedad >= 3) diasPorAño = 6;
    const años = mesesAntiguedad / 12;
    const dias = round2(diasPorAño * años);
    return { diasPorAño, dias, monto: round2(salarioDiario * dias) };
};

const calcularLiquidacion = (empleado, config, motivoSalida = 'despido') => {
    const { meses } = calcularAntiguedad(empleado.fechaIngreso);
    const salario = empleado.salarioBase;
    const salarioDiario = calcularSalarioDiario(salario, config);
    
    // Preaviso (solo si aplica según motivo)
    const preaviso = motivoSalida === 'despido' ? calcularPreaviso(salario, meses, config) : { dias: 0, monto: 0 };
    
    // Cesantía (solo despido injustificado)
    const cesantia = motivoSalida === 'despido' ? calcularCesantia(salario, meses, config) : { dias: 0, monto: 0 };
    
    // Vacaciones no disfrutadas
    const diasVacacionesAcum = Math.floor((meses / 12) * config.general.vacacionesDias);
    const diasVacacionesPend = diasVacacionesAcum - (empleado.vacacionesDisfrutadas || 0);
    const vacaciones = round2(salarioDiario * Math.max(0, diasVacacionesPend));
    
    // Salario pendiente (proporcional del mes)
    const diasPendientes = new Date().getDate();
    const salarioPendiente = round2(salarioDiario * diasPendientes);
    
    // Regalía proporcional
    const mesActual = new Date().getMonth() + 1;
    const regalia = calcularRegalia(salario, mesActual);
    
    return {
        preaviso, cesantia, vacaciones, salarioPendiente, regalia,
        total: round2(preaviso.monto + cesantia.monto + vacaciones + salarioPendiente + regalia)
    };
};

// =====================================================
// ICONOS SVG
// =====================================================
const Icons = {
    Dashboard: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
    Users: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    Dollar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
    FileText: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
    Settings: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
    Plus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Edit: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    Trash: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    X: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    Search: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    Download: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Printer: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
    Calendar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Check: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,6 9,17 4,12"/></svg>,
    Clock: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>,
    CreditCard: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
    AlertCircle: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    Info: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
    Gift: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,12 20,22 4,22 4,12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
    Umbrella: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7"/></svg>,
    UserMinus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
    UserCheck: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17,11 19,13 23,9"/></svg>,
    FileSpreadsheet: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="10" y1="9" x2="10" y2="21"/></svg>,
    Receipt: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1z"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>,
    Save: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>,
    Eye: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    Award: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21,13.89 7,23 12,20 17,23 15.79,13.88"/></svg>,
    Briefcase: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
    Home: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>,
    Activity: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>,
    Cloud: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
    CloudOff: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M7 17H4a4 4 0 0 1 0-8c.5 0 .97.09 1.41.26M16 17h2a5 5 0 0 0 .95-9.9"/><path d="M8.3 8.3A5.98 5.98 0 0 1 16 6c.5 0 .97.06 1.43.17"/></svg>,
    Refresh: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    LogIn: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10,17 15,12 10,7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>,
    LogOut: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
    Lock: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
    User: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
    Database: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
    Tool: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
};

// =====================================================
// COMPONENTES UI
// =====================================================
const Toast = ({ msg, type, onClose }) => {
    useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
    return <div className={`toast ${type}`}><span>{msg}</span></div>;
};

const Modal = ({ open, onClose, title, children, footer, size }) => {
    if (!open) return null;
    return (
        <div className="modal-backdrop" onClick={onClose}>
            <div className={`modal ${size || ''}`} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <span className="modal-title">{title}</span>
                    <button className="modal-close" onClick={onClose}><Icons.X /></button>
                </div>
                <div className="modal-body">{children}</div>
                {footer && <div className="modal-footer">{footer}</div>}
            </div>
        </div>
    );
};

// =====================================================
// COMPONENTE VOLANTE DE PAGO - DISEÑO OPTIMIZADO
// =====================================================
const Volante = ({ emp, det, periodo, config }) => {
    const periodoTxt = periodo.tipo === 'quincenal' 
        ? `${periodo.quincena === 1 ? '01-15' : '16-' + new Date(periodo.año, periodo.mes, 0).getDate()} de ${MESES[periodo.mes]} ${periodo.año}`
        : `${MESES[periodo.mes]} ${periodo.año}`;
    
    return (
        <div className="volante">
            {/* Header compacto: Empresa + Período en una línea */}
            <div className="volante-top">
                <div className="volante-empresa-info">
                    <strong>{config.empresa.nombre}</strong>
                    <span>{config.empresa.direccion} • RNC: {config.empresa.rnc}</span>
                </div>
                <div className="volante-tipo">
                    <strong>VOLANTE DE PAGO</strong>
                    <span>{periodoTxt}</span>
                </div>
            </div>
            
            {/* Nombre del empleado destacado */}
            <div className="volante-nombre-grande">
                {emp.nombre}
            </div>
            
            {/* Datos del empleado en línea horizontal */}
            <div className="volante-datos-linea">
                <div><label>{emp.tipoDocumento === 'pasaporte' ? 'Pasaporte' : 'Cédula'}:</label> <span>{emp.documento}</span></div>
                <div><label>NSS:</label> <span>{emp.nss || 'N/A'}</span></div>
                <div><label>Departamento:</label> <span>{emp.departamento}</span></div>
            </div>
            
            {/* Detalle Ingresos y Deducciones */}
            <div className="volante-detalle">
                <div className="volante-seccion">
                    <h4>INGRESOS</h4>
                    <div className="volante-linea"><span>Salario Base</span><span>RD$ {formatMoney(det.salarioBase)}</span></div>
                    {det.horasExtra > 0 && <div className="volante-linea"><span>Horas Extras</span><span>RD$ {formatMoney(det.horasExtra)}</span></div>}
                    {det.bonificacion > 0 && <div className="volante-linea"><span>Bonificación</span><span>RD$ {formatMoney(det.bonificacion)}</span></div>}
                    {det.comisiones > 0 && <div className="volante-linea"><span>Comisiones</span><span>RD$ {formatMoney(det.comisiones)}</span></div>}
                    {det.incentivos > 0 && <div className="volante-linea"><span>Incentivos</span><span>RD$ {formatMoney(det.incentivos)}</span></div>}
                    {det.viaticos > 0 && <div className="volante-linea"><span>Viáticos</span><span>RD$ {formatMoney(det.viaticos)}</span></div>}
                    {det.vacaciones > 0 && <div className="volante-linea"><span>Vacaciones</span><span>RD$ {formatMoney(det.vacaciones)}</span></div>}
                    {det.regalia > 0 && <div className="volante-linea"><span>Regalía Pascual</span><span>RD$ {formatMoney(det.regalia)}</span></div>}
                    {det.otrosIng > 0 && <div className="volante-linea"><span>Otros Ingresos</span><span>RD$ {formatMoney(det.otrosIng)}</span></div>}
                    <div className="volante-linea total"><span>TOTAL INGRESOS</span><span>RD$ {formatMoney(det.totalIng)}</span></div>
                </div>
                
                <div className="volante-seccion">
                    <h4>DEDUCCIONES</h4>
                    <div className="volante-linea"><span>AFP ({config.tss.afpEmpleado}%)</span><span>RD$ {formatMoney(det.afpEmp)}</span></div>
                    <div className="volante-linea"><span>SFS ({config.tss.sfsEmpleado}%)</span><span>RD$ {formatMoney(det.sfsEmp)}</span></div>
                    {det.isr > 0 && <div className="volante-linea"><span>ISR</span><span>RD$ {formatMoney(det.isr)}</span></div>}
                    {det.pdss > 0 && <div className="volante-linea"><span>PDSS Adicional</span><span>RD$ {formatMoney(det.pdss)}</span></div>}
                    {det.descAusencias > 0 && (
                        <div className="volante-linea volante-ausencias">
                            <span>Ausencias ({det.diasAus} día{det.diasAus > 1 ? 's' : ''}{det.fechasAus?.length > 0 ? `: ${det.fechasAus.map(f => parseInt(f.split('-')[2])).join(', ')}` : ''})</span>
                            <span>RD$ {formatMoney(det.descAusencias)}</span>
                        </div>
                    )}
                    {det.descTardanzas > 0 && <div className="volante-linea"><span>Desc. Tardanzas</span><span>RD$ {formatMoney(det.descTardanzas)}</span></div>}
                    {det.cuotaPrestamo > 0 && <div className="volante-linea"><span>Cuota Préstamo</span><span>RD$ {formatMoney(det.cuotaPrestamo)}</span></div>}
                    {det.cooperativa > 0 && <div className="volante-linea"><span>Cooperativa</span><span>RD$ {formatMoney(det.cooperativa)}</span></div>}
                    {det.seguroPrivado > 0 && <div className="volante-linea"><span>Seguro Médico</span><span>RD$ {formatMoney(det.seguroPrivado)}</span></div>}
                    {det.embargo > 0 && <div className="volante-linea"><span>Embargo/Pensión</span><span>RD$ {formatMoney(det.embargo)}</span></div>}
                    {det.otrasDed > 0 && <div className="volante-linea"><span>Otras Deducciones</span><span>RD$ {formatMoney(det.otrasDed)}</span></div>}
                    <div className="volante-linea total"><span>TOTAL DEDUCCIONES</span><span>RD$ {formatMoney(det.totalDed)}</span></div>
                </div>
            </div>
            
            {/* Pie: NETO + Firmas en una fila */}
            <div className="volante-pie">
                <div className="volante-firma-box">
                    <div className="volante-firma-linea"></div>
                    <span>Firma del Empleado</span>
                </div>
                <div className="volante-neto-box">
                    <label>NETO A RECIBIR</label>
                    <span>RD$ {formatMoney(det.neto)}</span>
                </div>
                <div className="volante-firma-box">
                    <div className="volante-firma-linea"></div>
                    <span>Fecha de Recibido</span>
                </div>
            </div>
        </div>
    );
};

// =====================================================
// CONFIGURACIÓN DE USUARIOS CON 2FA
// =====================================================
const USUARIOS_SISTEMA = {
    admin: { 
        password: 'Tehui@2026', 
        rol: 'admin', 
        nombre: 'Administrador',
        email: 'admin@tehui.edu.do',
        requires2FA: true,
        secreto2FA: null // Se genera en primera configuración
    },
    consulta: { 
        password: 'Ver2026$', 
        rol: 'consulta', 
        nombre: 'Usuario Consulta',
        email: 'consulta@tehui.edu.do',
        requires2FA: true,
        secreto2FA: null
    }
};

// =====================================================
// FUNCIONES DE AUTENTICACIÓN DE DOS FACTORES (2FA/TOTP)
// =====================================================

// Generar secreto aleatorio para TOTP (Base32)
const generarSecreto2FA = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let secreto = '';
    for (let i = 0; i < 32; i++) {
        secreto += chars[Math.floor(Math.random() * chars.length)];
    }
    return secreto;
};

// Decodificar Base32 a bytes
const base32ToBytes = (base32) => {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = '';
    for (let char of base32.toUpperCase().replace(/=+$/, '')) {
        const val = alphabet.indexOf(char);
        if (val === -1) continue;
        bits += val.toString(2).padStart(5, '0');
    }
    const bytes = [];
    for (let i = 0; i + 8 <= bits.length; i += 8) {
        bytes.push(parseInt(bits.substr(i, 8), 2));
    }
    return new Uint8Array(bytes);
};

// HMAC-SHA1 simplificado para TOTP
const hmacSha1 = async (key, message) => {
    const cryptoKey = await crypto.subtle.importKey(
        'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
    );
    const signature = await crypto.subtle.sign('HMAC', cryptoKey, message);
    return new Uint8Array(signature);
};

// Generar código TOTP
const generarTOTP = async (secreto, tiempo = null) => {
    try {
        const key = base32ToBytes(secreto);
        const epoch = tiempo || Math.floor(Date.now() / 1000);
        const counter = Math.floor(epoch / 30);
        
        const counterBytes = new Uint8Array(8);
        let temp = counter;
        for (let i = 7; i >= 0; i--) {
            counterBytes[i] = temp & 0xff;
            temp = Math.floor(temp / 256);
        }
        
        const hmac = await hmacSha1(key, counterBytes);
        const offset = hmac[hmac.length - 1] & 0x0f;
        const code = ((hmac[offset] & 0x7f) << 24 | 
                      (hmac[offset + 1] & 0xff) << 16 | 
                      (hmac[offset + 2] & 0xff) << 8 | 
                      (hmac[offset + 3] & 0xff)) % 1000000;
        
        return code.toString().padStart(6, '0');
    } catch (e) {
        console.error('Error generando TOTP:', e);
        return null;
    }
};

// Validar código TOTP (permite ±1 intervalo por desfase de tiempo)
const validarTOTP = async (secreto, codigo) => {
    const ahora = Math.floor(Date.now() / 1000);
    
    // Verificar código actual y ±1 intervalo (30 segundos)
    for (let offset of [0, -30, 30]) {
        const esperado = await generarTOTP(secreto, ahora + offset);
        if (esperado === codigo) return true;
    }
    return false;
};

// Generar URI para QR de Authenticator
const generarURIAuthenticator = (usuario, secreto, emisor = 'Sistema Nomina Tehui') => {
    const cuenta = encodeURIComponent(`${emisor}:${usuario}`);
    const params = new URLSearchParams({
        secret: secreto,
        issuer: emisor,
        algorithm: 'SHA1',
        digits: '6',
        period: '30'
    });
    return `otpauth://totp/${cuenta}?${params.toString()}`;
};

// Guardar/Cargar secretos 2FA del localStorage
const guardarSecreto2FA = (usuario, secreto) => {
    const secretos = JSON.parse(localStorage.getItem('tehui_2fa_secrets') || '{}');
    secretos[usuario] = secreto;
    localStorage.setItem('tehui_2fa_secrets', JSON.stringify(secretos));
};

const obtenerSecreto2FA = (usuario) => {
    const secretos = JSON.parse(localStorage.getItem('tehui_2fa_secrets') || '{}');
    return secretos[usuario] || null;
};

const tiene2FAConfigurado = (usuario) => {
    return obtenerSecreto2FA(usuario) !== null;
};

// =====================================================
// FUNCIONES DE CÓDIGO POR EMAIL (EmailJS)
// =====================================================
const EMAILJS_CONFIG = {
    serviceId: 'service_1944u1j',
    templateId: 'template_sn7v16n',
    publicKey: 't9mcT2kCIkd4kamkr'
};

// Inicializar EmailJS
try {
    emailjs.init(EMAILJS_CONFIG.publicKey);
    console.log('✅ EmailJS inicializado');
} catch (e) {
    console.log('⚠️ EmailJS no disponible:', e);
}

// Almacenamiento temporal de códigos por email (en memoria)
const codigosEmailTemp = {};

// Generar código aleatorio de 6 dígitos
const generarCodigoEmail = () => {
    return Math.floor(100000 + Math.random() * 900000).toString();
};

// Enviar código por email
const enviarCodigoEmail = async (usuario, email) => {
    const codigo = generarCodigoEmail();
    const expiracion = Date.now() + (5 * 60 * 1000); // 5 minutos
    
    // Guardar código temporalmente
    codigosEmailTemp[usuario] = { codigo, expiracion };
    
    try {
        const response = await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            {
                to_name: USUARIOS_SISTEMA[usuario]?.nombre || usuario,
                to_email: email,
                codigo: codigo
            }
        );
        console.log('✅ Código enviado por email:', response.status);
        return { success: true, message: 'Código enviado a ' + email };
    } catch (error) {
        console.error('❌ Error enviando email:', error);
        return { success: false, message: 'Error al enviar el código: ' + error.text };
    }
};

// Validar código por email
const validarCodigoEmail = (usuario, codigo) => {
    const datos = codigosEmailTemp[usuario];
    if (!datos) return false;
    
    // Verificar expiración
    if (Date.now() > datos.expiracion) {
        delete codigosEmailTemp[usuario];
        return false;
    }
    
    // Verificar código
    if (datos.codigo === codigo) {
        delete codigosEmailTemp[usuario]; // Usar solo una vez
        return true;
    }
    
    return false;
};

// =====================================================
// APLICACIÓN PRINCIPAL
// =====================================================

const App = () => {
    // =====================================================
    // AUTENTICACIÓN DE USUARIO CON 2FA
    // =====================================================
    const [usuarioActual, setUsuarioActual] = useState(() => {
        try {
            const saved = sessionStorage.getItem('tehui_nomina_session');
            return saved ? JSON.parse(saved) : null;
        } catch { return null; }
    });
    const [loginForm, setLoginForm] = useState({ usuario: '', password: '', error: '' });
    const [mostrarCambioPassword, setMostrarCambioPassword] = useState(false);
    const [cambioPasswordForm, setCambioPasswordForm] = useState({ actual: '', nueva: '', confirmar: '', error: '' });
    
    // Estados para 2FA
    const [paso2FA, setPaso2FA] = useState(null); // null, 'verificar', 'configurar', 'email'
    const [codigo2FA, setCodigo2FA] = useState('');
    const [error2FA, setError2FA] = useState('');
    const [secretoTemp, setSecretoTemp] = useState(null);
    const [usuarioTemp, setUsuarioTemp] = useState(null);
    const [qrGenerado, setQrGenerado] = useState(false);
    
    // Estados para código por email
    const [enviandoEmail, setEnviandoEmail] = useState(false);
    const [mensajeEmail, setMensajeEmail] = useState('');

    // Generar QR cuando se configura 2FA
    useEffect(() => {
        if (paso2FA === 'configurar' && secretoTemp && !qrGenerado) {
            setTimeout(() => {
                const qrContainer = document.getElementById('qr-2fa-container');
                if (qrContainer) {
                    qrContainer.innerHTML = '';
                    const uri = generarURIAuthenticator(usuarioTemp, secretoTemp);
                    new QRCode(qrContainer, {
                        text: uri,
                        width: 200,
                        height: 200,
                        colorDark: '#1565C0',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    setQrGenerado(true);
                }
            }, 100);
        }
    }, [paso2FA, secretoTemp, qrGenerado, usuarioTemp]);

    // Función para cambiar contraseña (solo muestra mensaje informativo)
    const handleCambioPassword = (e) => {
        e.preventDefault();
        const { actual, nueva, confirmar } = cambioPasswordForm;
        
        if (!actual || !nueva || !confirmar) {
            setCambioPasswordForm(prev => ({ ...prev, error: 'Todos los campos son requeridos' }));
            return;
        }
        if (nueva !== confirmar) {
            setCambioPasswordForm(prev => ({ ...prev, error: 'Las contraseñas no coinciden' }));
            return;
        }
        if (nueva.length < 6) {
            setCambioPasswordForm(prev => ({ ...prev, error: 'La contraseña debe tener al menos 6 caracteres' }));
            return;
        }
        
        // Simular cambio exitoso (en producción se conectaría a un backend)
        alert('Funcionalidad de cambio de contraseña: En un entorno de producción, esto actualizaría la contraseña en el servidor.');
        setMostrarCambioPassword(false);
        setCambioPasswordForm({ actual: '', nueva: '', confirmar: '', error: '' });
    };

    // Login de usuario del sistema CON 2FA
    const handleUserLogin = async (e) => {
        e.preventDefault();
        const { usuario, password } = loginForm;
        const userKey = usuario.toLowerCase().trim();
        const user = USUARIOS_SISTEMA[userKey];
        
        if (user && user.password === password) {
            // Credenciales correctas, verificar si necesita 2FA
            if (user.requires2FA) {
                setUsuarioTemp(userKey);
                
                if (tiene2FAConfigurado(userKey)) {
                    // Ya tiene 2FA configurado, pedir código
                    setPaso2FA('verificar');
                    setCodigo2FA('');
                    setError2FA('');
                } else {
                    // Primera vez, configurar 2FA
                    const nuevoSecreto = generarSecreto2FA();
                    setSecretoTemp(nuevoSecreto);
                    setPaso2FA('configurar');
                    setQrGenerado(false);
                    setCodigo2FA('');
                    setError2FA('');
                }
            } else {
                // No requiere 2FA, login directo
                completarLogin(userKey, user);
            }
        } else {
            setLoginForm(prev => ({ ...prev, error: 'Usuario o contraseña incorrectos' }));
        }
    };
    
    // Verificar código 2FA
    const handleVerificar2FA = async (e) => {
        e.preventDefault();
        setError2FA('');
        
        const secreto = paso2FA === 'configurar' ? secretoTemp : obtenerSecreto2FA(usuarioTemp);
        
        if (!secreto) {
            setError2FA('Error de configuración. Intente nuevamente.');
            return;
        }
        
        const esValido = await validarTOTP(secreto, codigo2FA);
        
        if (esValido) {
            // Si estaba configurando, guardar el secreto
            if (paso2FA === 'configurar') {
                guardarSecreto2FA(usuarioTemp, secretoTemp);
            }
            
            // Completar login
            const user = USUARIOS_SISTEMA[usuarioTemp];
            completarLogin(usuarioTemp, user);
            
            // Limpiar estados 2FA
            setPaso2FA(null);
            setCodigo2FA('');
            setSecretoTemp(null);
            setUsuarioTemp(null);
            setQrGenerado(false);
        } else {
            setError2FA('Código incorrecto. Verifique e intente nuevamente.');
            setCodigo2FA('');
        }
    };
    
    // Cancelar proceso 2FA
    const cancelar2FA = () => {
        setPaso2FA(null);
        setCodigo2FA('');
        setError2FA('');
        setSecretoTemp(null);
        setUsuarioTemp(null);
        setQrGenerado(false);
        setMensajeEmail('');
        setLoginForm({ usuario: '', password: '', error: '' });
    };
    
    // Enviar código por email como alternativa a Authenticator
    const handleEnviarCodigoEmail = async () => {
        const userKey = usuarioTemp || loginForm.usuario.toLowerCase().trim();
        const user = USUARIOS_SISTEMA[userKey];
        
        if (!user || !user.email) {
            setError2FA('No hay email configurado para este usuario');
            return;
        }
        
        setEnviandoEmail(true);
        setError2FA('');
        setMensajeEmail('');
        
        const resultado = await enviarCodigoEmail(userKey, user.email);
        
        setEnviandoEmail(false);
        
        if (resultado.success) {
            setUsuarioTemp(userKey);
            setPaso2FA('email');
            setMensajeEmail(resultado.message);
            setCodigo2FA('');
        } else {
            setError2FA(resultado.message);
        }
    };
    
    // Verificar código enviado por email
    const handleVerificarCodigoEmail = async (e) => {
        e.preventDefault();
        setError2FA('');
        
        const esValido = validarCodigoEmail(usuarioTemp, codigo2FA);
        
        if (esValido) {
            // Completar login
            const user = USUARIOS_SISTEMA[usuarioTemp];
            completarLogin(usuarioTemp, user);
            
            // Limpiar estados
            setPaso2FA(null);
            setCodigo2FA('');
            setUsuarioTemp(null);
            setMensajeEmail('');
        } else {
            setError2FA('Código incorrecto o expirado. El código expira en 5 minutos.');
            setCodigo2FA('');
        }
    };
    
    // Completar login exitoso
    const completarLogin = (userKey, user) => {
        const session = { usuario: userKey, rol: user.rol, nombre: user.nombre };
        setUsuarioActual(session);
        sessionStorage.setItem('tehui_nomina_session', JSON.stringify(session));
        setLoginForm({ usuario: '', password: '', error: '' });
        
        // Registrar acceso
        registrarAcceso(userKey, 'login');
        
        // ⭐ CONEXIÓN AUTOMÁTICA A SHAREPOINT (con delay mayor para evitar conflictos)
        setTimeout(async () => {
            try {
                console.log('Intentando conexión automática a SharePoint...');
                const account = await loginMicrosoft();
                if (account) {
                    setMsUser(account);
                    setSpConnected(true);
                    toast('✅ Conectado a SharePoint automáticamente', 'success');
                    cargarDatosSharePoint();
                } else {
                    console.log('No se pudo conectar automáticamente, cargando datos locales');
                    cargarDatosLocales();
                }
            } catch (e) {
                console.log('Auto-conexión SharePoint:', e.message);
                cargarDatosLocales();
            }
        }, 1500); // Aumentado a 1.5 segundos para dar tiempo a que se complete cualquier interacción
    };
    
    // Registro de accesos (auditoría)
    const registrarAcceso = (usuario, tipo) => {
        const registros = JSON.parse(localStorage.getItem('tehui_audit_log') || '[]');
        registros.push({
            usuario,
            tipo,
            fecha: new Date().toISOString(),
            ip: 'local',
            userAgent: navigator.userAgent.substring(0, 100)
        });
        // Mantener solo los últimos 100 registros
        if (registros.length > 100) registros.shift();
        localStorage.setItem('tehui_audit_log', JSON.stringify(registros));
    };

    // Logout de usuario del sistema
    const handleUserLogout = () => {
        if (window.confirm('¿Está seguro que desea cerrar sesión?')) {
            setUsuarioActual(null);
            sessionStorage.removeItem('tehui_nomina_session');
        }
    };

    // Estados de UI
    const [toasts, setToasts] = useState([]);
    const [loading, setLoading] = useState(false);
    const [modoImpresionNomina, setModoImpresionNomina] = useState(false);
    const [tipoReporteActivo, setTipoReporteActivo] = useState(null); // Para el sistema de reportes
    
    // Funciones de Toast
    const toast = (msg, type = 'info') => setToasts(p => [...p, { id: Date.now(), msg, type }]);
    const removeToast = id => setToasts(p => p.filter(t => t.id !== id));
    
    // Estados
    const [view, setView] = useState('dashboard');
    const [config, setConfig] = useState(CONFIG_DEFAULT);
    const [empleados, setEmpleados] = useState([]);
    const [prestamos, setPrestamos] = useState([]);
    const [licencias, setLicencias] = useState([]);
    const [nominas, setNominas] = useState([]);
    const [datosInicializados, setDatosInicializados] = useState(false); // Flag para evitar sobrescribir localStorage al inicio
    const [currentNomina, setCurrentNomina] = useState(null);
    const [nominaEdits, setNominaEdits] = useState({});
    const [searchTerm, setSearchTerm] = useState('');
    const [filterDept, setFilterDept] = useState('TODOS');
    const [filterEstado, setFilterEstado] = useState('ACTIVOS');
    
    // Estados de Configuración del Sistema (Mantenimiento)
    const [catalogos, setCatalogos] = useState({
        departamentos: DEPARTAMENTOS_DEFAULT,
        bancos: BANCOS_DEFAULT,
        tiposContrato: TIPOS_CONTRATO_DEFAULT,
        tiposLicencia: TIPOS_LICENCIA_DEFAULT,
        tiposRemuneracion: TIPOS_REMUNERACION_DEFAULT,
        cargos: CARGOS_DEFAULT
    });
    const [catalogoActivo, setCatalogoActivo] = useState('departamentos');
    const [nuevoItem, setNuevoItem] = useState('');
    const [editandoItem, setEditandoItem] = useState(null);
    
    // Accesos rápidos a catálogos
    const DEPARTAMENTOS = catalogos.departamentos;
    const BANCOS = catalogos.bancos;
    const TIPOS_CONTRATO = catalogos.tiposContrato;
    const TIPOS_LICENCIA = catalogos.tiposLicencia;
    const TIPOS_REMUNERACION = catalogos.tiposRemuneracion;
    const CARGOS = catalogos.cargos;
    
    // Estados SharePoint
    const [msUser, setMsUser] = useState(null);
    const [syncStatus, setSyncStatus] = useState({ syncing: false, lastSync: null, error: null });
    const [spConnected, setSpConnected] = useState(false);
    
    // Modales
    const [modals, setModals] = useState({
        empleado: false, prestamo: false, licencia: false, liquidacion: false,
        volantes: false, constancia: false, config: false, ausencias: false, pagosBanco: false,
        reportes: false // Modal de Centro de Reportes
    });
    const [editingEmp, setEditingEmp] = useState(null);
    const [selectedEmp, setSelectedEmp] = useState(null);
    const [selectedVolante, setSelectedVolante] = useState(null);
    const [ausenciasEmpId, setAusenciasEmpId] = useState(null); // Empleado seleccionado para registrar ausencias
    
    // Forms
    const empFormInit = { nombre: '', tipoDocumento: 'cedula', documento: '', nss: '', departamento: 'DOCENTE', cargo: '', salarioBase: '', tipoRemuneracion: 'Normal', fechaIngreso: '', fechaSalida: '', motivoSalida: '', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '', telefono: '', direccion: '', fechaNacimiento: '', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana' };
    const [empForm, setEmpForm] = useState(empFormInit);
    const [prestamoForm, setPrestamoForm] = useState({ empleadoId: '', monto: '', cuotas: '', desc: '', fecha: '' });
    const [editingPrestamo, setEditingPrestamo] = useState(null);
    const [licenciaForm, setLicenciaForm] = useState({ empleadoId: '', tipo: 'Vacaciones', fechaInicio: '', fechaFin: '', conPago: true, notas: '' });
    const [periodo, setPeriodo] = useState({ tipo: 'quincenal', mes: new Date().getMonth() + 1, año: new Date().getFullYear(), quincena: new Date().getDate() <= 15 ? 1 : 2 });
    const [liquidacionData, setLiquidacionData] = useState(null);

    // Init - solo cargar datos locales, SharePoint será manual
    useEffect(() => { 
        initMSAL().then(() => {
            if (currentAccount) {
                setMsUser(currentAccount);
                setSpConnected(true);
            }
            // Siempre cargar datos locales primero (es instantáneo)
            cargarDatosLocales();
        });
    }, []);

    // Login Microsoft - solo autenticar, no cargar datos
    const handleLogin = async () => {
        setLoading(true);
        try {
            const account = await loginMicrosoft();
            if (account) {
                setMsUser(account);
                setSpConnected(true);
                toast('✅ Conectado a Microsoft 365. Los datos se sincronizarán automáticamente.', 'success');
            } else {
                toast('No se pudo conectar', 'error');
            }
        } catch (e) {
            toast('Error al conectar: ' + e.message, 'error');
        }
        setLoading(false);
    };

    // Logout Microsoft
    const handleLogout = async () => {
        await logoutMicrosoft();
        setMsUser(null);
        setSpConnected(false);
        toast('Sesión cerrada', 'warning');
    };

    // Cargar datos desde SharePoint
    const cargarDatosSharePoint = async () => {
        setLoading(true);
        setSyncStatus(s => ({ ...s, syncing: true, error: null }));
        try {
            // Cargar TODO en una sola llamada
            const datos = await cargarTodoSP();
            
            if (datos) {
                if (datos.empleados?.length > 0) setEmpleados(datos.empleados);
                if (datos.prestamos?.length > 0) setPrestamos(datos.prestamos);
                if (datos.licencias?.length > 0) setLicencias(datos.licencias);
                if (datos.nominas?.length > 0) setNominas(eliminarDuplicadosNominas(datos.nominas));
                if (datos.config) setConfig(prev => ({ ...prev, ...datos.config }));
                if (datos.catalogos) setCatalogos(prev => ({ ...prev, ...datos.catalogos }));
                
                setSyncStatus({ syncing: false, lastSync: new Date(), error: null });
                setDatosInicializados(true);
                toast('✅ Datos cargados desde SharePoint', 'success');
            } else {
                // Si no hay datos en SP, cargar locales
                cargarDatosLocales();
                toast('📁 Sin datos en SharePoint, usando datos locales', 'info');
            }
        } catch (e) {
            setSyncStatus(s => ({ ...s, syncing: false, error: e.message }));
            toast('Error al cargar datos: ' + e.message, 'error');
            cargarDatosLocales();
        }
        setLoading(false);
    };

    // Sincronizar todo con SharePoint
    const sincronizarConSharePoint = async () => {
        if (!spConnected) {
            toast('Conecte con Microsoft primero', 'warning');
            return;
        }
        
        setLoading(true);
        setSyncStatus(s => ({ ...s, syncing: true }));
        
        try {
            // Usar sincronización masiva - UN SOLO registro con todo
            const resultado = await sincronizarTodoSP(empleados, prestamos, licencias, nominas, config, catalogos);
            
            if (resultado.success) {
                setSyncStatus({ syncing: false, lastSync: new Date(), error: null });
                toast(`✅ Sincronización completa: ${resultado.stats.empleados} empleados, ${resultado.stats.prestamos} préstamos`, 'success');
            } else {
                setSyncStatus({ syncing: false, lastSync: null, error: resultado.error });
                toast(`❌ Error: ${resultado.error}`, 'error');
            }
        } catch (e) {
            setSyncStatus(s => ({ ...s, syncing: false, error: e.message }));
            toast('Error en sincronización: ' + e.message, 'error');
        }
        setLoading(false);
    };

    // === PERSISTENCIA LOCAL (localStorage) ===
    const STORAGE_KEYS = {
        empleados: 'nominaTehui_empleados',
        prestamos: 'nominaTehui_prestamos',
        licencias: 'nominaTehui_licencias',
        nominas: 'nominaTehui_nominas',
        config: 'nominaTehui_config',
        catalogos: 'nominaTehui_catalogos'
    };

    const guardarEnLocal = (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Error guardando en localStorage:', e);
            return false;
        }
    };

    const cargarDeLocal = (key) => {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('Error cargando de localStorage:', e);
            return null;
        }
    };

    // Mapa MAESTRO completo de empleados (para migración de TODOS los campos)
    const DATOS_MAESTROS_EMPLEADOS = {
        '175008483': { banco: 'BHD León', cuenta: '30646860016', celular: '(829)-943-5474' },
        '031-0175106-7': { banco: 'ACAP', cuenta: '100020364950', celular: '(829)-458-1808' },
        '504587447': { banco: 'ACAP', cuenta: '100070133430', celular: '(829)-487-8039' },
        '104587395': { banco: 'Banreservas', cuenta: '9603026315', celular: '(809)-458-5099' },
        '094-0020547-3': { banco: 'Banreservas', cuenta: '9605795967', celular: '(829)-573-0980' },
        '402-3169217-5': { banco: 'Banco Popular', cuenta: '839042439', celular: '(809)-873-8758' },
        '224-0007033-4': { banco: 'BHD León', cuenta: '10254060011', celular: '(829)-728-4267' },
        '031-0243772-4': { banco: 'Banreservas', cuenta: '0301699601', celular: '(849)-330-9533' },
        '094375613': { banco: 'ACAP', cuenta: '100070137044', celular: '(809)-905-8926' },
        '402-2237446-0': { banco: 'BHD León', cuenta: '21187240014', celular: '(809)-669-8573' },
        '039-0024840-6': { banco: 'Banreservas', cuenta: '9603679466', celular: '(829)-961-1568' },
        '054868674': { banco: 'ACAP', cuenta: '100160157346', celular: '(829)-704-1687' },
        '402-1000810-4': { banco: 'BHD León', cuenta: '34257050021', celular: '(849)-851-1404' },
        '402-0961340-1': { banco: 'ACAP', cuenta: '100250066064', celular: '(809)-441-1708' },
        '402-1922127-8': { banco: 'ACAP', cuenta: '100020384390', celular: '(809)-457-3893' },
        '402-2631749-9': { banco: 'ACAP', cuenta: '100160144856', celular: '(829)-928-5968' },
        '031-0343936-4': { banco: 'ACAP', cuenta: '100070141726', celular: '(809)-204-3613' },
        '402-1546613-3': { banco: 'Banreservas', cuenta: '9608741088', celular: '(809)-276-7456' },
        '032-0031709-1': { banco: 'Banreservas', cuenta: '9608740924', celular: '(809)-216-5228' },
        '402-1106253-0': { banco: 'Banreservas', cuenta: '1202330765', celular: '(849)-394-4074' },
        '031-0073915-4': { banco: '', cuenta: '', celular: '' },
        '402-2280604-0': { banco: 'Banco Popular', cuenta: '826465213', celular: '(809)-798-7037' },
        '174630184': { banco: 'Banreservas', cuenta: '9600189996', celular: '(809)-340-7473' },
        '031-0410964-4': { banco: 'BHD León', cuenta: '34530350016', celular: '(809)-665-3875' },
        '176883175': { banco: 'Banreservas', cuenta: '2450373494', celular: '(829)-835-0189' },
        '031-0408757-6': { banco: 'Banreservas', cuenta: '9607586638', celular: '(829)-891-2449' },
        '031-0306511-0': { banco: 'ACAP', cuenta: '100070092512', celular: '(809)-277-4604' },
        '031-0278033-9': { banco: 'Banco Popular', cuenta: '852048115', celular: '(809)-910-4181' },
    };

    // Cargar datos locales (empleados reales del Centro Tehui - SUIR TSS)
    const cargarDatosLocales = () => {
        setLoading(true);
        setTimeout(() => {
            // Intentar cargar de localStorage primero
            const empsLocal = cargarDeLocal(STORAGE_KEYS.empleados);
            const prestsLocal = cargarDeLocal(STORAGE_KEYS.prestamos);
            const licsLocal = cargarDeLocal(STORAGE_KEYS.licencias);
            const nominasLocal = cargarDeLocal(STORAGE_KEYS.nominas);
            const configLocal = cargarDeLocal(STORAGE_KEYS.config);
            const catalogosLocal = cargarDeLocal(STORAGE_KEYS.catalogos);

            // Función para normalizar empleados (agregar campos faltantes y FORZAR migrar datos)
            const normalizarEmpleado = (emp) => {
                // SIEMPRE buscar datos en el mapa maestro por documento
                const datosMaestros = DATOS_MAESTROS_EMPLEADOS[emp.documento] || null;
                
                // Si encontramos datos en el mapa maestro, usarlos (tienen prioridad)
                const bancoFinal = datosMaestros ? datosMaestros.banco : (emp.banco || '');
                const cuentaFinal = datosMaestros ? datosMaestros.cuenta : (emp.cuenta || '');
                const celularFinal = datosMaestros && datosMaestros.celular ? datosMaestros.celular : (emp.celular || '');
                
                return {
                    celular: '', telefono: '', direccion: '', fechaNacimiento: '', 
                    estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', 
                    fechaSalida: '', motivoSalida: '',
                    dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0,
                    ...emp,  // Los datos existentes sobrescriben los valores por defecto
                    // Forzar datos desde mapa maestro si existen
                    banco: bancoFinal,
                    cuenta: cuentaFinal,
                    celular: celularFinal,
                };
            };
            
            // Si hay datos en localStorage, usarlos
            if (empsLocal && empsLocal.length > 0) {
                console.log('Cargando datos de localStorage...');
                const empsNormalizados = empsLocal.map(normalizarEmpleado);
                // Verificar si se actualizaron datos
                const datosActualizados = empsNormalizados.filter((e, i) => {
                    const empOriginal = empsLocal[i];
                    return e.banco !== empOriginal.banco || 
                           e.cuenta !== empOriginal.cuenta ||
                           e.celular !== empOriginal.celular;
                }).length;
                setEmpleados(empsNormalizados);
                setPrestamos(prestsLocal || []);
                setLicencias(licsLocal || []);
                setNominas(eliminarDuplicadosNominas(nominasLocal || []));
                if (configLocal) setConfig(configLocal);
                if (catalogosLocal) setCatalogos(catalogosLocal);
                setLoading(false);
                console.log('Habilitando persistencia automática...');
                setDatosInicializados(true); // Habilitar guardado automático
                if (datosActualizados > 0) {
                    toast(`Datos cargados. ${datosActualizados} empleados actualizados (bancos, celulares).`, 'success');
                    console.log(`Empleados actualizados: ${datosActualizados}`);
                } else {
                    toast('Datos cargados de almacenamiento local', 'success');
                }
                return;
            }

            // Si no hay datos en localStorage, usar los datos por defecto
            const emps = [
                { id: 1, nombre: 'Carreño Leon, Maria De Jesús', tipoDocumento: 'cedula', documento: '175008483', nss: '19021577-1', departamento: 'PROFESOR', cargo: 'MAESTRA DE ARTE', salarioBase: 18000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-05-06', tipoContrato: 'Indefinido', banco: 'BHD León', cuenta: '30646860016', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-943-5474', telefono: '', direccion: '', fechaNacimiento: '2003-03-20', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 2, nombre: 'Castillo Matta, Zeneida', tipoDocumento: 'cedula', documento: '031-0175106-7', nss: '03715559-5', departamento: 'ADMINISTRACION', cargo: 'LIMPIEZA', salarioBase: 6500, tipoRemuneracion: 'Trabajador ocasional (no fijo)', fechaIngreso: '2006-07-15', tipoContrato: 'Temporal', banco: 'ACAP', cuenta: '100020364950', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-458-1808', telefono: '', direccion: '', fechaNacimiento: '1974-06-12', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
                { id: 3, nombre: 'Fuentes De Garcia, Cary Roxana', tipoDocumento: 'cedula', documento: '504587447', nss: '18396764-2', departamento: 'PROFESOR', cargo: 'MAESTRA CUARTO PRIMARIA', salarioBase: 20000, tipoRemuneracion: 'Normal', fechaIngreso: '2022-08-01', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100070133430', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-487-8039', telefono: '', direccion: '', fechaNacimiento: '1977-06-25', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 4, nombre: 'Garcia Fuentes, Roxana Josefina', tipoDocumento: 'pasaporte', documento: '104587395', nss: '', departamento: 'PROFESOR', cargo: 'MAESTRA PRIMARIA', salarioBase: 25000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-08-05', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9603026315', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-458-5099', telefono: '', direccion: '', fechaNacimiento: '1999-06-19', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 5, nombre: 'Hernandez Cabrera, Ramona Altagracia', tipoDocumento: 'cedula', documento: '094-0020547-3', nss: '05699203-1', departamento: 'PROFESOR', cargo: 'PSICOLOGA', salarioBase: 20000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-05-01', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9605795967', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-573-0980', telefono: '', direccion: '', fechaNacimiento: '1983-12-10', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 6, nombre: 'Jimaquen Garcia, Lucelis Beatriz', tipoDocumento: 'cedula', documento: '402-3169217-5', nss: '18621595-0', departamento: 'PROFESOR', cargo: 'PROFESORA DE INGLES', salarioBase: 19000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-08-05', tipoContrato: 'Indefinido', banco: 'Banco Popular', cuenta: '839042439', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-873-8758', telefono: '', direccion: '', fechaNacimiento: '2005-12-10', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 7, nombre: 'Jimenez Cuevas, Ingrid Ivelisse', tipoDocumento: 'cedula', documento: '224-0007033-4', nss: '05571827-1', departamento: 'ASISTENTE', cargo: 'ASISTENTE MAESTRA TERCERO', salarioBase: 15000, tipoRemuneracion: 'Asalariado por hora/día/semana', fechaIngreso: '2025-10-20', tipoContrato: 'Por obra', banco: 'BHD León', cuenta: '10254060011', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-728-4267', telefono: '', direccion: '', fechaNacimiento: '1985-12-02', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 8, nombre: 'Jimenez Tavarez, Javier Arturo', tipoDocumento: 'cedula', documento: '031-0243772-4', nss: '03503956-2', departamento: 'PROFESOR', cargo: 'PROFESOR EDUCACION FISICA', salarioBase: 10000, tipoRemuneracion: 'Trabajador ocasional (no fijo)', fechaIngreso: '2021-10-15', tipoContrato: 'Temporal', banco: 'Banreservas', cuenta: '0301699601', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(849)-330-9533', telefono: '', direccion: '', fechaNacimiento: '1965-06-16', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 9, nombre: 'Lucena Villalobos, Yusmary Chiquinquira', tipoDocumento: 'cedula', documento: '094375613', nss: '18217801-7', departamento: 'PROFESOR', cargo: 'MAESTRA 1ER GRADO PRIMARIA', salarioBase: 19000, tipoRemuneracion: 'Normal', fechaIngreso: '2022-11-15', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100070137044', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-905-8926', telefono: '', direccion: '', fechaNacimiento: '1977-12-29', estadoCivil: 'Soltero/a', nacionalidad: 'Venezolana', tipoEmpleado: 'Profesor' },
                { id: 10, nombre: 'Medina, Melisa', tipoDocumento: 'cedula', documento: '039-0024840-6', nss: '07527950-2', departamento: 'PROFESOR', cargo: 'MAESTRA PRIMARIA', salarioBase: 18000, tipoRemuneracion: 'Normal', fechaIngreso: '2024-11-11', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9603679466', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-815-0735', telefono: '', direccion: '', fechaNacimiento: '1992-06-15', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 11, nombre: 'Mencia Mencia, Alba Iris', tipoDocumento: 'cedula', documento: '402-2237446-0', nss: '07683312-7', departamento: 'PROFESOR', cargo: 'MAESTRA TITULAR PRE-KINDER', salarioBase: 25000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-09-22', tipoContrato: 'Indefinido', banco: 'BHD León', cuenta: '21187240014', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-312-7558', telefono: '', direccion: '', fechaNacimiento: '1992-08-12', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 12, nombre: 'Millan, Diorelys Del Valle', tipoDocumento: 'pasaporte', documento: '054868674', nss: '', departamento: 'ASISTENTE', cargo: 'ASISTENTE NIVEL INICIAL', salarioBase: 18000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-05-06', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100160157346', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-704-1687', telefono: '', direccion: '', fechaNacimiento: '1979-09-08', estadoCivil: 'Soltero/a', nacionalidad: 'Venezolana', tipoEmpleado: 'Empleado' },
                { id: 13, nombre: 'Nuñez Sosa, Denzel Gabriel', tipoDocumento: 'cedula', documento: '402-1000810-4', nss: '07395851-2', departamento: 'PROFESOR', cargo: 'PROFESOR DE MUSICA', salarioBase: 11426.47, tipoRemuneracion: 'Asalariado por hora/día/semana', fechaIngreso: '2025-09-02', tipoContrato: 'Por obra', banco: 'BHD León', cuenta: '34257050021', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(849)-851-1404', telefono: '', direccion: '', fechaNacimiento: '2004-09-14', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 14, nombre: 'Paulino Paulino, Gabriela', tipoDocumento: 'cedula', documento: '402-0961340-1', nss: '17867486-3', departamento: 'MAESTRA INTEGRADORA', cargo: 'MAESTRA INTEGRADORA INICIAL', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2024-03-01', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100250066064', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-441-1708', telefono: '', direccion: '', fechaNacimiento: '2005-06-07', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 15, nombre: 'Peralta Mendoza, Daniela', tipoDocumento: 'cedula', documento: '402-1922127-8', nss: '09098043-1', departamento: 'PSICOLOGIA', cargo: 'MAESTRA INTEGRADORA', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2024-03-01', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100020384390', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-457-3893', telefono: '', direccion: '', fechaNacimiento: '2000-11-03', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 16, nombre: 'Perez Ramos, Valerin Mariel', tipoDocumento: 'cedula', documento: '402-2631749-9', nss: '16110843-2', departamento: 'PROFESOR', cargo: 'MAESTRA PRIMARIA SOCIALES', salarioBase: 18000, tipoRemuneracion: 'Normal', fechaIngreso: '2023-07-17', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100160144856', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-928-5968', telefono: '', direccion: '', fechaNacimiento: '1996-06-07', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
                { id: 17, nombre: 'Pichardo Quezada, Ana Rosa', tipoDocumento: 'cedula', documento: '031-0343936-4', nss: '03632048-7', departamento: 'ASISTENTE', cargo: 'CONSERJE', salarioBase: 10000, tipoRemuneracion: 'Trabajador ocasional (no fijo)', fechaIngreso: '2024-08-14', tipoContrato: 'Temporal', banco: 'ACAP', cuenta: '100070141726', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-204-3613', telefono: '', direccion: '', fechaNacimiento: '1974-07-10', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
                { id: 18, nombre: 'Ramos Santana, Emely Altagracia', tipoDocumento: 'cedula', documento: '402-1546613-3', nss: '17399380-7', departamento: 'PROFESOR', cargo: 'ASISTENTE PARVULO', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2022-08-01', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9608741088', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-276-7456', telefono: '', direccion: '', fechaNacimiento: '2002-11-22', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 19, nombre: 'Ramos Santana, Yudelca Altagracia', tipoDocumento: 'cedula', documento: '032-0031709-1', nss: '03713540-7', departamento: 'PROFESOR', cargo: 'MAESTRA TITULAR PRE-PRIMARIO', salarioBase: 25000, tipoRemuneracion: 'Normal', fechaIngreso: '2012-07-23', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9608740924', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-216-5228', telefono: '', direccion: '', fechaNacimiento: '1985-03-14', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 20, nombre: 'Rodriguez Reyes, Daniela Isabel', tipoDocumento: 'cedula', documento: '402-1106253-0', nss: '06687131-1', departamento: 'PROFESOR', cargo: 'PROFESORA DE INGLES NIVEL INICIAL', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2025-10-09', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '1202330765', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(849)-394-4074', telefono: '', direccion: '', fechaNacimiento: '2006-11-07', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 21, nombre: 'Rodriguez Rodriguez, Gabriel De Jesus', tipoDocumento: 'cedula', documento: '031-0073915-4', nss: '03657548-3', departamento: 'ADMINISTRACION', cargo: 'Representante', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2024-07-17', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '', telefono: '', direccion: '', fechaNacimiento: '', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
                { id: 22, nombre: 'Rosario Vasquez, Luisa Estebania', tipoDocumento: 'cedula', documento: '402-2280604-0', nss: '13781314-0', departamento: 'PSICOLOGIA', cargo: 'PSICOLOGA', salarioBase: 25000, tipoRemuneracion: 'Normal', fechaIngreso: '2024-09-02', tipoContrato: 'Indefinido', banco: 'Banco Popular', cuenta: '826465213', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-798-7037', telefono: '', direccion: '', fechaNacimiento: '1994-12-02', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 23, nombre: 'Sanchez De Colmenares, Flor Maria', tipoDocumento: 'cedula', documento: '174630184', nss: '18543727-7', departamento: 'PROFESOR', cargo: 'MAESTRA PRIMARIA', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2023-09-11', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9600189996', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-340-7473', telefono: '', direccion: '', fechaNacimiento: '1966-05-21', estadoCivil: 'Soltero/a', nacionalidad: 'Venezolana', tipoEmpleado: 'Profesor' },
                { id: 24, nombre: 'Tavarez Felipe, Yubelkys Altagracia', tipoDocumento: 'cedula', documento: '031-0410964-4', nss: '03679280-1', departamento: 'PROFESOR', cargo: 'TITULAR PARVULO', salarioBase: 25000, tipoRemuneracion: 'Normal', fechaIngreso: '2024-09-23', tipoContrato: 'Indefinido', banco: 'BHD León', cuenta: '34530350016', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-665-3875', telefono: '', direccion: '', fechaNacimiento: '1983-02-04', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 25, nombre: 'Vivas Cuencas, Lisbia Coromoto', tipoDocumento: 'cedula', documento: '176883175', nss: '18270308-0', departamento: 'PROFESOR', cargo: 'MAESTRA MATEMATICAS', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2024-10-08', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '2450373494', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-835-0189', telefono: '', direccion: '', fechaNacimiento: '1963-11-24', estadoCivil: 'Soltero/a', nacionalidad: 'Venezolana', tipoEmpleado: 'Profesor' },
                { id: 26, nombre: 'Jimaquen Cabrera, Mayorka Delfina', tipoDocumento: 'cedula', documento: '031-0408757-6', nss: '03361275-0', departamento: 'ASISTENTE', cargo: 'ASISTENTE KINDER', salarioBase: 17193.12, tipoRemuneracion: 'Normal', fechaIngreso: '2021-09-20', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '9607586638', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(829)-891-2449', telefono: '', direccion: '', fechaNacimiento: '1982-05-25', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Profesor' },
                { id: 27, nombre: 'Olivares Contreras De Rodriguez, Erika Cristina', tipoDocumento: 'cedula', documento: '031-0306511-0', nss: '03296898-1', departamento: 'ADMINISTRACION', cargo: 'DIRECTORA', salarioBase: 20000, tipoRemuneracion: 'Normal', fechaIngreso: '2004-07-25', tipoContrato: 'Indefinido', banco: 'ACAP', cuenta: '100070092512', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-277-4604', telefono: '', direccion: '', fechaNacimiento: '1969-02-06', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
                { id: 28, nombre: 'Inoa Espaillat, Fanny Josefina', tipoDocumento: 'cedula', documento: '031-0278033-9', nss: '', departamento: 'ADMINISTRACION', cargo: 'ASISTENTE ADMINISTRATIVO', salarioBase: 20000, tipoRemuneracion: 'Normal', fechaIngreso: '2025-01-07', tipoContrato: 'Indefinido', banco: 'Banco Popular', cuenta: '852048115', activo: true, dependientesSFS: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0, celular: '(809)-910-4181', telefono: '', direccion: '', fechaNacimiento: '1971-01-28', estadoCivil: 'Soltero/a', nacionalidad: 'Dominicana', tipoEmpleado: 'Empleado' },
            ];
            const prests = [];
            const lics = [];
            setEmpleados(emps.map(normalizarEmpleado));
            setPrestamos(prests);
            setLicencias(lics);
            setLoading(false);
            setDatosInicializados(true); // Habilitar guardado automático
            toast('Sistema cargado correctamente', 'success');
        }, 500);
    };

    // Helpers
    const openModal = name => setModals(m => ({ ...m, [name]: true }));
    const closeModal = name => setModals(m => ({ ...m, [name]: false }));
    const getPrestamosPend = empId => prestamos.filter(p => p.empleadoId === empId && p.activo && p.saldo > 0);

    // Funciones para manejar ausencias
    const abrirModalAusencias = (empId) => {
        setAusenciasEmpId(empId);
        openModal('ausencias');
    };

    const toggleFechaAusencia = (fecha) => {
        if (!ausenciasEmpId) return;
        setNominaEdits(prev => {
            const current = prev[ausenciasEmpId] || {};
            const fechasAus = current.fechasAus || [];
            const existe = fechasAus.includes(fecha);
            const nuevasFechas = existe 
                ? fechasAus.filter(f => f !== fecha) 
                : [...fechasAus, fecha].sort();
            return {
                ...prev,
                [ausenciasEmpId]: {
                    ...current,
                    fechasAus: nuevasFechas,
                    diasAus: nuevasFechas.length
                }
            };
        });
    };

    const getFechasDelPeriodo = () => {
        const { mes, año, tipo, quincena } = periodo;
        const fechas = [];
        const diasEnMes = new Date(año, mes, 0).getDate();
        
        let inicio, fin;
        if (tipo === 'quincenal') {
            inicio = quincena === 1 ? 1 : 16;
            fin = quincena === 1 ? 15 : diasEnMes;
        } else {
            inicio = 1;
            fin = diasEnMes;
        }
        
        for (let d = inicio; d <= fin; d++) {
            const fecha = new Date(año, mes - 1, d);
            const diaSemana = fecha.getDay();
            // Solo días laborables (lunes a viernes)
            if (diaSemana !== 0 && diaSemana !== 6) {
                fechas.push(`${año}-${String(mes).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
            }
        }
        return fechas;
    };

    const formatFechaCorta = (fecha) => {
        const [año, mes, dia] = fecha.split('-');
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        return `${parseInt(dia)} ${meses[parseInt(mes)-1]}`;
    };

    const getDiaSemana = (fecha) => {
        const dias = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
        const [año, mes, dia] = fecha.split('-').map(Number);
        return dias[new Date(año, mes - 1, dia).getDay()];
    };

    // Guardar automáticamente cuando cambien los datos (solo después de inicialización)
    React.useEffect(() => {
        if (datosInicializados && empleados.length > 0) {
            console.log('Guardando empleados en localStorage:', empleados.length);
            guardarEnLocal(STORAGE_KEYS.empleados, empleados);
        }
    }, [empleados, datosInicializados]);

    React.useEffect(() => {
        if (datosInicializados) {
            console.log('Guardando préstamos en localStorage:', prestamos.length);
            guardarEnLocal(STORAGE_KEYS.prestamos, prestamos);
        }
    }, [prestamos, datosInicializados]);

    React.useEffect(() => {
        if (datosInicializados) {
            console.log('Guardando licencias en localStorage:', licencias.length);
            guardarEnLocal(STORAGE_KEYS.licencias, licencias);
        }
    }, [licencias, datosInicializados]);

    React.useEffect(() => {
        if (datosInicializados) {
            console.log('Guardando nóminas en localStorage:', nominas.length);
            guardarEnLocal(STORAGE_KEYS.nominas, nominas);
        }
    }, [nominas, datosInicializados]);

    React.useEffect(() => {
        if (datosInicializados) {
            console.log('Guardando config en localStorage');
            guardarEnLocal(STORAGE_KEYS.config, config);
        }
    }, [config, datosInicializados]);

    React.useEffect(() => {
        if (datosInicializados) {
            console.log('Guardando catálogos en localStorage');
            guardarEnLocal(STORAGE_KEYS.catalogos, catalogos);
        }
    }, [catalogos, datosInicializados]);

    // ⭐ SINCRONIZACIÓN AUTOMÁTICA CON SHAREPOINT (con debounce de 5 segundos)
    const syncTimeoutRef = React.useRef(null);
    React.useEffect(() => {
        // Solo sincronizar si está conectado a SharePoint y hay datos inicializados
        if (!datosInicializados || !spConnected || syncStatus.syncing) return;
        
        // Cancelar sincronización pendiente
        if (syncTimeoutRef.current) {
            clearTimeout(syncTimeoutRef.current);
        }
        
        // Programar nueva sincronización en 5 segundos
        syncTimeoutRef.current = setTimeout(async () => {
            console.log('🔄 Auto-sincronizando con SharePoint...');
            setSyncStatus(s => ({ ...s, syncing: true }));
            
            try {
                const resultado = await sincronizarTodoSP(empleados, prestamos, licencias, nominas, config, catalogos);
                if (resultado.success) {
                    setSyncStatus({ syncing: false, lastSync: new Date(), error: null });
                    console.log('✅ Auto-sincronización completada');
                } else {
                    setSyncStatus({ syncing: false, lastSync: syncStatus.lastSync, error: resultado.error });
                    console.error('❌ Error en auto-sincronización:', resultado.error);
                }
            } catch (e) {
                setSyncStatus(s => ({ ...s, syncing: false, error: e.message }));
                console.error('❌ Error en auto-sincronización:', e);
            }
        }, 5000); // 5 segundos de delay
        
        // Cleanup
        return () => {
            if (syncTimeoutRef.current) {
                clearTimeout(syncTimeoutRef.current);
            }
        };
    }, [empleados, prestamos, licencias, nominas, config, catalogos, datosInicializados, spConnected]);

    // Función para restaurar datos por defecto (limpia localStorage)
    const restaurarDatosPorDefecto = () => {
        if (confirm('¿Está seguro de restaurar los datos por defecto? Se perderán todos los cambios guardados localmente.')) {
            Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
            window.location.reload();
        }
    };

    // Función para actualizar empleados desde plantilla sin borrar nóminas/préstamos
    const forzarActualizacionEmpleados = () => {
        if (confirm('¿Actualizar datos de empleados desde la plantilla maestra? Esto sobrescribirá: bancos, cuentas y celulares. Las nóminas y préstamos NO se borrarán.')) {
            // Borrar SOLO los empleados del localStorage
            localStorage.removeItem(STORAGE_KEYS.empleados);
            toast('Datos de empleados actualizados. Recargando...', 'success');
            setTimeout(() => window.location.reload(), 1000);
        }
    };

    const getTotalCuotas = empId => getPrestamosPend(empId).reduce((s, p) => s + p.cuotaMensual, 0);

    // CRUD Empleados
    const guardarEmpleado = async () => {
        if (!empForm.nombre || !empForm.salarioBase) { toast('Complete los campos requeridos', 'error'); return; }
        
        // Construir objeto con todos los campos, parseando números correctamente
        const data = { 
            ...empForm,
            // Campos numéricos - asegurar que se parseen correctamente
            salarioBase: parseFloat(empForm.salarioBase) || 0,
            dependientesSFS: parseInt(empForm.dependientesSFS) || 0,
            cooperativa: parseFloat(empForm.cooperativa) || 0,
            seguroPrivado: parseFloat(empForm.seguroPrivado) || 0,
            embargo: parseFloat(empForm.embargo) || 0,
            vacacionesDisfrutadas: parseFloat(empForm.vacacionesDisfrutadas) || 0,
            // Campos de texto - asegurar valores por defecto
            celular: empForm.celular || '',
            telefono: empForm.telefono || '',
            direccion: empForm.direccion || '',
            fechaNacimiento: empForm.fechaNacimiento || '',
            estadoCivil: empForm.estadoCivil || 'Soltero/a',
            nacionalidad: empForm.nacionalidad || 'Dominicana',
            fechaSalida: empForm.fechaSalida || '',
            motivoSalida: empForm.motivoSalida || '',
            // Booleano
            activo: empForm.activo === true || empForm.activo === 'true'
        };
        
        if (editingEmp) {
            // Al editar, preservar campos del empleado original que no están en el formulario
            const updated = { 
                ...editingEmp,  // Primero los datos originales
                ...data,       // Luego sobrescribir con los nuevos
                id: editingEmp.id, 
                _spId: editingEmp._spId 
            };
            setEmpleados(p => p.map(e => e.id === editingEmp.id ? updated : e));
            if (spConnected) await guardarEmpleadoSP(updated);
            toast('Empleado actualizado', 'success');
        } else {
            const newEmp = { ...data, id: Math.max(...empleados.map(e => e.id), 0) + 1 };
            setEmpleados(p => [...p, newEmp]);
            if (spConnected) await guardarEmpleadoSP(newEmp);
            toast('Empleado agregado', 'success');
        }
        closeModal('empleado');
        setEditingEmp(null);
        setEmpForm(empFormInit);
    };

    const editarEmpleado = emp => { 
        setEditingEmp(emp); 
        // Combinar con empFormInit para asegurar que todos los campos existan
        setEmpForm({ 
            ...empFormInit,  // Primero valores por defecto
            ...emp,          // Luego datos del empleado
            // Asegurar que campos booleanos se manejen correctamente
            activo: emp.activo === true || emp.activo === 'true'
        }); 
        openModal('empleado'); 
    };
    const eliminarEmpleado = id => { if (confirm('¿Eliminar empleado?')) { setEmpleados(p => p.filter(e => e.id !== id)); toast('Empleado eliminado', 'warning'); } };

    // CRUD Préstamos
    const guardarPrestamo = async () => {
        if (!prestamoForm.empleadoId || !prestamoForm.monto || !prestamoForm.cuotas) { toast('Complete los campos', 'error'); return; }
        const monto = parseFloat(prestamoForm.monto);
        const cuotas = parseInt(prestamoForm.cuotas);
        
        if (editingPrestamo) {
            // Actualizar préstamo existente
            const cuotasPagadas = editingPrestamo.cuotasPagadas || 0;
            const cuotaMensual = round2(monto / cuotas);
            const saldoPagado = cuotasPagadas * (editingPrestamo.cuotaMensual || 0);
            const nuevoSaldo = Math.max(0, monto - saldoPagado);
            
            const updated = {
                ...editingPrestamo,
                empleadoId: parseInt(prestamoForm.empleadoId),
                monto,
                cuotas,
                cuotaMensual,
                saldo: nuevoSaldo,
                desc: prestamoForm.desc || 'Préstamo',
                fecha: prestamoForm.fecha || editingPrestamo.fecha,
                activo: nuevoSaldo > 0
            };
            setPrestamos(p => p.map(pr => pr.id === editingPrestamo.id ? updated : pr));
            toast('Préstamo actualizado', 'success');
        } else {
            // Crear nuevo préstamo
            const nuevoPrestamo = {
                id: Date.now(), empleadoId: parseInt(prestamoForm.empleadoId), monto, cuotas, cuotasPagadas: 0,
                cuotaMensual: round2(monto / cuotas), saldo: monto, desc: prestamoForm.desc || 'Préstamo',
                fecha: prestamoForm.fecha || new Date().toISOString().split('T')[0], activo: true
            };
            setPrestamos(p => [...p, nuevoPrestamo]);
            if (spConnected) await guardarPrestamoSP(nuevoPrestamo);
            toast('Préstamo registrado', 'success');
        }
        closeModal('prestamo');
        setEditingPrestamo(null);
        setPrestamoForm({ empleadoId: '', monto: '', cuotas: '', desc: '', fecha: '' });
    };
    
    const editarPrestamo = (prestamo) => {
        setEditingPrestamo(prestamo);
        setPrestamoForm({
            empleadoId: prestamo.empleadoId.toString(),
            monto: prestamo.monto.toString(),
            cuotas: prestamo.cuotas.toString(),
            desc: prestamo.desc || '',
            fecha: prestamo.fecha || ''
        });
        openModal('prestamo');
    };
    
    const eliminarPrestamo = (prestamo) => {
        const emp = empleados.find(e => e.id === prestamo.empleadoId);
        if (window.confirm(`¿Eliminar el préstamo de ${emp?.nombre || 'este empleado'}?\n\nMonto: RD$ ${formatMoney(prestamo.monto)}\nSaldo pendiente: RD$ ${formatMoney(prestamo.saldo)}`)) {
            setPrestamos(p => p.filter(pr => pr.id !== prestamo.id));
            toast('Préstamo eliminado', 'success');
        }
    };

    // CRUD Licencias
    const guardarLicencia = () => {
        if (!licenciaForm.empleadoId || !licenciaForm.fechaInicio) { toast('Complete los campos', 'error'); return; }
        setLicencias(p => [...p, { ...licenciaForm, id: Date.now(), empleadoId: parseInt(licenciaForm.empleadoId) }]);
        toast('Licencia registrada', 'success');
        closeModal('licencia');
        setLicenciaForm({ empleadoId: '', tipo: 'Vacaciones', fechaInicio: '', fechaFin: '', conPago: true, notas: '' });
    };

    // Generar Nómina
    const generarNomina = () => {
        // Verificar si existe una nómina para el mismo período
        const codigoNuevo = `${periodo.año}${periodo.mes.toString().padStart(2,'0')}${periodo.tipo === 'quincenal' ? periodo.quincena : '0'}`;
        const existente = nominas.find(n => {
            const codigoExistente = `${n.periodo.año}${n.periodo.mes.toString().padStart(2,'0')}${n.periodo.tipo === 'quincenal' ? n.periodo.quincena : '0'}`;
            return codigoExistente === codigoNuevo && (n.estado === 'guardada' || n.estado === 'procesada');
        });
        
        // Verificar si hay un borrador existente para este período
        const borradorExistente = nominas.find(n => {
            const codigoExistente = `${n.periodo.año}${n.periodo.mes.toString().padStart(2,'0')}${n.periodo.tipo === 'quincenal' ? n.periodo.quincena : '0'}`;
            return codigoExistente === codigoNuevo && n.estado === 'borrador';
        });
        
        if (borradorExistente) {
            // Preguntar si quiere continuar con el borrador
            if (window.confirm(`Existe un BORRADOR guardado para este período (Código: ${codigoNuevo}).\n\n¿Desea CONTINUAR editando el borrador?\n\n• Sí = Cargar el borrador guardado\n• No = Crear una nómina nueva (el borrador se perderá)`)) {
                cargarBorrador(borradorExistente);
                return;
            } else {
                // Eliminar borrador anterior si decide crear uno nuevo
                setNominas(p => p.filter(n => n.id !== borradorExistente.id));
            }
        }
        
        if (existente) {
            // Preguntar si quiere editar la existente
            if (window.confirm(`Ya existe una nómina procesada para este período (Código: ${codigoNuevo}).\n\n¿Desea EDITARLA para hacer correcciones?\n\nLos cambios sobrescribirán la nómina anterior.`)) {
                editarNomina(existente);
                return;
            }
            return;
        }
        
        // Filtrar empleados elegibles: activos Y (sin fecha salida O fecha salida posterior al inicio del período)
        const inicioMes = new Date(periodo.año, periodo.mes - 1, 1);
        const activos = empleados.filter(e => {
            if (!e.activo) return false;
            if (!e.fechaSalida) return true;
            // Si tiene fecha de salida, incluir solo si salió después del inicio del período
            const fechaSal = new Date(e.fechaSalida);
            return fechaSal >= inicioMes;
        });
        
        if (activos.length === 0) {
            toast('No hay empleados activos para generar la nómina', 'error');
            return;
        }
        
        const divisor = periodo.tipo === 'quincenal' ? 2 : 1;
        const esRegalia = periodo.mes === 12 && (periodo.tipo === 'mensual' || periodo.quincena === 2);
        const edits = {};

        const detalles = activos.map(emp => {
            // IMPORTANTE: Calcular TSS sobre salario MENSUAL completo (para aplicar topes correctamente)
            const tssMensual = calcularTSS(emp.salarioBase, config);
            
            // Calcular ISR sobre salario anual completo (considerando dependientes)
            const salNetoAnual = (emp.salarioBase - tssMensual.afpEmp - tssMensual.sfsEmp) * 12;
            const isrMensual = calcularISR(salNetoAnual, config);
            
            // Ahora dividir TODO por el divisor (quincenal = 2, mensual = 1)
            const salBase = emp.salarioBase / divisor;
            const afpEmp = round2(tssMensual.afpEmp / divisor);
            const sfsEmp = round2(tssMensual.sfsEmp / divisor);
            const isr = round2(isrMensual / divisor);
            const afpPat = round2(tssMensual.afpPat / divisor);
            const sfsPat = round2(tssMensual.sfsPat / divisor);
            const infotep = round2(tssMensual.infotep / divisor);
            const riesgo = round2(tssMensual.riesgo / divisor);
            
            // Otras deducciones fijas también divididas
            // PDSS = Dependientes adicionales SFS × Valor Per Cápita mensual / divisor
            const pdss = round2(((emp.dependientesSFS || 0) * (config.tss.pdssPerCapita || 1715.46)) / divisor);
            const cooperativa = (emp.cooperativa || 0) / divisor;
            const seguroPrivado = (emp.seguroPrivado || 0) / divisor;
            const embargo = (emp.embargo || 0) / divisor;
            const cuotaPrestamo = getTotalCuotas(emp.id) / divisor;

            // Calcular regalía si es diciembre (solo en 2da quincena o mensual)
            const regalia = esRegalia ? calcularRegalia(emp.salarioBase, 12) : 0;

            edits[emp.id] = { diasAus: 0, fechasAus: [], minTard: 0, horas35: 0, horas100: 0, bonificacion: 0, comisiones: 0, incentivos: 0, viaticos: 0, otrosIng: 0, otrasDed: 0 };

            const totalIng = salBase + regalia;
            const totalDed = afpEmp + sfsEmp + isr + pdss + cuotaPrestamo + cooperativa + seguroPrivado + embargo;

            return {
                empId: emp.id, nombre: emp.nombre, depto: emp.departamento, cargo: emp.cargo,
                salarioBase: salBase, horasExtra: 0, bonificacion: 0, comisiones: 0, incentivos: 0, viaticos: 0, vacaciones: 0, regalia, otrosIng: 0, totalIng,
                diasAus: 0, fechasAus: [], descAusencias: 0, minTard: 0, descTardanzas: 0,
                afpEmp, sfsEmp, isr, pdss, cuotaPrestamo, cooperativa, seguroPrivado, embargo, otrasDed: 0, totalDed,
                neto: round2(totalIng - totalDed),
                afpPat, sfsPat, infotep, riesgo
            };
        });

        setNominaEdits(edits);
        setCurrentNomina({ id: Date.now(), codigo: codigoNuevo, periodo: { ...periodo }, fecha: new Date().toISOString(), detalles, estado: 'borrador' });
        toast(`Nómina ${codigoNuevo} generada - Use "Guardar Borrador" para guardar cambios`, 'warning');
        setView('nomina');
    };

    // Recalcular nómina
    const recalcularDetalle = empId => {
        if (!currentNomina || !nominaEdits[empId]) return null;
        const emp = empleados.find(e => e.id === empId);
        const ed = nominaEdits[empId];
        const divisor = currentNomina.periodo.tipo === 'quincenal' ? 2 : 1;
        const esRegalia = currentNomina.periodo.mes === 12 && (currentNomina.periodo.tipo === 'mensual' || currentNomina.periodo.quincena === 2);

        const salBase = emp.salarioBase / divisor;
        const salDiario = calcularSalarioDiario(emp.salarioBase, config);
        const salHora = calcularSalarioHora(emp.salarioBase, config);

        // Descuentos por ausencias y tardanzas (proporcionales al período)
        const descAusencias = round2(salDiario * (ed.diasAus || 0) / divisor);
        const descTardanzas = round2((salHora * (ed.minTard || 0) / 60) / divisor);
        const horasExtra = calcularHorasExtras(emp.salarioBase, ed.horas35 || 0, ed.horas100 || 0, config).total / divisor;
        const bonificacion = parseFloat(ed.bonificacion) || 0;
        const comisiones = parseFloat(ed.comisiones) || 0;
        const incentivos = parseFloat(ed.incentivos) || 0;
        const viaticos = parseFloat(ed.viaticos) || 0;
        const otrosIng = parseFloat(ed.otrosIng) || 0;
        const otrasDed = parseFloat(ed.otrasDed) || 0;
        const regalia = esRegalia ? calcularRegalia(emp.salarioBase, 12) : 0;

        // Deducciones fijas divididas por período
        // PDSS = Dependientes adicionales SFS × Valor Per Cápita mensual / divisor
        const pdss = round2(((emp.dependientesSFS || 0) * (config.tss.pdssPerCapita || 1715.46)) / divisor);
        const cooperativa = (emp.cooperativa || 0) / divisor;
        const seguroPrivado = (emp.seguroPrivado || 0) / divisor;
        const embargo = (emp.embargo || 0) / divisor;
        const cuotaPrestamo = getTotalCuotas(emp.id) / divisor;

        // IMPORTANTE: Calcular TSS sobre salario MENSUAL equivalente (para aplicar topes correctamente)
        // Reconstruir salario mensual considerando ausencias
        const salMensualParaTSS = Math.max(0, emp.salarioBase - (descAusencias * divisor));
        const tssMensual = calcularTSS(salMensualParaTSS, config);
        
        // Calcular ISR sobre salario anual (considerando dependientes)
        const salNetoAnual = (salMensualParaTSS - tssMensual.afpEmp - tssMensual.sfsEmp) * 12;
        const isrMensual = calcularISR(salNetoAnual, config);
        
        // Dividir TSS e ISR por el divisor
        const afpEmp = round2(tssMensual.afpEmp / divisor);
        const sfsEmp = round2(tssMensual.sfsEmp / divisor);
        const isr = round2(isrMensual / divisor);
        const afpPat = round2(tssMensual.afpPat / divisor);
        const sfsPat = round2(tssMensual.sfsPat / divisor);
        const infotep = round2(tssMensual.infotep / divisor);
        const riesgo = round2(tssMensual.riesgo / divisor);

        const totalIng = salBase + horasExtra + bonificacion + comisiones + incentivos + viaticos + regalia + otrosIng;
        const totalDed = afpEmp + sfsEmp + isr + pdss + descAusencias + descTardanzas + cuotaPrestamo + cooperativa + seguroPrivado + embargo + otrasDed;

        return {
            empId: emp.id, nombre: emp.nombre, depto: emp.departamento, cargo: emp.cargo,
            salarioBase: salBase, horasExtra, horas35: ed.horas35 || 0, horas100: ed.horas100 || 0, bonificacion, comisiones, incentivos, viaticos, vacaciones: 0, regalia, otrosIng, totalIng,
            diasAus: ed.diasAus || 0, fechasAus: ed.fechasAus || [], descAusencias, minTard: ed.minTard || 0, descTardanzas,
            afpEmp, sfsEmp, isr, pdss, cuotaPrestamo, cooperativa, seguroPrivado, embargo, otrasDed, totalDed,
            neto: round2(totalIng - totalDed),
            afpPat, sfsPat, infotep, riesgo
        };
    };

    const getDetallesRecalc = () => currentNomina ? currentNomina.detalles.map(d => recalcularDetalle(d.empId) || d) : [];
    const updateEdit = (empId, field, val) => setNominaEdits(p => ({ ...p, [empId]: { ...p[empId], [field]: val } }));

    // Guardar nómina como borrador (persiste en localStorage)
    const guardarBorrador = () => {
        if (!currentNomina) {
            toast('No hay nómina para guardar', 'error');
            return;
        }
        
        const detalles = getDetallesRecalc();
        const nominaActualizada = { 
            ...currentNomina, 
            detalles,
            estado: 'borrador',
            fechaModificacion: new Date().toISOString()
        };
        
        // Actualizar estado de nómina actual
        setCurrentNomina(nominaActualizada);
        
        // Actualizar lista de nóminas
        setNominas(prev => {
            const existe = prev.find(n => n.id === nominaActualizada.id);
            let nuevasNominas;
            if (existe) {
                nuevasNominas = prev.map(n => n.id === nominaActualizada.id ? nominaActualizada : n);
            } else {
                nuevasNominas = [...prev, nominaActualizada];
            }
            
            // Guardar directamente en localStorage para asegurar persistencia
            try {
                localStorage.setItem(STORAGE_KEYS.nominas, JSON.stringify(nuevasNominas));
                console.log('Borrador guardado en localStorage:', nominaActualizada.codigo);
            } catch (e) {
                console.error('Error guardando borrador:', e);
            }
            
            return nuevasNominas;
        });
        
        toast('Borrador guardado correctamente', 'success');
    };
    
    // Cargar borrador existente
    const cargarBorrador = (borrador) => {
        // Reconstruir los edits desde los detalles del borrador
        const edits = {};
        borrador.detalles.forEach(d => {
            edits[d.empId] = {
                diasAus: d.diasAus || 0,
                fechasAus: d.fechasAus || [],
                minTard: d.minTard || 0,
                horas35: d.horas35 || 0,
                horas100: d.horas100 || 0,
                bonificacion: d.bonificacion || 0,
                comisiones: d.comisiones || 0,
                incentivos: d.incentivos || 0,
                viaticos: d.viaticos || 0,
                otrosIng: d.otrosIng || 0,
                otrasDed: d.otrasDed || 0
            };
        });
        
        setNominaEdits(edits);
        setCurrentNomina(borrador);
        toast(`Borrador ${borrador.codigo} cargado - Continúe editando`, 'info');
        setView('nomina');
    };

    // Procesar/Cerrar nómina (finalizar)
    const procesarNomina = async () => {
        const esEdicion = currentNomina.editandoExistente;
        const mensajeConfirm = esEdicion 
            ? '¿Está seguro de GUARDAR los cambios?\n\nLos cambios sobrescribirán la nómina anterior.'
            : '¿Está seguro de PROCESAR esta nómina?\n\nUna vez procesada:\n• Se actualizarán los saldos de préstamos\n• Quedará guardada en el historial\n• Podrá editarla posteriormente si necesita corregir algo';
        
        if (!window.confirm(mensajeConfirm)) {
            return;
        }
        
        const detalles = getDetallesRecalc();
        const codigo = currentNomina.codigo || `${currentNomina.periodo.año}${currentNomina.periodo.mes.toString().padStart(2,'0')}${currentNomina.periodo.tipo === 'quincenal' ? currentNomina.periodo.quincena : '0'}`;
        
        // Limpiar flags de edición antes de guardar
        const nominaFinal = { 
            ...currentNomina, 
            codigo, 
            detalles, 
            estado: 'procesada', 
            fechaProceso: new Date().toISOString(),
            editandoExistente: undefined,
            idOriginal: undefined,
            fechaModificacion: esEdicion ? new Date().toISOString() : undefined
        };
        delete nominaFinal.editandoExistente;
        delete nominaFinal.idOriginal;

        // Actualizar préstamos SOLO si es una nómina nueva (no si es edición)
        const prestamosActualizados = [];
        if (!esEdicion) {
            detalles.forEach(d => {
                if (d.cuotaPrestamo > 0) {
                    setPrestamos(p => p.map(pr => {
                        if (pr.empleadoId === d.empId && pr.activo && pr.saldo > 0) {
                            const desc = pr.cuotaMensual / (currentNomina.periodo.tipo === 'quincenal' ? 2 : 1);
                            const nuevoSaldo = Math.max(0, pr.saldo - desc);
                            const actualizado = { ...pr, saldo: nuevoSaldo, cuotasPagadas: pr.cuotasPagadas + (currentNomina.periodo.tipo === 'quincenal' ? 0.5 : 1), activo: nuevoSaldo > 0 };
                            prestamosActualizados.push(actualizado);
                            return actualizado;
                        }
                        return pr;
                    }));
                }
            });
        }

        // Si es edición, sobrescribir; si es nueva, agregar (pero verificar duplicados)
        if (esEdicion) {
            const idOriginal = currentNomina.idOriginal || currentNomina.id;
            setNominas(p => p.map(n => n.id === idOriginal ? { ...nominaFinal, id: idOriginal } : n));
        } else {
            // Verificar si ya existe una nómina con el mismo código
            setNominas(p => {
                const existente = p.find(n => n.codigo === codigo && n.estado !== 'anulada');
                if (existente) {
                    // Si existe, actualizar en lugar de agregar
                    console.log(`Actualizando nómina existente con código ${codigo}`);
                    return p.map(n => n.id === existente.id ? { ...nominaFinal, id: existente.id } : n);
                } else {
                    // Si no existe, agregar nueva
                    return [...p, nominaFinal];
                }
            });
        }
        
        setCurrentNomina(nominaFinal);
        
        // Sincronizar con SharePoint
        if (spConnected) {
            await guardarNominaSP(nominaFinal);
            for (const p of prestamosActualizados) {
                await guardarPrestamoSP(p);
            }
        }
        
        toast(`Nómina ${codigo} ${esEdicion ? 'actualizada' : 'procesada'} correctamente`, 'success');
    };
    
    // Editar nómina existente (cargar como borrador para modificar)
    const editarNomina = (nomina) => {
        // Reconstruir los edits desde los detalles de la nómina
        const edits = {};
        nomina.detalles.forEach(det => {
            edits[det.empId] = {
                diasAus: det.diasAus || 0,
                fechasAus: det.fechasAus || [],
                minTard: det.minTard || 0,
                horas35: 0, // Las horas extras se recalculan
                horas100: 0,
                bonificacion: det.bonificacion || 0,
                comisiones: det.comisiones || 0,
                incentivos: det.incentivos || 0,
                viaticos: det.viaticos || 0,
                otrosIng: det.otrosIng || 0,
                otrasDed: det.otrasDed || 0
            };
        });
        
        // Cargar la nómina como borrador
        const nominaBorrador = {
            ...nomina,
            estado: 'borrador',
            editandoExistente: true, // Flag para saber que estamos editando
            idOriginal: nomina.id // Guardar ID original para sobrescribir
        };
        
        setNominaEdits(edits);
        setPeriodo(nomina.periodo);
        setCurrentNomina(nominaBorrador);
        setView('nomina');
        
        toast(`Editando nómina ${nomina.codigo} - Haga los cambios y presione "Procesar Nómina" para guardar`, 'info');
    };
    
    // Anular nómina (solo para casos especiales)
    const anularNomina = async (nomina) => {
        const motivo = window.prompt('Ingrese el motivo de anulación:');
        if (!motivo) return;
        
        if (!window.confirm(`¿Está seguro de ANULAR la nómina ${nomina.codigo}?\n\nNOTA: Normalmente es mejor EDITAR la nómina.\nAnular solo si necesita eliminarla completamente del historial.`)) {
            return;
        }
        
        const nominaAnulada = { 
            ...nomina, 
            estado: 'anulada', 
            fechaAnulacion: new Date().toISOString(),
            motivoAnulacion: motivo 
        };
        
        setNominas(p => p.map(n => n.id === nomina.id ? nominaAnulada : n));
        
        // Sincronizar con SharePoint
        if (spConnected) {
            await guardarNominaSP(nominaAnulada);
        }
        
        toast(`Nómina ${nomina.codigo} anulada.`, 'warning');
    };
    
    // Función legacy para compatibilidad
    const guardarNomina = procesarNomina;

    // Liquidación
    const calcularLiquidacionEmp = (emp, motivo = 'despido') => {
        const liq = calcularLiquidacion(emp, config, motivo);
        setLiquidacionData({ emp, motivo, ...liq });
        openModal('liquidacion');
    };

    // Exportar Excel (simulado)
    const exportarExcel = () => {
        if (!currentNomina) return;
        toast('Generando archivo Excel...', 'info');
        
        const dets = getDetallesRecalc();
        const periodo = currentNomina.periodo;
        const periodoStr = `${periodo.tipo === 'quincenal' ? 'Q' + periodo.quincena + '_' : ''}${periodo.mes}_${periodo.año}`;
        
        // Crear contenido HTML para Excel
        let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
            <head><meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; }
                th, td { border: 1px solid #000; padding: 5px; }
                th { background: #1565C0; color: white; font-weight: bold; }
                .money { text-align: right; }
                .header { background: #f0f0f0; font-weight: bold; }
                .total { background: #e0e0e0; font-weight: bold; }
            </style>
            </head><body>
            <h2>NÓMINA - Centro Educativo Tehui</h2>
            <p><strong>Período:</strong> ${['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][periodo.mes]} ${periodo.año} ${periodo.tipo === 'quincenal' ? '- Quincena ' + periodo.quincena : ''}</p>
            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-DO')}</p>
            <table>
                <tr>
                    <th>Empleado</th>
                    <th>Departamento</th>
                    <th>Cargo</th>
                    <th>Salario Base</th>
                    <th>Horas Extra</th>
                    <th>Bonificación</th>
                    <th>Comisiones</th>
                    <th>Incentivos</th>
                    <th>Viáticos</th>
                    <th>Otros Ing.</th>
                    <th>Total Ingresos</th>
                    <th>AFP (2.87%)</th>
                    <th>SFS (3.04%)</th>
                    <th>ISR</th>
                    <th>Préstamos</th>
                    <th>Ausencias</th>
                    <th>Otras Ded.</th>
                    <th>Total Deducciones</th>
                    <th>NETO A PAGAR</th>
                </tr>`;
        
        dets.forEach(d => {
            html += `
                <tr>
                    <td>${d.nombre}</td>
                    <td>${d.depto}</td>
                    <td>${d.cargo || '-'}</td>
                    <td class="money">${d.salarioBase.toFixed(2)}</td>
                    <td class="money">${d.horasExtra.toFixed(2)}</td>
                    <td class="money">${d.bonificacion.toFixed(2)}</td>
                    <td class="money">${(d.comisiones || 0).toFixed(2)}</td>
                    <td class="money">${(d.incentivos || 0).toFixed(2)}</td>
                    <td class="money">${(d.viaticos || 0).toFixed(2)}</td>
                    <td class="money">${d.otrosIng.toFixed(2)}</td>
                    <td class="money">${d.totalIng.toFixed(2)}</td>
                    <td class="money">${d.afpEmp.toFixed(2)}</td>
                    <td class="money">${d.sfsEmp.toFixed(2)}</td>
                    <td class="money">${d.isr.toFixed(2)}</td>
                    <td class="money">${d.cuotaPrestamo.toFixed(2)}</td>
                    <td class="money">${(d.descAusencias || 0).toFixed(2)}</td>
                    <td class="money">${d.otrasDed.toFixed(2)}</td>
                    <td class="money">${d.totalDed.toFixed(2)}</td>
                    <td class="money" style="background:#c8e6c9;font-weight:bold;">${d.neto.toFixed(2)}</td>
                </tr>`;
        });
        
        // Totales
        const totales = dets.reduce((a, d) => ({
            salarioBase: a.salarioBase + d.salarioBase,
            horasExtra: a.horasExtra + d.horasExtra,
            bonificacion: a.bonificacion + d.bonificacion,
            comisiones: a.comisiones + (d.comisiones || 0),
            incentivos: a.incentivos + (d.incentivos || 0),
            viaticos: a.viaticos + (d.viaticos || 0),
            otrosIng: a.otrosIng + d.otrosIng,
            totalIng: a.totalIng + d.totalIng,
            afpEmp: a.afpEmp + d.afpEmp,
            sfsEmp: a.sfsEmp + d.sfsEmp,
            isr: a.isr + d.isr,
            cuotaPrestamo: a.cuotaPrestamo + d.cuotaPrestamo,
            descAusencias: a.descAusencias + (d.descAusencias || 0),
            otrasDed: a.otrasDed + d.otrasDed,
            totalDed: a.totalDed + d.totalDed,
            neto: a.neto + d.neto
        }), { salarioBase: 0, horasExtra: 0, bonificacion: 0, comisiones: 0, incentivos: 0, viaticos: 0, otrosIng: 0, totalIng: 0, afpEmp: 0, sfsEmp: 0, isr: 0, cuotaPrestamo: 0, descAusencias: 0, otrasDed: 0, totalDed: 0, neto: 0 });
        
        html += `
            <tr class="total">
                <td colspan="3"><strong>TOTALES</strong></td>
                <td class="money">${totales.salarioBase.toFixed(2)}</td>
                <td class="money">${totales.horasExtra.toFixed(2)}</td>
                <td class="money">${totales.bonificacion.toFixed(2)}</td>
                <td class="money">${totales.comisiones.toFixed(2)}</td>
                <td class="money">${totales.incentivos.toFixed(2)}</td>
                <td class="money">${totales.viaticos.toFixed(2)}</td>
                <td class="money">${totales.otrosIng.toFixed(2)}</td>
                <td class="money">${totales.totalIng.toFixed(2)}</td>
                <td class="money">${totales.afpEmp.toFixed(2)}</td>
                <td class="money">${totales.sfsEmp.toFixed(2)}</td>
                <td class="money">${totales.isr.toFixed(2)}</td>
                <td class="money">${totales.cuotaPrestamo.toFixed(2)}</td>
                <td class="money">${totales.descAusencias.toFixed(2)}</td>
                <td class="money">${totales.otrasDed.toFixed(2)}</td>
                <td class="money">${totales.totalDed.toFixed(2)}</td>
                <td class="money" style="background:#a5d6a7;font-weight:bold;">${totales.neto.toFixed(2)}</td>
            </tr>
            </table>
            <br/><br/>
            <h3>Aportes Patronales</h3>
            <table>
                <tr><th>Concepto</th><th>Monto</th></tr>
                <tr><td>AFP Patronal (7.10%)</td><td class="money">${dets.reduce((s,d) => s + d.afpPat, 0).toFixed(2)}</td></tr>
                <tr><td>SFS Patronal (7.09%)</td><td class="money">${dets.reduce((s,d) => s + d.sfsPat, 0).toFixed(2)}</td></tr>
                <tr><td>INFOTEP (1%)</td><td class="money">${dets.reduce((s,d) => s + d.infotep, 0).toFixed(2)}</td></tr>
                <tr><td>Riesgo Laboral (${config.tss.riesgoLaboral}%)</td><td class="money">${dets.reduce((s,d) => s + d.riesgo, 0).toFixed(2)}</td></tr>
            </table>
            </body></html>`;
        
        // Crear y descargar archivo
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Nomina_Tehui_${periodoStr}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast('Archivo Excel generado correctamente', 'success');
    };

    // Función para imprimir nómina
    const imprimirNomina = () => {
        setModoImpresionNomina(true);
        setTimeout(() => {
            window.print();
            setTimeout(() => setModoImpresionNomina(false), 500);
        }, 100);
    };
    
    const imprimirVolantes = () => {
        document.body.classList.add('printing-volantes');
        setTimeout(() => {
            window.print();
            setTimeout(() => document.body.classList.remove('printing-volantes'), 500);
        }, 100);
    };
    
    const imprimirChecklist = () => {
        document.body.classList.add('printing-checklist');
        setTimeout(() => {
            window.print();
            setTimeout(() => document.body.classList.remove('printing-checklist'), 500);
        }, 100);
    };
    
    // Función para imprimir desde el Centro de Reportes
    const imprimirReporte = () => {
        document.body.classList.add('printing-reportes');
        setTimeout(() => {
            window.print();
            setTimeout(() => document.body.classList.remove('printing-reportes'), 500);
        }, 100);
    };
    
    // Abrir Centro de Reportes
    const abrirCentroReportes = (tipo = null) => {
        setTipoReporteActivo(tipo);
        openModal('reportes');
    };
    
    // Tipos de reportes disponibles organizados por categoría
    const CATEGORIAS_REPORTES = [
        {
            id: 'empleados',
            nombre: '👥 Empleados',
            reportes: [
                { id: 'empleados-activos', nombre: 'Listado de Empleados Activos', icon: '👥', desc: 'Directorio completo con datos de contacto y bancarios' },
                { id: 'empleados-depto', nombre: 'Empleados por Departamento', icon: '🏢', desc: 'Agrupados por departamento con totales' },
                { id: 'empleados-antiguedad', nombre: 'Empleados por Antigüedad', icon: '📅', desc: 'Ordenados por fecha de ingreso' },
                { id: 'empleados-salarios', nombre: 'Escala Salarial', icon: '💰', desc: 'Rangos salariales por departamento' },
                { id: 'empleados-cumple', nombre: 'Cumpleañeros del Mes', icon: '🎂', desc: 'Empleados que cumplen años este mes' },
                { id: 'empleados-desvinculados', nombre: 'Empleados Desvinculados', icon: '🚪', desc: 'Historial de empleados que salieron' }
            ]
        },
        {
            id: 'nomina',
            nombre: '💵 Nómina',
            reportes: [
                { id: 'nomina-depto', nombre: 'Nómina por Departamento', icon: '📊', desc: 'Empleados agrupados por departamento con subtotales', requiereNomina: true },
                { id: 'nomina-resumen', nombre: 'Resumen Ejecutivo', icon: '📋', desc: 'Resumen de la nómina en una página', requiereNomina: true },
                { id: 'nomina-banco', nombre: 'Distribución por Banco', icon: '🏦', desc: 'Totales a depositar por cada banco', requiereNomina: true }
            ]
        },
        {
            id: 'fiscal',
            nombre: '🏛️ Fiscal / TSS',
            reportes: [
                { id: 'tss', nombre: 'Reporte TSS Completo', icon: '🏛️', desc: 'AFP, SFS, Infotep, Riesgo Laboral', requiereNomina: true },
                { id: 'tss-resumen', nombre: 'Resumen Aportes TSS', icon: '📑', desc: 'Totales de aportes empleado y patronal', requiereNomina: true },
                { id: 'isr', nombre: 'Retenciones ISR', icon: '📄', desc: 'Impuesto sobre la renta retenido', requiereNomina: true }
            ]
        },
        {
            id: 'detalles',
            nombre: '📈 Detalles',
            reportes: [
                { id: 'deducciones', nombre: 'Detalle de Deducciones', icon: '📉', desc: 'Todas las deducciones por empleado', requiereNomina: true },
                { id: 'ingresos', nombre: 'Detalle de Ingresos', icon: '📈', desc: 'Ingresos extras (bonos, comisiones, etc.)', requiereNomina: true },
                { id: 'horas-extra', nombre: 'Horas Extras', icon: '⏰', desc: 'Detalle de horas extras pagadas', requiereNomina: true }
            ]
        },
        {
            id: 'prestamos',
            nombre: '💳 Préstamos',
            reportes: [
                { id: 'prestamos-activos', nombre: 'Préstamos Activos', icon: '💳', desc: 'Préstamos vigentes con saldos pendientes' },
                { id: 'prestamos-vencer', nombre: 'Próximos a Vencer', icon: '⚠️', desc: 'Préstamos que terminan en los próximos 3 meses' },
                { id: 'prestamos-historial', nombre: 'Historial de Préstamos', icon: '📚', desc: 'Todos los préstamos incluyendo pagados' }
            ]
        },
        {
            id: 'comparativos',
            nombre: '📊 Comparativos',
            reportes: [
                { id: 'comparativo-nominas', nombre: 'Comparativo de Nóminas', icon: '📊', desc: 'Comparar dos períodos de nómina', requiereNomina: true },
                { id: 'evolucion-salarios', nombre: 'Evolución Salarial', icon: '📈', desc: 'Histórico de cambios salariales' }
            ]
        }
    ];
    
    const [categoriaReporteActiva, setCategoriaReporteActiva] = useState(null);

    // Filtros
    const empsFiltrados = useMemo(() => empleados.filter(e => {
        const matchSearch = e.nombre.toLowerCase().includes(searchTerm.toLowerCase()) || e.documento?.includes(searchTerm) || e.nss?.includes(searchTerm) || e.celular?.includes(searchTerm);
        const matchDept = filterDept === 'TODOS' || e.departamento === filterDept;
        const esDesvinculado = e.fechaSalida ? true : false;
        const matchEstado = filterEstado === 'TODOS' || 
            (filterEstado === 'ACTIVOS' && e.activo && !esDesvinculado) ||
            (filterEstado === 'DESVINCULADOS' && esDesvinculado);
        return matchSearch && matchDept && matchEstado;
    }), [empleados, searchTerm, filterDept, filterEstado]);

    const stats = useMemo(() => {
        const activos = empleados.filter(e => e.activo && !e.fechaSalida);
        const desvinculados = empleados.filter(e => e.fechaSalida);
        return {
            totalEmps: activos.length,
            totalDesvinculados: desvinculados.length,
            totalNomina: activos.reduce((s, e) => s + e.salarioBase, 0),
            totalPrestamos: prestamos.filter(p => p.activo).reduce((s, p) => s + p.saldo, 0),
            prestamosActivos: prestamos.filter(p => p.activo && p.saldo > 0).length,
            licenciasActivas: licencias.filter(l => new Date(l.fechaFin) >= new Date()).length
        };
    }, [empleados, prestamos, licencias]);

    const nominaPorDepto = useMemo(() => {
        const dets = getDetallesRecalc();
        return dets.reduce((acc, d) => { if (!acc[d.depto]) acc[d.depto] = []; acc[d.depto].push(d); return acc; }, {});
    }, [currentNomina, nominaEdits, config]);

    const totalesNomina = useMemo(() => {
        const dets = getDetallesRecalc();
        if (!dets.length) return null;
        return dets.reduce((a, d) => ({
            totalIng: a.totalIng + d.totalIng, totalDed: a.totalDed + d.totalDed, totalNeto: a.totalNeto + d.neto,
            totalAfpEmp: a.totalAfpEmp + d.afpEmp, totalSfsEmp: a.totalSfsEmp + d.sfsEmp, totalIsr: a.totalIsr + d.isr,
            totalAfpPat: a.totalAfpPat + d.afpPat, totalSfsPat: a.totalSfsPat + d.sfsPat,
            totalInfotep: a.totalInfotep + d.infotep, totalRiesgo: a.totalRiesgo + d.riesgo
        }), { totalIng: 0, totalDed: 0, totalNeto: 0, totalAfpEmp: 0, totalSfsEmp: 0, totalIsr: 0, totalAfpPat: 0, totalSfsPat: 0, totalInfotep: 0, totalRiesgo: 0 });
    }, [currentNomina, nominaEdits, config]);

    const volantesData = useMemo(() => {
        if (!currentNomina) return [];
        const dets = getDetallesRecalc();
        if (selectedVolante) {
            const d = dets.find(x => x.empId === selectedVolante);
            const e = empleados.find(x => x.id === selectedVolante);
            return d && e ? [{ emp: e, det: d }] : [];
        }
        return dets.map(d => ({ emp: empleados.find(e => e.id === d.empId), det: d })).filter(x => x.emp);
    }, [currentNomina, selectedVolante, nominaEdits, empleados]);

    // Calcular totales por banco para fondos a depositar
    const fondosPorBanco = useMemo(() => {
        if (!currentNomina) return null;
        const dets = getDetallesRecalc();
        const bancos = {};
        
        dets.forEach(d => {
            const emp = empleados.find(e => e.id === d.empId);
            if (!emp) return;
            
            const banco = emp.banco || 'Sin cuenta';
            const cuenta = emp.cuenta || '';
            
            if (!bancos[banco]) {
                bancos[banco] = { empleados: [], totalNeto: 0, totalBruto: 0 };
            }
            bancos[banco].empleados.push({ 
                nombre: d.nombre, 
                cuenta, 
                neto: d.neto, 
                bruto: d.salarioBase,
                cedula: emp.documento || '',
                departamento: emp.departamento || '',
                totalIng: d.totalIng,
                totalDed: d.totalDed,
                afpEmp: d.afpEmp,
                sfsEmp: d.sfsEmp,
                isr: d.isr
            });
            bancos[banco].totalNeto += d.neto;
            bancos[banco].totalBruto += d.salarioBase;
        });
        
        return bancos;
    }, [currentNomina, nominaEdits, empleados]);

    // =========================================
    // PERMISOS DE USUARIO
    // =========================================
    const esAdmin = usuarioActual?.rol === 'admin';

    // =========================================
    // RENDER VISTAS
    // =========================================
    const renderDashboard = () => (
        <>
            {/* Panel de conexión SharePoint */}
            {!spConnected && (
                <div className="card" style={{marginBottom:'16px', background:'linear-gradient(135deg, #0078d4 0%, #00bcf2 100%)', color:'white', border:'none'}}>
                    <div className="card-body" style={{display:'flex', alignItems:'center', justifyContent:'space-between', padding:'16px 20px'}}>
                        <div>
                            <h3 style={{fontSize:'14px', fontWeight:'700', marginBottom:'4px', display:'flex', alignItems:'center', gap:'8px'}}>
                                <Icons.Cloud /> Conectar con SharePoint
                            </h3>
                            <p style={{fontSize:'11px', opacity:0.9}}>
                                Sincroniza tus datos con Microsoft 365 para acceso desde cualquier dispositivo y respaldo automático.
                            </p>
                        </div>
                        <button className="btn" style={{background:'white', color:'#0078d4', fontWeight:'700'}} onClick={handleLogin}>
                            <Icons.LogIn /> Conectar ahora
                        </button>
                    </div>
                </div>
            )}
            
            <div className="stats">
                <div className="stat"><div className="stat-header"><span className="stat-label">Empleados</span><div className="stat-icon green"><Icons.Users /></div></div><div className="stat-value">{stats.totalEmps}</div><div className="stat-sub">Activos</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Nómina Mensual</span><div className="stat-icon blue"><Icons.Dollar /></div></div><div className="stat-value" style={{fontSize:'15px'}}>RD$ {formatMoney(stats.totalNomina)}</div><div className="stat-sub">Salarios base</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Préstamos</span><div className="stat-icon purple"><Icons.CreditCard /></div></div><div className="stat-value">{stats.prestamosActivos}</div><div className="stat-sub">RD$ {formatMoney(stats.totalPrestamos)}</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Licencias</span><div className="stat-icon orange"><Icons.Calendar /></div></div><div className="stat-value">{stats.licenciasActivas}</div><div className="stat-sub">Activas</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">AFP Emp.</span><div className="stat-icon yellow"><Icons.FileText /></div></div><div className="stat-value">{config.tss.afpEmpleado}%</div><div className="stat-sub">Tasa vigente</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">SFS Emp.</span><div className="stat-icon red"><Icons.FileText /></div></div><div className="stat-value">{config.tss.sfsEmpleado}%</div><div className="stat-sub">Tasa vigente</div></div>
            </div>

            <div style={{display:'grid', gridTemplateColumns:'2fr 1fr', gap:'16px'}}>
                <div className="card">
                    <div className="card-header"><span className="card-title"><Icons.Calendar /> Generar Nómina</span></div>
                    <div className="card-body">
                        {!(
                            <div className="alert alert-warning" style={{marginBottom:'12px'}}>
                                <Icons.AlertCircle /><span><strong>Modo Consulta:</strong> Solo puede ver información. Contacte al administrador para generar nóminas.</span>
                            </div>
                        )}
                        <div className="alert alert-info"><Icons.Info /><span>La nómina se genera como borrador. Puede ajustar ausencias, tardanzas, horas extras y otros conceptos antes de guardar.</span></div>
                        <div className="form-row" style={{flexWrap:'wrap', gap:'12px', marginBottom:'12px'}}>
                            <div className="form-group"><label className="form-label">Tipo</label><select className="form-control" style={{width:'110px'}} value={periodo.tipo} onChange={e => setPeriodo(p => ({...p, tipo: e.target.value}))} disabled={!esAdmin}><option value="quincenal">Quincenal</option><option value="mensual">Mensual</option></select></div>
                            <div className="form-group"><label className="form-label">Mes</label><select className="form-control" style={{width:'110px'}} value={periodo.mes} onChange={e => setPeriodo(p => ({...p, mes: +e.target.value}))} disabled={!esAdmin}>{MESES.slice(1).map((m,i) => <option key={i} value={i+1}>{m}</option>)}</select></div>
                            <div className="form-group"><label className="form-label">Año</label><select className="form-control" style={{width:'80px'}} value={periodo.año} onChange={e => setPeriodo(p => ({...p, año: +e.target.value}))} disabled={!esAdmin}><option>2024</option><option>2025</option><option>2026</option></select></div>
                            {periodo.tipo === 'quincenal' && <div className="form-group"><label className="form-label">Quincena</label><select className="form-control" style={{width:'120px'}} value={periodo.quincena} onChange={e => setPeriodo(p => ({...p, quincena: +e.target.value}))} disabled={!esAdmin}><option value="1">1ra (1-15)</option><option value="2">2da (16-31)</option></select></div>}
                        </div>
                        {periodo.mes === 12 && <div className="alert alert-success"><Icons.Gift /><span><strong>Regalía Pascual:</strong> Se incluirá automáticamente en la {periodo.tipo === 'quincenal' ? '2da quincena' : 'nómina'} de diciembre.</span></div>}
                        <button className="btn btn-primary" style={{width:'100%'}} onClick={generarNomina} disabled={!esAdmin}><Icons.FileText /> Generar Nómina</button>
                    </div>
                </div>

                <div className="card">
                    <div className="card-header"><span className="card-title"><Icons.Activity /> Accesos Rápidos</span></div>
                    <div className="card-body" style={{display:'grid', gap:'8px'}}>
                        {esAdmin ? (
                            <>
                                <button className="btn btn-secondary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Nuevo Empleado</button>
                                <button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.CreditCard /> Registrar Préstamo</button>
                                <button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Calendar /> Nueva Licencia</button>
                                <button className="btn btn-orange" onClick={() => openModal('reportes')}><Icons.FileText /> 📊 Centro Reportes</button>
                            </>
                        ) : (
                            <>
                                <button className="btn btn-secondary" onClick={() => setView('empleados')}><Icons.Users /> Ver Empleados</button>
                                <button className="btn btn-purple" onClick={() => setView('prestamos')}><Icons.CreditCard /> Ver Préstamos</button>
                                <button className="btn btn-info" onClick={() => setView('historial')}><Icons.FileText /> Ver Historial</button>
                            </>
                        )}
                    </div>
                </div>
            </div>
            
            {/* Nueva sección informativa */}
            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'16px', marginTop:'16px'}}>
                {/* Cumpleañeros del Mes */}
                <div className="card" style={{background:'linear-gradient(135deg, #fff9c4 0%, #fff59d 100%)', border:'none'}}>
                    <div className="card-header" style={{borderBottom:'1px solid rgba(0,0,0,0.1)'}}>
                        <span className="card-title" style={{color:'#f57f17'}}>🎂 Cumpleañeros de {MESES[new Date().getMonth() + 1]}</span>
                    </div>
                    <div className="card-body" style={{maxHeight:'180px', overflowY:'auto'}}>
                        {(() => {
                            const mesActual = new Date().getMonth() + 1;
                            const cumples = empleados.filter(e => e.activo && !e.fechaSalida && e.fechaNacimiento)
                                .filter(e => new Date(e.fechaNacimiento).getMonth() + 1 === mesActual)
                                .sort((a,b) => new Date(a.fechaNacimiento).getDate() - new Date(b.fechaNacimiento).getDate());
                            return cumples.length === 0 ? (
                                <div style={{textAlign:'center', padding:'20px', color:'#795548'}}>
                                    <div style={{fontSize:'24px', marginBottom:'8px'}}>🎈</div>
                                    <div style={{fontSize:'11px'}}>No hay cumpleañeros este mes</div>
                                </div>
                            ) : (
                                <div style={{display:'flex', flexDirection:'column', gap:'8px'}}>
                                    {cumples.slice(0,5).map(e => (
                                        <div key={e.id} style={{display:'flex', alignItems:'center', gap:'10px', padding:'6px 8px', background:'rgba(255,255,255,0.6)', borderRadius:'8px'}}>
                                            <div style={{width:'32px', height:'32px', borderRadius:'50%', background:'linear-gradient(135deg, #ff9800, #ff5722)', display:'flex', alignItems:'center', justifyContent:'center', color:'white', fontWeight:'700', fontSize:'11px'}}>
                                                {new Date(e.fechaNacimiento).getDate()}
                                            </div>
                                            <div>
                                                <div style={{fontWeight:'600', fontSize:'11px', color:'#333'}}>{e.nombre.split(' ').slice(0,2).join(' ')}</div>
                                                <div style={{fontSize:'9px', color:'#666'}}>{e.departamento} • {calcularEdad(e.fechaNacimiento)} años</div>
                                            </div>
                                        </div>
                                    ))}
                                    {cumples.length > 5 && <div style={{fontSize:'10px', color:'#795548', textAlign:'center'}}>+{cumples.length - 5} más</div>}
                                </div>
                            );
                        })()}
                    </div>
                </div>
                
                {/* Calendario Fiscal */}
                <div className="card" style={{background:'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', border:'none'}}>
                    <div className="card-header" style={{borderBottom:'1px solid rgba(0,0,0,0.1)'}}>
                        <span className="card-title" style={{color:'#1565c0'}}>📅 Calendario Fiscal RD</span>
                    </div>
                    <div className="card-body">
                        <div style={{display:'flex', flexDirection:'column', gap:'8px'}}>
                            <div style={{padding:'8px 10px', background:'rgba(255,255,255,0.7)', borderRadius:'8px', borderLeft:'3px solid #1565c0'}}>
                                <div style={{fontWeight:'600', fontSize:'11px', color:'#1565c0'}}>📋 TSS (Seguridad Social)</div>
                                <div style={{fontSize:'10px', color:'#333'}}>Pago antes del día <strong>3</strong> de cada mes</div>
                            </div>
                            <div style={{padding:'8px 10px', background:'rgba(255,255,255,0.7)', borderRadius:'8px', borderLeft:'3px solid #388e3c'}}>
                                <div style={{fontWeight:'600', fontSize:'11px', color:'#388e3c'}}>💰 IR-17 (Retenciones)</div>
                                <div style={{fontSize:'10px', color:'#333'}}>Presentar antes del día <strong>10</strong></div>
                            </div>
                            <div style={{padding:'8px 10px', background:'rgba(255,255,255,0.7)', borderRadius:'8px', borderLeft:'3px solid #f57c00'}}>
                                <div style={{fontWeight:'600', fontSize:'11px', color:'#f57c00'}}>📄 INFOTEP</div>
                                <div style={{fontSize:'10px', color:'#333'}}>Pago trimestral (Abril, Julio, Oct, Enero)</div>
                            </div>
                            <div style={{padding:'8px 10px', background:'rgba(255,255,255,0.7)', borderRadius:'8px', borderLeft:'3px solid #7b1fa2'}}>
                                <div style={{fontWeight:'600', fontSize:'11px', color:'#7b1fa2'}}>🎁 Regalía Pascual</div>
                                <div style={{fontSize:'10px', color:'#333'}}>Pagar antes del <strong>20 de diciembre</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Tips Educativos */}
                <div className="card" style={{background:'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border:'none'}}>
                    <div className="card-header" style={{borderBottom:'1px solid rgba(0,0,0,0.1)'}}>
                        <span className="card-title" style={{color:'#2e7d32'}}>💡 Sabías que...</span>
                    </div>
                    <div className="card-body">
                        {(() => {
                            const tips = [
                                { titulo: 'Vacaciones', texto: 'Todo trabajador tiene derecho a 14 días de vacaciones después de 1 año de trabajo continuo (Art. 177 CT).', icon: '🏖️' },
                                { titulo: 'Horas Extras', texto: 'Las horas extras se pagan con 35% adicional (normales) y 100% adicional (nocturnas/feriados).', icon: '⏰' },
                                { titulo: 'Preaviso', texto: 'El preaviso va de 7 días (3-6 meses) hasta 28 días (más de 1 año de trabajo).', icon: '📝' },
                                { titulo: 'Cesantía', texto: 'La cesantía se calcula: 6 días por año trabajado para los primeros 2 años, luego varía según antigüedad.', icon: '💼' },
                                { titulo: 'Salario 13', texto: 'La Regalía Pascual (Salario 13) debe pagarse antes del 20 de diciembre de cada año.', icon: '🎄' },
                                { titulo: 'Maternidad', texto: 'La licencia de maternidad es de 14 semanas: 6 antes y 8 después del parto.', icon: '👶' },
                                { titulo: 'AFP', texto: 'El tope máximo cotizable AFP es de 20 salarios mínimos (actualmente RD$ 508,800/mes).', icon: '🏦' },
                                { titulo: 'Bonificación', texto: 'Las empresas pueden otorgar bonificaciones sin que estas formen parte del salario ordinario.', icon: '🎁' }
                            ];
                            const tipDelDia = tips[new Date().getDate() % tips.length];
                            return (
                                <div style={{padding:'12px', background:'rgba(255,255,255,0.7)', borderRadius:'10px'}}>
                                    <div style={{display:'flex', alignItems:'center', gap:'10px', marginBottom:'8px'}}>
                                        <span style={{fontSize:'28px'}}>{tipDelDia.icon}</span>
                                        <span style={{fontWeight:'700', fontSize:'13px', color:'#1b5e20'}}>{tipDelDia.titulo}</span>
                                    </div>
                                    <p style={{fontSize:'11px', color:'#333', lineHeight:'1.5', margin:0}}>{tipDelDia.texto}</p>
                                </div>
                            );
                        })()}
                        <div style={{marginTop:'12px', textAlign:'center'}}>
                            <span style={{fontSize:'9px', color:'#558b2f', fontStyle:'italic'}}>📚 Código de Trabajo de la República Dominicana</span>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Alertas y Recordatorios */}
            {(() => {
                const prestamosVencer = prestamos.filter(p => p.activo && p.saldo > 0 && Math.ceil(p.saldo / p.cuotaMensual) <= 2);
                const licenciasActivas = licencias.filter(l => l.activo && new Date(l.fechaFin) >= new Date());
                const sinBanco = empleados.filter(e => e.activo && !e.fechaSalida && !e.banco);
                const sinNSS = empleados.filter(e => e.activo && !e.fechaSalida && !e.nss);
                
                const alertas = [];
                if (prestamosVencer.length > 0) alertas.push({ tipo: 'warning', icon: '💳', texto: `${prestamosVencer.length} préstamo(s) próximo(s) a completarse` });
                if (sinBanco.length > 0) alertas.push({ tipo: 'info', icon: '🏦', texto: `${sinBanco.length} empleado(s) sin datos bancarios` });
                if (sinNSS.length > 0) alertas.push({ tipo: 'info', icon: '📋', texto: `${sinNSS.length} empleado(s) sin NSS registrado` });
                
                return alertas.length > 0 ? (
                    <div style={{marginTop:'16px', display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))', gap:'10px'}}>
                        {alertas.map((a, i) => (
                            <div key={i} className={`alert alert-${a.tipo}`} style={{margin:0}}>
                                <span style={{fontSize:'16px'}}>{a.icon}</span>
                                <span style={{fontSize:'11px'}}>{a.texto}</span>
                            </div>
                        ))}
                    </div>
                ) : null;
            })()}
        </>
    );

    const renderEmpleados = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.Users /> Empleados ({empsFiltrados.length})</span>{<button className="btn btn-primary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Nuevo</button>}</div>
            <div className="card-body">
                <div className="search-wrap"><Icons.Search className="search-icon" /><input className="search-input" placeholder="Buscar por nombre, documento o celular..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                <div style={{display:'flex', gap:'16px', flexWrap:'wrap', marginBottom:'12px'}}>
                    <div className="filters"><span className={`filter ${filterDept === 'TODOS' ? 'active' : ''}`} onClick={() => setFilterDept('TODOS')}>Todos Dptos</span>{DEPARTAMENTOS.slice(0,6).map(d => <span key={d} className={`filter ${filterDept === d ? 'active' : ''}`} onClick={() => setFilterDept(d)}>{d}</span>)}</div>
                    <div className="filters">
                        <span className={`filter ${filterEstado === 'ACTIVOS' ? 'active' : ''}`} onClick={() => setFilterEstado('ACTIVOS')} style={{background: filterEstado === 'ACTIVOS' ? 'var(--success)' : ''}}>✅ Activos</span>
                        <span className={`filter ${filterEstado === 'DESVINCULADOS' ? 'active' : ''}`} onClick={() => setFilterEstado('DESVINCULADOS')} style={{background: filterEstado === 'DESVINCULADOS' ? 'var(--danger)' : ''}}>🚪 Desvinculados</span>
                        <span className={`filter ${filterEstado === 'TODOS' ? 'active' : ''}`} onClick={() => setFilterEstado('TODOS')}>📋 Todos</span>
                    </div>
                </div>
                <div className="table-wrap">
                    <table>
                        <thead><tr><th>Empleado</th><th>Documento</th><th>Edad</th><th>Celular</th><th>Departamento</th><th>Salario</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody>
                            {empsFiltrados.map(e => {
                                const prest = getPrestamosPend(e.id).reduce((s,p) => s + p.saldo, 0);
                                const esDesvinculado = e.fechaSalida ? true : false;
                                const edad = calcularEdad(e.fechaNacimiento);
                                return (
                                    <tr key={e.id} style={esDesvinculado ? {opacity: 0.7, background: 'rgba(239,68,68,0.05)'} : {}}>
                                        <td><div className="emp-cell"><div className="emp-avatar" style={esDesvinculado ? {background: '#6c757d'} : {}}>{getInitials(e.nombre)}</div><div><div className="emp-name">{e.nombre}</div><div className="emp-sub">{e.cargo || e.departamento}</div></div></div></td>
                                        <td style={{fontFamily:'JetBrains Mono', fontSize:'10px'}}><span className="badge badge-secondary" style={{fontSize:'8px', marginRight:'4px'}}>{e.tipoDocumento === 'pasaporte' ? 'PAS' : 'CED'}</span>{e.documento}</td>
                                        <td style={{textAlign:'center'}}>{edad !== null ? <span style={{fontWeight:'600'}}>{edad} <span style={{fontSize:'9px', color:'var(--text-muted)'}}>años</span></span> : <span style={{color:'var(--text-muted)'}}>-</span>}</td>
                                        <td style={{fontSize:'11px'}}>{e.celular || <span style={{color:'var(--text-muted)'}}>-</span>}</td>
                                        <td><span className="badge badge-info">{e.departamento}</span></td>
                                        <td className="money">RD$ {formatMoney(e.salarioBase)}</td>
                                        <td>
                                            {esDesvinculado ? (
                                                <div>
                                                    <span className="badge badge-danger">Desvinculado</span>
                                                    <div style={{fontSize:'9px', color:'var(--text-muted)', marginTop:'2px'}}>{formatDate(e.fechaSalida)}</div>
                                                </div>
                                            ) : (
                                                <span className={`badge ${e.activo ? 'badge-success' : 'badge-warning'}`}>{e.activo ? 'Activo' : 'Inactivo'}</span>
                                            )}
                                        </td>
                                        <td>
                                            <div className="actions">
                                                {<button className="action-btn" title="Editar" onClick={() => editarEmpleado(e)}><Icons.Edit /></button>}
                                                {<button className="action-btn" title="Liquidar" onClick={() => calcularLiquidacionEmp(e)}><Icons.UserMinus /></button>}
                                                <button className="action-btn" title="Constancia" onClick={() => { setSelectedEmp(e); openModal('constancia'); }}><Icons.FileText /></button>
                                                <button className="action-btn" title="Ver historial nóminas" onClick={() => { setSelectedEmp(e); setView('historial'); }}><Icons.Clock /></button>
                                                {<button className="action-btn danger" title="Eliminar" onClick={() => eliminarEmpleado(e.id)}><Icons.Trash /></button>}
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );

    const renderNomina = () => {
        if (!currentNomina) return (
            <div className="card"><div className="card-body"><div className="empty"><Icons.FileText /><h3>No hay nómina generada</h3><p>Genere una desde el Dashboard</p><button className="btn btn-primary" style={{marginTop:'12px'}} onClick={() => setView('dashboard')}>Ir al Dashboard</button></div></div></div>
        );

        const periodoTxt = currentNomina.periodo.tipo === 'quincenal' ? `Q${currentNomina.periodo.quincena} ${MESES[currentNomina.periodo.mes]} ${currentNomina.periodo.año}` : `${MESES[currentNomina.periodo.mes]} ${currentNomina.periodo.año}`;
        const esBorrador = currentNomina.estado === 'borrador';
        const esProcesada = currentNomina.estado === 'procesada' || currentNomina.estado === 'guardada';
        const esAnulada = currentNomina.estado === 'anulada';
        const codigo = currentNomina.codigo || 'Sin código';

        return (
            <div className="card">
                <div className="card-header">
                    <span className="card-title">
                        <Icons.FileText /> Nómina: {periodoTxt} 
                        <span className="badge badge-info" style={{marginLeft:'8px', fontFamily:'JetBrains Mono'}}>{codigo}</span>
                        {esBorrador && <span className="badge badge-warning" style={{marginLeft:'6px'}}>Borrador</span>}
                        {esProcesada && <span className="badge badge-success" style={{marginLeft:'6px'}}>Procesada</span>}
                        {esAnulada && <span className="badge badge-danger" style={{marginLeft:'6px'}}>Anulada</span>}
                    </span>
                    <div className="btn-group">
                        {esBorrador && (
                            <>
                                <button className="btn btn-primary" onClick={guardarBorrador} style={{fontWeight:'bold'}}><Icons.Save /> 💾 Guardar Borrador</button>
                                <button className="btn btn-success" onClick={procesarNomina}><Icons.Check /> Procesar Nómina</button>
                            </>
                        )}
                        {esProcesada && (
                            <>
                                {<button className="btn btn-warning" onClick={() => editarNomina(currentNomina)}><Icons.Edit /> Editar</button>}
                                <button className="btn btn-info" onClick={imprimirNomina}><Icons.Printer /> Imprimir</button>
                                <button className="btn btn-purple" onClick={() => { setSelectedVolante(null); openModal('volantes'); }}><Icons.Receipt /> Volantes</button>
                                <button className="btn btn-orange" onClick={() => abrirCentroReportes()}><Icons.FileText /> 📊 Reportes</button>
                                <button className="btn btn-secondary" onClick={exportarExcel}><Icons.Download /> Excel</button>
                                {<button className="btn btn-danger" onClick={() => anularNomina(currentNomina)}><Icons.X /> Anular</button>}
                            </>
                        )}
                        {esAnulada && (
                            <button className="btn btn-primary" onClick={() => setView('dashboard')}><Icons.Plus /> Crear Nueva</button>
                        )}
                    </div>
                </div>
                <div className="card-body">
                    {esBorrador && <div className="alert alert-warning"><Icons.AlertCircle /><span><strong>Nómina en Borrador:</strong> Ajuste ausencias, tardanzas, horas extras y deducciones. Luego presione "Procesar Nómina" para finalizar.</span></div>}
                    {esAnulada && <div className="alert alert-danger"><Icons.AlertCircle /><span><strong>Nómina Anulada:</strong> {currentNomina.motivoAnulacion || 'Sin motivo especificado'}. Puede crear una nueva nómina para este período desde el Dashboard.</span></div>}
                    
                    <div className="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th className="sticky-col">Empleado</th>
                                    <th>Salario</th>
                                    {esBorrador && <><th>Aus.</th><th>Tard.</th><th>H.35%</th><th>H.100%</th><th>Bonif.</th><th>Comis.</th><th>Incent.</th><th>Viát.</th><th>+Otros</th><th>-Otros</th></>}
                                    <th>AFP</th>
                                    <th>SFS</th>
                                    <th>ISR</th>
                                    <th>Préstamo</th>
                                    <th>Otras</th>
                                    <th>Total Ded.</th>
                                    <th>Neto</th>
                                    {esProcesada && <th></th>}
                                </tr>
                            </thead>
                            <tbody>
                                {Object.entries(nominaPorDepto).map(([depto, dets]) => (
                                    <React.Fragment key={depto}>
                                        {dets.map(d => (
                                            <tr key={d.empId}>
                                                <td className="sticky-col"><div className="emp-cell"><div className="emp-avatar" style={{width:24,height:24,fontSize:9}}>{getInitials(d.nombre)}</div><div><div className="emp-name" style={{fontSize:10}}>{d.nombre}</div><span className="badge badge-secondary" style={{fontSize:8}}>{d.depto}</span></div></div></td>
                                                <td className="money">{formatMoney(d.salarioBase)}</td>
                                                {esBorrador && <>
                                                    <td>
                                                        <button 
                                                            className="btn btn-xs" 
                                                            style={{
                                                                minWidth:'45px', 
                                                                padding:'2px 6px',
                                                                background: (nominaEdits[d.empId]?.diasAus || 0) > 0 ? '#dc3545' : '#6c757d',
                                                                color: 'white',
                                                                border: 'none'
                                                            }} 
                                                            onClick={() => abrirModalAusencias(d.empId)}
                                                            title={nominaEdits[d.empId]?.fechasAus?.length > 0 ? nominaEdits[d.empId].fechasAus.map(f => formatFechaCorta(f)).join(', ') : 'Click para registrar ausencias'}
                                                        >
                                                            {nominaEdits[d.empId]?.diasAus || 0}
                                                        </button>
                                                    </td>
                                                    <td><input className="inline-input" type="number" min="0" style={{width:'45px'}} value={nominaEdits[d.empId]?.minTard || ''} onChange={e => updateEdit(d.empId, 'minTard', e.target.value)} placeholder="min" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.horas35 || ''} onChange={e => updateEdit(d.empId, 'horas35', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.horas100 || ''} onChange={e => updateEdit(d.empId, 'horas100', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.bonificacion || ''} onChange={e => updateEdit(d.empId, 'bonificacion', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.comisiones || ''} onChange={e => updateEdit(d.empId, 'comisiones', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.incentivos || ''} onChange={e => updateEdit(d.empId, 'incentivos', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.viaticos || ''} onChange={e => updateEdit(d.empId, 'viaticos', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.otrosIng || ''} onChange={e => updateEdit(d.empId, 'otrosIng', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.otrasDed || ''} onChange={e => updateEdit(d.empId, 'otrasDed', e.target.value)} placeholder="0" /></td>
                                                </>}
                                                <td className="money">{formatMoney(d.afpEmp)}</td>
                                                <td className="money">{formatMoney(d.sfsEmp)}</td>
                                                <td className="money">{d.isr > 0 ? formatMoney(d.isr) : '-'}</td>
                                                <td className="money">{d.cuotaPrestamo > 0 ? formatMoney(d.cuotaPrestamo) : '-'}</td>
                                                <td className="money">{(d.cooperativa + d.seguroPrivado + d.embargo + d.descAusencias + d.descTardanzas) > 0 ? formatMoney(d.cooperativa + d.seguroPrivado + d.embargo + d.descAusencias + d.descTardanzas) : '-'}</td>
                                                <td className="money neg">{formatMoney(d.totalDed)}</td>
                                                <td className="money pos" style={{fontWeight:700}}>{formatMoney(d.neto)}</td>
                                                {esProcesada && <td><button className="btn btn-xs btn-secondary" onClick={() => { setSelectedVolante(d.empId); openModal('volantes'); }}><Icons.Eye /></button></td>}
                                            </tr>
                                        ))}
                                        <tr className="dept-row">
                                            <td className="sticky-col"><strong>TOTAL {depto}</strong></td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.salarioBase,0))}</td>
                                            {esBorrador && <td colSpan="5"></td>}
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.afpEmp,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.sfsEmp,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.isr,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.cuotaPrestamo,0))}</td>
                                            <td></td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.totalDed,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.neto,0))}</td>
                                            {esProcesada && <td></td>}
                                        </tr>
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {totalesNomina && (
                        <div className="summary-grid">
                            <div className="summary-box">
                                <div className="summary-title">Resumen Nómina</div>
                                <div className="summary-row"><span>Total Ingresos</span><span>RD$ {formatMoney(totalesNomina.totalIng)}</span></div>
                                <div className="summary-row"><span>TSS Empleado</span><span>RD$ {formatMoney(totalesNomina.totalAfpEmp + totalesNomina.totalSfsEmp)}</span></div>
                                <div className="summary-row"><span>ISR</span><span>RD$ {formatMoney(totalesNomina.totalIsr)}</span></div>
                                <div className="summary-row"><span>Total Deducciones</span><span style={{color:'var(--danger)'}}>RD$ {formatMoney(totalesNomina.totalDed)}</span></div>
                                <div className="summary-row"><span>NETO A PAGAR</span><span style={{color:'var(--success)'}}>RD$ {formatMoney(totalesNomina.totalNeto)}</span></div>
                            </div>
                            <div className="summary-box">
                                <div className="summary-title">Aportes Patronales</div>
                                <div className="summary-row"><span>AFP ({config.tss.afpEmpleador}%)</span><span>RD$ {formatMoney(totalesNomina.totalAfpPat)}</span></div>
                                <div className="summary-row"><span>SFS ({config.tss.sfsEmpleador}%)</span><span>RD$ {formatMoney(totalesNomina.totalSfsPat)}</span></div>
                                <div className="summary-row"><span>INFOTEP ({config.tss.infotep}%)</span><span>RD$ {formatMoney(totalesNomina.totalInfotep)}</span></div>
                                <div className="summary-row"><span>Riesgo Laboral ({config.tss.riesgoLaboral}%)</span><span>RD$ {formatMoney(totalesNomina.totalRiesgo)}</span></div>
                                <div className="summary-row"><span>TOTAL APORTES</span><span style={{color:'var(--primary)'}}>RD$ {formatMoney(totalesNomina.totalAfpPat + totalesNomina.totalSfsPat + totalesNomina.totalInfotep + totalesNomina.totalRiesgo)}</span></div>
                            </div>
                            <div className="summary-box">
                                <div className="summary-title">TSS Consolidado (DGII)</div>
                                <div className="summary-row"><span>AFP Total</span><span>RD$ {formatMoney(totalesNomina.totalAfpEmp + totalesNomina.totalAfpPat)}</span></div>
                                <div className="summary-row"><span>SFS Total</span><span>RD$ {formatMoney(totalesNomina.totalSfsEmp + totalesNomina.totalSfsPat)}</span></div>
                                <div className="summary-row"><span>ISR Retenido (IR-17)</span><span>RD$ {formatMoney(totalesNomina.totalIsr)}</span></div>
                                <div className="summary-row"><span>Empleados</span><span>{getDetallesRecalc().length}</span></div>
                            </div>
                        </div>
                    )}
                    
                    {fondosPorBanco && Object.keys(fondosPorBanco).length > 0 && (
                        <div className="card" style={{marginTop:'16px', background:'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)', border:'none'}}>
                            <div className="card-header" style={{borderBottom:'1px solid rgba(255,255,255,0.1)'}}>
                                <span className="card-title" style={{color:'white'}}><Icons.CreditCard /> 💰 Fondos a Depositar por Banco</span>
                            </div>
                            <div className="card-body">
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))', gap:'12px'}}>
                                    {Object.entries(fondosPorBanco).sort((a,b) => b[1].totalNeto - a[1].totalNeto).map(([banco, data]) => (
                                        <div key={banco} style={{
                                            background: banco === 'Sin cuenta' ? 'linear-gradient(135deg, #6c757d, #495057)' : 
                                                        banco === 'Banreservas' ? 'linear-gradient(135deg, #00723f, #005a32)' :
                                                        banco === 'BHD León' ? 'linear-gradient(135deg, #003366, #001a33)' :
                                                        banco === 'Banco Popular' ? 'linear-gradient(135deg, #ff6600, #cc5200)' :
                                                        banco === 'ACAP' ? 'linear-gradient(135deg, #8b0000, #5c0000)' :
                                                        'linear-gradient(135deg, #2c3e50, #1a252f)',
                                            borderRadius:'12px',
                                            padding:'16px',
                                            color:'white'
                                        }}>
                                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'12px'}}>
                                                <div style={{fontWeight:'700', fontSize:'14px'}}>{banco === 'Sin cuenta' ? '💵 Efectivo/Cheque' : `🏦 ${banco}`}</div>
                                                <div style={{background:'rgba(255,255,255,0.2)', padding:'4px 10px', borderRadius:'20px', fontSize:'11px'}}>{data.empleados.length} emp.</div>
                                            </div>
                                            <div style={{fontSize:'24px', fontWeight:'800', marginBottom:'8px', fontFamily:'JetBrains Mono'}}>
                                                RD$ {formatMoney(data.totalNeto)}
                                            </div>
                                            <div style={{fontSize:'10px', opacity:0.8, marginBottom:'10px'}}>Neto a depositar</div>
                                            <div style={{borderTop:'1px solid rgba(255,255,255,0.2)', paddingTop:'10px', maxHeight:'120px', overflowY:'auto'}}>
                                                {data.empleados.map((emp, idx) => (
                                                    <div key={idx} style={{display:'flex', justifyContent:'space-between', fontSize:'10px', padding:'3px 0', borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                                                        <span style={{opacity:0.9, maxWidth:'55%', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{emp.nombre}</span>
                                                        <span style={{fontFamily:'JetBrains Mono', fontWeight:'600'}}>RD$ {formatMoney(emp.neto)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            {banco !== 'Sin cuenta' && (
                                                <div style={{marginTop:'8px', fontSize:'9px', opacity:0.6, textAlign:'right'}}>
                                                    Cta: {data.empleados[0]?.cuenta ? data.empleados[0].cuenta.slice(-4) + '...' : 'Ver detalle'}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div style={{marginTop:'16px', padding:'16px', background:'rgba(255,255,255,0.1)', borderRadius:'12px', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                    <div>
                                        <div style={{color:'rgba(255,255,255,0.7)', fontSize:'11px'}}>TOTAL NETO A PAGAR</div>
                                        <div style={{color:'#4ade80', fontSize:'28px', fontWeight:'800', fontFamily:'JetBrains Mono'}}>
                                            RD$ {formatMoney(Object.values(fondosPorBanco).reduce((sum, b) => sum + b.totalNeto, 0))}
                                        </div>
                                    </div>
                                    <div style={{display:'flex', alignItems:'center', gap:'16px'}}>
                                        <div style={{textAlign:'right'}}>
                                            <div style={{color:'rgba(255,255,255,0.7)', fontSize:'11px'}}>BANCOS</div>
                                            <div style={{color:'white', fontSize:'20px', fontWeight:'700'}}>{Object.keys(fondosPorBanco).length}</div>
                                        </div>
                                        <button 
                                            className="btn" 
                                            style={{background:'#4ade80', color:'#000', fontWeight:'700', padding:'12px 20px'}}
                                            onClick={() => openModal('pagosBanco')}
                                        >
                                            <Icons.Printer /> Imprimir Checklist
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const renderPrestamos = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.CreditCard /> Préstamos y Adelantos</span><button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.Plus /> Nuevo</button></div>
            <div className="card-body">
                {prestamos.length === 0 ? <div className="empty"><Icons.CreditCard /><h3>Sin préstamos</h3></div> : (
                    <div className="table-wrap">
                        <table>
                            <thead><tr><th>Empleado</th><th>Descripción</th><th>Monto</th><th>Cuota</th><th>Progreso</th><th>Saldo</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody>
                                {prestamos.map(p => {
                                    const emp = empleados.find(e => e.id === p.empleadoId);
                                    return (
                                        <tr key={p.id}>
                                            <td><div className="emp-cell"><div className="emp-avatar" style={{background:'linear-gradient(135deg, var(--purple), #8e44ad)'}}>{emp ? getInitials(emp.nombre) : '?'}</div><div><div className="emp-name">{emp?.nombre || 'N/A'}</div></div></div></td>
                                            <td>{p.desc}</td>
                                            <td className="money">RD$ {formatMoney(p.monto)}</td>
                                            <td className="money">RD$ {formatMoney(p.cuotaMensual)}</td>
                                            <td style={{minWidth:'100px'}}><div style={{display:'flex',alignItems:'center',gap:'6px'}}><div className="progress" style={{flex:1}}><div className="progress-bar" style={{width:`${(p.cuotasPagadas/p.cuotas)*100}%`}}></div></div><span style={{fontSize:'9px'}}>{p.cuotasPagadas}/{p.cuotas}</span></div></td>
                                            <td className="money" style={{fontWeight:700}}>RD$ {formatMoney(p.saldo)}</td>
                                            <td><span className={`badge ${p.activo && p.saldo > 0 ? 'badge-warning' : 'badge-success'}`}>{p.activo && p.saldo > 0 ? 'Activo' : 'Pagado'}</span></td>
                                            <td>
                                                <div style={{display:'flex', gap:'4px'}}>
                                                    <button className="btn btn-sm" onClick={() => editarPrestamo(p)} title="Editar" disabled={!esAdmin}><Icons.Edit /></button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => eliminarPrestamo(p)} title="Eliminar" disabled={!esAdmin}><Icons.Trash /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );

    const renderLicencias = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.Calendar /> Licencias y Permisos</span><button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Plus /> Nueva</button></div>
            <div className="card-body">
                <div className="alert alert-info"><Icons.Info /><span><strong>Licencias RD:</strong> Maternidad (14 semanas), Paternidad (2 días), Vacaciones (14 días mín. después de 1 año), Duelo (3 días), Matrimonio (5 días).</span></div>
                {licencias.length === 0 ? <div className="empty"><Icons.Calendar /><h3>Sin licencias registradas</h3></div> : (
                    <div className="table-wrap">
                        <table>
                            <thead><tr><th>Empleado</th><th>Tipo</th><th>Inicio</th><th>Fin</th><th>Con Pago</th><th>Notas</th><th>Estado</th></tr></thead>
                            <tbody>
                                {licencias.map(l => {
                                    const emp = empleados.find(e => e.id === l.empleadoId);
                                    const activa = new Date(l.fechaFin) >= new Date();
                                    return (
                                        <tr key={l.id}>
                                            <td><div className="emp-cell"><div className="emp-avatar">{emp ? getInitials(emp.nombre) : '?'}</div><div className="emp-name">{emp?.nombre || 'N/A'}</div></div></td>
                                            <td><span className="badge badge-info">{l.tipo}</span></td>
                                            <td>{formatDate(l.fechaInicio)}</td>
                                            <td>{formatDate(l.fechaFin)}</td>
                                            <td>{l.conPago ? <span className="badge badge-success">Sí</span> : <span className="badge badge-danger">No</span>}</td>
                                            <td style={{fontSize:'10px'}}>{l.notas || '-'}</td>
                                            <td><span className={`badge ${activa ? 'badge-warning' : 'badge-secondary'}`}>{activa ? 'Activa' : 'Finalizada'}</span></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );

    // Estados para filtros del historial
    const [historialFiltro, setHistorialFiltro] = useState({ año: 'TODOS', departamento: 'TODOS' });
    
    // Generar código único de nómina (formato: YYYYMMQQ o YYYYMM)
    const generarCodigoNomina = (periodo) => {
        const año = periodo.año.toString();
        const mes = periodo.mes.toString().padStart(2, '0');
        const quincena = periodo.tipo === 'quincenal' ? periodo.quincena.toString() : '0';
        return `${año}${mes}${quincena}`;
    };
    
    // Calcular fechas del período
    const getFechasPeriodo = (periodo) => {
        const año = periodo.año;
        const mes = periodo.mes;
        const ultimoDia = new Date(año, mes, 0).getDate();
        
        if (periodo.tipo === 'quincenal') {
            if (periodo.quincena === 1) {
                return { inicio: `01/${mes.toString().padStart(2,'0')}/${año}`, fin: `15/${mes.toString().padStart(2,'0')}/${año}` };
            } else {
                return { inicio: `16/${mes.toString().padStart(2,'0')}/${año}`, fin: `${ultimoDia}/${mes.toString().padStart(2,'0')}/${año}` };
            }
        } else {
            return { inicio: `01/${mes.toString().padStart(2,'0')}/${año}`, fin: `${ultimoDia}/${mes.toString().padStart(2,'0')}/${año}` };
        }
    };
    
    // Filtrar nóminas del historial
    const nominasFiltradas = useMemo(() => {
        return nominas.filter(n => {
            const matchAño = historialFiltro.año === 'TODOS' || n.periodo.año.toString() === historialFiltro.año;
            return matchAño;
        }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    }, [nominas, historialFiltro]);
    
    const renderHistorial = () => (
        <div className="card">
            <div className="card-header">
                <span className="card-title"><Icons.Clock /> Historial de Nóminas</span>
                <div style={{display:'flex', gap:'8px', alignItems:'center'}}>
                    <select className="form-control sm" style={{width:'100px'}} value={historialFiltro.año} onChange={e => setHistorialFiltro(f => ({...f, año: e.target.value}))}>
                        <option value="TODOS">Todos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <span style={{fontSize:'10px', color:'var(--text-muted)'}}>{nominasFiltradas.length} nóminas</span>
                </div>
            </div>
            <div className="card-body">
                {nominasFiltradas.length === 0 ? (
                    <div className="empty"><Icons.Clock /><h3>Sin historial</h3><p>Las nóminas guardadas aparecerán aquí</p></div>
                ) : (
                    <div className="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Fecha Inicial</th>
                                    <th>Fecha Final</th>
                                    <th>Tipo</th>
                                    <th>Empleados</th>
                                    <th>Total Bruto</th>
                                    <th>Total Ded.</th>
                                    <th>Total Neto</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {nominasFiltradas.map(n => {
                                    const codigo = n.codigo || generarCodigoNomina(n.periodo);
                                    const fechas = getFechasPeriodo(n.periodo);
                                    const totalBruto = n.detalles.reduce((s,d) => s + d.totalIng, 0);
                                    const totalDed = n.detalles.reduce((s,d) => s + d.totalDed, 0);
                                    const totalNeto = n.detalles.reduce((s,d) => s + d.neto, 0);
                                    const esProcesada = n.estado === 'procesada' || n.estado === 'guardada';
                                    const esAnulada = n.estado === 'anulada';
                                    return (
                                        <tr key={n.id} style={esAnulada ? {opacity: 0.6, textDecoration: 'line-through'} : {}}>
                                            <td><span className="badge badge-info" style={{fontFamily:'JetBrains Mono', fontSize:'10px'}}>{codigo}</span></td>
                                            <td style={{fontFamily:'JetBrains Mono', fontSize:'10px'}}>{fechas.inicio}</td>
                                            <td style={{fontFamily:'JetBrains Mono', fontSize:'10px'}}>{fechas.fin}</td>
                                            <td><span className={`badge ${n.periodo.tipo === 'quincenal' ? 'badge-purple' : 'badge-info'}`} style={{fontSize:'9px'}}>{n.periodo.tipo === 'quincenal' ? `Q${n.periodo.quincena}` : 'Mensual'}</span></td>
                                            <td style={{textAlign:'center'}}>{n.detalles.length}</td>
                                            <td className="money">RD$ {formatMoney(totalBruto)}</td>
                                            <td className="money neg">RD$ {formatMoney(totalDed)}</td>
                                            <td className="money pos" style={{fontWeight:700}}>RD$ {formatMoney(totalNeto)}</td>
                                            <td>
                                                <span className={`badge ${esProcesada ? 'badge-success' : esAnulada ? 'badge-danger' : 'badge-warning'}`}>
                                                    {esProcesada ? 'Procesada' : esAnulada ? 'Anulada' : 'Borrador'}
                                                </span>
                                            </td>
                                            <td>
                                                <div className="btn-group">
                                                    <button className="btn btn-xs btn-secondary" title="Ver detalle" onClick={() => { setCurrentNomina(n); setView('nomina'); }}><Icons.Eye /></button>
                                                    {n.estado === 'borrador' && (
                                                        <>
                                                            <button className="btn btn-xs btn-primary" title="Continuar editando" onClick={() => cargarBorrador(n)}><Icons.Edit /></button>
                                                            <button className="btn btn-xs btn-danger" title="Eliminar borrador" onClick={() => { if(window.confirm('¿Eliminar este borrador?')) setNominas(p => p.filter(x => x.id !== n.id)); }}><Icons.Trash /></button>
                                                        </>
                                                    )}
                                                    {esProcesada && (
                                                        <>
                                                            <button className="btn btn-xs btn-purple" title="Volantes" onClick={() => { setCurrentNomina(n); setSelectedVolante(null); openModal('volantes'); }}><Icons.Receipt /></button>
                                                            <button className="btn btn-xs btn-info" title="Imprimir" onClick={() => { setCurrentNomina(n); setTimeout(imprimirNomina, 100); }}><Icons.Printer /></button>
                                                            <button className="btn btn-xs btn-warning" title="Editar" onClick={() => editarNomina(n)}><Icons.Edit /></button>
                                                            <button className="btn btn-xs btn-danger" title="Anular" onClick={() => anularNomina(n)}><Icons.X /></button>
                                                        </>
                                                    )}
                                                    {esAnulada && (
                                                        <span style={{fontSize:'9px', color:'var(--text-muted)', marginLeft:'4px'}} title={n.motivoAnulacion}>Anulada</span>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        {/* Resumen */}
                        <div style={{marginTop:'16px', padding:'12px', background:'var(--bg-main)', borderRadius:'8px'}}>
                            <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'16px', textAlign:'center'}}>
                                <div><div style={{fontSize:'10px', color:'var(--text-secondary)', marginBottom:'4px'}}>NÓMINAS</div><div style={{fontSize:'18px', fontWeight:'700'}}>{nominasFiltradas.length}</div></div>
                                <div><div style={{fontSize:'10px', color:'var(--text-secondary)', marginBottom:'4px'}}>TOTAL BRUTO</div><div style={{fontSize:'14px', fontWeight:'700', fontFamily:'JetBrains Mono'}}>RD$ {formatMoney(nominasFiltradas.reduce((s,n) => s + n.detalles.reduce((ss,d) => ss + d.totalIng, 0), 0))}</div></div>
                                <div><div style={{fontSize:'10px', color:'var(--text-secondary)', marginBottom:'4px'}}>TOTAL DEDUCCIONES</div><div style={{fontSize:'14px', fontWeight:'700', fontFamily:'JetBrains Mono', color:'var(--danger)'}}>RD$ {formatMoney(nominasFiltradas.reduce((s,n) => s + n.detalles.reduce((ss,d) => ss + d.totalDed, 0), 0))}</div></div>
                                <div><div style={{fontSize:'10px', color:'var(--text-secondary)', marginBottom:'4px'}}>TOTAL NETO PAGADO</div><div style={{fontSize:'14px', fontWeight:'700', fontFamily:'JetBrains Mono', color:'var(--success)'}}>RD$ {formatMoney(nominasFiltradas.reduce((s,n) => s + n.detalles.reduce((ss,d) => ss + d.neto, 0), 0))}</div></div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );

    // Funciones para gestión de catálogos
    const agregarItemCatalogo = () => {
        if (!nuevoItem.trim()) return toast('Ingrese un valor', 'error');
        const lista = catalogos[catalogoActivo];
        if (lista.includes(nuevoItem.trim().toUpperCase()) || lista.includes(nuevoItem.trim())) {
            return toast('Este valor ya existe', 'error');
        }
        setCatalogos(prev => ({
            ...prev,
            [catalogoActivo]: [...prev[catalogoActivo], catalogoActivo === 'departamentos' ? nuevoItem.trim().toUpperCase() : nuevoItem.trim()]
        }));
        setNuevoItem('');
        toast('Agregado correctamente', 'success');
    };
    
    const eliminarItemCatalogo = (item) => {
        if (!window.confirm(`¿Eliminar "${item}"?`)) return;
        setCatalogos(prev => ({
            ...prev,
            [catalogoActivo]: prev[catalogoActivo].filter(i => i !== item)
        }));
        toast('Eliminado correctamente', 'success');
    };
    
    const editarItemCatalogo = (itemOriginal, itemNuevo) => {
        if (!itemNuevo.trim()) return;
        setCatalogos(prev => ({
            ...prev,
            [catalogoActivo]: prev[catalogoActivo].map(i => i === itemOriginal ? (catalogoActivo === 'departamentos' ? itemNuevo.trim().toUpperCase() : itemNuevo.trim()) : i)
        }));
        setEditandoItem(null);
        toast('Actualizado correctamente', 'success');
    };
    
    const catalogoInfo = {
        departamentos: { titulo: 'Departamentos', icono: <Icons.Users />, descripcion: 'Áreas o departamentos de la institución' },
        bancos: { titulo: 'Bancos', icono: <Icons.CreditCard />, descripcion: 'Entidades bancarias para pagos' },
        tiposContrato: { titulo: 'Tipos de Contrato', icono: <Icons.FileText />, descripcion: 'Modalidades de contratación laboral' },
        tiposLicencia: { titulo: 'Tipos de Licencia', icono: <Icons.Calendar />, descripcion: 'Tipos de permisos y licencias' },
        tiposRemuneracion: { titulo: 'Tipos de Remuneración', icono: <Icons.Dollar />, descripcion: 'Formas de pago según TSS' },
        cargos: { titulo: 'Cargos', icono: <Icons.Award />, descripcion: 'Posiciones o cargos laborales' }
    };

    const renderMantenimiento = () => (
        <div style={{display:'grid', gridTemplateColumns:'280px 1fr', gap:'16px'}}>
            {/* Panel lateral de catálogos */}
            <div className="card">
                <div className="card-header"><span className="card-title"><Icons.Database /> Catálogos</span></div>
                <div className="card-body" style={{padding:'8px'}}>
                    {Object.entries(catalogoInfo).map(([key, info]) => (
                        <div 
                            key={key}
                            className={`nav-item ${catalogoActivo === key ? 'active' : ''}`}
                            style={{margin:'2px 0', background: catalogoActivo === key ? 'var(--primary-light)' : 'transparent', color: catalogoActivo === key ? 'white' : 'var(--text-primary)', borderRadius:'6px', cursor:'pointer'}}
                            onClick={() => { setCatalogoActivo(key); setNuevoItem(''); setEditandoItem(null); }}
                        >
                            {info.icono}
                            <div>
                                <div style={{fontWeight:600, fontSize:'11px'}}>{info.titulo}</div>
                                <div style={{fontSize:'9px', opacity:0.7}}>{catalogos[key].length} items</div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
            
            {/* Panel de edición */}
            <div className="card">
                <div className="card-header">
                    <span className="card-title">{catalogoInfo[catalogoActivo].icono} {catalogoInfo[catalogoActivo].titulo}</span>
                    <span style={{fontSize:'10px', color:'var(--text-muted)'}}>{catalogoInfo[catalogoActivo].descripcion}</span>
                </div>
                <div className="card-body">
                    {/* Formulario agregar */}
                    <div style={{display:'flex', gap:'8px', marginBottom:'16px'}}>
                        <input 
                            className="form-control" 
                            placeholder={`Nuevo ${catalogoInfo[catalogoActivo].titulo.slice(0,-1).toLowerCase()}...`}
                            value={nuevoItem}
                            onChange={e => setNuevoItem(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && agregarItemCatalogo()}
                        />
                        <button className="btn btn-primary" onClick={agregarItemCatalogo}><Icons.Plus /> Agregar</button>
                    </div>
                    
                    {/* Lista de items */}
                    <div className="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th style={{width:'40px'}}>#</th>
                                    <th>Nombre</th>
                                    <th style={{width:'100px'}}>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {catalogos[catalogoActivo].map((item, idx) => (
                                    <tr key={idx}>
                                        <td style={{textAlign:'center', color:'var(--text-muted)'}}>{idx + 1}</td>
                                        <td>
                                            {editandoItem === item ? (
                                                <input 
                                                    className="form-control sm"
                                                    defaultValue={item}
                                                    autoFocus
                                                    onBlur={e => editarItemCatalogo(item, e.target.value)}
                                                    onKeyPress={e => e.key === 'Enter' && editarItemCatalogo(item, e.target.value)}
                                                />
                                            ) : (
                                                <span style={{fontWeight:500}}>{item}</span>
                                            )}
                                        </td>
                                        <td>
                                            <div className="actions">
                                                <button className="action-btn" title="Editar" onClick={() => setEditandoItem(item)}><Icons.Edit /></button>
                                                <button className="action-btn danger" title="Eliminar" onClick={() => eliminarItemCatalogo(item)}><Icons.Trash /></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {catalogos[catalogoActivo].length === 0 && (
                        <div className="empty">
                            <Icons.AlertCircle />
                            <h3>Sin registros</h3>
                            <p>Agregue nuevos items usando el formulario de arriba</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );

    const renderConfig = () => (
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'16px'}}>
            <div className="card">
                <div className="card-header"><span className="card-title"><Icons.Settings /> Tasas TSS</span></div>
                <div className="card-body">
                    <div className="config-section">
                        <div className="config-title">Aportes del Empleado</div>
                        <div className="config-row"><span>AFP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.afpEmpleado} onChange={e => setConfig(c => ({...c, tss: {...c.tss, afpEmpleado: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>SFS</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.sfsEmpleado} onChange={e => setConfig(c => ({...c, tss: {...c.tss, sfsEmpleado: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Aportes del Empleador</div>
                        <div className="config-row"><span>AFP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.afpEmpleador} onChange={e => setConfig(c => ({...c, tss: {...c.tss, afpEmpleador: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>SFS</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.sfsEmpleador} onChange={e => setConfig(c => ({...c, tss: {...c.tss, sfsEmpleador: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>INFOTEP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.infotep} onChange={e => setConfig(c => ({...c, tss: {...c.tss, infotep: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>Riesgo Laboral</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.riesgoLaboral} onChange={e => setConfig(c => ({...c, tss: {...c.tss, riesgoLaboral: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Topes Cotizables</div>
                        <div className="config-row"><span>Tope AFP</span><input className="config-input" style={{width:'100px'}} type="number" value={config.tss.topeAfp} onChange={e => setConfig(c => ({...c, tss: {...c.tss, topeAfp: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Tope SFS</span><input className="config-input" style={{width:'100px'}} type="number" value={config.tss.topeSfs} onChange={e => setConfig(c => ({...c, tss: {...c.tss, topeSfs: +e.target.value}}))} /></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">PDSS - Plan de Servicios de Salud</div>
                        <div className="config-row"><span>Per Cápita Adicional</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}>RD$ <input className="config-input" style={{width:'80px'}} type="number" value={config.tss.pdssPerCapita} onChange={e => setConfig(c => ({...c, tss: {...c.tss, pdssPerCapita: +e.target.value}}))} />/mes</div></div>
                        <div style={{fontSize:'10px', color:'var(--text-muted)', marginTop:'4px'}}>Monto mensual por cada dependiente adicional inscrito en el SFS del empleado</div>
                    </div>
                </div>
            </div>
            <div className="card">
                <div className="card-header"><span className="card-title"><Icons.FileText /> Parámetros Generales</span></div>
                <div className="card-body">
                    <div className="config-section">
                        <div className="config-title">Cálculos</div>
                        <div className="config-row"><span>Días laborables/mes</span><input className="config-input" type="number" step="0.01" value={config.general.diasMes} onChange={e => setConfig(c => ({...c, general: {...c.general, diasMes: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Salario mínimo</span><input className="config-input" style={{width:'90px'}} type="number" value={config.general.salarioMinimo} onChange={e => setConfig(c => ({...c, general: {...c.general, salarioMinimo: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Días vacaciones (mín)</span><input className="config-input" type="number" value={config.general.vacacionesDias} onChange={e => setConfig(c => ({...c, general: {...c.general, vacacionesDias: +e.target.value}}))} /></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Horas Extras</div>
                        <div className="config-row"><span>Horas 9-44 semanal</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" value={config.general.horasExtra35} onChange={e => setConfig(c => ({...c, general: {...c.general, horasExtra35: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>+44, feriados, domingos</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" value={config.general.horasExtra100} onChange={e => setConfig(c => ({...c, general: {...c.general, horasExtra100: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Empresa</div>
                        <div style={{marginBottom:'8px'}}><label className="form-label">Nombre</label><input className="form-control sm" value={config.empresa.nombre} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, nombre: e.target.value}}))} /></div>
                        <div style={{marginBottom:'8px'}}><label className="form-label">RNC</label><input className="form-control sm" value={config.empresa.rnc} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, rnc: e.target.value}}))} /></div>
                        <div><label className="form-label">Dirección</label><input className="form-control sm" value={config.empresa.direccion} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, direccion: e.target.value}}))} /></div>
                    </div>
                    <button className="btn btn-primary" style={{width:'100%',marginTop:'12px'}} onClick={() => toast('Configuración guardada', 'success')}><Icons.Save /> Guardar Configuración</button>
                    <button className="btn btn-warning" style={{width:'100%',marginTop:'8px'}} onClick={forzarActualizacionEmpleados}><Icons.Refresh /> Actualizar Empleados desde Plantilla</button>
                    <button className="btn btn-danger" style={{width:'100%',marginTop:'8px'}} onClick={restaurarDatosPorDefecto}><Icons.Trash /> Restaurar TODO por Defecto</button>
                </div>
            </div>
        </div>
    );

    const renderContent = () => {
        switch(view) {
            case 'dashboard': return renderDashboard();
            case 'empleados': return renderEmpleados();
            case 'nomina': return renderNomina();
            case 'prestamos': return renderPrestamos();
            case 'licencias': return renderLicencias();
            case 'historial': return renderHistorial();
            case 'mantenimiento': return renderMantenimiento();
            case 'config': return renderConfig();
            default: return renderDashboard();
        }
    };

    return (
        <div className="app">
            {/* Pantalla de Login */}
            {!usuarioActual && !paso2FA ? (
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #0D47A1 0%, #1565C0 50%, #1E88E5 100%)',
                    padding: '20px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '32px',
                        width: '100%',
                        maxWidth: '360px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }}>
                        {/* Logo Tehui */}
                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                            <img 
                                src="data:image/png;base64,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"
                                alt="Centro Educativo Tehui"
                                style={{ width: '120px', height: '120px', objectFit: 'contain', marginBottom: '16px' }}
                            />
                            <h1 style={{ 
                                fontSize: '20px', 
                                fontWeight: '700', 
                                marginBottom: '4px',
                                color: 'var(--primary)'
                            }}>
                                Sistema de Nómina
                            </h1>
                        </div>
                        
                        {/* Formulario */}
                        <form onSubmit={handleUserLogin}>
                            <div style={{ marginBottom: '14px' }}>
                                <label style={{ display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '5px', color: 'var(--text-secondary)' }}>
                                    👤 Usuario
                                </label>
                                <input 
                                    type="text"
                                    className="form-control"
                                    value={loginForm.usuario}
                                    onChange={e => setLoginForm(f => ({ ...f, usuario: e.target.value, error: '' }))}
                                    placeholder="Ingrese su usuario"
                                    style={{ width: '100%', padding: '10px 12px' }}
                                    autoFocus
                                />
                            </div>
                            <div style={{ marginBottom: '18px' }}>
                                <label style={{ display: 'block', fontSize: '11px', fontWeight: '600', marginBottom: '5px', color: 'var(--text-secondary)' }}>
                                    🔒 Contraseña
                                </label>
                                <input 
                                    type="password"
                                    className="form-control"
                                    value={loginForm.password}
                                    onChange={e => setLoginForm(f => ({ ...f, password: e.target.value, error: '' }))}
                                    placeholder="Ingrese su contraseña"
                                    style={{ width: '100%', padding: '10px 12px' }}
                                />
                            </div>
                            
                            {loginForm.error && (
                                <div style={{ 
                                    padding: '10px 12px', 
                                    background: 'rgba(239,68,68,0.1)', 
                                    border: '1px solid rgba(239,68,68,0.3)',
                                    borderRadius: '8px', 
                                    color: 'var(--danger)',
                                    fontSize: '12px',
                                    marginBottom: '14px'
                                }}>
                                    ⚠️ {loginForm.error}
                                </div>
                            )}
                            
                            <button 
                                type="submit" 
                                className="btn btn-primary"
                                style={{ 
                                    width: '100%', 
                                    padding: '11px',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}
                            >
                                🔑 Iniciar Sesión
                            </button>
                        </form>
                        
                        <div style={{ 
                            marginTop: '20px', 
                            paddingTop: '16px', 
                            borderTop: '1px solid var(--border)',
                            textAlign: 'center'
                        }}>
                            <p style={{ fontSize: '10px', color: 'var(--text-muted)' }}>
                                Sistema Nómina Tehui v3.83 © 2026
                            </p>
                        </div>
                    </div>
                </div>
            ) : paso2FA === 'configurar' ? (
                /* ========================================== */
                /* PANTALLA DE CONFIGURACIÓN 2FA (Primera vez) */
                /* ========================================== */
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #0D47A1 0%, #1565C0 50%, #1E88E5 100%)',
                    padding: '20px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '32px',
                        width: '100%',
                        maxWidth: '420px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }}>
                        <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '12px'
                            }}>🔐</div>
                            <h2 style={{ 
                                fontSize: '18px', 
                                fontWeight: '700', 
                                color: 'var(--primary)',
                                marginBottom: '8px'
                            }}>
                                Configurar Autenticación
                            </h2>
                            <p style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                Escanea el código QR con Microsoft Authenticator
                            </p>
                        </div>
                        
                        {/* Código QR */}
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'center', 
                            marginBottom: '20px',
                            padding: '16px',
                            background: '#f8f9fa',
                            borderRadius: '12px'
                        }}>
                            <div id="qr-2fa-container" style={{ 
                                width: '200px', 
                                height: '200px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}>
                                <span style={{ color: 'var(--text-muted)' }}>Generando QR...</span>
                            </div>
                        </div>
                        
                        {/* Instrucciones */}
                        <div style={{ 
                            background: '#e3f2fd', 
                            padding: '12px', 
                            borderRadius: '8px',
                            marginBottom: '16px',
                            fontSize: '11px'
                        }}>
                            <strong>📱 Pasos:</strong>
                            <ol style={{ marginLeft: '16px', marginTop: '6px', lineHeight: '1.6' }}>
                                <li>Abre Microsoft Authenticator en tu celular</li>
                                <li>Toca "+" y selecciona "Otra cuenta"</li>
                                <li>Escanea este código QR</li>
                                <li>Ingresa el código de 6 dígitos abajo</li>
                            </ol>
                        </div>
                        
                        {/* Código secreto manual (backup) */}
                        <details style={{ marginBottom: '16px' }}>
                            <summary style={{ 
                                fontSize: '11px', 
                                color: 'var(--text-secondary)', 
                                cursor: 'pointer' 
                            }}>
                                ¿No puedes escanear? Ingresa manualmente
                            </summary>
                            <div style={{ 
                                marginTop: '8px', 
                                padding: '10px', 
                                background: '#fff3e0',
                                borderRadius: '6px',
                                fontFamily: 'JetBrains Mono, monospace',
                                fontSize: '12px',
                                wordBreak: 'break-all',
                                textAlign: 'center'
                            }}>
                                {secretoTemp}
                            </div>
                        </details>
                        
                        {/* Formulario de verificación */}
                        <form onSubmit={handleVerificar2FA}>
                            <div style={{ marginBottom: '14px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    fontSize: '11px', 
                                    fontWeight: '600', 
                                    marginBottom: '5px', 
                                    color: 'var(--text-secondary)' 
                                }}>
                                    🔢 Código de verificación
                                </label>
                                <input 
                                    type="text"
                                    className="form-control"
                                    value={codigo2FA}
                                    onChange={e => {
                                        const val = e.target.value.replace(/\D/g, '').slice(0, 6);
                                        setCodigo2FA(val);
                                        setError2FA('');
                                    }}
                                    placeholder="000000"
                                    maxLength={6}
                                    style={{ 
                                        width: '100%', 
                                        padding: '12px', 
                                        fontSize: '24px',
                                        textAlign: 'center',
                                        letterSpacing: '8px',
                                        fontFamily: 'JetBrains Mono, monospace'
                                    }}
                                    autoFocus
                                />
                            </div>
                            
                            {error2FA && (
                                <div style={{ 
                                    padding: '10px 12px', 
                                    background: 'rgba(239,68,68,0.1)', 
                                    border: '1px solid rgba(239,68,68,0.3)',
                                    borderRadius: '8px', 
                                    color: 'var(--danger)',
                                    fontSize: '12px',
                                    marginBottom: '14px'
                                }}>
                                    ⚠️ {error2FA}
                                </div>
                            )}
                            
                            <button 
                                type="submit" 
                                className="btn btn-primary"
                                disabled={codigo2FA.length !== 6}
                                style={{ 
                                    width: '100%', 
                                    padding: '11px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    opacity: codigo2FA.length !== 6 ? 0.6 : 1
                                }}
                            >
                                ✓ Verificar y Activar 2FA
                            </button>
                        </form>
                        
                        {/* Opción alternativa: código por correo */}
                        <div style={{ 
                            marginTop: '20px', 
                            paddingTop: '16px', 
                            borderTop: '1px solid var(--border)',
                            textAlign: 'center'
                        }}>
                            <p style={{ fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px' }}>
                                ¿Prefieres recibir el código por correo?
                            </p>
                            <button 
                                onClick={handleEnviarCodigoEmail}
                                disabled={enviandoEmail}
                                style={{ 
                                    width: '100%',
                                    padding: '10px',
                                    background: 'linear-gradient(135deg, var(--tehui-orange), #EF6C00)',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'white',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    opacity: enviandoEmail ? 0.7 : 1
                                }}
                            >
                                {enviandoEmail ? '📧 Enviando...' : '📧 Usar código por correo'}
                            </button>
                            <p style={{ fontSize: '9px', color: 'var(--text-muted)', marginTop: '8px' }}>
                                Podrás configurar Authenticator más tarde
                            </p>
                        </div>
                        
                        <button 
                            onClick={cancelar2FA}
                            style={{ 
                                width: '100%', 
                                marginTop: '12px',
                                padding: '10px',
                                background: 'none',
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                color: 'var(--text-secondary)',
                                fontSize: '12px',
                                cursor: 'pointer'
                            }}
                        >
                            ← Cancelar
                        </button>
                    </div>
                </div>
            ) : paso2FA === 'verificar' ? (
                /* ========================================== */
                /* PANTALLA DE VERIFICACIÓN 2FA (Cada login) */
                /* ========================================== */
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #0D47A1 0%, #1565C0 50%, #1E88E5 100%)',
                    padding: '20px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '32px',
                        width: '100%',
                        maxWidth: '360px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }}>
                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '12px'
                            }}>📱</div>
                            <h2 style={{ 
                                fontSize: '18px', 
                                fontWeight: '700', 
                                color: 'var(--primary)',
                                marginBottom: '8px'
                            }}>
                                Verificación de Seguridad
                            </h2>
                            <p style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                Ingresa el código de Microsoft Authenticator
                            </p>
                        </div>
                        
                        <form onSubmit={handleVerificar2FA}>
                            <div style={{ marginBottom: '20px' }}>
                                <input 
                                    type="text"
                                    className="form-control"
                                    value={codigo2FA}
                                    onChange={e => {
                                        const val = e.target.value.replace(/\D/g, '').slice(0, 6);
                                        setCodigo2FA(val);
                                        setError2FA('');
                                    }}
                                    placeholder="000000"
                                    maxLength={6}
                                    style={{ 
                                        width: '100%', 
                                        padding: '16px', 
                                        fontSize: '28px',
                                        textAlign: 'center',
                                        letterSpacing: '10px',
                                        fontFamily: 'JetBrains Mono, monospace',
                                        border: '2px solid var(--border)',
                                        borderRadius: '12px'
                                    }}
                                    autoFocus
                                />
                                <p style={{ 
                                    fontSize: '10px', 
                                    color: 'var(--text-muted)', 
                                    textAlign: 'center',
                                    marginTop: '8px'
                                }}>
                                    El código cambia cada 30 segundos
                                </p>
                            </div>
                            
                            {error2FA && (
                                <div style={{ 
                                    padding: '10px 12px', 
                                    background: 'rgba(239,68,68,0.1)', 
                                    border: '1px solid rgba(239,68,68,0.3)',
                                    borderRadius: '8px', 
                                    color: 'var(--danger)',
                                    fontSize: '12px',
                                    marginBottom: '14px',
                                    textAlign: 'center'
                                }}>
                                    ⚠️ {error2FA}
                                </div>
                            )}
                            
                            <button 
                                type="submit" 
                                className="btn btn-primary"
                                disabled={codigo2FA.length !== 6}
                                style={{ 
                                    width: '100%', 
                                    padding: '12px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    opacity: codigo2FA.length !== 6 ? 0.6 : 1
                                }}
                            >
                                🔓 Verificar
                            </button>
                        </form>
                        
                        <button 
                            onClick={cancelar2FA}
                            style={{ 
                                width: '100%', 
                                marginTop: '12px',
                                padding: '10px',
                                background: 'none',
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                color: 'var(--text-secondary)',
                                fontSize: '12px',
                                cursor: 'pointer'
                            }}
                        >
                            ← Volver al login
                        </button>
                        
                        {/* Opción de código por correo */}
                        <div style={{ 
                            marginTop: '16px', 
                            paddingTop: '16px', 
                            borderTop: '1px solid var(--border)',
                            textAlign: 'center'
                        }}>
                            <p style={{ fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px' }}>
                                ¿No tienes acceso a Authenticator?
                            </p>
                            <button 
                                onClick={handleEnviarCodigoEmail}
                                disabled={enviandoEmail}
                                style={{ 
                                    width: '100%',
                                    padding: '10px',
                                    background: 'linear-gradient(135deg, var(--tehui-orange), #EF6C00)',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'white',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    opacity: enviandoEmail ? 0.7 : 1
                                }}
                            >
                                {enviandoEmail ? '📧 Enviando...' : '📧 Enviar código al correo'}
                            </button>
                        </div>
                        
                        <div style={{ 
                            marginTop: '12px', 
                            textAlign: 'center'
                        }}>
                            <p style={{ fontSize: '10px', color: 'var(--text-muted)' }}>
                                Usuario: <strong>{usuarioTemp}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            ) : paso2FA === 'email' ? (
                /* ========================================== */
                /* PANTALLA DE CÓDIGO POR EMAIL */
                /* ========================================== */
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #E65100 0%, #FB8C00 50%, #FFA726 100%)',
                    padding: '20px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '32px',
                        width: '100%',
                        maxWidth: '360px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }}>
                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '12px'
                            }}>📧</div>
                            <h2 style={{ 
                                fontSize: '18px', 
                                fontWeight: '700', 
                                color: 'var(--tehui-orange)',
                                marginBottom: '8px'
                            }}>
                                Código por Correo
                            </h2>
                            <p style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                {mensajeEmail || 'Ingresa el código enviado a tu correo'}
                            </p>
                        </div>
                        
                        <div style={{
                            background: '#fff3e0',
                            padding: '12px',
                            borderRadius: '8px',
                            marginBottom: '20px',
                            fontSize: '11px',
                            color: '#E65100'
                        }}>
                            ⏱️ El código expira en <strong>5 minutos</strong>
                        </div>
                        
                        <form onSubmit={handleVerificarCodigoEmail}>
                            <div style={{ marginBottom: '20px' }}>
                                <input 
                                    type="text"
                                    className="form-control"
                                    value={codigo2FA}
                                    onChange={e => {
                                        const val = e.target.value.replace(/\D/g, '').slice(0, 6);
                                        setCodigo2FA(val);
                                        setError2FA('');
                                    }}
                                    placeholder="000000"
                                    maxLength={6}
                                    style={{ 
                                        width: '100%', 
                                        padding: '16px', 
                                        fontSize: '28px',
                                        textAlign: 'center',
                                        letterSpacing: '10px',
                                        fontFamily: 'JetBrains Mono, monospace',
                                        border: '2px solid var(--tehui-orange)',
                                        borderRadius: '12px'
                                    }}
                                    autoFocus
                                />
                            </div>
                            
                            {error2FA && (
                                <div style={{ 
                                    padding: '10px 12px', 
                                    background: 'rgba(239,68,68,0.1)', 
                                    border: '1px solid rgba(239,68,68,0.3)',
                                    borderRadius: '8px', 
                                    color: 'var(--danger)',
                                    fontSize: '12px',
                                    marginBottom: '14px',
                                    textAlign: 'center'
                                }}>
                                    ⚠️ {error2FA}
                                </div>
                            )}
                            
                            <button 
                                type="submit" 
                                className="btn btn-orange"
                                disabled={codigo2FA.length !== 6}
                                style={{ 
                                    width: '100%', 
                                    padding: '12px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    opacity: codigo2FA.length !== 6 ? 0.6 : 1
                                }}
                            >
                                🔓 Verificar Código
                            </button>
                        </form>
                        
                        {/* Reenviar código */}
                        <button 
                            onClick={handleEnviarCodigoEmail}
                            disabled={enviandoEmail}
                            style={{ 
                                width: '100%', 
                                marginTop: '12px',
                                padding: '10px',
                                background: 'none',
                                border: '1px solid var(--tehui-orange)',
                                borderRadius: '8px',
                                color: 'var(--tehui-orange)',
                                fontSize: '12px',
                                cursor: 'pointer',
                                opacity: enviandoEmail ? 0.6 : 1
                            }}
                        >
                            {enviandoEmail ? '📧 Enviando...' : '🔄 Reenviar código'}
                        </button>
                        
                        <button 
                            onClick={() => {
                                setPaso2FA('verificar');
                                setCodigo2FA('');
                                setError2FA('');
                                setMensajeEmail('');
                            }}
                            style={{ 
                                width: '100%', 
                                marginTop: '8px',
                                padding: '10px',
                                background: 'none',
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                color: 'var(--text-secondary)',
                                fontSize: '12px',
                                cursor: 'pointer'
                            }}
                        >
                            ← Volver a Authenticator
                        </button>
                        
                        <div style={{ 
                            marginTop: '16px', 
                            paddingTop: '12px', 
                            borderTop: '1px solid var(--border)',
                            textAlign: 'center'
                        }}>
                            <p style={{ fontSize: '10px', color: 'var(--text-muted)' }}>
                                Usuario: <strong>{usuarioTemp}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            ) : (
            <>
            {/* Sidebar */}
            <aside className="sidebar no-print">
                <div className="sidebar-header"><div className="logo"><div className="logo-icon"><img src="data:image/png;base64,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" alt="Tehui" /></div><div><h1>Nómina Tehui</h1><span>Sistema v3.83</span></div></div></div>
                <nav className="nav">
                    <div className="nav-group"><div className="nav-label">Principal</div>
                        <div className={`nav-item ${view === 'dashboard' ? 'active' : ''}`} onClick={() => setView('dashboard')}><Icons.Dashboard /><span>Dashboard</span></div>
                        <div className={`nav-item ${view === 'empleados' ? 'active' : ''}`} onClick={() => setView('empleados')}><Icons.Users /><span>Empleados</span></div>
                        <div className={`nav-item ${view === 'nomina' ? 'active' : ''}`} onClick={() => setView('nomina')}><Icons.Dollar /><span>Nómina</span></div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Gestión</div>
                        <div className={`nav-item ${view === 'prestamos' ? 'active' : ''}`} onClick={() => setView('prestamos')}><Icons.CreditCard /><span>Préstamos</span>{stats.prestamosActivos > 0 && <span className="nav-badge">{stats.prestamosActivos}</span>}</div>
                        <div className={`nav-item ${view === 'licencias' ? 'active' : ''}`} onClick={() => setView('licencias')}><Icons.Calendar /><span>Licencias</span>{stats.licenciasActivas > 0 && <span className="nav-badge">{stats.licenciasActivas}</span>}</div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Reportes</div>
                        <div className={`nav-item ${view === 'historial' ? 'active' : ''}`} onClick={() => setView('historial')}><Icons.Clock /><span>Historial</span></div>
                        <div className="nav-item" onClick={() => openModal('reportes')} style={{background:'rgba(251,140,0,0.15)'}}><Icons.FileText /><span>📊 Centro de Reportes</span></div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Sistema</div>
                        <div className={`nav-item ${view === 'mantenimiento' ? 'active' : ''}`} onClick={() => setView('mantenimiento')}><Icons.Database /><span>Mantenimiento</span></div>
                        <div className={`nav-item ${view === 'config' ? 'active' : ''}`} onClick={() => setView('config')}><Icons.Settings /><span>Configuración</span></div>
                    </div>
                    
                    {/* Sección SharePoint */}
                    <div className="nav-group" style={{marginTop:'auto', borderTop:'1px solid rgba(255,255,255,0.1)', paddingTop:'12px'}}>
                        <div className="nav-label">SharePoint</div>
                        {!spConnected ? (
                            <div className="nav-item" onClick={handleLogin} style={{background:'rgba(0,120,212,0.2)', color:'#4fc3f7'}}>
                                <Icons.LogIn /><span>Conectar Microsoft</span>
                            </div>
                        ) : (
                            <>
                                <div style={{padding:'6px 10px', fontSize:'10px', color:'rgba(255,255,255,0.7)'}}>
                                    <div style={{display:'flex', alignItems:'center', gap:'6px', marginBottom:'4px'}}>
                                        <span style={{width:'8px', height:'8px', borderRadius:'50%', background: syncStatus.error ? '#f44336' : '#4caf50'}}></span>
                                        <span>{syncStatus.error ? 'Error sync' : 'Conectado'}</span>
                                    </div>
                                    <div style={{fontSize:'9px', color:'rgba(255,255,255,0.5)', marginLeft:'14px'}}>
                                        {msUser?.username || msUser?.name || 'Usuario'}
                                    </div>
                                    {syncStatus.error && (
                                        <div style={{fontSize:'9px', color:'#ff6b6b', marginLeft:'14px', marginTop:'2px'}}>
                                            ⚠️ {syncStatus.error}
                                        </div>
                                    )}
                                    {syncStatus.lastSync && !syncStatus.error && (
                                        <div style={{fontSize:'9px', color:'rgba(255,255,255,0.4)', marginLeft:'14px', marginTop:'2px'}}>
                                            Último sync: {syncStatus.lastSync.toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                                <div className="nav-item" onClick={sincronizarConSharePoint} style={{color: syncStatus.syncing ? '#ffc107' : syncStatus.error ? '#ff6b6b' : 'rgba(255,255,255,0.6)'}}>
                                    <Icons.Refresh style={syncStatus.syncing ? {animation:'spin 1s linear infinite'} : {}} /><span>{syncStatus.syncing ? 'Sincronizando...' : syncStatus.error ? 'Reintentar' : 'Sincronizar'}</span>
                                </div>
                                <div className="nav-item" onClick={handleLogout} style={{color:'rgba(255,255,255,0.5)'}}>
                                    <Icons.LogOut /><span>Desconectar</span>
                                </div>
                            </>
                        )}
                    </div>
                </nav>
            </aside>

            {/* Main */}
            <main className="main">
                <header className="topbar no-print">
                    <div className="topbar-left">
                        <h2>{view === 'dashboard' ? 'Dashboard' : view === 'empleados' ? 'Empleados' : view === 'nomina' ? 'Nómina' : view === 'prestamos' ? 'Préstamos' : view === 'licencias' ? 'Licencias' : view === 'historial' ? 'Historial' : view === 'mantenimiento' ? 'Mantenimiento' : 'Configuración'}</h2>
                        <p style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            {config.empresa.nombre}
                            {spConnected ? (
                                <span style={{display:'inline-flex', alignItems:'center', gap:'4px', background:'rgba(76,175,80,0.1)', color:'#4caf50', padding:'2px 8px', borderRadius:'10px', fontSize:'9px', fontWeight:'600'}}>
                                    <Icons.Cloud style={{width:'10px', height:'10px'}} /> SharePoint
                                </span>
                            ) : (
                                <span style={{display:'inline-flex', alignItems:'center', gap:'4px', background:'rgba(255,152,0,0.1)', color:'#ff9800', padding:'2px 8px', borderRadius:'10px', fontSize:'9px', fontWeight:'600'}}>
                                    <Icons.CloudOff style={{width:'10px', height:'10px'}} /> Local
                                </span>
                            )}
                        </p>
                    </div>
                    <div className="topbar-right" style={{display:'flex', alignItems:'center', gap:'12px'}}>
                        {spConnected && (
                            <button className="btn btn-secondary btn-sm" onClick={sincronizarConSharePoint} disabled={syncStatus.syncing}>
                                <Icons.Refresh style={syncStatus.syncing ? {animation:'spin 1s linear infinite'} : {}} /> {syncStatus.syncing ? 'Sincronizando...' : 'Sincronizar'}
                            </button>
                        )}
                        {view === 'empleados' && <button className="btn btn-primary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Empleado</button>}
                        {view === 'prestamos' && <button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.Plus /> Préstamo</button>}
                        {view === 'licencias' && <button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Plus /> Licencia</button>}
                        
                        {/* Menú de Usuario */}
                        <div style={{display:'flex', alignItems:'center', gap:'8px', paddingLeft:'12px', borderLeft:'1px solid var(--border-color)'}}>
                            <div style={{
                                display:'flex', 
                                alignItems:'center', 
                                gap:'8px',
                                background:'var(--bg-main)',
                                padding:'6px 12px',
                                borderRadius:'20px'
                            }}>
                                <div style={{
                                    width:'28px', 
                                    height:'28px', 
                                    borderRadius:'50%', 
                                    background: usuarioActual?.rol === 'admin' ? 'linear-gradient(135deg, var(--primary), var(--purple))' : 'linear-gradient(135deg, var(--info), var(--success))',
                                    display:'flex',
                                    alignItems:'center',
                                    justifyContent:'center',
                                    color:'white',
                                    fontSize:'11px',
                                    fontWeight:'700'
                                }}>
                                    {usuarioActual?.usuario?.substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <div style={{fontSize:'11px', fontWeight:'600'}}>{usuarioActual?.nombre}</div>
                                    <div style={{fontSize:'9px', color:'var(--text-muted)'}}>
                                        {usuarioActual?.rol === 'admin' ? 
                                            <span style={{color:'var(--primary)'}}>Administrador</span> : 
                                            <span style={{color:'var(--info)'}}>Solo Consulta</span>
                                        }
                                    </div>
                                </div>
                            </div>
                            <button 
                                className="btn btn-secondary btn-sm" 
                                onClick={() => setMostrarCambioPassword(true)}
                                title="Cambiar contraseña"
                                style={{padding:'6px'}}
                            >
                                <Icons.Lock style={{width:'14px', height:'14px'}} />
                            </button>
                            <button 
                                className="btn btn-danger btn-sm" 
                                onClick={handleUserLogout}
                                title="Cerrar sesión"
                                style={{padding:'6px'}}
                            >
                                <Icons.LogOut style={{width:'14px', height:'14px'}} />
                            </button>
                        </div>
                    </div>
                </header>
                <div className="page">{renderContent()}</div>
            </main>

            {/* Modal Empleado */}
            <Modal open={modals.empleado} onClose={() => { closeModal('empleado'); setEditingEmp(null); setEmpForm(empFormInit); }} title={editingEmp ? 'Editar Empleado' : 'Nuevo Empleado'} size="lg" footer={<><button className="btn btn-secondary" onClick={() => closeModal('empleado')}>Cancelar</button><button className="btn btn-primary" onClick={guardarEmpleado}><Icons.Check /> {editingEmp ? 'Actualizar' : 'Guardar'}</button></>}>
                <div className="form-grid">
                    <div className="form-group span-2"><label className="form-label">Nombre Completo *</label><input className="form-control" value={empForm.nombre} onChange={e => setEmpForm(f => ({...f, nombre: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Tipo Documento</label><select className="form-control" value={empForm.tipoDocumento} onChange={e => setEmpForm(f => ({...f, tipoDocumento: e.target.value}))}><option value="cedula">Cédula</option><option value="pasaporte">Pasaporte</option></select></div>
                    <div className="form-group"><label className="form-label">{empForm.tipoDocumento === 'cedula' ? 'Cédula' : 'Pasaporte'} *</label><input className="form-control" value={empForm.documento} onChange={e => setEmpForm(f => ({...f, documento: e.target.value}))} placeholder={empForm.tipoDocumento === 'cedula' ? '000-0000000-0' : 'Número de pasaporte'} /></div>
                    <div className="form-group"><label className="form-label">NSS (Seg. Social)</label><input className="form-control" value={empForm.nss} onChange={e => setEmpForm(f => ({...f, nss: e.target.value}))} placeholder="00000000-0" /><div className="form-help">Número asignado por TSS</div></div>
                    <div className="form-group"><label className="form-label">Departamento *</label><select className="form-control" value={empForm.departamento} onChange={e => setEmpForm(f => ({...f, departamento: e.target.value}))}>{DEPARTAMENTOS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Cargo</label><input className="form-control" value={empForm.cargo} onChange={e => setEmpForm(f => ({...f, cargo: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Salario Mensual *</label><input className="form-control" type="number" value={empForm.salarioBase} onChange={e => setEmpForm(f => ({...f, salarioBase: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Tipo Remuneración</label><select className="form-control" value={empForm.tipoRemuneracion} onChange={e => setEmpForm(f => ({...f, tipoRemuneracion: e.target.value}))}>{TIPOS_REMUNERACION.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Fecha Ingreso</label><input className="form-control" type="date" value={empForm.fechaIngreso} onChange={e => setEmpForm(f => ({...f, fechaIngreso: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Tipo Contrato</label><select className="form-control" value={empForm.tipoContrato} onChange={e => setEmpForm(f => ({...f, tipoContrato: e.target.value}))}>{TIPOS_CONTRATO.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                </div>
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>📋 Datos Personales</h4>
                <div className="form-grid">
                    <div className="form-group"><label className="form-label">📱 Celular</label><input className="form-control" value={empForm.celular || ''} onChange={e => setEmpForm(f => ({...f, celular: e.target.value}))} placeholder="809-000-0000" /></div>
                    <div className="form-group"><label className="form-label">📞 Teléfono Casa</label><input className="form-control" value={empForm.telefono || ''} onChange={e => setEmpForm(f => ({...f, telefono: e.target.value}))} placeholder="809-000-0000" /></div>
                    <div className="form-group">
                        <label className="form-label">🎂 Fecha Nacimiento {empForm.fechaNacimiento && <span style={{fontWeight:'normal', color:'var(--primary)', marginLeft:'8px'}}>({calcularEdad(empForm.fechaNacimiento)} años)</span>}</label>
                        <input className="form-control" type="date" value={empForm.fechaNacimiento || ''} onChange={e => setEmpForm(f => ({...f, fechaNacimiento: e.target.value}))} />
                    </div>
                    <div className="form-group"><label className="form-label">💍 Estado Civil</label><select className="form-control" value={empForm.estadoCivil || 'Soltero/a'} onChange={e => setEmpForm(f => ({...f, estadoCivil: e.target.value}))}><option value="Soltero/a">Soltero/a</option><option value="Casado/a">Casado/a</option><option value="Unión Libre">Unión Libre</option><option value="Divorciado/a">Divorciado/a</option><option value="Viudo/a">Viudo/a</option></select></div>
                    <div className="form-group"><label className="form-label">🌍 Nacionalidad</label><select className="form-control" value={empForm.nacionalidad || 'Dominicana'} onChange={e => setEmpForm(f => ({...f, nacionalidad: e.target.value}))}><option value="Dominicana">Dominicana</option><option value="Haitiana">Haitiana</option><option value="Venezolana">Venezolana</option><option value="Colombiana">Colombiana</option><option value="Estadounidense">Estadounidense</option><option value="Española">Española</option><option value="Otra">Otra</option></select></div>
                    <div className="form-group span-2"><label className="form-label">🏠 Dirección</label><input className="form-control" value={empForm.direccion || ''} onChange={e => setEmpForm(f => ({...f, direccion: e.target.value}))} placeholder="Calle, No., Sector, Ciudad" /></div>
                </div>
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>💰 Deducciones Fijas Mensuales</h4>
                <div className="form-grid">
                    <div className="form-group">
                        <label className="form-label">👨‍👩‍👧 PDSS - Dependientes Adic.</label>
                        <input className="form-control" type="number" min="0" max="10" value={empForm.dependientesSFS || 0} onChange={e => setEmpForm(f => ({...f, dependientesSFS: parseInt(e.target.value) || 0}))} placeholder="0" />
                        <div className="form-help">Dependientes adicionales en SFS</div>
                        {(empForm.dependientesSFS > 0) && (
                            <div className="alert alert-info" style={{marginTop:'6px', padding:'6px 10px', fontSize:'11px'}}>
                                <strong>Descuento mensual:</strong> {empForm.dependientesSFS} × RD$ {formatMoney(config.tss.pdssPerCapita || 1715.46)} = <strong>RD$ {formatMoney((empForm.dependientesSFS || 0) * (config.tss.pdssPerCapita || 1715.46))}</strong>
                            </div>
                        )}
                        <div style={{fontSize:'10px', color:'var(--primary)', marginTop:'4px', cursor:'pointer'}} onClick={() => { closeModal('empleado'); setView('config'); }}>
                            ⚙️ Cambiar valor Per Cápita (actual: RD$ {formatMoney(config.tss.pdssPerCapita || 1715.46)})
                        </div>
                    </div>
                    <div className="form-group"><label className="form-label">Cooperativa</label><input className="form-control" type="number" value={empForm.cooperativa} onChange={e => setEmpForm(f => ({...f, cooperativa: e.target.value}))} placeholder="0" /></div>
                    <div className="form-group"><label className="form-label">Seguro Médico</label><input className="form-control" type="number" value={empForm.seguroPrivado} onChange={e => setEmpForm(f => ({...f, seguroPrivado: e.target.value}))} placeholder="0" /><div className="form-help">Seguro privado adicional</div></div>
                    <div className="form-group"><label className="form-label">Embargo/Pensión</label><input className="form-control" type="number" value={empForm.embargo} onChange={e => setEmpForm(f => ({...f, embargo: e.target.value}))} placeholder="0" /><div className="form-help">Deducciones judiciales</div></div>
                </div>
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>📤 Desvinculación (solo si aplica)</h4>
                <div className="form-grid">
                    <div className="form-group"><label className="form-label">🚪 Fecha de Salida</label><input className="form-control" type="date" value={empForm.fechaSalida || ''} onChange={e => setEmpForm(f => ({...f, fechaSalida: e.target.value, activo: e.target.value ? false : f.activo}))} /><div className="form-help">Al colocar fecha, el empleado se desvincula de nóminas futuras</div></div>
                    <div className="form-group"><label className="form-label">📝 Motivo de Salida</label><select className="form-control" value={empForm.motivoSalida || ''} onChange={e => setEmpForm(f => ({...f, motivoSalida: e.target.value}))}><option value="">Seleccionar...</option><option value="Renuncia">Renuncia voluntaria</option><option value="Despido">Despido</option><option value="Fin de contrato">Fin de contrato</option><option value="Jubilación">Jubilación</option><option value="Fallecimiento">Fallecimiento</option><option value="Abandono">Abandono de trabajo</option><option value="Mutuo acuerdo">Mutuo acuerdo</option><option value="Otro">Otro</option></select></div>
                </div>
                {empForm.fechaSalida && (
                    <div className="alert alert-warning" style={{marginTop:'8px'}}><Icons.AlertCircle /><span><strong>Empleado desvinculado:</strong> No aparecerá en nuevas nóminas pero su historial de pagos se conservará para consultas.</span></div>
                )}
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>Datos Bancarios</h4>
                <div className="form-grid form-grid-3">
                    <div className="form-group"><label className="form-label">Banco</label><select className="form-control" value={empForm.banco} onChange={e => setEmpForm(f => ({...f, banco: e.target.value}))}><option value="">Seleccionar...</option>{BANCOS.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">No. Cuenta</label><input className="form-control" value={empForm.cuenta} onChange={e => setEmpForm(f => ({...f, cuenta: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Estado</label><select className="form-control" value={empForm.activo} onChange={e => setEmpForm(f => ({...f, activo: e.target.value === 'true'}))}><option value="true">Activo</option><option value="false">Inactivo</option></select></div>
                </div>
            </Modal>

            {/* Modal Préstamo */}
            <Modal open={modals.prestamo} onClose={() => { closeModal('prestamo'); setEditingPrestamo(null); setPrestamoForm({empleadoId:'',monto:'',cuotas:'',desc:'',fecha:''}); }} title={editingPrestamo ? 'Editar Préstamo' : 'Nuevo Préstamo'} footer={<><button className="btn btn-secondary" onClick={() => closeModal('prestamo')}>Cancelar</button><button className="btn btn-purple" onClick={guardarPrestamo}><Icons.Check /> {editingPrestamo ? 'Actualizar' : 'Registrar'}</button></>}>
                <div className="form-grid form-grid-2">
                    <div className="form-group full"><label className="form-label">Empleado *</label><select className="form-control" value={prestamoForm.empleadoId} onChange={e => setPrestamoForm(f => ({...f, empleadoId: e.target.value}))}><option value="">Seleccionar...</option>{empleados.filter(e => e.activo).map(e => <option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Monto Total *</label><input className="form-control" type="number" value={prestamoForm.monto} onChange={e => setPrestamoForm(f => ({...f, monto: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Cuotas *</label><input className="form-control" type="number" min="1" value={prestamoForm.cuotas} onChange={e => setPrestamoForm(f => ({...f, cuotas: e.target.value}))} /></div>
                    {prestamoForm.monto && prestamoForm.cuotas && <div className="form-group full"><div className="alert alert-success"><Icons.Info /><span>Cuota mensual: <strong>RD$ {formatMoney(+prestamoForm.monto / +prestamoForm.cuotas)}</strong></span></div></div>}
                    {editingPrestamo && editingPrestamo.cuotasPagadas > 0 && <div className="form-group full"><div className="alert alert-warning"><Icons.Info /><span>Ya se han pagado <strong>{editingPrestamo.cuotasPagadas} cuotas</strong>. El saldo se recalculará automáticamente.</span></div></div>}
                    <div className="form-group"><label className="form-label">Fecha Inicio</label><input className="form-control" type="date" value={prestamoForm.fecha} onChange={e => setPrestamoForm(f => ({...f, fecha: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Descripción</label><input className="form-control" value={prestamoForm.desc} onChange={e => setPrestamoForm(f => ({...f, desc: e.target.value}))} placeholder="Préstamo personal..." /></div>
                </div>
            </Modal>

            {/* Modal Licencia */}
            <Modal open={modals.licencia} onClose={() => closeModal('licencia')} title="Nueva Licencia" footer={<><button className="btn btn-secondary" onClick={() => closeModal('licencia')}>Cancelar</button><button className="btn btn-info" onClick={guardarLicencia}><Icons.Check /> Registrar</button></>}>
                <div className="form-grid form-grid-2">
                    <div className="form-group full"><label className="form-label">Empleado *</label><select className="form-control" value={licenciaForm.empleadoId} onChange={e => setLicenciaForm(f => ({...f, empleadoId: e.target.value}))}><option value="">Seleccionar...</option>{empleados.filter(e => e.activo).map(e => <option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Tipo</label><select className="form-control" value={licenciaForm.tipo} onChange={e => setLicenciaForm(f => ({...f, tipo: e.target.value}))}>{TIPOS_LICENCIA.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Con Pago</label><select className="form-control" value={licenciaForm.conPago} onChange={e => setLicenciaForm(f => ({...f, conPago: e.target.value === 'true'}))}><option value="true">Sí</option><option value="false">No</option></select></div>
                    <div className="form-group"><label className="form-label">Fecha Inicio *</label><input className="form-control" type="date" value={licenciaForm.fechaInicio} onChange={e => setLicenciaForm(f => ({...f, fechaInicio: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Fecha Fin</label><input className="form-control" type="date" value={licenciaForm.fechaFin} onChange={e => setLicenciaForm(f => ({...f, fechaFin: e.target.value}))} /></div>
                    <div className="form-group full"><label className="form-label">Notas</label><input className="form-control" value={licenciaForm.notas} onChange={e => setLicenciaForm(f => ({...f, notas: e.target.value}))} /></div>
                </div>
            </Modal>

            {/* Modal Liquidación */}
            <Modal open={modals.liquidacion} onClose={() => closeModal('liquidacion')} title="Cálculo de Liquidación" size="md">
                {liquidacionData && (
                    <div>
                        <div className="alert alert-info"><Icons.UserMinus /><span><strong>{liquidacionData.emp.nombre}</strong> - Antigüedad: {calcularAntiguedad(liquidacionData.emp.fechaIngreso).años} años, {calcularAntiguedad(liquidacionData.emp.fechaIngreso).meses % 12} meses</span></div>
                        <div className="config-section">
                            <div className="config-title">Desglose de Liquidación (Despido)</div>
                            <div className="config-row"><span>Preaviso ({liquidacionData.preaviso.dias} días)</span><span className="money">RD$ {formatMoney(liquidacionData.preaviso.monto)}</span></div>
                            <div className="config-row"><span>Cesantía ({round2(liquidacionData.cesantia.dias)} días)</span><span className="money">RD$ {formatMoney(liquidacionData.cesantia.monto)}</span></div>
                            <div className="config-row"><span>Vacaciones no disfrutadas</span><span className="money">RD$ {formatMoney(liquidacionData.vacaciones)}</span></div>
                            <div className="config-row"><span>Salario pendiente</span><span className="money">RD$ {formatMoney(liquidacionData.salarioPendiente)}</span></div>
                            <div className="config-row"><span>Regalía proporcional</span><span className="money">RD$ {formatMoney(liquidacionData.regalia)}</span></div>
                            <div className="config-row" style={{fontWeight:700, borderTop:'2px solid var(--border)', paddingTop:'8px', marginTop:'8px'}}><span>TOTAL LIQUIDACIÓN</span><span className="money pos" style={{fontSize:'14px'}}>RD$ {formatMoney(liquidacionData.total)}</span></div>
                        </div>
                        <button className="btn btn-primary" style={{width:'100%', marginTop:'12px'}} onClick={() => { toast('Liquidación exportada', 'success'); closeModal('liquidacion'); }}><Icons.Download /> Exportar Liquidación</button>
                    </div>
                )}
            </Modal>

            {/* Modal Volantes */}
            <Modal open={modals.volantes} onClose={() => { closeModal('volantes'); setSelectedVolante(null); }} title="Volantes de Pago" size="xl" footer={<><button className="btn btn-secondary" onClick={() => closeModal('volantes')}>Cerrar</button><button className="btn btn-primary" onClick={imprimirVolantes}><Icons.Printer /> Imprimir</button></>}>
                <div className="print-area">
                    {volantesData.map((v, i) => <Volante key={i} emp={v.emp} det={v.det} periodo={currentNomina?.periodo} config={config} />)}
                </div>
            </Modal>

            {/* Modal Checklist Pagos por Banco */}
            <Modal 
                open={modals.pagosBanco} 
                onClose={() => closeModal('pagosBanco')} 
                title="📋 Checklist de Pagos por Banco" 
                size="xl" 
                footer={
                    <>
                        <button className="btn btn-secondary" onClick={() => closeModal('pagosBanco')}>Cerrar</button>
                        <button className="btn btn-primary" onClick={imprimirChecklist}><Icons.Printer /> Imprimir Checklist</button>
                    </>
                }
            >
                {fondosPorBanco && currentNomina && (
                    <div className="print-area print-pagos-banco">
                        {/* Nota para opciones de EPSON - solo visible en pantalla */}
                        <div className="no-print" style={{background:'#fef3c7', border:'1px solid #f59e0b', padding:'10px 15px', marginBottom:'15px', borderRadius:'6px', fontSize:'12px'}}>
                            <strong>💡 Para opciones avanzadas de EPSON:</strong> En el diálogo de impresión, haz clic en <strong>"Imprimir usando el diálogo de sistema..."</strong> o presiona <strong>Ctrl+Shift+P</strong>
                        </div>
                        
                        {/* Encabezado compacto horizontal */}
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', borderBottom:'2px solid #000', paddingBottom:'8px', marginBottom:'10px'}}>
                            <div>
                                <h2 style={{margin:0, fontSize:'14px'}}>CENTRO EDUCATIVO TEHUI</h2>
                                <p style={{margin:0, fontSize:'9px', color:'#666'}}>Educando en valores con calidad</p>
                            </div>
                            <div style={{textAlign:'center'}}>
                                <h3 style={{margin:0, fontSize:'12px', border:'1px solid #333', padding:'5px 15px'}}>📋 CHECKLIST DE PAGOS POR BANCO</h3>
                            </div>
                            <div style={{textAlign:'right', fontSize:'10px'}}>
                                <div><strong>Período:</strong> {MESES[currentNomina.periodo.mes]} {currentNomina.periodo.año}{currentNomina.periodo.tipo === 'quincenal' ? ` - ${currentNomina.periodo.quincena === 1 ? '1ra' : '2da'} Quinc.` : ''}</div>
                                <div><strong>Código:</strong> {currentNomina.codigo} | <strong>Fecha:</strong> {new Date().toLocaleDateString('es-DO')}</div>
                            </div>
                        </div>

                        {/* Resumen rápido */}
                        <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'10px', marginBottom:'20px', padding:'10px', background:'#f5f5f5', border:'1px solid #ccc', borderRadius:'4px'}}>
                            <div style={{textAlign:'center'}}>
                                <div style={{fontSize:'9px', color:'#666'}}>TOTAL EMPLEADOS</div>
                                <div style={{fontSize:'16px', fontWeight:'bold'}}>{Object.values(fondosPorBanco).reduce((sum, b) => sum + b.empleados.length, 0)}</div>
                            </div>
                            <div style={{textAlign:'center'}}>
                                <div style={{fontSize:'9px', color:'#666'}}>BANCOS/FORMAS PAGO</div>
                                <div style={{fontSize:'16px', fontWeight:'bold'}}>{Object.keys(fondosPorBanco).length}</div>
                            </div>
                            <div style={{textAlign:'center'}}>
                                <div style={{fontSize:'9px', color:'#666'}}>TOTAL BRUTO</div>
                                <div style={{fontSize:'14px', fontWeight:'bold', fontFamily:'JetBrains Mono'}}>RD$ {formatMoney(Object.values(fondosPorBanco).reduce((sum, b) => sum + b.totalBruto, 0))}</div>
                            </div>
                            <div style={{textAlign:'center', background:'#333', color:'white', padding:'5px', borderRadius:'4px'}}>
                                <div style={{fontSize:'9px', opacity:0.8}}>TOTAL NETO A PAGAR</div>
                                <div style={{fontSize:'14px', fontWeight:'bold', fontFamily:'JetBrains Mono'}}>RD$ {formatMoney(Object.values(fondosPorBanco).reduce((sum, b) => sum + b.totalNeto, 0))}</div>
                            </div>
                        </div>

                        {/* Detalle por banco */}
                        {Object.entries(fondosPorBanco).sort((a,b) => b[1].totalNeto - a[1].totalNeto).map(([banco, data], bancoIdx) => (
                            <div key={banco} style={{marginBottom:'20px', pageBreakInside:'avoid'}}>
                                {/* Header del banco */}
                                <div style={{
                                    background: banco === 'Sin cuenta' ? '#6c757d' : 
                                                banco === 'Banreservas' ? '#00723f' :
                                                banco === 'BHD León' ? '#003366' :
                                                banco === 'Banco Popular' ? '#ff6600' :
                                                banco === 'ACAP' ? '#8b0000' : '#2c3e50',
                                    color: 'white',
                                    padding: '10px 15px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <span style={{fontSize:'14px', fontWeight:'bold'}}>
                                            {banco === 'Sin cuenta' ? '💵 EFECTIVO / CHEQUE' : `🏦 ${banco.toUpperCase()}`}
                                        </span>
                                        <span style={{marginLeft:'15px', fontSize:'11px', opacity:0.9}}>
                                            ({data.empleados.length} empleado{data.empleados.length !== 1 ? 's' : ''})
                                        </span>
                                    </div>
                                    <div style={{textAlign:'right'}}>
                                        <div style={{fontSize:'10px', opacity:0.8}}>Total a depositar:</div>
                                        <div style={{fontSize:'16px', fontWeight:'bold', fontFamily:'JetBrains Mono'}}>RD$ {formatMoney(data.totalNeto)}</div>
                                    </div>
                                </div>

                                {/* Tabla de empleados */}
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px'}}>
                                    <thead>
                                        <tr style={{background:'#e8e8e8'}}>
                                            <th style={{border:'1px solid #999', padding:'6px', width:'25px', textAlign:'center'}}>✓</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'left'}}>Empleado</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'left'}}>Cédula</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'left'}}>Depto.</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'left'}}>No. Cuenta</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>Salario</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>Deducciones</th>
                                            <th style={{border:'1px solid #999', padding:'6px', textAlign:'right', background:'#d0d0d0', fontWeight:'bold'}}>NETO</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.empleados.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((emp, idx) => (
                                            <tr key={idx} style={{background: idx % 2 === 0 ? '#fff' : '#f9f9f9'}}>
                                                <td style={{border:'1px solid #ccc', padding:'5px', textAlign:'center'}}>
                                                    <div style={{width:'14px', height:'14px', border:'2px solid #333', borderRadius:'2px', margin:'0 auto'}}></div>
                                                </td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', fontWeight:'600'}}>{emp.nombre}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', fontFamily:'JetBrains Mono', fontSize:'8px'}}>{emp.cedula}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', fontSize:'8px'}}>{emp.departamento}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', fontFamily:'JetBrains Mono', fontSize:'8px'}}>{emp.cuenta || '-'}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', textAlign:'right', fontFamily:'JetBrains Mono'}}>{formatMoney(emp.bruto)}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', textAlign:'right', fontFamily:'JetBrains Mono', color:'#c00'}}>{formatMoney(emp.totalDed)}</td>
                                                <td style={{border:'1px solid #ccc', padding:'5px', textAlign:'right', fontFamily:'JetBrains Mono', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(emp.neto)}</td>
                                            </tr>
                                        ))}
                                        {/* Subtotal del banco */}
                                        <tr style={{background:'#d0d0d0', fontWeight:'bold'}}>
                                            <td colSpan="5" style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>
                                                SUBTOTAL {banco.toUpperCase()}:
                                            </td>
                                            <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontFamily:'JetBrains Mono'}}>{formatMoney(data.totalBruto)}</td>
                                            <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontFamily:'JetBrains Mono', color:'#c00'}}>{formatMoney(data.empleados.reduce((s,e) => s + e.totalDed, 0))}</td>
                                            <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontFamily:'JetBrains Mono', fontSize:'11px', background:'#333', color:'white'}}>{formatMoney(data.totalNeto)}</td>
                                        </tr>
                                    </tbody>
                                </table>

                                {/* Checkbox de confirmación del banco */}
                                <div style={{marginTop:'8px', padding:'8px 12px', background:'#f0f0f0', border:'1px solid #ccc', display:'flex', alignItems:'center', gap:'10px'}}>
                                    <div style={{width:'18px', height:'18px', border:'2px solid #333', borderRadius:'2px'}}></div>
                                    <span style={{fontSize:'10px'}}>
                                        <strong>Depósito {banco === 'Sin cuenta' ? 'en efectivo/cheque' : `a ${banco}`} realizado</strong> 
                                        &nbsp;— Monto: <strong>RD$ {formatMoney(data.totalNeto)}</strong>
                                        &nbsp;— Fecha: _____________ 
                                        &nbsp;— Ref/Comprobante: _______________________
                                    </span>
                                </div>
                            </div>
                        ))}

                        {/* Resumen final y firmas */}
                        <div style={{marginTop:'20px', pageBreakInside:'avoid'}}>
                            <div style={{background:'#1a1a2e', color:'white', padding:'15px', marginBottom:'15px'}}>
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                    <div>
                                        <div style={{fontSize:'10px', opacity:0.8}}>GRAN TOTAL A PAGAR (TODOS LOS BANCOS)</div>
                                        <div style={{fontSize:'24px', fontWeight:'bold', fontFamily:'JetBrains Mono', color:'#4ade80'}}>
                                            RD$ {formatMoney(Object.values(fondosPorBanco).reduce((sum, b) => sum + b.totalNeto, 0))}
                                        </div>
                                    </div>
                                    <div style={{textAlign:'right'}}>
                                        <div style={{fontSize:'10px', opacity:0.8}}>Total Empleados: {Object.values(fondosPorBanco).reduce((sum, b) => sum + b.empleados.length, 0)}</div>
                                        <div style={{fontSize:'10px', opacity:0.8}}>Bancos/Formas: {Object.keys(fondosPorBanco).length}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Firmas */}
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'30px', marginTop:'30px'}}>
                                <div style={{textAlign:'center'}}>
                                    <div style={{borderTop:'1px solid #333', marginTop:'40px', paddingTop:'8px', fontSize:'10px'}}>
                                        Elaborado por
                                    </div>
                                </div>
                                <div style={{textAlign:'center'}}>
                                    <div style={{borderTop:'1px solid #333', marginTop:'40px', paddingTop:'8px', fontSize:'10px'}}>
                                        Verificado por
                                    </div>
                                </div>
                                <div style={{textAlign:'center'}}>
                                    <div style={{borderTop:'1px solid #333', marginTop:'40px', paddingTop:'8px', fontSize:'10px'}}>
                                        Autorizado por
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </Modal>

            {/* Modal Constancia */}
            <Modal open={modals.constancia} onClose={() => closeModal('constancia')} title="Constancia de Trabajo" size="md">
                {selectedEmp && (
                    <div style={{fontFamily:'serif', lineHeight:1.8}}>
                        <div style={{textAlign:'center', marginBottom:'20px'}}>
                            <h2 style={{fontSize:'16px'}}>{config.empresa.nombre}</h2>
                            <p style={{fontSize:'11px', color:'var(--text-secondary)'}}>{config.empresa.direccion}<br/>RNC: {config.empresa.rnc}</p>
                        </div>
                        <h3 style={{textAlign:'center', margin:'20px 0', textDecoration:'underline'}}>CONSTANCIA DE TRABAJO</h3>
                        <p style={{textAlign:'justify', fontSize:'12px'}}>
                            Por medio de la presente hacemos constar que el/la Sr(a). <strong>{selectedEmp.nombre}</strong>, 
                            portador(a) de la cédula de identidad No. <strong>{selectedEmp.cedula}</strong>, 
                            labora en nuestra institución desde el <strong>{formatDate(selectedEmp.fechaIngreso)}</strong>, 
                            desempeñando el cargo de <strong>{selectedEmp.cargo || selectedEmp.departamento}</strong>, 
                            devengando un salario mensual de <strong>RD$ {formatMoney(selectedEmp.salarioBase)}</strong>.
                        </p>
                        <p style={{fontSize:'12px', marginTop:'16px'}}>
                            Se expide la presente constancia a solicitud de la parte interesada, para los fines que considere pertinentes.
                        </p>
                        <p style={{fontSize:'12px', marginTop:'20px'}}>
                            Dado en Santiago de los Caballeros, República Dominicana, a los {new Date().getDate()} días del mes de {MESES[new Date().getMonth() + 1]} del {new Date().getFullYear()}.
                        </p>
                        <div style={{marginTop:'50px', textAlign:'center'}}>
                            <div style={{borderTop:'1px solid #333', width:'200px', margin:'0 auto', paddingTop:'8px', fontSize:'11px'}}>Firma y Sello</div>
                        </div>
                        <button className="btn btn-primary no-print" style={{width:'100%', marginTop:'20px'}} onClick={() => window.print()}><Icons.Printer /> Imprimir</button>
                    </div>
                )}
            </Modal>

            {/* Modal Centro de Reportes */}
            <Modal 
                open={modals.reportes} 
                onClose={() => { closeModal('reportes'); setTipoReporteActivo(null); setCategoriaReporteActiva(null); }} 
                title="📊 Centro de Reportes" 
                size="xl"
                footer={
                    tipoReporteActivo ? (
                        <>
                            <button className="btn btn-secondary" onClick={() => setTipoReporteActivo(null)}>← Volver</button>
                            <button className="btn btn-primary" onClick={imprimirReporte}><Icons.Printer /> Imprimir Reporte</button>
                        </>
                    ) : (
                        <button className="btn btn-secondary" onClick={() => closeModal('reportes')}>Cerrar</button>
                    )
                }
            >
                {!tipoReporteActivo ? (
                    /* Selector de tipo de reporte por categorías */
                    <div className="reporte-selector">
                        <div className="alert alert-info no-print" style={{marginBottom:'16px'}}>
                            <Icons.Info />
                            <span>Seleccione una categoría y luego el reporte que desea generar. Los reportes marcados con 🔒 requieren una nómina seleccionada.</span>
                        </div>
                        
                        {/* Selector de nómina si no hay una activa */}
                        {!currentNomina && nominas.filter(n => n.estado === 'procesada' || n.estado === 'guardada').length > 0 && (
                            <div style={{marginBottom:'16px', padding:'12px', background:'var(--bg-main)', borderRadius:'8px', border:'1px solid var(--border)'}}>
                                <label style={{fontSize:'11px', fontWeight:'600', marginBottom:'6px', display:'block'}}>Seleccionar Nómina para reportes:</label>
                                <select 
                                    className="form-control" 
                                    style={{maxWidth:'400px'}}
                                    onChange={e => {
                                        const nom = nominas.find(n => n.id === e.target.value);
                                        if (nom) setCurrentNomina(nom);
                                    }}
                                >
                                    <option value="">-- Seleccione una nómina --</option>
                                    {nominas.filter(n => n.estado === 'procesada' || n.estado === 'guardada').slice(0, 12).map(n => (
                                        <option key={n.id} value={n.id}>
                                            {MESES[n.periodo.mes]} {n.periodo.año} {n.periodo.tipo === 'quincenal' ? `Q${n.periodo.quincena}` : ''} - {n.codigo}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        )}
                        
                        {/* Categorías de reportes */}
                        <div style={{display:'grid', gridTemplateColumns:'200px 1fr', gap:'16px', minHeight:'400px'}}>
                            {/* Lista de categorías */}
                            <div style={{borderRight:'1px solid var(--border)', paddingRight:'16px'}}>
                                <div style={{fontSize:'11px', fontWeight:'600', color:'var(--text-muted)', marginBottom:'8px'}}>CATEGORÍAS</div>
                                {CATEGORIAS_REPORTES.map(cat => (
                                    <div 
                                        key={cat.id}
                                        onClick={() => setCategoriaReporteActiva(cat.id)}
                                        style={{
                                            padding:'10px 12px',
                                            marginBottom:'4px',
                                            borderRadius:'6px',
                                            cursor:'pointer',
                                            background: categoriaReporteActiva === cat.id ? 'var(--primary)' : 'transparent',
                                            color: categoriaReporteActiva === cat.id ? 'white' : 'var(--text-primary)',
                                            fontWeight: categoriaReporteActiva === cat.id ? '600' : '400',
                                            fontSize:'12px',
                                            transition:'all 0.2s'
                                        }}
                                    >
                                        {cat.nombre}
                                    </div>
                                ))}
                            </div>
                            
                            {/* Lista de reportes de la categoría seleccionada */}
                            <div>
                                {!categoriaReporteActiva ? (
                                    <div style={{textAlign:'center', padding:'40px', color:'var(--text-muted)'}}>
                                        <Icons.FileText style={{width:'48px', height:'48px', opacity:0.3, marginBottom:'12px'}} />
                                        <p>Seleccione una categoría para ver los reportes disponibles</p>
                                    </div>
                                ) : (
                                    <>
                                        <div style={{fontSize:'14px', fontWeight:'600', marginBottom:'12px'}}>
                                            {CATEGORIAS_REPORTES.find(c => c.id === categoriaReporteActiva)?.nombre}
                                        </div>
                                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(220px, 1fr))', gap:'10px'}}>
                                            {CATEGORIAS_REPORTES.find(c => c.id === categoriaReporteActiva)?.reportes.map(rep => {
                                                const disponible = !rep.requiereNomina || currentNomina;
                                                return (
                                                    <div 
                                                        key={rep.id}
                                                        onClick={() => disponible && setTipoReporteActivo(rep.id)}
                                                        style={{
                                                            padding:'14px',
                                                            border:'1px solid var(--border)',
                                                            borderRadius:'8px',
                                                            cursor: disponible ? 'pointer' : 'not-allowed',
                                                            opacity: disponible ? 1 : 0.5,
                                                            background:'var(--bg-card)',
                                                            transition:'all 0.2s'
                                                        }}
                                                        onMouseOver={e => { if(disponible) { e.currentTarget.style.borderColor='var(--primary)'; e.currentTarget.style.boxShadow='0 2px 8px rgba(21,101,192,0.15)'; }}}
                                                        onMouseOut={e => { e.currentTarget.style.borderColor='var(--border)'; e.currentTarget.style.boxShadow='none'; }}
                                                    >
                                                        <div style={{display:'flex', alignItems:'center', gap:'8px', marginBottom:'6px'}}>
                                                            <span style={{fontSize:'20px'}}>{rep.icon}</span>
                                                            <span style={{fontWeight:'600', fontSize:'12px'}}>{rep.nombre}</span>
                                                            {rep.requiereNomina && !currentNomina && <span title="Requiere nómina">🔒</span>}
                                                        </div>
                                                        <div style={{fontSize:'10px', color:'var(--text-muted)'}}>{rep.desc}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                ) : (
                    /* Contenido del reporte */
                    <div className="reporte-print-area" style={{background:'white', padding:'15px'}}>
                        {/* Encabezado común para todos los reportes */}
                        <div style={{textAlign:'center', marginBottom:'15px', borderBottom:'2px solid #000', paddingBottom:'8px'}}>
                            <h2 style={{margin:0, fontSize:'14px'}}>{config.empresa.nombre}</h2>
                            <p style={{margin:'3px 0', fontSize:'10px'}}>{config.empresa.direccion}</p>
                            <p style={{margin:'3px 0', fontSize:'10px'}}>RNC: {config.empresa.rnc}</p>
                            <h3 style={{margin:'8px 0 5px', fontSize:'12px', background:'#e0e0e0', padding:'4px'}}>
                                {TIPOS_REPORTES.find(t => t.id === tipoReporteActivo)?.nombre?.toUpperCase()}
                            </h3>
                            {currentNomina && (
                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'9px', marginTop:'5px'}}>
                                    <span>Período: {MESES[currentNomina.periodo.mes]} {currentNomina.periodo.año} {currentNomina.periodo.tipo === 'quincenal' ? `- Quincena ${currentNomina.periodo.quincena}` : ''}</span>
                                    <span>Código: {currentNomina.codigo} | Fecha: {new Date().toLocaleDateString('es-DO')}</span>
                                </div>
                            )}
                        </div>
                        
                        {/* REPORTE: Nómina por Departamento */}
                        {tipoReporteActivo === 'nomina-depto' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            const porDepto = detalles.reduce((acc, d) => { 
                                const depto = d.depto || 'SIN DEPARTAMENTO';
                                if (!acc[depto]) acc[depto] = []; 
                                acc[depto].push(d); 
                                return acc; 
                            }, {});
                            const deptosOrdenados = Object.keys(porDepto).sort();
                            
                            return (
                                <>
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'left'}}>Empleado</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>Salario</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>Otros</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>Total Ing.</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>AFP</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>SFS</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>ISR</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>Otras Ded.</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>Total Ded.</th>
                                                <th style={{border:'1px solid #000', padding:'3px', textAlign:'right', background:'#b0b0b0'}}>NETO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {deptosOrdenados.map(depto => {
                                                const empsDepto = porDepto[depto];
                                                const totDepto = empsDepto.reduce((a, d) => ({
                                                    salario: a.salario + d.salarioBase,
                                                    otros: a.otros + d.horasExtra + d.bonificacion + (d.comisiones || 0) + (d.incentivos || 0),
                                                    totalIng: a.totalIng + d.totalIng,
                                                    afp: a.afp + d.afpEmp,
                                                    sfs: a.sfs + d.sfsEmp,
                                                    isr: a.isr + d.isr,
                                                    otrasDed: a.otrasDed + d.cuotaPrestamo + d.descAusencias + d.descTardanzas + d.otrasDed,
                                                    totalDed: a.totalDed + d.totalDed,
                                                    neto: a.neto + d.neto
                                                }), {salario:0, otros:0, totalIng:0, afp:0, sfs:0, isr:0, otrasDed:0, totalDed:0, neto:0});
                                                
                                                return (
                                                    <React.Fragment key={depto}>
                                                        <tr style={{background:'#f0f0f0'}}>
                                                            <td colSpan="10" style={{border:'1px solid #000', padding:'4px', fontWeight:'bold', fontSize:'9px'}}>{depto}</td>
                                                        </tr>
                                                        {empsDepto.map((d, idx) => (
                                                            <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f8f8f8'}}>
                                                                <td style={{border:'1px solid #999', padding:'2px 3px'}}>{d.nombre}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{formatMoney(d.salarioBase)}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{(d.horasExtra + d.bonificacion + (d.comisiones||0) + (d.incentivos||0)) > 0 ? formatMoney(d.horasExtra + d.bonificacion + (d.comisiones||0) + (d.incentivos||0)) : '-'}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right', fontWeight:'600'}}>{formatMoney(d.totalIng)}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{formatMoney(d.afpEmp)}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{formatMoney(d.sfsEmp)}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{d.isr > 0 ? formatMoney(d.isr) : '-'}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{(d.cuotaPrestamo + d.descAusencias + d.descTardanzas + d.otrasDed) > 0 ? formatMoney(d.cuotaPrestamo + d.descAusencias + d.descTardanzas + d.otrasDed) : '-'}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right'}}>{formatMoney(d.totalDed)}</td>
                                                                <td style={{border:'1px solid #999', padding:'2px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.neto)}</td>
                                                            </tr>
                                                        ))}
                                                        <tr style={{background:'#e0e0e0', fontWeight:'bold'}}>
                                                            <td style={{border:'1px solid #000', padding:'3px', fontSize:'8px'}}>SUBTOTAL {depto}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{formatMoney(totDepto.salario)}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{totDepto.otros > 0 ? formatMoney(totDepto.otros) : '-'}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{formatMoney(totDepto.totalIng)}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{formatMoney(totDepto.afp)}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{formatMoney(totDepto.sfs)}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{totDepto.isr > 0 ? formatMoney(totDepto.isr) : '-'}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{totDepto.otrasDed > 0 ? formatMoney(totDepto.otrasDed) : '-'}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right'}}>{formatMoney(totDepto.totalDed)}</td>
                                                            <td style={{border:'1px solid #000', padding:'3px', textAlign:'right', background:'#c8c8c8'}}>{formatMoney(totDepto.neto)}</td>
                                                        </tr>
                                                    </React.Fragment>
                                                );
                                            })}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'4px', fontSize:'9px'}}>TOTAL GENERAL ({detalles.length} empleados)</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.salarioBase, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.horasExtra + d.bonificacion + (d.comisiones||0) + (d.incentivos||0), 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.totalIng, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.afpEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.sfsEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.isr, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.cuotaPrestamo + d.descAusencias + d.descTardanzas + d.otrasDed, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.totalDed, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(detalles.reduce((s,d) => s + d.neto, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div className="reporte-firmas" style={{marginTop:'20px', display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'25px', fontSize:'9px'}}>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Elaborado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Revisado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Aprobado por</div></div>
                                    </div>
                                </>
                            );
                        })()}
                        
                        {/* REPORTE: Resumen de Nómina */}
                        {tipoReporteActivo === 'nomina-resumen' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            const porDepto = detalles.reduce((acc, d) => { 
                                const depto = d.depto || 'SIN DEPARTAMENTO';
                                if (!acc[depto]) acc[depto] = []; 
                                acc[depto].push(d); 
                                return acc; 
                            }, {});
                            const totales = detalles.reduce((a, d) => ({
                                salario: a.salario + d.salarioBase, otros: a.otros + d.horasExtra + d.bonificacion + (d.comisiones||0) + (d.incentivos||0),
                                totalIng: a.totalIng + d.totalIng, afpEmp: a.afpEmp + d.afpEmp, sfsEmp: a.sfsEmp + d.sfsEmp, isr: a.isr + d.isr,
                                totalDed: a.totalDed + d.totalDed, neto: a.neto + d.neto, afpPat: a.afpPat + d.afpPat, sfsPat: a.sfsPat + d.sfsPat,
                                infotep: a.infotep + d.infotep, riesgo: a.riesgo + d.riesgo
                            }), {salario:0, otros:0, totalIng:0, afpEmp:0, sfsEmp:0, isr:0, totalDed:0, neto:0, afpPat:0, sfsPat:0, infotep:0, riesgo:0});
                            
                            return (
                                <div className="reporte-seccion">
                                    <h4 style={{fontSize:'11px', marginBottom:'10px', borderBottom:'1px solid #999', paddingBottom:'5px'}}>Resumen por Departamento</h4>
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px', marginBottom:'15px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Departamento</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'center'}}>Empleados</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Salarios</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Otros Ing.</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Total Ingresos</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Total Deduc.</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right', background:'#b0b0b0'}}>Neto a Pagar</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.entries(porDepto).sort((a,b) => a[0].localeCompare(b[0])).map(([depto, emps]) => {
                                                const tot = emps.reduce((a,d) => ({
                                                    sal: a.sal + d.salarioBase, otros: a.otros + d.horasExtra + d.bonificacion + (d.comisiones||0) + (d.incentivos||0),
                                                    totalIng: a.totalIng + d.totalIng, totalDed: a.totalDed + d.totalDed, neto: a.neto + d.neto
                                                }), {sal:0, otros:0, totalIng:0, totalDed:0, neto:0});
                                                return (
                                                    <tr key={depto}>
                                                        <td style={{border:'1px solid #999', padding:'4px', fontWeight:'600'}}>{depto}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'center'}}>{emps.length}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(tot.sal)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{tot.otros > 0 ? formatMoney(tot.otros) : '-'}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(tot.totalIng)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(tot.totalDed)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(tot.neto)}</td>
                                                    </tr>
                                                );
                                            })}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'5px'}}>TOTALES</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'center'}}>{detalles.length}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(totales.salario)}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(totales.otros)}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(totales.totalIng)}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(totales.totalDed)}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right', fontSize:'11px', background:'#909090'}}>{formatMoney(totales.neto)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                                        <div style={{border:'1px solid #999', padding:'10px'}}>
                                            <h4 style={{fontSize:'10px', marginBottom:'8px', borderBottom:'1px solid #ccc', paddingBottom:'4px'}}>Aportes a la Seguridad Social</h4>
                                            <table style={{width:'100%', fontSize:'9px'}}>
                                                <tbody>
                                                    <tr><td>AFP Empleado ({config.tss.afpEmpleado}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.afpEmp)}</td></tr>
                                                    <tr><td>AFP Patronal ({config.tss.afpPatronal}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.afpPat)}</td></tr>
                                                    <tr style={{fontWeight:'bold', borderTop:'1px solid #999'}}><td>Total AFP</td><td style={{textAlign:'right'}}>{formatMoney(totales.afpEmp + totales.afpPat)}</td></tr>
                                                    <tr><td colSpan="2" style={{height:'8px'}}></td></tr>
                                                    <tr><td>SFS Empleado ({config.tss.sfsEmpleado}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.sfsEmp)}</td></tr>
                                                    <tr><td>SFS Patronal ({config.tss.sfsPatronal}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.sfsPat)}</td></tr>
                                                    <tr style={{fontWeight:'bold', borderTop:'1px solid #999'}}><td>Total SFS</td><td style={{textAlign:'right'}}>{formatMoney(totales.sfsEmp + totales.sfsPat)}</td></tr>
                                                    <tr><td colSpan="2" style={{height:'8px'}}></td></tr>
                                                    <tr><td>INFOTEP ({config.tss.infotep}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.infotep)}</td></tr>
                                                    <tr><td>Riesgo Laboral ({config.tss.riesgoLaboral}%)</td><td style={{textAlign:'right'}}>{formatMoney(totales.riesgo)}</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style={{border:'1px solid #999', padding:'10px'}}>
                                            <h4 style={{fontSize:'10px', marginBottom:'8px', borderBottom:'1px solid #ccc', paddingBottom:'4px'}}>Resumen General</h4>
                                            <div style={{fontSize:'10px'}}>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}><span>Total Empleados:</span><strong>{detalles.length}</strong></div>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}><span>Total Ingresos:</span><strong>{formatMoney(totales.totalIng)}</strong></div>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}><span>Total Deducciones:</span><strong>{formatMoney(totales.totalDed)}</strong></div>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}><span>ISR Retenido:</span><strong>{formatMoney(totales.isr)}</strong></div>
                                                <div style={{display:'flex', justifyContent:'space-between', padding:'8px', background:'#d0d0d0', marginTop:'10px', border:'2px solid #000'}}>
                                                    <span style={{fontWeight:'bold'}}>NETO A PAGAR:</span>
                                                    <span style={{fontWeight:'bold', fontSize:'12px'}}>{formatMoney(totales.neto)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="reporte-firmas" style={{marginTop:'25px', display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'25px', fontSize:'9px'}}>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'30px'}}>Elaborado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'30px'}}>Revisado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'30px'}}>Aprobado por</div></div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* REPORTE: TSS */}
                        {tipoReporteActivo === 'tss' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cédula/NSS</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario Cotiz.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>AFP Emp.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>AFP Pat.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>SFS Emp.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>SFS Pat.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>INFOTEP</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Riesgo Lab.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right', background:'#b0b0b0'}}>Total TSS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {detalles.map((d, idx) => {
                                                const emp = empleados.find(e => e.id === d.empId);
                                                return (
                                                    <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                        <td style={{border:'1px solid #999', padding:'3px'}}>{d.nombre}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{emp?.documento}<br/>{emp?.nss || '-'}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.salarioBase)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.afpEmp)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.afpPat)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.sfsEmp)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.sfsPat)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.infotep)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.riesgo)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.afpEmp + d.afpPat + d.sfsEmp + d.sfsPat + d.infotep + d.riesgo)}</td>
                                                    </tr>
                                                );
                                            })}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td colSpan="2" style={{border:'2px solid #000', padding:'4px'}}>TOTALES ({detalles.length})</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.salarioBase, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.afpEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.afpPat, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.sfsEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.sfsPat, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.infotep, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.riesgo, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(detalles.reduce((s,d) => s + d.afpEmp + d.afpPat + d.sfsEmp + d.sfsPat + d.infotep + d.riesgo, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div className="reporte-firmas" style={{marginTop:'20px', display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'25px', fontSize:'9px'}}>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Elaborado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Revisado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Aprobado por</div></div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* REPORTE: Deducciones */}
                        {tipoReporteActivo === 'deducciones' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>AFP</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>SFS</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>ISR</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Préstamos</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Ausencias</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Tardanzas</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Otras Ded.</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right', background:'#b0b0b0'}}>Total Ded.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {detalles.map((d, idx) => (
                                                <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                    <td style={{border:'1px solid #999', padding:'3px'}}>{d.nombre}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.afpEmp)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.sfsEmp)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.isr > 0 ? formatMoney(d.isr) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.cuotaPrestamo > 0 ? formatMoney(d.cuotaPrestamo) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.descAusencias > 0 ? formatMoney(d.descAusencias) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.descTardanzas > 0 ? formatMoney(d.descTardanzas) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.otrasDed > 0 ? formatMoney(d.otrasDed) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.totalDed)}</td>
                                                </tr>
                                            ))}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'4px'}}>TOTALES</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.afpEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.sfsEmp, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.isr, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.cuotaPrestamo, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.descAusencias, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.descTardanzas, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.otrasDed, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(detalles.reduce((s,d) => s + d.totalDed, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div className="reporte-firmas" style={{marginTop:'20px', display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'25px', fontSize:'9px'}}>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Elaborado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Revisado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Aprobado por</div></div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* REPORTE: Ingresos */}
                        {tipoReporteActivo === 'ingresos' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario Base</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Horas Extra</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Bonificación</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Comisiones</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Incentivos</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Regalía</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right', background:'#b0b0b0'}}>Total Ing.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {detalles.map((d, idx) => (
                                                <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                    <td style={{border:'1px solid #999', padding:'3px'}}>{d.nombre}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.salarioBase)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.horasExtra > 0 ? formatMoney(d.horasExtra) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{d.bonificacion > 0 ? formatMoney(d.bonificacion) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{(d.comisiones||0) > 0 ? formatMoney(d.comisiones) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{(d.incentivos||0) > 0 ? formatMoney(d.incentivos) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{(d.regalia||0) > 0 ? formatMoney(d.regalia) : '-'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.totalIng)}</td>
                                                </tr>
                                            ))}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'4px'}}>TOTALES</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.salarioBase, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.horasExtra, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + d.bonificacion, 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + (d.comisiones||0), 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + (d.incentivos||0), 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(detalles.reduce((s,d) => s + (d.regalia||0), 0))}</td>
                                                <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(detalles.reduce((s,d) => s + d.totalIng, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div className="reporte-firmas" style={{marginTop:'20px', display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:'25px', fontSize:'9px'}}>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Elaborado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Revisado por</div></div>
                                        <div style={{textAlign:'center'}}><div style={{borderTop:'1px solid #333', paddingTop:'4px', marginTop:'25px'}}>Aprobado por</div></div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* REPORTES DE EMPLEADOS */}
                        {/* Empleados Activos */}
                        {(tipoReporteActivo === 'empleados' || tipoReporteActivo === 'empleados-activos') && (
                            <div className="reporte-seccion">
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                    <thead>
                                        <tr style={{background:'#d0d0d0'}}>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Nombre</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cédula</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Celular</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Departamento</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cargo</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>F. Ingreso</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Banco</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cuenta</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {empleados.filter(e => e.activo && !e.fechaSalida).sort((a,b) => a.nombre.localeCompare(b.nombre)).map((e, idx) => (
                                            <tr key={e.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{e.nombre}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{e.documento}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{e.celular || '-'}</td>
                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.departamento}</td>
                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.cargo || '-'}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(e.fechaIngreso)}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(e.salarioBase)}</td>
                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.banco || '-'}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{e.cuenta || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div style={{marginTop:'10px', display:'flex', justifyContent:'space-between', fontSize:'9px'}}>
                                    <span>Total empleados activos: <strong>{empleados.filter(e => e.activo && !e.fechaSalida).length}</strong></span>
                                    <span>Nómina mensual: <strong>RD$ {formatMoney(empleados.filter(e => e.activo && !e.fechaSalida).reduce((s,e) => s + e.salarioBase, 0))}</strong></span>
                                </div>
                            </div>
                        )}
                        
                        {/* Empleados por Departamento */}
                        {tipoReporteActivo === 'empleados-depto' && (() => {
                            const activos = empleados.filter(e => e.activo && !e.fechaSalida);
                            const porDepto = activos.reduce((acc, e) => {
                                if (!acc[e.departamento]) acc[e.departamento] = [];
                                acc[e.departamento].push(e);
                                return acc;
                            }, {});
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Nombre</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cédula</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cargo</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>F. Ingreso</th>
                                                <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(porDepto).sort().map(depto => {
                                                const emps = porDepto[depto].sort((a,b) => a.nombre.localeCompare(b.nombre));
                                                const totalDepto = emps.reduce((s,e) => s + e.salarioBase, 0);
                                                return (
                                                    <React.Fragment key={depto}>
                                                        <tr style={{background:'#e8e8e8'}}>
                                                            <td colSpan="5" style={{border:'1px solid #000', padding:'5px', fontWeight:'bold', fontSize:'9px'}}>{depto} ({emps.length} empleados)</td>
                                                        </tr>
                                                        {emps.map((e, idx) => (
                                                            <tr key={e.id} style={{background: idx % 2 === 0 ? '#fff' : '#f8f8f8'}}>
                                                                <td style={{border:'1px solid #999', padding:'3px', paddingLeft:'15px'}}>{e.nombre}</td>
                                                                <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{e.documento}</td>
                                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.cargo || '-'}</td>
                                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(e.fechaIngreso)}</td>
                                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(e.salarioBase)}</td>
                                                            </tr>
                                                        ))}
                                                        <tr style={{background:'#d8d8d8'}}>
                                                            <td colSpan="4" style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'600'}}>Subtotal {depto}:</td>
                                                            <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(totalDepto)}</td>
                                                        </tr>
                                                    </React.Fragment>
                                                );
                                            })}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td colSpan="4" style={{border:'2px solid #000', padding:'5px'}}>TOTAL GENERAL ({activos.length} empleados)</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right', fontSize:'10px'}}>{formatMoney(activos.reduce((s,e) => s + e.salarioBase, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            );
                        })()}
                        
                        {/* Empleados por Antigüedad */}
                        {tipoReporteActivo === 'empleados-antiguedad' && (
                            <div className="reporte-seccion">
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                    <thead>
                                        <tr style={{background:'#d0d0d0'}}>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Nombre</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Departamento</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>F. Ingreso</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Antigüedad</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {empleados.filter(e => e.activo && !e.fechaSalida).sort((a,b) => new Date(a.fechaIngreso) - new Date(b.fechaIngreso)).map((e, idx) => {
                                            const antiguedad = calcularAntiguedad(e.fechaIngreso);
                                            return (
                                                <tr key={e.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                    <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{e.nombre}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px'}}>{e.departamento}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(e.fechaIngreso)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontWeight:'600'}}>{antiguedad.años > 0 ? `${antiguedad.años}a ${antiguedad.meses % 12}m` : `${antiguedad.meses}m`}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(e.salarioBase)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {/* Escala Salarial */}
                        {tipoReporteActivo === 'empleados-salarios' && (() => {
                            const activos = empleados.filter(e => e.activo && !e.fechaSalida);
                            const porDepto = activos.reduce((acc, e) => {
                                if (!acc[e.departamento]) acc[e.departamento] = [];
                                acc[e.departamento].push(e);
                                return acc;
                            }, {});
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Departamento</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'center'}}>Empleados</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Salario Mínimo</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Salario Máximo</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Promedio</th>
                                                <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Total Depto.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(porDepto).sort().map((depto, idx) => {
                                                const emps = porDepto[depto];
                                                const salarios = emps.map(e => e.salarioBase);
                                                const min = Math.min(...salarios);
                                                const max = Math.max(...salarios);
                                                const prom = salarios.reduce((a,b) => a+b, 0) / salarios.length;
                                                const total = salarios.reduce((a,b) => a+b, 0);
                                                return (
                                                    <tr key={depto} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                        <td style={{border:'1px solid #999', padding:'4px', fontWeight:'600'}}>{depto}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'center'}}>{emps.length}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(min)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(max)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(prom)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(total)}</td>
                                                    </tr>
                                                );
                                            })}
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'5px'}}>TOTALES</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'center'}}>{activos.length}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(Math.min(...activos.map(e => e.salarioBase)))}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(Math.max(...activos.map(e => e.salarioBase)))}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right'}}>{formatMoney(activos.reduce((s,e) => s + e.salarioBase, 0) / activos.length)}</td>
                                                <td style={{border:'2px solid #000', padding:'5px', textAlign:'right', fontSize:'10px'}}>{formatMoney(activos.reduce((s,e) => s + e.salarioBase, 0))}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            );
                        })()}
                        
                        {/* Cumpleañeros del Mes */}
                        {tipoReporteActivo === 'empleados-cumple' && (() => {
                            const mesActual = new Date().getMonth() + 1;
                            const cumpleaneros = empleados.filter(e => e.activo && !e.fechaSalida && e.fechaNacimiento).filter(e => {
                                const mes = new Date(e.fechaNacimiento).getMonth() + 1;
                                return mes === mesActual;
                            }).sort((a,b) => new Date(a.fechaNacimiento).getDate() - new Date(b.fechaNacimiento).getDate());
                            return (
                                <div className="reporte-seccion">
                                    <div style={{textAlign:'center', marginBottom:'15px'}}>
                                        <h4 style={{fontSize:'14px'}}>🎂 Cumpleañeros de {MESES[mesActual]}</h4>
                                    </div>
                                    {cumpleaneros.length === 0 ? (
                                        <div style={{textAlign:'center', padding:'30px', color:'var(--text-muted)'}}>
                                            No hay cumpleañeros este mes
                                        </div>
                                    ) : (
                                        <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px'}}>
                                            <thead>
                                                <tr style={{background:'#d0d0d0'}}>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'center'}}>Día</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Nombre</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Departamento</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'center'}}>Edad</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {cumpleaneros.map((e, idx) => {
                                                    const dia = new Date(e.fechaNacimiento).getDate();
                                                    const edad = calcularEdad(e.fechaNacimiento);
                                                    return (
                                                        <tr key={e.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                            <td style={{border:'1px solid #999', padding:'4px', textAlign:'center', fontWeight:'bold', fontSize:'12px'}}>{dia}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px', fontWeight:'600'}}>{e.nombre}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px'}}>{e.departamento}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px', textAlign:'center'}}>{edad} años</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    )}
                                    <div style={{marginTop:'10px', fontSize:'9px', textAlign:'right'}}>
                                        <strong>Total cumpleañeros: {cumpleaneros.length}</strong>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* Empleados Desvinculados */}
                        {tipoReporteActivo === 'empleados-desvinculados' && (
                            <div className="reporte-seccion">
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                    <thead>
                                        <tr style={{background:'#d0d0d0'}}>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Nombre</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Cédula</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Departamento</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>F. Ingreso</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>F. Salida</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Motivo</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Último Salario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {empleados.filter(e => e.fechaSalida).sort((a,b) => new Date(b.fechaSalida) - new Date(a.fechaSalida)).map((e, idx) => (
                                            <tr key={e.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{e.nombre}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', fontSize:'7px'}}>{e.documento}</td>
                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.departamento}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(e.fechaIngreso)}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(e.fechaSalida)}</td>
                                                <td style={{border:'1px solid #999', padding:'3px'}}>{e.motivoSalida || '-'}</td>
                                                <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(e.salarioBase)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div style={{marginTop:'10px', fontSize:'9px', textAlign:'right'}}>
                                    <strong>Total desvinculados: {empleados.filter(e => e.fechaSalida).length}</strong>
                                </div>
                            </div>
                        )}
                        
                        {/* REPORTES DE NÓMINA POR BANCO */}
                        {tipoReporteActivo === 'nomina-banco' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            const porBanco = {};
                            detalles.forEach(d => {
                                const emp = empleados.find(e => e.id === d.empId);
                                const banco = emp?.banco || 'Sin cuenta';
                                if (!porBanco[banco]) porBanco[banco] = [];
                                porBanco[banco].push({...d, cuenta: emp?.cuenta});
                            });
                            return (
                                <div className="reporte-seccion">
                                    {Object.keys(porBanco).sort().map(banco => {
                                        const emps = porBanco[banco];
                                        const totalBanco = emps.reduce((s,d) => s + d.neto, 0);
                                        return (
                                            <div key={banco} style={{marginBottom:'15px'}}>
                                                <div style={{background:'#333', color:'white', padding:'8px 12px', fontWeight:'bold'}}>{banco === 'Sin cuenta' ? '💵 Efectivo/Cheque' : `🏦 ${banco}`} - {emps.length} empleados - RD$ {formatMoney(totalBanco)}</div>
                                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                                    <thead>
                                                        <tr style={{background:'#e8e8e8'}}>
                                                            <th style={{border:'1px solid #999', padding:'3px', textAlign:'left'}}>Empleado</th>
                                                            <th style={{border:'1px solid #999', padding:'3px', textAlign:'left'}}>Cuenta</th>
                                                            <th style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>Neto</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {emps.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((d, idx) => (
                                                            <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f8f8f8'}}>
                                                                <td style={{border:'1px solid #ccc', padding:'2px 4px'}}>{d.nombre}</td>
                                                                <td style={{border:'1px solid #ccc', padding:'2px 4px', fontSize:'7px'}}>{d.cuenta || '-'}</td>
                                                                <td style={{border:'1px solid #ccc', padding:'2px 4px', textAlign:'right', fontWeight:'600'}}>{formatMoney(d.neto)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        );
                                    })}
                                    <div style={{background:'#b0b0b0', padding:'10px', fontWeight:'bold', display:'flex', justifyContent:'space-between'}}>
                                        <span>TOTAL A DEPOSITAR</span>
                                        <span>RD$ {formatMoney(detalles.reduce((s,d) => s + d.neto, 0))}</span>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* REPORTES DE PRÉSTAMOS */}
                        {(tipoReporteActivo === 'prestamos' || tipoReporteActivo === 'prestamos-activos') && (
                            <div className="reporte-seccion">
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                    <thead>
                                        <tr style={{background:'#d0d0d0'}}>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Fecha</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Monto Original</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Cuota</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Cuotas Rest.</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Pagado</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right', background:'#b0b0b0'}}>Saldo</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {prestamos.filter(p => p.activo && p.saldo > 0).map((p, idx) => {
                                            const emp = empleados.find(e => e.id === p.empleadoId);
                                            const pagado = p.monto - p.saldo;
                                            return (
                                                <tr key={p.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                    <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{emp?.nombre || 'N/A'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(p.fecha)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(p.monto)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(p.cuotaMensual)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center'}}>{Math.ceil(p.saldo / p.cuotaMensual)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(pagado)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(p.saldo)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center'}}>{p.saldo > 0 ? 'Pendiente' : 'Pagado'}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                            <td colSpan="2" style={{border:'2px solid #000', padding:'4px'}}>TOTALES ({prestamos.filter(p => p.activo && p.saldo > 0).length} préstamos activos)</td>
                                            <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(prestamos.filter(p => p.activo && p.saldo > 0).reduce((s,p) => s + p.monto, 0))}</td>
                                            <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(prestamos.filter(p => p.activo && p.saldo > 0).reduce((s,p) => s + p.cuotaMensual, 0))}</td>
                                            <td style={{border:'2px solid #000', padding:'4px'}}></td>
                                            <td style={{border:'2px solid #000', padding:'4px', textAlign:'right'}}>{formatMoney(prestamos.filter(p => p.activo && p.saldo > 0).reduce((s,p) => s + (p.monto - p.saldo), 0))}</td>
                                            <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(prestamos.filter(p => p.activo && p.saldo > 0).reduce((s,p) => s + p.saldo, 0))}</td>
                                            <td style={{border:'2px solid #000', padding:'4px'}}></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {/* Préstamos por vencer */}
                        {tipoReporteActivo === 'prestamos-vencer' && (() => {
                            const proximosVencer = prestamos.filter(p => p.activo && p.saldo > 0).filter(p => {
                                const cuotasRest = Math.ceil(p.saldo / p.cuotaMensual);
                                return cuotasRest <= 3;
                            });
                            return (
                                <div className="reporte-seccion">
                                    <div style={{marginBottom:'10px', padding:'10px', background:'#fff3e0', border:'1px solid #ffb74d', borderRadius:'6px', fontSize:'10px'}}>
                                        ⚠️ Préstamos que se completarán en los próximos 3 meses
                                    </div>
                                    {proximosVencer.length === 0 ? (
                                        <div style={{textAlign:'center', padding:'30px', color:'var(--text-muted)'}}>
                                            No hay préstamos próximos a vencer
                                        </div>
                                    ) : (
                                        <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px'}}>
                                            <thead>
                                                <tr style={{background:'#d0d0d0'}}>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Empleado</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Cuota Mensual</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'center'}}>Cuotas Restantes</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Saldo Pendiente</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {proximosVencer.map((p, idx) => {
                                                    const emp = empleados.find(e => e.id === p.empleadoId);
                                                    const cuotasRest = Math.ceil(p.saldo / p.cuotaMensual);
                                                    return (
                                                        <tr key={p.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                            <td style={{border:'1px solid #999', padding:'4px', fontWeight:'600'}}>{emp?.nombre || 'N/A'}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(p.cuotaMensual)}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px', textAlign:'center', fontWeight:'bold', color: cuotasRest === 1 ? '#e53935' : '#fb8c00'}}>{cuotasRest}</td>
                                                            <td style={{border:'1px solid #999', padding:'4px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(p.saldo)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* Historial de Préstamos */}
                        {tipoReporteActivo === 'prestamos-historial' && (
                            <div className="reporte-seccion">
                                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                    <thead>
                                        <tr style={{background:'#d0d0d0'}}>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Fecha</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Monto</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Pagado</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Saldo</th>
                                            <th style={{border:'1px solid #000', padding:'4px', textAlign:'center'}}>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {prestamos.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map((p, idx) => {
                                            const emp = empleados.find(e => e.id === p.empleadoId);
                                            const pagado = p.monto - p.saldo;
                                            const completado = p.saldo <= 0;
                                            return (
                                                <tr key={p.id} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5', opacity: completado ? 0.7 : 1}}>
                                                    <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{emp?.nombre || 'N/A'}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center', fontSize:'7px'}}>{formatDate(p.fecha)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(p.monto)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(pagado)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(p.saldo)}</td>
                                                    <td style={{border:'1px solid #999', padding:'3px', textAlign:'center'}}>
                                                        <span style={{padding:'2px 6px', borderRadius:'4px', fontSize:'7px', background: completado ? '#c8e6c9' : '#fff3e0', color: completado ? '#2e7d32' : '#e65100'}}>
                                                            {completado ? '✓ Pagado' : 'Activo'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {/* Resumen TSS */}
                        {tipoReporteActivo === 'tss-resumen' && currentNomina && (() => {
                            const detalles = getDetallesRecalc();
                            const totales = detalles.reduce((a, d) => ({
                                afpEmp: a.afpEmp + d.afpEmp, afpPat: a.afpPat + d.afpPat,
                                sfsEmp: a.sfsEmp + d.sfsEmp, sfsPat: a.sfsPat + d.sfsPat,
                                infotep: a.infotep + d.infotep, riesgo: a.riesgo + d.riesgo
                            }), {afpEmp:0, afpPat:0, sfsEmp:0, sfsPat:0, infotep:0, riesgo:0});
                            return (
                                <div className="reporte-seccion">
                                    <table style={{width:'70%', margin:'0 auto', borderCollapse:'collapse', fontSize:'10px'}}>
                                        <thead>
                                            <tr style={{background:'#d0d0d0'}}>
                                                <th style={{border:'1px solid #000', padding:'8px', textAlign:'left'}}>Concepto</th>
                                                <th style={{border:'1px solid #000', padding:'8px', textAlign:'right'}}>Empleado</th>
                                                <th style={{border:'1px solid #000', padding:'8px', textAlign:'right'}}>Patronal</th>
                                                <th style={{border:'1px solid #000', padding:'8px', textAlign:'right', background:'#b0b0b0'}}>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td style={{border:'1px solid #999', padding:'6px', fontWeight:'600'}}>AFP</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.afpEmp)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.afpPat)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(totales.afpEmp + totales.afpPat)}</td></tr>
                                            <tr style={{background:'#f5f5f5'}}><td style={{border:'1px solid #999', padding:'6px', fontWeight:'600'}}>SFS</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.sfsEmp)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.sfsPat)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(totales.sfsEmp + totales.sfsPat)}</td></tr>
                                            <tr><td style={{border:'1px solid #999', padding:'6px', fontWeight:'600'}}>INFOTEP</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'center'}}>-</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.infotep)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(totales.infotep)}</td></tr>
                                            <tr style={{background:'#f5f5f5'}}><td style={{border:'1px solid #999', padding:'6px', fontWeight:'600'}}>Riesgo Laboral</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'center'}}>-</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right'}}>{formatMoney(totales.riesgo)}</td>
                                                <td style={{border:'1px solid #999', padding:'6px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(totales.riesgo)}</td></tr>
                                            <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                <td style={{border:'2px solid #000', padding:'8px'}}>TOTALES</td>
                                                <td style={{border:'2px solid #000', padding:'8px', textAlign:'right'}}>{formatMoney(totales.afpEmp + totales.sfsEmp)}</td>
                                                <td style={{border:'2px solid #000', padding:'8px', textAlign:'right'}}>{formatMoney(totales.afpPat + totales.sfsPat + totales.infotep + totales.riesgo)}</td>
                                                <td style={{border:'2px solid #000', padding:'8px', textAlign:'right', background:'#909090', fontSize:'12px'}}>{formatMoney(totales.afpEmp + totales.afpPat + totales.sfsEmp + totales.sfsPat + totales.infotep + totales.riesgo)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            );
                        })()}
                        
                        {/* ISR Retenido */}
                        {tipoReporteActivo === 'isr' && currentNomina && (() => {
                            const detalles = getDetallesRecalc().filter(d => d.isr > 0);
                            return (
                                <div className="reporte-seccion">
                                    {detalles.length === 0 ? (
                                        <div style={{textAlign:'center', padding:'30px', color:'var(--text-muted)'}}>No hay retenciones de ISR en esta nómina</div>
                                    ) : (
                                        <table style={{width:'100%', borderCollapse:'collapse', fontSize:'8px'}}>
                                            <thead>
                                                <tr style={{background:'#d0d0d0'}}>
                                                    <th style={{border:'1px solid #000', padding:'4px', textAlign:'left'}}>Empleado</th>
                                                    <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Salario Bruto</th>
                                                    <th style={{border:'1px solid #000', padding:'4px', textAlign:'right'}}>Ded. TSS</th>
                                                    <th style={{border:'1px solid #000', padding:'4px', textAlign:'right', background:'#b0b0b0'}}>ISR Retenido</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {detalles.map((d, idx) => (
                                                    <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                        <td style={{border:'1px solid #999', padding:'3px', fontWeight:'600'}}>{d.nombre}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.totalIng)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right'}}>{formatMoney(d.afpEmp + d.sfsEmp)}</td>
                                                        <td style={{border:'1px solid #999', padding:'3px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.isr)}</td>
                                                    </tr>
                                                ))}
                                                <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                    <td colSpan="3" style={{border:'2px solid #000', padding:'4px'}}>TOTAL ISR ({detalles.length} empleados)</td>
                                                    <td style={{border:'2px solid #000', padding:'4px', textAlign:'right', background:'#909090', fontSize:'10px'}}>{formatMoney(detalles.reduce((s,d) => s + d.isr, 0))}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* Horas Extra */}
                        {tipoReporteActivo === 'horas-extra' && currentNomina && (() => {
                            const detalles = getDetallesRecalc().filter(d => d.horasExtra > 0);
                            return (
                                <div className="reporte-seccion">
                                    {detalles.length === 0 ? (
                                        <div style={{textAlign:'center', padding:'30px', color:'var(--text-muted)'}}>No hay horas extras en esta nómina</div>
                                    ) : (
                                        <table style={{width:'100%', borderCollapse:'collapse', fontSize:'9px'}}>
                                            <thead>
                                                <tr style={{background:'#d0d0d0'}}>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Empleado</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'left'}}>Departamento</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'right'}}>Salario Base</th>
                                                    <th style={{border:'1px solid #000', padding:'5px', textAlign:'right', background:'#b0b0b0'}}>Monto H. Extra</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {detalles.map((d, idx) => (
                                                    <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f5f5f5'}}>
                                                        <td style={{border:'1px solid #999', padding:'4px', fontWeight:'600'}}>{d.nombre}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px'}}>{d.depto}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right'}}>{formatMoney(d.salarioBase)}</td>
                                                        <td style={{border:'1px solid #999', padding:'4px', textAlign:'right', fontWeight:'bold', background:'#e8e8e8'}}>{formatMoney(d.horasExtra)}</td>
                                                    </tr>
                                                ))}
                                                <tr style={{background:'#b0b0b0', fontWeight:'bold'}}>
                                                    <td colSpan="3" style={{border:'2px solid #000', padding:'5px'}}>TOTAL HORAS EXTRA ({detalles.length} empleados)</td>
                                                    <td style={{border:'2px solid #000', padding:'5px', textAlign:'right', fontSize:'11px'}}>{formatMoney(detalles.reduce((s,d) => s + d.horasExtra, 0))}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* REPORTE: Comparativo y Pendientes */}
                        {(tipoReporteActivo === 'comparativo' || tipoReporteActivo === 'comparativo-nominas' || tipoReporteActivo === 'evolucion-salarios') && (
                            <div className="alert alert-info">
                                <Icons.Info />
                                <span>El reporte comparativo estará disponible próximamente. Permitirá comparar dos períodos de nómina.</span>
                            </div>
                        )}
                    </div>
                )}
            </Modal>

            {/* Modal de Ausencias */}
            <Modal 
                open={modals.ausencias} 
                onClose={() => { closeModal('ausencias'); setAusenciasEmpId(null); }} 
                title="Registrar Días No Laborados" 
                size="md"
                footer={
                    <>
                        <button className="btn btn-secondary" onClick={() => { closeModal('ausencias'); setAusenciasEmpId(null); }}>Cerrar</button>
                    </>
                }
            >
                {ausenciasEmpId && (
                    <div>
                        <div className="alert alert-info" style={{marginBottom:'16px'}}>
                            <Icons.Info />
                            <span>
                                <strong>{empleados.find(e => e.id === ausenciasEmpId)?.nombre}</strong><br/>
                                Seleccione los días que NO laboró en este período. El descuento se calculará automáticamente.
                            </span>
                        </div>
                        
                        <div style={{marginBottom:'16px', padding:'12px', background:'var(--bg-secondary)', borderRadius:'8px'}}>
                            <strong>Período:</strong> {MESES[periodo.mes]} {periodo.año} 
                            {periodo.tipo === 'quincenal' && ` - ${periodo.quincena === 1 ? '1ra' : '2da'} Quincena`}
                        </div>

                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(100px, 1fr))', gap:'8px'}}>
                            {getFechasDelPeriodo().map(fecha => {
                                const seleccionada = (nominaEdits[ausenciasEmpId]?.fechasAus || []).includes(fecha);
                                return (
                                    <button
                                        key={fecha}
                                        className="btn btn-sm"
                                        style={{
                                            background: seleccionada ? '#dc3545' : 'var(--bg-tertiary)',
                                            color: seleccionada ? 'white' : 'var(--text-primary)',
                                            border: seleccionada ? '2px solid #dc3545' : '1px solid var(--border-color)',
                                            padding: '8px 4px',
                                            display: 'flex',
                                            flexDirection: 'column',
                                            alignItems: 'center',
                                            fontSize: '11px'
                                        }}
                                        onClick={() => toggleFechaAusencia(fecha)}
                                    >
                                        <span style={{fontWeight:'bold'}}>{getDiaSemana(fecha)}</span>
                                        <span>{formatFechaCorta(fecha)}</span>
                                    </button>
                                );
                            })}
                        </div>

                        {(nominaEdits[ausenciasEmpId]?.fechasAus?.length || 0) > 0 && (
                            <div style={{marginTop:'16px', padding:'12px', background:'#dc354520', borderRadius:'8px', border:'1px solid #dc3545'}}>
                                <strong style={{color:'#dc3545'}}>Días seleccionados ({nominaEdits[ausenciasEmpId]?.fechasAus?.length || 0}):</strong>
                                <div style={{marginTop:'8px', display:'flex', flexWrap:'wrap', gap:'4px'}}>
                                    {nominaEdits[ausenciasEmpId]?.fechasAus?.map(f => (
                                        <span key={f} className="badge" style={{background:'#dc3545', color:'white', padding:'4px 8px'}}>
                                            {getDiaSemana(f)} {formatFechaCorta(f)}
                                        </span>
                                    ))}
                                </div>
                                <div style={{marginTop:'8px', fontSize:'12px', color:'var(--text-secondary)'}}>
                                    Descuento estimado: <strong style={{color:'#dc3545'}}>RD$ {formatMoney(
                                        calcularSalarioDiario(empleados.find(e => e.id === ausenciasEmpId)?.salarioBase || 0, config) * 
                                        (nominaEdits[ausenciasEmpId]?.fechasAus?.length || 0)
                                    )}</strong>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </Modal>

            {/* Modal Cambio de Contraseña */}
            <Modal 
                open={mostrarCambioPassword} 
                onClose={() => { setMostrarCambioPassword(false); setCambioPasswordForm({ actual: '', nueva: '', confirmar: '', error: '' }); }} 
                title="Cambiar Contraseña" 
                size="sm"
                footer={
                    <>
                        <button className="btn btn-secondary" onClick={() => setMostrarCambioPassword(false)}>Cancelar</button>
                        <button className="btn btn-primary" onClick={handleCambioPassword}><Icons.Check /> Cambiar</button>
                    </>
                }
            >
                <form onSubmit={handleCambioPassword}>
                    <div className="form-group">
                        <label className="form-label">Contraseña Actual</label>
                        <input 
                            type="password" 
                            className="form-control" 
                            value={cambioPasswordForm.actual}
                            onChange={e => setCambioPasswordForm(f => ({ ...f, actual: e.target.value, error: '' }))}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Nueva Contraseña</label>
                        <input 
                            type="password" 
                            className="form-control" 
                            value={cambioPasswordForm.nueva}
                            onChange={e => setCambioPasswordForm(f => ({ ...f, nueva: e.target.value, error: '' }))}
                        />
                        <div className="form-help">Mínimo 6 caracteres</div>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Confirmar Nueva Contraseña</label>
                        <input 
                            type="password" 
                            className="form-control" 
                            value={cambioPasswordForm.confirmar}
                            onChange={e => setCambioPasswordForm(f => ({ ...f, confirmar: e.target.value, error: '' }))}
                        />
                    </div>
                    {cambioPasswordForm.error && (
                        <div className="alert alert-danger" style={{marginTop:'12px'}}>
                            <Icons.AlertCircle /><span>{cambioPasswordForm.error}</span>
                        </div>
                    )}
                </form>
            </Modal>

            {/* Toasts */}
            <div className="toasts">{toasts.map(t => <Toast key={t.id} msg={t.msg} type={t.type} onClose={() => removeToast(t.id)} />)}</div>
            
            {/* Loading */}
            {loading && <div className="loading"><div className="spinner"></div></div>}
            
            {/* Área de Impresión de Nómina - Agrupada por Departamento */}
            {modoImpresionNomina && currentNomina && (() => {
                const detalles = getDetallesRecalc();
                const porDepto = detalles.reduce((acc, d) => { 
                    const depto = d.depto || 'SIN DEPARTAMENTO';
                    if (!acc[depto]) acc[depto] = []; 
                    acc[depto].push(d); 
                    return acc; 
                }, {});
                const deptosOrdenados = Object.keys(porDepto).sort();
                const totalesGral = detalles.reduce((a, d) => ({
                    salario: a.salario + d.salarioBase,
                    horasExtra: a.horasExtra + d.horasExtra,
                    bonificacion: a.bonificacion + d.bonificacion,
                    comisiones: a.comisiones + (d.comisiones || 0),
                    incentivos: a.incentivos + (d.incentivos || 0),
                    totalIng: a.totalIng + d.totalIng,
                    afpEmp: a.afpEmp + d.afpEmp,
                    sfsEmp: a.sfsEmp + d.sfsEmp,
                    isr: a.isr + d.isr,
                    prestamo: a.prestamo + d.cuotaPrestamo,
                    otras: a.otras + d.descAusencias + d.descTardanzas + d.otrasDed,
                    totalDed: a.totalDed + d.totalDed,
                    neto: a.neto + d.neto,
                    afpPat: a.afpPat + d.afpPat,
                    sfsPat: a.sfsPat + d.sfsPat,
                    infotep: a.infotep + d.infotep,
                    riesgo: a.riesgo + d.riesgo
                }), { salario: 0, horasExtra: 0, bonificacion: 0, comisiones: 0, incentivos: 0, totalIng: 0, afpEmp: 0, sfsEmp: 0, isr: 0, prestamo: 0, otras: 0, totalDed: 0, neto: 0, afpPat: 0, sfsPat: 0, infotep: 0, riesgo: 0 });
                
                return (
                <div className="print-area" style={{padding: '15px', background: 'white'}}>
                    {/* Encabezado del reporte */}
                    <div style={{textAlign: 'center', marginBottom: '15px', borderBottom: '2px solid #000', paddingBottom: '8px'}}>
                        <h2 style={{margin: 0, fontSize: '14px'}}>CENTRO EDUCATIVO DE FORMACIÓN INTEGRAL TEHUI</h2>
                        <p style={{margin: '3px 0', fontSize: '10px'}}>Carretera Don Pedro no. 140, esquina Las Orquídeas</p>
                        <p style={{margin: '3px 0', fontSize: '10px'}}>GRUPO PAIDOS, SRL - RNC: 133-03246-5</p>
                        <h3 style={{margin: '8px 0 5px', fontSize: '12px', background: '#e0e0e0', padding: '4px'}}>
                            NÓMINA DESDE {currentNomina.periodo.quincena === 1 ? '01' : '16'}/{String(currentNomina.periodo.mes).padStart(2,'0')}/{currentNomina.periodo.año} HASTA {currentNomina.periodo.quincena === 1 ? '15' : new Date(currentNomina.periodo.año, currentNomina.periodo.mes, 0).getDate()}/{String(currentNomina.periodo.mes).padStart(2,'0')}/{currentNomina.periodo.año}
                        </h3>
                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '9px', marginTop: '5px'}}>
                            <span>Nómina No. {currentNomina.codigo}</span>
                            <span>Fecha: {new Date().toLocaleDateString('es-DO')} {new Date().toLocaleTimeString('es-DO')}</span>
                        </div>
                    </div>
                    
                    {/* Tabla agrupada por departamento */}
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '8px'}}>
                        <thead>
                            <tr style={{background: '#d0d0d0'}}>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'left', width: '20%'}}>Empleado</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '7%'}}>Salario</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '5%'}}>Otros</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '6%'}}>Seg. Soc.</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '6%'}}>Imp/Renta</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '7%'}}>Total Ing.</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '7%'}}>Total Ded.</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '8%', background: '#b0b0b0', fontWeight: 'bold'}}>NETO</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '6%'}}>AFP</th>
                                <th style={{border: '1px solid #000', padding: '3px', textAlign: 'right', width: '6%'}}>S.F. Salud</th>
                            </tr>
                        </thead>
                        <tbody>
                            {deptosOrdenados.map(depto => {
                                const empsDepto = porDepto[depto];
                                const totDepto = empsDepto.reduce((a, d) => ({
                                    salario: a.salario + d.salarioBase,
                                    otros: a.otros + d.horasExtra + d.bonificacion + (d.comisiones || 0) + (d.incentivos || 0),
                                    segSoc: a.segSoc + d.afpEmp + d.sfsEmp,
                                    isr: a.isr + d.isr,
                                    totalIng: a.totalIng + d.totalIng,
                                    totalDed: a.totalDed + d.totalDed,
                                    neto: a.neto + d.neto,
                                    afpEmp: a.afpEmp + d.afpEmp,
                                    sfsEmp: a.sfsEmp + d.sfsEmp
                                }), { salario: 0, otros: 0, segSoc: 0, isr: 0, totalIng: 0, totalDed: 0, neto: 0, afpEmp: 0, sfsEmp: 0 });
                                
                                return (
                                    <React.Fragment key={depto}>
                                        {/* Encabezado del departamento */}
                                        <tr style={{background: '#f0f0f0'}}>
                                            <td colSpan="10" style={{border: '1px solid #000', padding: '4px', fontWeight: 'bold', fontSize: '9px'}}>{depto}</td>
                                        </tr>
                                        {/* Empleados del departamento */}
                                        {empsDepto.map((d, idx) => {
                                            const otros = d.horasExtra + d.bonificacion + (d.comisiones || 0) + (d.incentivos || 0);
                                            const segSoc = d.afpEmp + d.sfsEmp;
                                            return (
                                                <tr key={d.empId} style={{background: idx % 2 === 0 ? '#fff' : '#f8f8f8'}}>
                                                    <td style={{border: '1px solid #999', padding: '2px 3px'}}>{d.empId} - {d.nombre}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(d.salarioBase)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{otros > 0 ? formatMoney(otros) : ''}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(segSoc)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{d.isr > 0 ? formatMoney(d.isr) : ''}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: '600'}}>{formatMoney(d.totalIng)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(d.totalDed)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: 'bold', background: '#e8e8e8'}}>{formatMoney(d.neto)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontSize: '7px'}}>{formatMoney(d.afpEmp)}</td>
                                                    <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontSize: '7px'}}>{formatMoney(d.sfsEmp)}</td>
                                                </tr>
                                            );
                                        })}
                                        {/* Subtotal del departamento */}
                                        <tr style={{background: '#e0e0e0', fontWeight: 'bold'}}>
                                            <td style={{border: '1px solid #000', padding: '3px', fontSize: '8px'}}>TOTAL DE {depto}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{formatMoney(totDepto.salario)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{totDepto.otros > 0 ? formatMoney(totDepto.otros) : ''}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{formatMoney(totDepto.segSoc)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{totDepto.isr > 0 ? formatMoney(totDepto.isr) : ''}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{formatMoney(totDepto.totalIng)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right'}}>{formatMoney(totDepto.totalDed)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right', background: '#c8c8c8'}}>{formatMoney(totDepto.neto)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right', fontSize: '7px'}}>{formatMoney(totDepto.afpEmp)}</td>
                                            <td style={{border: '1px solid #000', padding: '3px', textAlign: 'right', fontSize: '7px'}}>{formatMoney(totDepto.sfsEmp)}</td>
                                        </tr>
                                        {/* Espacio entre departamentos */}
                                        <tr><td colSpan="10" style={{height: '5px', border: 'none'}}></td></tr>
                                    </React.Fragment>
                                );
                            })}
                            {/* Total General */}
                            <tr style={{background: '#b0b0b0', fontWeight: 'bold'}}>
                                <td style={{border: '2px solid #000', padding: '4px', fontSize: '9px'}}>TOTAL GENERAL ({detalles.length} empleados)</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.salario)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.horasExtra + totalesGral.bonificacion + totalesGral.comisiones + totalesGral.incentivos)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.afpEmp + totalesGral.sfsEmp)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.isr)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.totalIng)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.totalDed)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right', background: '#909090', fontSize: '10px'}}>{formatMoney(totalesGral.neto)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.afpEmp)}</td>
                                <td style={{border: '2px solid #000', padding: '4px', textAlign: 'right'}}>{formatMoney(totalesGral.sfsEmp)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    {/* Resumen de Aportes - Formato similar al PDF */}
                    <div style={{marginTop: '12px', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', fontSize: '9px', pageBreakInside: 'avoid'}}>
                        <div style={{background: '#f5f5f5', padding: '8px', border: '1px solid #999'}}>
                            <h4 style={{margin: '0 0 8px 0', borderBottom: '1px solid #999', paddingBottom: '4px', fontSize: '10px'}}>Aportes a la Seguridad Social</h4>
                            <table style={{width: '100%', fontSize: '8px', borderCollapse: 'collapse'}}>
                                <thead>
                                    <tr style={{background: '#e0e0e0'}}>
                                        <th style={{border: '1px solid #999', padding: '3px', textAlign: 'left'}}>Concepto</th>
                                        <th style={{border: '1px solid #999', padding: '3px', textAlign: 'right'}}>Empleado</th>
                                        <th style={{border: '1px solid #999', padding: '3px', textAlign: 'right'}}>Empleador</th>
                                        <th style={{border: '1px solid #999', padding: '3px', textAlign: 'right'}}>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style={{border: '1px solid #999', padding: '2px'}}>AFP</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.afpEmp)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.afpPat)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: 'bold'}}>{formatMoney(totalesGral.afpEmp + totalesGral.afpPat)}</td>
                                    </tr>
                                    <tr>
                                        <td style={{border: '1px solid #999', padding: '2px'}}>SFS</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.sfsEmp)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.sfsPat)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: 'bold'}}>{formatMoney(totalesGral.sfsEmp + totalesGral.sfsPat)}</td>
                                    </tr>
                                    <tr>
                                        <td style={{border: '1px solid #999', padding: '2px'}}>INFOTEP</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>-</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.infotep)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: 'bold'}}>{formatMoney(totalesGral.infotep)}</td>
                                    </tr>
                                    <tr>
                                        <td style={{border: '1px solid #999', padding: '2px'}}>Riesgo Laboral</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>-</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right'}}>{formatMoney(totalesGral.riesgo)}</td>
                                        <td style={{border: '1px solid #999', padding: '2px', textAlign: 'right', fontWeight: 'bold'}}>{formatMoney(totalesGral.riesgo)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style={{background: '#f5f5f5', padding: '8px', border: '1px solid #999'}}>
                            <h4 style={{margin: '0 0 8px 0', borderBottom: '1px solid #999', paddingBottom: '4px', fontSize: '10px'}}>Resumen de Nómina</h4>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}><span>Total Ingresos:</span><span style={{fontWeight: 'bold'}}>RD$ {formatMoney(totalesGral.totalIng)}</span></div>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}><span>Total Deducciones:</span><span style={{fontWeight: 'bold'}}>RD$ {formatMoney(totalesGral.totalDed)}</span></div>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}><span>Total Empleados:</span><span style={{fontWeight: 'bold'}}>{detalles.length}</span></div>
                            <div style={{display: 'flex', justifyContent: 'space-between', padding: '6px', background: '#d0d0d0', border: '2px solid #000', marginTop: '8px'}}>
                                <span><strong>TOTAL NETO A PAGAR:</strong></span>
                                <span style={{fontWeight: 'bold', fontSize: '11px'}}>RD$ {formatMoney(totalesGral.neto)}</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Firmas */}
                    <div style={{marginTop: '20px', display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '25px', fontSize: '9px', pageBreakInside: 'avoid'}}>
                        <div style={{textAlign: 'center'}}>
                            <div style={{borderTop: '1px solid #333', paddingTop: '4px', marginTop: '25px'}}>Elaborado por</div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                            <div style={{borderTop: '1px solid #333', paddingTop: '4px', marginTop: '25px'}}>Revisado por</div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                            <div style={{borderTop: '1px solid #333', paddingTop: '4px', marginTop: '25px'}}>Aprobado por</div>
                        </div>
                    </div>
                </div>
                );
            })()}
            </>
            )}
        </div>
    );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>

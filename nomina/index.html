<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Nómina Tehui v3.0 - Profesional RD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f5132; --primary-light: #198754; --primary-dark: #0a3622;
            --secondary: #fd7e14; --accent: #0dcaf0;
            --bg-main: #f5f7f9; --bg-card: #ffffff; --bg-sidebar: #0f1419;
            --text-primary: #1a1f24; --text-secondary: #5c6975; --text-muted: #8b95a1;
            --border: #dee2e6; --border-light: #e9ecef;
            --success: #198754; --warning: #ffc107; --danger: #dc3545; --info: #0dcaf0; --purple: #6f42c1;
            --shadow: 0 1px 3px rgba(0,0,0,0.08); --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 8px; --radius-lg: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-main); color: var(--text-primary); font-size: 13px; line-height: 1.5; }
        
        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: var(--bg-sidebar); position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; gap: 10px; color: white; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary-light), var(--secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; }
        .logo h1 { font-size: 14px; font-weight: 700; }
        .logo span { font-size: 10px; color: var(--text-muted); display: block; }
        
        .nav { padding: 12px 8px; }
        .nav-group { margin-bottom: 16px; }
        .nav-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.4); padding: 0 10px; margin-bottom: 6px; }
        .nav-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 6px; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; margin-bottom: 2px; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-item.active { background: var(--primary-light); color: white; }
        .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
        .nav-badge { background: var(--danger); color: white; font-size: 9px; padding: 1px 5px; border-radius: 8px; margin-left: auto; }
        
        .main { flex: 1; margin-left: 220px; overflow-x: hidden; }
        .topbar { background: var(--bg-card); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .topbar-left h2 { font-size: 16px; font-weight: 700; }
        .topbar-left p { font-size: 11px; color: var(--text-secondary); }
        .topbar-right { display: flex; gap: 8px; }
        .page { padding: 16px 20px; overflow-x: auto; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 7px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.15s; white-space: nowrap; }
        .btn-primary { background: var(--primary-light); color: white; }
        .btn-primary:hover { background: var(--primary); }
        .btn-secondary { background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-info { background: var(--info); color: #000; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-orange { background: var(--secondary); color: white; }
        .btn-sm { padding: 5px 8px; font-size: 11px; }
        .btn-xs { padding: 3px 6px; font-size: 10px; }
        .btn-icon { padding: 6px; width: 28px; height: 28px; }
        .btn-group { display: flex; gap: 4px; }
        
        /* Cards */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border-light); margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .card-body { padding: 16px; overflow: auto; }
        .card-footer { padding: 12px 16px; border-top: 1px solid var(--border-light); background: var(--bg-main); }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat { background: var(--bg-card); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); border: 1px solid var(--border-light); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .stat-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .stat-icon.green { background: rgba(25,135,84,0.1); color: var(--success); }
        .stat-icon.blue { background: rgba(13,202,240,0.1); color: var(--info); }
        .stat-icon.orange { background: rgba(253,126,20,0.1); color: var(--secondary); }
        .stat-icon.red { background: rgba(220,53,69,0.1); color: var(--danger); }
        .stat-icon.purple { background: rgba(111,66,193,0.1); color: var(--purple); }
        .stat-icon.yellow { background: rgba(255,193,7,0.15); color: #997404; }
        .stat-label { font-size: 10px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: 800; }
        .stat-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        
        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px 10px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); background: var(--bg-main); border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        tr:hover td { background: rgba(0,0,0,0.01); }
        .sticky-col { position: sticky; left: 0; background: var(--bg-card); z-index: 1; }
        
        .emp-cell { display: flex; align-items: center; gap: 8px; min-width: 180px; }
        .emp-avatar { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--primary-light), var(--primary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 10px; flex-shrink: 0; }
        .emp-name { font-weight: 600; font-size: 11px; white-space: nowrap; }
        .emp-sub { font-size: 9px; color: var(--text-muted); }
        
        .badge { display: inline-flex; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; }
        .badge-success { background: rgba(25,135,84,0.1); color: var(--success); }
        .badge-warning { background: rgba(255,193,7,0.15); color: #997404; }
        .badge-danger { background: rgba(220,53,69,0.1); color: var(--danger); }
        .badge-info { background: rgba(13,202,240,0.1); color: #055160; }
        .badge-purple { background: rgba(111,66,193,0.1); color: var(--purple); }
        .badge-secondary { background: var(--bg-main); color: var(--text-secondary); }
        
        .money { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .money.pos { color: var(--success); }
        .money.neg { color: var(--danger); }
        
        .actions { display: flex; gap: 3px; }
        .action-btn { width: 24px; height: 24px; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--bg-main); color: var(--text-secondary); transition: all 0.15s; }
        .action-btn:hover { background: var(--primary-light); color: white; }
        .action-btn.danger:hover { background: var(--danger); }
        .action-btn svg { width: 12px; height: 12px; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .form-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .form-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .form-group { }
        .form-group.full { grid-column: 1 / -1; }
        .form-group.span-2 { grid-column: span 2; }
        .form-group.span-3 { grid-column: span 3; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .form-control { width: 100%; padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: inherit; transition: border-color 0.15s; }
        .form-control:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(25,135,84,0.1); }
        .form-control.sm { padding: 5px 8px; font-size: 11px; }
        .form-help { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
        .form-row { display: flex; gap: 8px; align-items: flex-end; }
        
        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal.md { max-width: 650px; }
        .modal.lg { max-width: 850px; }
        .modal.xl { max-width: 1100px; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-size: 14px; font-weight: 700; }
        .modal-close { width: 28px; height: 28px; border-radius: 6px; border: none; background: var(--bg-main); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 8px; background: var(--bg-main); flex-shrink: 0; }
        
        /* Tabs */
        .tabs { display: flex; gap: 2px; background: var(--bg-main); padding: 3px; border-radius: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .tab { padding: 6px 12px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-radius: 4px; transition: all 0.15s; white-space: nowrap; }
        .tab:hover { color: var(--primary); }
        .tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }
        
        /* Config */
        .config-section { border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .config-title { font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .config-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border-light); font-size: 11px; }
        .config-row:last-child { border-bottom: none; }
        .config-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; text-align: right; font-family: 'JetBrains Mono', monospace; }
        
        /* Alert */
        .alert { padding: 10px 12px; border-radius: 6px; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px; font-size: 11px; }
        .alert svg { flex-shrink: 0; width: 14px; height: 14px; margin-top: 1px; }
        .alert-info { background: rgba(13,202,240,0.1); border: 1px solid rgba(13,202,240,0.2); color: #055160; }
        .alert-warning { background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.2); color: #664d03; }
        .alert-success { background: rgba(25,135,84,0.1); border: 1px solid rgba(25,135,84,0.2); color: var(--success); }
        .alert-danger { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.2); color: var(--danger); }
        
        /* Inline input */
        .inline-input { padding: 3px 5px; border: 1px solid var(--border); border-radius: 3px; font-size: 10px; width: 55px; text-align: right; font-family: 'JetBrains Mono', monospace; }
        .inline-input:focus { outline: none; border-color: var(--primary-light); }
        
        /* Summary */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
        .summary-box { background: var(--bg-main); border-radius: 8px; padding: 12px; }
        .summary-title { font-size: 10px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px dashed var(--border); }
        .summary-row:last-child { border-bottom: none; font-weight: 700; padding-top: 6px; margin-top: 4px; border-top: 2px solid var(--border); font-size: 11px; }
        
        .dept-row { background: linear-gradient(90deg, rgba(15,81,50,0.05), transparent); }
        .dept-row td { font-weight: 700; color: var(--primary); border-bottom: 2px solid var(--primary-light); }
        
        /* Progress */
        .progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-light); border-radius: 2px; }
        
        /* Empty */
        .empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; }
        .empty h3 { font-size: 14px; margin-bottom: 4px; color: var(--text-primary); }
        .empty p { font-size: 12px; }
        
        /* SVG size control */
        svg { max-width: 100%; height: auto; }
        .card-body svg:not(.stat-icon svg):not(.action-btn svg) { width: 16px; height: 16px; }
        .card-header svg { width: 16px; height: 16px; }
        .stat-icon svg { width: 18px; height: 18px; }
        
        /* Toast */
        .toasts { position: fixed; bottom: 16px; right: 16px; z-index: 2000; }
        .toast { padding: 10px 14px; border-radius: 8px; background: var(--bg-card); box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 8px; margin-top: 8px; min-width: 220px; font-size: 12px; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.warning { border-left: 3px solid var(--warning); }
        
        /* Loading */
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* SharePoint connection styles */
        .sp-connected { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .sp-disconnected { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
        .sync-spin { animation: spin 1s linear infinite; }
        
        /* Search */
        .search-wrap { position: relative; margin-bottom: 12px; }
        .search-input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 14px; height: 14px; }
        
        .filters { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
        .filter { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); transition: all 0.15s; }
        .filter:hover { border-color: var(--primary-light); color: var(--primary); }
        .filter.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Print */
        .print-only { display: none; }
        .volante { border: 1px solid #333; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; font-size: 10px; }
        .volante-header { display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .volante-empresa h2 { font-size: 13px; margin-bottom: 2px; }
        .volante-empresa p { font-size: 9px; color: #666; }
        .volante-periodo { text-align: right; }
        .volante-periodo strong { display: block; font-size: 11px; }
        .volante-empleado { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #f5f5f5; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .volante-campo label { font-size: 8px; color: #666; text-transform: uppercase; display: block; }
        .volante-campo span { font-weight: 600; font-size: 10px; }
        .volante-detalle { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .volante-seccion h4 { font-size: 10px; background: #e0e0e0; padding: 4px 6px; margin-bottom: 4px; }
        .volante-linea { display: flex; justify-content: space-between; padding: 2px 4px; font-size: 9px; border-bottom: 1px dotted #ccc; }
        .volante-linea:last-child { border-bottom: none; }
        .volante-linea.total { background: #f0f0f0; font-weight: bold; border-top: 1px solid #333; margin-top: 4px; padding-top: 4px; }
        .volante-neto { background: var(--primary); color: white; padding: 10px; text-align: center; border-radius: 4px; margin: 10px 0; }
        .volante-neto label { font-size: 9px; opacity: 0.9; }
        .volante-neto span { display: block; font-size: 18px; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        .volante-firmas { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .volante-firma { text-align: center; }
        .volante-firma-linea { border-top: 1px solid #333; margin-top: 25px; padding-top: 4px; font-size: 9px; }
        
        /* Responsive */
        @media (max-width: 1400px) { .stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .stats { grid-template-columns: repeat(2, 1fr); } .form-grid { grid-template-columns: repeat(2, 1fr); } .summary-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; } .stats { grid-template-columns: 1fr; } .form-grid { grid-template-columns: 1fr; } }
        
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            @page { margin: 10mm; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// =====================================================
// CONFIGURACIÓN DE SHAREPOINT
// =====================================================
const SHAREPOINT_CONFIG = {
    clientId: '2133c50e-ffb4-4793-af2b-385d451b997b', // Client ID de Azure de Tehui
    authority: 'https://login.microsoftonline.com/tehui.onmicrosoft.com', // Tenant de Tehui
    redirectUri: window.location.href.split('?')[0], // Usa la URL actual
    scopes: ['User.Read', 'Sites.ReadWrite.All', 'Files.ReadWrite.All'],
    siteName: 'SistemaBoletinTehui',
    siteUrl: 'tehui.sharepoint.com:/sites/SistemaBoletinTehui',
    listas: {
        empleados: 'NominaEmpleados',
        prestamos: 'NominaPrestamos',
        licencias: 'NominaLicencias',
        nominas: 'NominasHistorial',
        config: 'NominaConfiguracion'
    },
    enabled: true
};

// Cargar MSAL dinámicamente
const loadMSAL = () => {
    return new Promise((resolve, reject) => {
        if (window.msal) { resolve(window.msal); return; }
        const script = document.createElement('script');
        script.src = 'https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js';
        script.onload = () => resolve(window.msal);
        script.onerror = reject;
        document.head.appendChild(script);
    });
};

let msalInstance = null;
let currentAccount = null;

const initMSAL = async () => {
    if (msalInstance) return msalInstance;
    try {
        const msal = await loadMSAL();
        msalInstance = new msal.PublicClientApplication({
            auth: {
                clientId: SHAREPOINT_CONFIG.clientId,
                authority: SHAREPOINT_CONFIG.authority,
                redirectUri: SHAREPOINT_CONFIG.redirectUri
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        });
        await msalInstance.initialize();
        
        // Manejar respuesta de redirección
        try {
            const response = await msalInstance.handleRedirectPromise();
            if (response) {
                currentAccount = response.account;
            }
        } catch (e) {
            console.log('No redirect response');
        }
        
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) currentAccount = accounts[0];
        return msalInstance;
    } catch (e) {
        console.error('Error inicializando MSAL:', e);
        return null;
    }
};

const loginMicrosoft = async () => {
    try {
        const instance = await initMSAL();
        if (!instance) return null;
        const response = await instance.loginPopup({ scopes: SHAREPOINT_CONFIG.scopes });
        currentAccount = response.account;
        return response.account;
    } catch (e) {
        console.error('Error en login:', e);
        return null;
    }
};

const logoutMicrosoft = async () => {
    try {
        const instance = await initMSAL();
        if (instance && currentAccount) {
            await instance.logoutPopup({ account: currentAccount });
            currentAccount = null;
        }
    } catch (e) {
        console.error('Error en logout:', e);
    }
};

const getAccessToken = async () => {
    try {
        const instance = await initMSAL();
        if (!instance || !currentAccount) return null;
        const response = await instance.acquireTokenSilent({
            scopes: SHAREPOINT_CONFIG.scopes,
            account: currentAccount
        });
        return response.accessToken;
    } catch (e) {
        try {
            const instance = await initMSAL();
            const response = await instance.acquireTokenPopup({ scopes: SHAREPOINT_CONFIG.scopes });
            return response.accessToken;
        } catch (e2) {
            console.error('Error obteniendo token:', e2);
            return null;
        }
    }
};

const getSharePointSiteId = async (token) => {
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_CONFIG.siteUrl}`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (!response.ok) return null;
        const data = await response.json();
        return data.id;
    } catch (e) {
        console.error('Error obteniendo siteId:', e);
        return null;
    }
};

const getOrCreateList = async (token, siteId, listName, columns) => {
    try {
        // Buscar lista existente
        const searchResponse = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq '${listName}'`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (searchResponse.ok) {
            const data = await searchResponse.json();
            if (data.value && data.value.length > 0) return data.value[0].id;
        }
        
        // Crear lista si no existe
        const createResponse = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists`,
            {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    displayName: listName,
                    columns: columns,
                    list: { template: 'genericList' }
                })
            }
        );
        if (createResponse.ok) {
            const newList = await createResponse.json();
            return newList.id;
        }
        return null;
    } catch (e) {
        console.error('Error con lista:', e);
        return null;
    }
};

// Columnas para cada lista
const COLUMNAS_EMPLEADOS = [
    { name: 'Cedula', text: {} },
    { name: 'Departamento', text: {} },
    { name: 'Cargo', text: {} },
    { name: 'SalarioBase', number: {} },
    { name: 'FechaIngreso', dateTime: {} },
    { name: 'Activo', boolean: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_PRESTAMOS = [
    { name: 'EmpleadoId', number: {} },
    { name: 'Monto', number: {} },
    { name: 'Cuotas', number: {} },
    { name: 'Saldo', number: {} },
    { name: 'Activo', boolean: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_LICENCIAS = [
    { name: 'EmpleadoId', number: {} },
    { name: 'Tipo', text: {} },
    { name: 'FechaInicio', dateTime: {} },
    { name: 'FechaFin', dateTime: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_NOMINAS = [
    { name: 'Periodo', text: {} },
    { name: 'FechaGeneracion', dateTime: {} },
    { name: 'TotalNeto', number: {} },
    { name: 'Estado', text: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

const COLUMNAS_CONFIG = [
    { name: 'TipoConfig', text: {} },
    { name: 'DatosJSON', text: { allowMultipleLines: true } }
];

// Funciones CRUD SharePoint
const guardarEmpleadoSP = async (empleado) => {
    if (!SHAREPOINT_CONFIG.enabled) return false;
    const token = await getAccessToken();
    if (!token) return false;
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return false;
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.empleados, COLUMNAS_EMPLEADOS);
        if (!listId) return false;
        
        const campos = {
            fields: {
                Title: empleado.nombre,
                Cedula: empleado.cedula || '',
                Departamento: empleado.departamento,
                Cargo: empleado.cargo || '',
                SalarioBase: empleado.salarioBase,
                Activo: empleado.activo,
                DatosJSON: JSON.stringify(empleado)
            }
        };
        
        // Buscar si existe
        const searchUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$filter=fields/Cedula eq '${empleado.cedula}'&$expand=fields`;
        const searchResp = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const searchData = await searchResp.json();
        
        if (searchData.value && searchData.value.length > 0) {
            // Actualizar
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items/${searchData.value[0].id}`,
                { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        } else {
            // Crear
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`,
                { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        }
        return true;
    } catch (e) {
        console.error('Error guardando empleado:', e);
        return false;
    }
};

const cargarEmpleadosSP = async () => {
    if (!SHAREPOINT_CONFIG.enabled) return [];
    const token = await getAccessToken();
    if (!token) return [];
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return [];
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.empleados, COLUMNAS_EMPLEADOS);
        if (!listId) return [];
        
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=500`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (!response.ok) return [];
        const data = await response.json();
        
        return (data.value || []).map(item => {
            try {
                const emp = JSON.parse(item.fields.DatosJSON || '{}');
                emp._spId = item.id;
                return emp;
            } catch { return null; }
        }).filter(Boolean);
    } catch (e) {
        console.error('Error cargando empleados:', e);
        return [];
    }
};

const guardarPrestamoSP = async (prestamo) => {
    if (!SHAREPOINT_CONFIG.enabled) return false;
    const token = await getAccessToken();
    if (!token) return false;
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return false;
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.prestamos, COLUMNAS_PRESTAMOS);
        if (!listId) return false;
        
        const campos = {
            fields: {
                Title: `Préstamo ${prestamo.id}`,
                EmpleadoId: prestamo.empleadoId,
                Monto: prestamo.monto,
                Cuotas: prestamo.cuotas,
                Saldo: prestamo.saldo,
                Activo: prestamo.activo,
                DatosJSON: JSON.stringify(prestamo)
            }
        };
        
        if (prestamo._spId) {
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items/${prestamo._spId}`,
                { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        } else {
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`,
                { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        }
        return true;
    } catch (e) {
        console.error('Error guardando préstamo:', e);
        return false;
    }
};

const cargarPrestamosSP = async () => {
    if (!SHAREPOINT_CONFIG.enabled) return [];
    const token = await getAccessToken();
    if (!token) return [];
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return [];
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.prestamos, COLUMNAS_PRESTAMOS);
        if (!listId) return [];
        
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=500`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (!response.ok) return [];
        const data = await response.json();
        
        return (data.value || []).map(item => {
            try {
                const p = JSON.parse(item.fields.DatosJSON || '{}');
                p._spId = item.id;
                return p;
            } catch { return null; }
        }).filter(Boolean);
    } catch (e) {
        console.error('Error cargando préstamos:', e);
        return [];
    }
};

const guardarNominaSP = async (nomina) => {
    if (!SHAREPOINT_CONFIG.enabled) return false;
    const token = await getAccessToken();
    if (!token) return false;
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return false;
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.nominas, COLUMNAS_NOMINAS);
        if (!listId) return false;
        
        const periodoTxt = `${nomina.periodo.tipo === 'quincenal' ? 'Q' + nomina.periodo.quincena + ' ' : ''}${nomina.periodo.mes}/${nomina.periodo.año}`;
        const totalNeto = nomina.detalles.reduce((s, d) => s + d.neto, 0);
        
        const campos = {
            fields: {
                Title: `Nómina ${periodoTxt}`,
                Periodo: periodoTxt,
                FechaGeneracion: nomina.fecha,
                TotalNeto: totalNeto,
                Estado: nomina.estado,
                DatosJSON: JSON.stringify(nomina)
            }
        };
        
        await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`,
            { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
        );
        return true;
    } catch (e) {
        console.error('Error guardando nómina:', e);
        return false;
    }
};

const cargarNominasSP = async () => {
    if (!SHAREPOINT_CONFIG.enabled) return [];
    const token = await getAccessToken();
    if (!token) return [];
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return [];
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.nominas, COLUMNAS_NOMINAS);
        if (!listId) return [];
        
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=100&$orderby=fields/FechaGeneracion desc`,
            { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (!response.ok) return [];
        const data = await response.json();
        
        return (data.value || []).map(item => {
            try {
                const n = JSON.parse(item.fields.DatosJSON || '{}');
                n._spId = item.id;
                return n;
            } catch { return null; }
        }).filter(Boolean);
    } catch (e) {
        console.error('Error cargando nóminas:', e);
        return [];
    }
};

const guardarConfigSP = async (tipoConfig, datos) => {
    if (!SHAREPOINT_CONFIG.enabled) return false;
    const token = await getAccessToken();
    if (!token) return false;
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return false;
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.config, COLUMNAS_CONFIG);
        if (!listId) return false;
        
        const campos = {
            fields: {
                Title: tipoConfig,
                TipoConfig: tipoConfig,
                DatosJSON: JSON.stringify(datos)
            }
        };
        
        // Buscar si existe
        const searchUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$filter=fields/TipoConfig eq '${tipoConfig}'&$expand=fields`;
        const searchResp = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const searchData = await searchResp.json();
        
        if (searchData.value && searchData.value.length > 0) {
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items/${searchData.value[0].id}`,
                { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        } else {
            await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`,
                { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(campos) }
            );
        }
        return true;
    } catch (e) {
        console.error('Error guardando config:', e);
        return false;
    }
};

const cargarConfigSP = async (tipoConfig) => {
    if (!SHAREPOINT_CONFIG.enabled) return null;
    const token = await getAccessToken();
    if (!token) return null;
    try {
        const siteId = await getSharePointSiteId(token);
        if (!siteId) return null;
        const listId = await getOrCreateList(token, siteId, SHAREPOINT_CONFIG.listas.config, COLUMNAS_CONFIG);
        if (!listId) return null;
        
        const searchUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$filter=fields/TipoConfig eq '${tipoConfig}'&$expand=fields`;
        const response = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!response.ok) return null;
        const data = await response.json();
        
        if (data.value && data.value.length > 0) {
            return JSON.parse(data.value[0].fields.DatosJSON || '{}');
        }
        return null;
    } catch (e) {
        console.error('Error cargando config:', e);
        return null;
    }
};

// =====================================================
// CONFIGURACIÓN INICIAL - LEYES LABORALES RD 2025
// =====================================================
const CONFIG_DEFAULT = {
    tss: {
        afpEmpleado: 2.87, sfsEmpleado: 3.04,
        afpEmpleador: 7.10, sfsEmpleador: 7.09,
        infotep: 1.00, riesgoLaboral: 1.20,
        topeAfp: 485070, topeSfs: 485070
    },
    isr: [
        { min: 0, max: 416220, tasa: 0, fijo: 0 },
        { min: 416220.01, max: 624329, tasa: 15, fijo: 0 },
        { min: 624329.01, max: 867123, tasa: 20, fijo: 31216.35 },
        { min: 867123.01, max: Infinity, tasa: 25, fijo: 79775.15 }
    ],
    general: {
        diasMes: 23.83,
        salarioMinimo: 21000,
        horasExtra35: 35,  // Horas 9-44 semanal
        horasExtra100: 100, // Más de 44, feriados, domingos
        vacacionesDias: 14,
        regaliaMes: 12
    },
    empresa: {
        nombre: 'Centro Educativo de Formación Integral Tehui',
        rnc: '133-03246-5',
        direccion: 'Carretera Don Pedro No. 140, Esq. Las Orquideas',
        telefono: '809-000-0000',
        representante: 'GRUPO PAIDOS, SRL'
    },
    liquidacion: {
        preavisoMeses: { 3: 7, 6: 14, 12: 28 }, // días según antigüedad en meses
        cesantiaDias: { 3: 6, 6: 13, 12: 21, 60: 23 } // días por año según antigüedad
    }
};

const DEPARTAMENTOS = ['ADMINISTRACION', 'ASISTENTE', 'DOCENTE', 'MAESTRA INTEGRADORA', 'PROFESOR', 'PSICOLOGIA', 'MANTENIMIENTO', 'COCINA', 'TRANSPORTE', 'SEGURIDAD'];
const BANCOS = ['Banco Popular Dominicano', 'BHD León', 'Banreservas', 'Scotiabank', 'Banco Santa Cruz', 'Banco Promerica', 'Asociación Popular', 'Banco BDI', 'Banco Caribe', 'Banco Vimenca'];
const TIPOS_CONTRATO = ['Indefinido', 'Temporal', 'Por Obra', 'Pasantía', 'Prueba'];
const TIPOS_LICENCIA = ['Maternidad', 'Paternidad', 'Médica', 'Sin Sueldo', 'Duelo', 'Matrimonio', 'Vacaciones'];
const MESES = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

// =====================================================
// FUNCIONES DE CÁLCULO
// =====================================================
const round2 = n => Math.round(n * 100) / 100;
const formatMoney = n => new Intl.NumberFormat('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
const formatDate = d => d ? new Date(d).toLocaleDateString('es-DO') : '-';
const getInitials = name => name?.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() || '??';

const calcularAntiguedad = (fechaIngreso) => {
    if (!fechaIngreso) return { años: 0, meses: 0, dias: 0 };
    const inicio = new Date(fechaIngreso);
    const hoy = new Date();
    let años = hoy.getFullYear() - inicio.getFullYear();
    let meses = hoy.getMonth() - inicio.getMonth();
    let dias = hoy.getDate() - inicio.getDate();
    if (dias < 0) { meses--; dias += 30; }
    if (meses < 0) { años--; meses += 12; }
    return { años, meses: años * 12 + meses, dias };
};

const calcularTSS = (salario, config) => {
    const topeAfp = Math.min(salario, config.tss.topeAfp);
    const topeSfs = Math.min(salario, config.tss.topeSfs);
    return {
        afpEmp: round2(topeAfp * config.tss.afpEmpleado / 100),
        sfsEmp: round2(topeSfs * config.tss.sfsEmpleado / 100),
        afpPat: round2(topeAfp * config.tss.afpEmpleador / 100),
        sfsPat: round2(topeSfs * config.tss.sfsEmpleador / 100),
        infotep: round2(salario * config.tss.infotep / 100),
        riesgo: round2(salario * config.tss.riesgoLaboral / 100)
    };
};

const calcularISR = (salarioAnualNeto, config) => {
    for (const t of config.isr) {
        if (salarioAnualNeto >= t.min && salarioAnualNeto <= t.max) {
            if (t.tasa === 0) return 0;
            return round2((((salarioAnualNeto - t.min) * t.tasa / 100) + t.fijo) / 12);
        }
    }
    return 0;
};

const calcularSalarioDiario = (salarioMensual, config) => round2(salarioMensual / config.general.diasMes);
const calcularSalarioHora = (salarioMensual, config) => round2(calcularSalarioDiario(salarioMensual, config) / 8);

const calcularHorasExtras = (salarioMensual, horas35, horas100, config) => {
    const salarioHora = calcularSalarioHora(salarioMensual, config);
    const extra35 = round2(horas35 * salarioHora * (1 + config.general.horasExtra35 / 100));
    const extra100 = round2(horas100 * salarioHora * (1 + config.general.horasExtra100 / 100));
    return { extra35, extra100, total: round2(extra35 + extra100) };
};

const calcularVacaciones = (salarioMensual, diasVacaciones, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    return round2(salarioDiario * diasVacaciones);
};

const calcularRegalia = (salarioPromedio, mesesTrabajados) => {
    // Regalía = (Salario promedio / 12) * meses trabajados en el año
    return round2((salarioPromedio / 12) * Math.min(mesesTrabajados, 12));
};

const calcularPreaviso = (salarioMensual, mesesAntiguedad, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    let dias = 0;
    if (mesesAntiguedad >= 12) dias = 28;
    else if (mesesAntiguedad >= 6) dias = 14;
    else if (mesesAntiguedad >= 3) dias = 7;
    return { dias, monto: round2(salarioDiario * dias) };
};

const calcularCesantia = (salarioMensual, mesesAntiguedad, config) => {
    const salarioDiario = calcularSalarioDiario(salarioMensual, config);
    let diasPorAño = 0;
    if (mesesAntiguedad >= 60) diasPorAño = 23;
    else if (mesesAntiguedad >= 12) diasPorAño = 21;
    else if (mesesAntiguedad >= 6) diasPorAño = 13;
    else if (mesesAntiguedad >= 3) diasPorAño = 6;
    const años = mesesAntiguedad / 12;
    const dias = round2(diasPorAño * años);
    return { diasPorAño, dias, monto: round2(salarioDiario * dias) };
};

const calcularLiquidacion = (empleado, config, motivoSalida = 'despido') => {
    const { meses } = calcularAntiguedad(empleado.fechaIngreso);
    const salario = empleado.salarioBase;
    const salarioDiario = calcularSalarioDiario(salario, config);
    
    // Preaviso (solo si aplica según motivo)
    const preaviso = motivoSalida === 'despido' ? calcularPreaviso(salario, meses, config) : { dias: 0, monto: 0 };
    
    // Cesantía (solo despido injustificado)
    const cesantia = motivoSalida === 'despido' ? calcularCesantia(salario, meses, config) : { dias: 0, monto: 0 };
    
    // Vacaciones no disfrutadas
    const diasVacacionesAcum = Math.floor((meses / 12) * config.general.vacacionesDias);
    const diasVacacionesPend = diasVacacionesAcum - (empleado.vacacionesDisfrutadas || 0);
    const vacaciones = round2(salarioDiario * Math.max(0, diasVacacionesPend));
    
    // Salario pendiente (proporcional del mes)
    const diasPendientes = new Date().getDate();
    const salarioPendiente = round2(salarioDiario * diasPendientes);
    
    // Regalía proporcional
    const mesActual = new Date().getMonth() + 1;
    const regalia = calcularRegalia(salario, mesActual);
    
    return {
        preaviso, cesantia, vacaciones, salarioPendiente, regalia,
        total: round2(preaviso.monto + cesantia.monto + vacaciones + salarioPendiente + regalia)
    };
};

// =====================================================
// ICONOS SVG
// =====================================================
const Icons = {
    Dashboard: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
    Users: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    Dollar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
    FileText: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
    Settings: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
    Plus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Edit: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    Trash: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    X: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    Search: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    Download: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Printer: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
    Calendar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Check: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,6 9,17 4,12"/></svg>,
    Clock: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>,
    CreditCard: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
    AlertCircle: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    Info: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
    Gift: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,12 20,22 4,22 4,12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
    Umbrella: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7"/></svg>,
    UserMinus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
    UserCheck: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17,11 19,13 23,9"/></svg>,
    FileSpreadsheet: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="10" y1="9" x2="10" y2="21"/></svg>,
    Receipt: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1z"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>,
    Save: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>,
    Eye: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    Award: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21,13.89 7,23 12,20 17,23 15.79,13.88"/></svg>,
    Briefcase: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
    Home: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>,
    Activity: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>,
    Cloud: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
    CloudOff: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M7 17H4a4 4 0 0 1 0-8c.5 0 .97.09 1.41.26M16 17h2a5 5 0 0 0 .95-9.9"/><path d="M8.3 8.3A5.98 5.98 0 0 1 16 6c.5 0 .97.06 1.43.17"/></svg>,
    Refresh: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    LogIn: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10,17 15,12 10,7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>,
    LogOut: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
};

// =====================================================
// COMPONENTES UI
// =====================================================
const Toast = ({ msg, type, onClose }) => {
    useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
    return <div className={`toast ${type}`}><span>{msg}</span></div>;
};

const Modal = ({ open, onClose, title, children, footer, size }) => {
    if (!open) return null;
    return (
        <div className="modal-backdrop" onClick={onClose}>
            <div className={`modal ${size || ''}`} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <span className="modal-title">{title}</span>
                    <button className="modal-close" onClick={onClose}><Icons.X /></button>
                </div>
                <div className="modal-body">{children}</div>
                {footer && <div className="modal-footer">{footer}</div>}
            </div>
        </div>
    );
};

// =====================================================
// COMPONENTE VOLANTE DE PAGO
// =====================================================
const Volante = ({ emp, det, periodo, config }) => {
    const periodoTxt = periodo.tipo === 'quincenal' 
        ? `${periodo.quincena === 1 ? '01-15' : '16-' + new Date(periodo.año, periodo.mes, 0).getDate()} de ${MESES[periodo.mes]} ${periodo.año}`
        : `${MESES[periodo.mes]} ${periodo.año}`;
    
    return (
        <div className="volante">
            <div className="volante-header">
                <div className="volante-empresa">
                    <h2>{config.empresa.nombre}</h2>
                    <p>{config.empresa.direccion}</p>
                    <p>RNC: {config.empresa.rnc}</p>
                </div>
                <div className="volante-periodo">
                    <strong>VOLANTE DE PAGO</strong>
                    <span>Período: {periodoTxt}</span>
                </div>
            </div>
            
            <div className="volante-empleado">
                <div className="volante-campo"><label>Nombre</label><span>{emp.nombre}</span></div>
                <div className="volante-campo"><label>Cédula</label><span>{emp.cedula}</span></div>
                <div className="volante-campo"><label>Departamento</label><span>{emp.departamento}</span></div>
                <div className="volante-campo"><label>Cargo</label><span>{emp.cargo || emp.departamento}</span></div>
            </div>
            
            <div className="volante-detalle">
                <div className="volante-seccion">
                    <h4>INGRESOS</h4>
                    <div className="volante-linea"><span>Salario Base</span><span>RD$ {formatMoney(det.salarioBase)}</span></div>
                    {det.horasExtra > 0 && <div className="volante-linea"><span>Horas Extras</span><span>RD$ {formatMoney(det.horasExtra)}</span></div>}
                    {det.bonificacion > 0 && <div className="volante-linea"><span>Bonificación</span><span>RD$ {formatMoney(det.bonificacion)}</span></div>}
                    {det.comisiones > 0 && <div className="volante-linea"><span>Comisiones</span><span>RD$ {formatMoney(det.comisiones)}</span></div>}
                    {det.incentivos > 0 && <div className="volante-linea"><span>Incentivos</span><span>RD$ {formatMoney(det.incentivos)}</span></div>}
                    {det.viaticos > 0 && <div className="volante-linea"><span>Viáticos</span><span>RD$ {formatMoney(det.viaticos)}</span></div>}
                    {det.vacaciones > 0 && <div className="volante-linea"><span>Vacaciones</span><span>RD$ {formatMoney(det.vacaciones)}</span></div>}
                    {det.regalia > 0 && <div className="volante-linea"><span>Regalía Pascual</span><span>RD$ {formatMoney(det.regalia)}</span></div>}
                    {det.otrosIng > 0 && <div className="volante-linea"><span>Otros Ingresos</span><span>RD$ {formatMoney(det.otrosIng)}</span></div>}
                    <div className="volante-linea total"><span>TOTAL INGRESOS</span><span>RD$ {formatMoney(det.totalIng)}</span></div>
                </div>
                
                <div className="volante-seccion">
                    <h4>DEDUCCIONES</h4>
                    <div className="volante-linea"><span>AFP ({config.tss.afpEmpleado}%)</span><span>RD$ {formatMoney(det.afpEmp)}</span></div>
                    <div className="volante-linea"><span>SFS ({config.tss.sfsEmpleado}%)</span><span>RD$ {formatMoney(det.sfsEmp)}</span></div>
                    {det.isr > 0 && <div className="volante-linea"><span>ISR</span><span>RD$ {formatMoney(det.isr)}</span></div>}
                    {det.pdss > 0 && <div className="volante-linea"><span>PDSS Adicional</span><span>RD$ {formatMoney(det.pdss)}</span></div>}
                    {det.descAusencias > 0 && <div className="volante-linea"><span>Desc. Ausencias ({det.diasAus} días)</span><span>RD$ {formatMoney(det.descAusencias)}</span></div>}
                    {det.descTardanzas > 0 && <div className="volante-linea"><span>Desc. Tardanzas</span><span>RD$ {formatMoney(det.descTardanzas)}</span></div>}
                    {det.cuotaPrestamo > 0 && <div className="volante-linea"><span>Cuota Préstamo</span><span>RD$ {formatMoney(det.cuotaPrestamo)}</span></div>}
                    {det.cooperativa > 0 && <div className="volante-linea"><span>Cooperativa</span><span>RD$ {formatMoney(det.cooperativa)}</span></div>}
                    {det.seguroPrivado > 0 && <div className="volante-linea"><span>Seguro Médico</span><span>RD$ {formatMoney(det.seguroPrivado)}</span></div>}
                    {det.embargo > 0 && <div className="volante-linea"><span>Embargo/Pensión</span><span>RD$ {formatMoney(det.embargo)}</span></div>}
                    {det.otrasDed > 0 && <div className="volante-linea"><span>Otras Deducciones</span><span>RD$ {formatMoney(det.otrasDed)}</span></div>}
                    <div className="volante-linea total"><span>TOTAL DEDUCCIONES</span><span>RD$ {formatMoney(det.totalDed)}</span></div>
                </div>
            </div>
            
            <div className="volante-neto">
                <label>NETO A RECIBIR</label>
                <span>RD$ {formatMoney(det.neto)}</span>
            </div>
            
            <div className="volante-firmas">
                <div className="volante-firma"><div className="volante-firma-linea">Firma del Empleado</div></div>
                <div className="volante-firma"><div className="volante-firma-linea">Fecha de Recibido</div></div>
            </div>
        </div>
    );
};

// =====================================================
// APLICACIÓN PRINCIPAL
// =====================================================
const App = () => {
    // Estados
    const [view, setView] = useState('dashboard');
    const [config, setConfig] = useState(CONFIG_DEFAULT);
    const [empleados, setEmpleados] = useState([]);
    const [prestamos, setPrestamos] = useState([]);
    const [licencias, setLicencias] = useState([]);
    const [nominas, setNominas] = useState([]);
    const [currentNomina, setCurrentNomina] = useState(null);
    const [nominaEdits, setNominaEdits] = useState({});
    const [searchTerm, setSearchTerm] = useState('');
    const [filterDept, setFilterDept] = useState('TODOS');
    const [loading, setLoading] = useState(false);
    const [toasts, setToasts] = useState([]);
    
    // Estados SharePoint
    const [msUser, setMsUser] = useState(null);
    const [syncStatus, setSyncStatus] = useState({ syncing: false, lastSync: null, error: null });
    const [spConnected, setSpConnected] = useState(false);
    
    // Modales
    const [modals, setModals] = useState({
        empleado: false, prestamo: false, licencia: false, liquidacion: false,
        volantes: false, constancia: false, config: false
    });
    const [editingEmp, setEditingEmp] = useState(null);
    const [selectedEmp, setSelectedEmp] = useState(null);
    const [selectedVolante, setSelectedVolante] = useState(null);
    
    // Forms
    const empFormInit = { nombre: '', cedula: '', departamento: 'DOCENTE', cargo: '', salarioBase: '', fechaIngreso: '', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0 };
    const [empForm, setEmpForm] = useState(empFormInit);
    const [prestamoForm, setPrestamoForm] = useState({ empleadoId: '', monto: '', cuotas: '', desc: '', fecha: '' });
    const [licenciaForm, setLicenciaForm] = useState({ empleadoId: '', tipo: 'Vacaciones', fechaInicio: '', fechaFin: '', conPago: true, notas: '' });
    const [periodo, setPeriodo] = useState({ tipo: 'quincenal', mes: new Date().getMonth() + 1, año: new Date().getFullYear(), quincena: new Date().getDate() <= 15 ? 1 : 2 });
    const [liquidacionData, setLiquidacionData] = useState(null);

    // Init
    useEffect(() => { 
        initMSAL().then(() => {
            if (currentAccount) {
                setMsUser(currentAccount);
                setSpConnected(true);
                cargarDatosSharePoint();
            } else {
                cargarDatosLocales();
            }
        });
    }, []);

    // Login Microsoft
    const handleLogin = async () => {
        setLoading(true);
        try {
            const account = await loginMicrosoft();
            if (account) {
                setMsUser(account);
                setSpConnected(true);
                toast('Conectado a Microsoft 365', 'success');
                await cargarDatosSharePoint();
            } else {
                toast('No se pudo conectar', 'error');
            }
        } catch (e) {
            toast('Error al conectar: ' + e.message, 'error');
        }
        setLoading(false);
    };

    // Logout Microsoft
    const handleLogout = async () => {
        await logoutMicrosoft();
        setMsUser(null);
        setSpConnected(false);
        toast('Sesión cerrada', 'warning');
    };

    // Cargar datos desde SharePoint
    const cargarDatosSharePoint = async () => {
        setLoading(true);
        setSyncStatus(s => ({ ...s, syncing: true, error: null }));
        try {
            // Cargar configuración
            const configSP = await cargarConfigSP('ConfigTSS');
            if (configSP) setConfig(prev => ({ ...prev, ...configSP }));
            
            // Cargar empleados
            const empsSP = await cargarEmpleadosSP();
            if (empsSP.length > 0) {
                setEmpleados(empsSP);
            } else {
                cargarDatosLocales(); // Si no hay datos en SP, cargar demo
            }
            
            // Cargar préstamos
            const prestsSP = await cargarPrestamosSP();
            setPrestamos(prestsSP);
            
            // Cargar nóminas
            const nominasSP = await cargarNominasSP();
            setNominas(nominasSP);
            
            setSyncStatus({ syncing: false, lastSync: new Date(), error: null });
            toast('Datos sincronizados con SharePoint', 'success');
        } catch (e) {
            setSyncStatus(s => ({ ...s, syncing: false, error: e.message }));
            toast('Error al cargar datos: ' + e.message, 'error');
            cargarDatosLocales();
        }
        setLoading(false);
    };

    // Sincronizar todo con SharePoint
    const sincronizarConSharePoint = async () => {
        if (!spConnected) {
            toast('Conecte con Microsoft primero', 'warning');
            return;
        }
        
        setLoading(true);
        setSyncStatus(s => ({ ...s, syncing: true }));
        let exitos = 0, errores = 0;
        
        try {
            // Guardar configuración
            if (await guardarConfigSP('ConfigTSS', config)) exitos++;
            else errores++;
            
            // Guardar empleados
            for (const emp of empleados) {
                if (await guardarEmpleadoSP(emp)) exitos++;
                else errores++;
            }
            
            // Guardar préstamos
            for (const p of prestamos) {
                if (await guardarPrestamoSP(p)) exitos++;
                else errores++;
            }
            
            setSyncStatus({ syncing: false, lastSync: new Date(), error: null });
            toast(`Sincronización completa: ${exitos} exitosos, ${errores} errores`, exitos > errores ? 'success' : 'warning');
        } catch (e) {
            setSyncStatus(s => ({ ...s, syncing: false, error: e.message }));
            toast('Error en sincronización: ' + e.message, 'error');
        }
        setLoading(false);
    };

    // Cargar datos locales (demo)
    const cargarDatosLocales = () => {
        setLoading(true);
        setTimeout(() => {
            const emps = [
                { id: 1, nombre: 'Erika Cristina Olivares', cedula: '001-0000001-1', departamento: 'ADMINISTRACION', cargo: 'Coordinadora General', salarioBase: 35000, fechaIngreso: '2018-03-01', tipoContrato: 'Indefinido', banco: 'Banco Popular Dominicano', cuenta: '123456789', activo: true, pdss: 0, cooperativa: 500, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 14 },
                { id: 2, nombre: 'Fanny Josefina Inoa Espaillat', cedula: '001-0000002-2', departamento: 'ADMINISTRACION', cargo: 'Contadora', salarioBase: 30000, fechaIngreso: '2019-06-15', tipoContrato: 'Indefinido', banco: 'BHD León', cuenta: '987654321', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 1200, embargo: 0, vacacionesDisfrutadas: 7 },
                { id: 3, nombre: 'Ana Rosa Pichardo Quezada', cedula: '001-0000003-3', departamento: 'ADMINISTRACION', cargo: 'Asistente Administrativa', salarioBase: 18000, fechaIngreso: '2020-01-15', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0 },
                { id: 4, nombre: 'Mayorka Delfina Jimaquen Cabrera', cedula: '001-0000004-4', departamento: 'ASISTENTE', cargo: 'Asistente Principal', salarioBase: 22000, fechaIngreso: '2019-08-01', tipoContrato: 'Indefinido', banco: 'BHD León', cuenta: '', activo: true, pdss: 1715.46, cooperativa: 0, seguroPrivado: 0, embargo: 3500, vacacionesDisfrutadas: 14 },
                { id: 5, nombre: 'Diorelys Del Valle Millan', cedula: '001-0000005-5', departamento: 'ASISTENTE', cargo: 'Asistente de Aula', salarioBase: 18000, fechaIngreso: '2021-02-01', tipoContrato: 'Indefinido', banco: 'Banco Popular Dominicano', cuenta: '', activo: true, pdss: 0, cooperativa: 300, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0 },
                { id: 6, nombre: 'Alba Iris Mencia Mencia', cedula: '001-0000006-6', departamento: 'PROFESOR', cargo: 'Profesora de Matemáticas', salarioBase: 28000, fechaIngreso: '2016-01-15', tipoContrato: 'Indefinido', banco: 'Banreservas', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 28 },
                { id: 7, nombre: 'Cary Roxanna Fuentes De Garcia', cedula: '001-0000007-7', departamento: 'PROFESOR', cargo: 'Profesora de Español', salarioBase: 25000, fechaIngreso: '2018-08-01', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 14 },
                { id: 8, nombre: 'Daniela Peralta Mendoza', cedula: '001-0000008-8', departamento: 'MAESTRA INTEGRADORA', cargo: 'Maestra Integradora', salarioBase: 20000, fechaIngreso: '2020-09-01', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0 },
                { id: 9, nombre: 'Luisa Estebania Rosario Vasquez', cedula: '001-0000009-9', departamento: 'PSICOLOGIA', cargo: 'Psicóloga Escolar', salarioBase: 32000, fechaIngreso: '2020-06-01', tipoContrato: 'Indefinido', banco: 'Scotiabank', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 7 },
                { id: 10, nombre: 'Juan Carlos Rodriguez', cedula: '001-0000010-0', departamento: 'MANTENIMIENTO', cargo: 'Conserje', salarioBase: 21000, fechaIngreso: '2022-03-01', tipoContrato: 'Indefinido', banco: '', cuenta: '', activo: true, pdss: 0, cooperativa: 0, seguroPrivado: 0, embargo: 0, vacacionesDisfrutadas: 0 },
            ];
            const prests = [
                { id: 1, empleadoId: 1, monto: 20000, cuotas: 8, cuotasPagadas: 3, cuotaMensual: 2500, saldo: 12500, desc: 'Préstamo personal', fecha: '2025-10-01', activo: true },
                { id: 2, empleadoId: 4, monto: 10000, cuotas: 5, cuotasPagadas: 1, cuotaMensual: 2000, saldo: 8000, desc: 'Adelanto', fecha: '2025-12-01', activo: true },
            ];
            const lics = [
                { id: 1, empleadoId: 6, tipo: 'Vacaciones', fechaInicio: '2025-12-20', fechaFin: '2026-01-03', conPago: true, notas: 'Vacaciones de fin de año' },
            ];
            setEmpleados(emps);
            setPrestamos(prests);
            setLicencias(lics);
            setLoading(false);
            toast('Sistema cargado correctamente', 'success');
        }, 500);
    };

    // Helpers
    const toast = (msg, type = 'info') => setToasts(p => [...p, { id: Date.now(), msg, type }]);
    const removeToast = id => setToasts(p => p.filter(t => t.id !== id));
    const openModal = name => setModals(m => ({ ...m, [name]: true }));
    const closeModal = name => setModals(m => ({ ...m, [name]: false }));
    const getPrestamosPend = empId => prestamos.filter(p => p.empleadoId === empId && p.activo && p.saldo > 0);
    const getTotalCuotas = empId => getPrestamosPend(empId).reduce((s, p) => s + p.cuotaMensual, 0);

    // CRUD Empleados
    const guardarEmpleado = async () => {
        if (!empForm.nombre || !empForm.salarioBase) { toast('Complete los campos requeridos', 'error'); return; }
        const data = { ...empForm, salarioBase: parseFloat(empForm.salarioBase), pdss: parseFloat(empForm.pdss) || 0, cooperativa: parseFloat(empForm.cooperativa) || 0, seguroPrivado: parseFloat(empForm.seguroPrivado) || 0, embargo: parseFloat(empForm.embargo) || 0 };
        
        if (editingEmp) {
            const updated = { ...data, id: editingEmp.id, _spId: editingEmp._spId };
            setEmpleados(p => p.map(e => e.id === editingEmp.id ? updated : e));
            if (spConnected) await guardarEmpleadoSP(updated);
            toast('Empleado actualizado', 'success');
        } else {
            const newEmp = { ...data, id: Math.max(...empleados.map(e => e.id), 0) + 1 };
            setEmpleados(p => [...p, newEmp]);
            if (spConnected) await guardarEmpleadoSP(newEmp);
            toast('Empleado agregado', 'success');
        }
        closeModal('empleado');
        setEditingEmp(null);
        setEmpForm(empFormInit);
    };

    const editarEmpleado = emp => { setEditingEmp(emp); setEmpForm({ ...emp }); openModal('empleado'); };
    const eliminarEmpleado = id => { if (confirm('¿Eliminar empleado?')) { setEmpleados(p => p.filter(e => e.id !== id)); toast('Empleado eliminado', 'warning'); } };

    // CRUD Préstamos
    const guardarPrestamo = async () => {
        if (!prestamoForm.empleadoId || !prestamoForm.monto || !prestamoForm.cuotas) { toast('Complete los campos', 'error'); return; }
        const monto = parseFloat(prestamoForm.monto);
        const cuotas = parseInt(prestamoForm.cuotas);
        const nuevoPrestamo = {
            id: Date.now(), empleadoId: parseInt(prestamoForm.empleadoId), monto, cuotas, cuotasPagadas: 0,
            cuotaMensual: round2(monto / cuotas), saldo: monto, desc: prestamoForm.desc || 'Préstamo',
            fecha: prestamoForm.fecha || new Date().toISOString().split('T')[0], activo: true
        };
        setPrestamos(p => [...p, nuevoPrestamo]);
        if (spConnected) await guardarPrestamoSP(nuevoPrestamo);
        toast('Préstamo registrado', 'success');
        closeModal('prestamo');
        setPrestamoForm({ empleadoId: '', monto: '', cuotas: '', desc: '', fecha: '' });
    };

    // CRUD Licencias
    const guardarLicencia = () => {
        if (!licenciaForm.empleadoId || !licenciaForm.fechaInicio) { toast('Complete los campos', 'error'); return; }
        setLicencias(p => [...p, { ...licenciaForm, id: Date.now(), empleadoId: parseInt(licenciaForm.empleadoId) }]);
        toast('Licencia registrada', 'success');
        closeModal('licencia');
        setLicenciaForm({ empleadoId: '', tipo: 'Vacaciones', fechaInicio: '', fechaFin: '', conPago: true, notas: '' });
    };

    // Generar Nómina
    const generarNomina = () => {
        const activos = empleados.filter(e => e.activo);
        const divisor = periodo.tipo === 'quincenal' ? 2 : 1;
        const esRegalia = periodo.mes === 12 && (periodo.tipo === 'mensual' || periodo.quincena === 2);
        const edits = {};

        const detalles = activos.map(emp => {
            const salBase = emp.salarioBase / divisor;
            const pdss = (emp.pdss || 0) / divisor;
            const cooperativa = (emp.cooperativa || 0) / divisor;
            const seguroPrivado = (emp.seguroPrivado || 0) / divisor;
            const embargo = (emp.embargo || 0) / divisor;
            const cuotaPrestamo = getTotalCuotas(emp.id) / divisor;

            // Calcular regalía si es diciembre
            const regalia = esRegalia ? calcularRegalia(emp.salarioBase, 12) : 0;

            edits[emp.id] = { diasAus: 0, minTard: 0, horas35: 0, horas100: 0, bonificacion: 0, comisiones: 0, incentivos: 0, viaticos: 0, otrosIng: 0, otrasDed: 0 };

            const tss = calcularTSS(salBase, config);
            const salNetoAnual = (salBase - tss.afpEmp - tss.sfsEmp) * 12 * divisor;
            const isr = calcularISR(salNetoAnual, config);

            const totalIng = salBase + regalia;
            const totalDed = tss.afpEmp + tss.sfsEmp + isr + pdss + cuotaPrestamo + cooperativa + seguroPrivado + embargo;

            return {
                empId: emp.id, nombre: emp.nombre, depto: emp.departamento, cargo: emp.cargo,
                salarioBase: salBase, horasExtra: 0, bonificacion: 0, comisiones: 0, incentivos: 0, viaticos: 0, vacaciones: 0, regalia, otrosIng: 0, totalIng,
                diasAus: 0, descAusencias: 0, minTard: 0, descTardanzas: 0,
                afpEmp: tss.afpEmp, sfsEmp: tss.sfsEmp, isr, pdss, cuotaPrestamo, cooperativa, seguroPrivado, embargo, otrasDed: 0, totalDed,
                neto: round2(totalIng - totalDed),
                afpPat: tss.afpPat, sfsPat: tss.sfsPat, infotep: tss.infotep, riesgo: tss.riesgo
            };
        });

        setNominaEdits(edits);
        setCurrentNomina({ id: Date.now(), periodo: { ...periodo }, fecha: new Date().toISOString(), detalles, estado: 'borrador' });
        toast('Nómina generada - Ajuste valores antes de guardar', 'success');
        setView('nomina');
    };

    // Recalcular nómina
    const recalcularDetalle = empId => {
        if (!currentNomina || !nominaEdits[empId]) return null;
        const emp = empleados.find(e => e.id === empId);
        const ed = nominaEdits[empId];
        const divisor = currentNomina.periodo.tipo === 'quincenal' ? 2 : 1;
        const esRegalia = currentNomina.periodo.mes === 12 && (currentNomina.periodo.tipo === 'mensual' || currentNomina.periodo.quincena === 2);

        const salBase = emp.salarioBase / divisor;
        const salDiario = calcularSalarioDiario(emp.salarioBase, config);
        const salHora = calcularSalarioHora(emp.salarioBase, config);

        const descAusencias = round2((salDiario * (ed.diasAus || 0)) / divisor);
        const descTardanzas = round2((salHora * (ed.minTard || 0) / 60) / divisor);
        const horasExtra = calcularHorasExtras(emp.salarioBase, ed.horas35 || 0, ed.horas100 || 0, config).total / divisor;
        const bonificacion = parseFloat(ed.bonificacion) || 0;
        const comisiones = parseFloat(ed.comisiones) || 0;
        const incentivos = parseFloat(ed.incentivos) || 0;
        const viaticos = parseFloat(ed.viaticos) || 0;
        const otrosIng = parseFloat(ed.otrosIng) || 0;
        const otrasDed = parseFloat(ed.otrasDed) || 0;
        const regalia = esRegalia ? calcularRegalia(emp.salarioBase, 12) : 0;

        const pdss = (emp.pdss || 0) / divisor;
        const cooperativa = (emp.cooperativa || 0) / divisor;
        const seguroPrivado = (emp.seguroPrivado || 0) / divisor;
        const embargo = (emp.embargo || 0) / divisor;
        const cuotaPrestamo = getTotalCuotas(emp.id) / divisor;

        const salParaTSS = Math.max(0, salBase - descAusencias);
        const tss = calcularTSS(salParaTSS, config);
        const salNetoAnual = (salParaTSS - tss.afpEmp - tss.sfsEmp) * 12 * divisor;
        const isr = calcularISR(salNetoAnual, config);

        const totalIng = salBase + horasExtra + bonificacion + comisiones + incentivos + viaticos + regalia + otrosIng;
        const totalDed = tss.afpEmp + tss.sfsEmp + isr + pdss + descAusencias + descTardanzas + cuotaPrestamo + cooperativa + seguroPrivado + embargo + otrasDed;

        return {
            empId: emp.id, nombre: emp.nombre, depto: emp.departamento, cargo: emp.cargo,
            salarioBase: salBase, horasExtra, bonificacion, comisiones, incentivos, viaticos, vacaciones: 0, regalia, otrosIng, totalIng,
            diasAus: ed.diasAus || 0, descAusencias, minTard: ed.minTard || 0, descTardanzas,
            afpEmp: tss.afpEmp, sfsEmp: tss.sfsEmp, isr, pdss, cuotaPrestamo, cooperativa, seguroPrivado, embargo, otrasDed, totalDed,
            neto: round2(totalIng - totalDed),
            afpPat: tss.afpPat, sfsPat: tss.sfsPat, infotep: tss.infotep, riesgo: tss.riesgo
        };
    };

    const getDetallesRecalc = () => currentNomina ? currentNomina.detalles.map(d => recalcularDetalle(d.empId) || d) : [];
    const updateEdit = (empId, field, val) => setNominaEdits(p => ({ ...p, [empId]: { ...p[empId], [field]: val } }));

    // Guardar nómina
    const guardarNomina = async () => {
        const detalles = getDetallesRecalc();
        const nominaFinal = { ...currentNomina, detalles, estado: 'guardada' };

        // Actualizar préstamos
        const prestamosActualizados = [];
        detalles.forEach(d => {
            if (d.cuotaPrestamo > 0) {
                setPrestamos(p => p.map(pr => {
                    if (pr.empleadoId === d.empId && pr.activo && pr.saldo > 0) {
                        const desc = pr.cuotaMensual / (currentNomina.periodo.tipo === 'quincenal' ? 2 : 1);
                        const nuevoSaldo = Math.max(0, pr.saldo - desc);
                        const actualizado = { ...pr, saldo: nuevoSaldo, cuotasPagadas: pr.cuotasPagadas + (currentNomina.periodo.tipo === 'quincenal' ? 0.5 : 1), activo: nuevoSaldo > 0 };
                        prestamosActualizados.push(actualizado);
                        return actualizado;
                    }
                    return pr;
                }));
            }
        });

        setNominas(p => [...p, nominaFinal]);
        setCurrentNomina(nominaFinal);
        
        // Sincronizar con SharePoint
        if (spConnected) {
            await guardarNominaSP(nominaFinal);
            for (const p of prestamosActualizados) {
                await guardarPrestamoSP(p);
            }
        }
        
        toast('Nómina guardada correctamente', 'success');
    };

    // Liquidación
    const calcularLiquidacionEmp = (emp, motivo = 'despido') => {
        const liq = calcularLiquidacion(emp, config, motivo);
        setLiquidacionData({ emp, motivo, ...liq });
        openModal('liquidacion');
    };

    // Exportar Excel (simulado)
    const exportarExcel = () => {
        toast('Exportando a Excel...', 'info');
        // En producción: usar SheetJS o similar
        setTimeout(() => toast('Archivo generado: nomina_' + new Date().toISOString().slice(0,10) + '.xlsx', 'success'), 1000);
    };

    // Filtros
    const empsFiltrados = useMemo(() => empleados.filter(e => {
        const matchSearch = e.nombre.toLowerCase().includes(searchTerm.toLowerCase()) || e.cedula?.includes(searchTerm);
        const matchDept = filterDept === 'TODOS' || e.departamento === filterDept;
        return matchSearch && matchDept;
    }), [empleados, searchTerm, filterDept]);

    const stats = useMemo(() => {
        const activos = empleados.filter(e => e.activo);
        return {
            totalEmps: activos.length,
            totalNomina: activos.reduce((s, e) => s + e.salarioBase, 0),
            totalPrestamos: prestamos.filter(p => p.activo).reduce((s, p) => s + p.saldo, 0),
            prestamosActivos: prestamos.filter(p => p.activo && p.saldo > 0).length,
            licenciasActivas: licencias.filter(l => new Date(l.fechaFin) >= new Date()).length
        };
    }, [empleados, prestamos, licencias]);

    const nominaPorDepto = useMemo(() => {
        const dets = getDetallesRecalc();
        return dets.reduce((acc, d) => { if (!acc[d.depto]) acc[d.depto] = []; acc[d.depto].push(d); return acc; }, {});
    }, [currentNomina, nominaEdits, config]);

    const totalesNomina = useMemo(() => {
        const dets = getDetallesRecalc();
        if (!dets.length) return null;
        return dets.reduce((a, d) => ({
            totalIng: a.totalIng + d.totalIng, totalDed: a.totalDed + d.totalDed, totalNeto: a.totalNeto + d.neto,
            totalAfpEmp: a.totalAfpEmp + d.afpEmp, totalSfsEmp: a.totalSfsEmp + d.sfsEmp, totalIsr: a.totalIsr + d.isr,
            totalAfpPat: a.totalAfpPat + d.afpPat, totalSfsPat: a.totalSfsPat + d.sfsPat,
            totalInfotep: a.totalInfotep + d.infotep, totalRiesgo: a.totalRiesgo + d.riesgo
        }), { totalIng: 0, totalDed: 0, totalNeto: 0, totalAfpEmp: 0, totalSfsEmp: 0, totalIsr: 0, totalAfpPat: 0, totalSfsPat: 0, totalInfotep: 0, totalRiesgo: 0 });
    }, [currentNomina, nominaEdits, config]);

    const volantesData = useMemo(() => {
        if (!currentNomina) return [];
        const dets = getDetallesRecalc();
        if (selectedVolante) {
            const d = dets.find(x => x.empId === selectedVolante);
            const e = empleados.find(x => x.id === selectedVolante);
            return d && e ? [{ emp: e, det: d }] : [];
        }
        return dets.map(d => ({ emp: empleados.find(e => e.id === d.empId), det: d })).filter(x => x.emp);
    }, [currentNomina, selectedVolante, nominaEdits, empleados]);

    // =========================================
    // RENDER VISTAS
    // =========================================
    const renderDashboard = () => (
        <>
            {/* Panel de conexión SharePoint */}
            {!spConnected && (
                <div className="card" style={{marginBottom:'16px', background:'linear-gradient(135deg, #0078d4 0%, #00bcf2 100%)', color:'white', border:'none'}}>
                    <div className="card-body" style={{display:'flex', alignItems:'center', justifyContent:'space-between', padding:'16px 20px'}}>
                        <div>
                            <h3 style={{fontSize:'14px', fontWeight:'700', marginBottom:'4px', display:'flex', alignItems:'center', gap:'8px'}}>
                                <Icons.Cloud /> Conectar con SharePoint
                            </h3>
                            <p style={{fontSize:'11px', opacity:0.9}}>
                                Sincroniza tus datos con Microsoft 365 para acceso desde cualquier dispositivo y respaldo automático.
                            </p>
                        </div>
                        <button className="btn" style={{background:'white', color:'#0078d4', fontWeight:'700'}} onClick={handleLogin}>
                            <Icons.LogIn /> Conectar ahora
                        </button>
                    </div>
                </div>
            )}
            
            {/* Alert de conexión exitosa */}
            {spConnected && syncStatus.lastSync && (
                <div className="alert alert-success" style={{marginBottom:'16px'}}>
                    <Icons.Cloud />
                    <span>
                        <strong>Conectado a SharePoint</strong> - Los datos se guardarán automáticamente en tu sitio de Microsoft 365.
                        {syncStatus.lastSync && ` Última sincronización: ${syncStatus.lastSync.toLocaleTimeString()}`}
                    </span>
                </div>
            )}
            
            <div className="stats">
                <div className="stat"><div className="stat-header"><span className="stat-label">Empleados</span><div className="stat-icon green"><Icons.Users /></div></div><div className="stat-value">{stats.totalEmps}</div><div className="stat-sub">Activos</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Nómina Mensual</span><div className="stat-icon blue"><Icons.Dollar /></div></div><div className="stat-value" style={{fontSize:'15px'}}>RD$ {formatMoney(stats.totalNomina)}</div><div className="stat-sub">Salarios base</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Préstamos</span><div className="stat-icon purple"><Icons.CreditCard /></div></div><div className="stat-value">{stats.prestamosActivos}</div><div className="stat-sub">RD$ {formatMoney(stats.totalPrestamos)}</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">Licencias</span><div className="stat-icon orange"><Icons.Calendar /></div></div><div className="stat-value">{stats.licenciasActivas}</div><div className="stat-sub">Activas</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">AFP Emp.</span><div className="stat-icon yellow"><Icons.FileText /></div></div><div className="stat-value">{config.tss.afpEmpleado}%</div><div className="stat-sub">Tasa vigente</div></div>
                <div className="stat"><div className="stat-header"><span className="stat-label">SFS Emp.</span><div className="stat-icon red"><Icons.FileText /></div></div><div className="stat-value">{config.tss.sfsEmpleado}%</div><div className="stat-sub">Tasa vigente</div></div>
            </div>

            <div style={{display:'grid', gridTemplateColumns:'2fr 1fr', gap:'16px'}}>
                <div className="card">
                    <div className="card-header"><span className="card-title"><Icons.Calendar /> Generar Nómina</span></div>
                    <div className="card-body">
                        <div className="alert alert-info"><Icons.Info /><span>La nómina se genera como borrador. Puede ajustar ausencias, tardanzas, horas extras y otros conceptos antes de guardar.</span></div>
                        <div className="form-row" style={{flexWrap:'wrap', gap:'12px', marginBottom:'12px'}}>
                            <div className="form-group"><label className="form-label">Tipo</label><select className="form-control" style={{width:'110px'}} value={periodo.tipo} onChange={e => setPeriodo(p => ({...p, tipo: e.target.value}))}><option value="quincenal">Quincenal</option><option value="mensual">Mensual</option></select></div>
                            <div className="form-group"><label className="form-label">Mes</label><select className="form-control" style={{width:'110px'}} value={periodo.mes} onChange={e => setPeriodo(p => ({...p, mes: +e.target.value}))}>{MESES.slice(1).map((m,i) => <option key={i} value={i+1}>{m}</option>)}</select></div>
                            <div className="form-group"><label className="form-label">Año</label><select className="form-control" style={{width:'80px'}} value={periodo.año} onChange={e => setPeriodo(p => ({...p, año: +e.target.value}))}><option>2024</option><option>2025</option><option>2026</option></select></div>
                            {periodo.tipo === 'quincenal' && <div className="form-group"><label className="form-label">Quincena</label><select className="form-control" style={{width:'120px'}} value={periodo.quincena} onChange={e => setPeriodo(p => ({...p, quincena: +e.target.value}))}><option value="1">1ra (1-15)</option><option value="2">2da (16-31)</option></select></div>}
                        </div>
                        {periodo.mes === 12 && <div className="alert alert-success"><Icons.Gift /><span><strong>Regalía Pascual:</strong> Se incluirá automáticamente en la {periodo.tipo === 'quincenal' ? '2da quincena' : 'nómina'} de diciembre.</span></div>}
                        <button className="btn btn-primary" style={{width:'100%'}} onClick={generarNomina}><Icons.FileText /> Generar Nómina</button>
                    </div>
                </div>

                <div className="card">
                    <div className="card-header"><span className="card-title"><Icons.Activity /> Accesos Rápidos</span></div>
                    <div className="card-body" style={{display:'grid', gap:'8px'}}>
                        <button className="btn btn-secondary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Nuevo Empleado</button>
                        <button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.CreditCard /> Registrar Préstamo</button>
                        <button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Calendar /> Nueva Licencia</button>
                        <button className="btn btn-orange" onClick={() => openModal('config')}><Icons.Settings /> Configuración TSS</button>
                    </div>
                </div>
            </div>
        </>
    );

    const renderEmpleados = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.Users /> Empleados ({empsFiltrados.length})</span><button className="btn btn-primary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Nuevo</button></div>
            <div className="card-body">
                <div className="search-wrap"><Icons.Search className="search-icon" /><input className="search-input" placeholder="Buscar por nombre o cédula..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                <div className="filters"><span className={`filter ${filterDept === 'TODOS' ? 'active' : ''}`} onClick={() => setFilterDept('TODOS')}>Todos</span>{DEPARTAMENTOS.slice(0,7).map(d => <span key={d} className={`filter ${filterDept === d ? 'active' : ''}`} onClick={() => setFilterDept(d)}>{d}</span>)}</div>
                <div className="table-wrap">
                    <table>
                        <thead><tr><th>Empleado</th><th>Cédula</th><th>Departamento</th><th>Salario</th><th>Antigüedad</th><th>Préstamos</th><th>Deducciones Fijas</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody>
                            {empsFiltrados.map(e => {
                                const ant = calcularAntiguedad(e.fechaIngreso);
                                const prest = getPrestamosPend(e.id).reduce((s,p) => s + p.saldo, 0);
                                const dedFijas = (e.cooperativa||0) + (e.seguroPrivado||0) + (e.embargo||0) + (e.pdss||0);
                                return (
                                    <tr key={e.id}>
                                        <td><div className="emp-cell"><div className="emp-avatar">{getInitials(e.nombre)}</div><div><div className="emp-name">{e.nombre}</div><div className="emp-sub">{e.cargo || e.departamento}</div></div></div></td>
                                        <td style={{fontFamily:'JetBrains Mono', fontSize:'10px'}}>{e.cedula}</td>
                                        <td><span className="badge badge-info">{e.departamento}</span></td>
                                        <td className="money">RD$ {formatMoney(e.salarioBase)}</td>
                                        <td><span className="badge badge-secondary">{ant.años}a {ant.meses % 12}m</span></td>
                                        <td>{prest > 0 ? <span className="badge badge-warning">RD$ {formatMoney(prest)}</span> : '-'}</td>
                                        <td>{dedFijas > 0 ? <span className="money neg">RD$ {formatMoney(dedFijas)}</span> : '-'}</td>
                                        <td><span className={`badge ${e.activo ? 'badge-success' : 'badge-danger'}`}>{e.activo ? 'Activo' : 'Inactivo'}</span></td>
                                        <td>
                                            <div className="actions">
                                                <button className="action-btn" title="Editar" onClick={() => editarEmpleado(e)}><Icons.Edit /></button>
                                                <button className="action-btn" title="Liquidar" onClick={() => calcularLiquidacionEmp(e)}><Icons.UserMinus /></button>
                                                <button className="action-btn" title="Constancia" onClick={() => { setSelectedEmp(e); openModal('constancia'); }}><Icons.FileText /></button>
                                                <button className="action-btn danger" title="Eliminar" onClick={() => eliminarEmpleado(e.id)}><Icons.Trash /></button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );

    const renderNomina = () => {
        if (!currentNomina) return (
            <div className="card"><div className="card-body"><div className="empty"><Icons.FileText /><h3>No hay nómina generada</h3><p>Genere una desde el Dashboard</p><button className="btn btn-primary" style={{marginTop:'12px'}} onClick={() => setView('dashboard')}>Ir al Dashboard</button></div></div></div>
        );

        const periodoTxt = currentNomina.periodo.tipo === 'quincenal' ? `Q${currentNomina.periodo.quincena} ${MESES[currentNomina.periodo.mes]} ${currentNomina.periodo.año}` : `${MESES[currentNomina.periodo.mes]} ${currentNomina.periodo.año}`;
        const esBorrador = currentNomina.estado === 'borrador';

        return (
            <div className="card">
                <div className="card-header">
                    <span className="card-title"><Icons.FileText /> Nómina: {periodoTxt} {esBorrador && <span className="badge badge-warning" style={{marginLeft:'6px'}}>Borrador</span>}</span>
                    <div className="btn-group">
                        {esBorrador && <button className="btn btn-success" onClick={guardarNomina}><Icons.Save /> Guardar</button>}
                        {!esBorrador && <><button className="btn btn-info" onClick={() => window.print()}><Icons.Printer /> Imprimir</button><button className="btn btn-purple" onClick={() => { setSelectedVolante(null); openModal('volantes'); }}><Icons.Receipt /> Volantes</button><button className="btn btn-secondary" onClick={exportarExcel}><Icons.Download /> Excel</button></>}
                    </div>
                </div>
                <div className="card-body">
                    {esBorrador && <div className="alert alert-warning"><Icons.AlertCircle /><span>Ajuste ausencias, tardanzas, horas extras y deducciones adicionales. Los cálculos se actualizan automáticamente.</span></div>}
                    
                    <div className="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th className="sticky-col">Empleado</th>
                                    <th>Salario</th>
                                    {esBorrador && <><th>Aus.</th><th>Tard.</th><th>H.35%</th><th>H.100%</th><th>Bonif.</th></>}
                                    <th>AFP</th>
                                    <th>SFS</th>
                                    <th>ISR</th>
                                    <th>Préstamo</th>
                                    <th>Otras</th>
                                    <th>Total Ded.</th>
                                    <th>Neto</th>
                                    {!esBorrador && <th></th>}
                                </tr>
                            </thead>
                            <tbody>
                                {Object.entries(nominaPorDepto).map(([depto, dets]) => (
                                    <React.Fragment key={depto}>
                                        {dets.map(d => (
                                            <tr key={d.empId}>
                                                <td className="sticky-col"><div className="emp-cell"><div className="emp-avatar" style={{width:24,height:24,fontSize:9}}>{getInitials(d.nombre)}</div><div><div className="emp-name" style={{fontSize:10}}>{d.nombre}</div><span className="badge badge-secondary" style={{fontSize:8}}>{d.depto}</span></div></div></td>
                                                <td className="money">{formatMoney(d.salarioBase)}</td>
                                                {esBorrador && <>
                                                    <td><input className="inline-input" type="number" min="0" max="15" style={{width:'40px',textAlign:'center'}} value={nominaEdits[d.empId]?.diasAus || 0} onChange={e => updateEdit(d.empId, 'diasAus', +e.target.value)} /></td>
                                                    <td><input className="inline-input" type="number" min="0" style={{width:'45px'}} value={nominaEdits[d.empId]?.minTard || ''} onChange={e => updateEdit(d.empId, 'minTard', e.target.value)} placeholder="min" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.horas35 || ''} onChange={e => updateEdit(d.empId, 'horas35', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.horas100 || ''} onChange={e => updateEdit(d.empId, 'horas100', e.target.value)} placeholder="0" /></td>
                                                    <td><input className="inline-input" type="number" min="0" value={nominaEdits[d.empId]?.bonificacion || ''} onChange={e => updateEdit(d.empId, 'bonificacion', e.target.value)} placeholder="0" /></td>
                                                </>}
                                                <td className="money">{formatMoney(d.afpEmp)}</td>
                                                <td className="money">{formatMoney(d.sfsEmp)}</td>
                                                <td className="money">{d.isr > 0 ? formatMoney(d.isr) : '-'}</td>
                                                <td className="money">{d.cuotaPrestamo > 0 ? formatMoney(d.cuotaPrestamo) : '-'}</td>
                                                <td className="money">{(d.cooperativa + d.seguroPrivado + d.embargo + d.descAusencias + d.descTardanzas) > 0 ? formatMoney(d.cooperativa + d.seguroPrivado + d.embargo + d.descAusencias + d.descTardanzas) : '-'}</td>
                                                <td className="money neg">{formatMoney(d.totalDed)}</td>
                                                <td className="money pos" style={{fontWeight:700}}>{formatMoney(d.neto)}</td>
                                                {!esBorrador && <td><button className="btn btn-xs btn-secondary" onClick={() => { setSelectedVolante(d.empId); openModal('volantes'); }}><Icons.Eye /></button></td>}
                                            </tr>
                                        ))}
                                        <tr className="dept-row">
                                            <td className="sticky-col"><strong>TOTAL {depto}</strong></td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.salarioBase,0))}</td>
                                            {esBorrador && <td colSpan="5"></td>}
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.afpEmp,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.sfsEmp,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.isr,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.cuotaPrestamo,0))}</td>
                                            <td></td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.totalDed,0))}</td>
                                            <td className="money">{formatMoney(dets.reduce((s,d)=>s+d.neto,0))}</td>
                                            {!esBorrador && <td></td>}
                                        </tr>
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {totalesNomina && (
                        <div className="summary-grid">
                            <div className="summary-box">
                                <div className="summary-title">Resumen Nómina</div>
                                <div className="summary-row"><span>Total Ingresos</span><span>RD$ {formatMoney(totalesNomina.totalIng)}</span></div>
                                <div className="summary-row"><span>TSS Empleado</span><span>RD$ {formatMoney(totalesNomina.totalAfpEmp + totalesNomina.totalSfsEmp)}</span></div>
                                <div className="summary-row"><span>ISR</span><span>RD$ {formatMoney(totalesNomina.totalIsr)}</span></div>
                                <div className="summary-row"><span>Total Deducciones</span><span style={{color:'var(--danger)'}}>RD$ {formatMoney(totalesNomina.totalDed)}</span></div>
                                <div className="summary-row"><span>NETO A PAGAR</span><span style={{color:'var(--success)'}}>RD$ {formatMoney(totalesNomina.totalNeto)}</span></div>
                            </div>
                            <div className="summary-box">
                                <div className="summary-title">Aportes Patronales</div>
                                <div className="summary-row"><span>AFP ({config.tss.afpEmpleador}%)</span><span>RD$ {formatMoney(totalesNomina.totalAfpPat)}</span></div>
                                <div className="summary-row"><span>SFS ({config.tss.sfsEmpleador}%)</span><span>RD$ {formatMoney(totalesNomina.totalSfsPat)}</span></div>
                                <div className="summary-row"><span>INFOTEP ({config.tss.infotep}%)</span><span>RD$ {formatMoney(totalesNomina.totalInfotep)}</span></div>
                                <div className="summary-row"><span>Riesgo Laboral ({config.tss.riesgoLaboral}%)</span><span>RD$ {formatMoney(totalesNomina.totalRiesgo)}</span></div>
                                <div className="summary-row"><span>TOTAL APORTES</span><span style={{color:'var(--primary)'}}>RD$ {formatMoney(totalesNomina.totalAfpPat + totalesNomina.totalSfsPat + totalesNomina.totalInfotep + totalesNomina.totalRiesgo)}</span></div>
                            </div>
                            <div className="summary-box">
                                <div className="summary-title">TSS Consolidado (DGII)</div>
                                <div className="summary-row"><span>AFP Total</span><span>RD$ {formatMoney(totalesNomina.totalAfpEmp + totalesNomina.totalAfpPat)}</span></div>
                                <div className="summary-row"><span>SFS Total</span><span>RD$ {formatMoney(totalesNomina.totalSfsEmp + totalesNomina.totalSfsPat)}</span></div>
                                <div className="summary-row"><span>ISR Retenido (IR-17)</span><span>RD$ {formatMoney(totalesNomina.totalIsr)}</span></div>
                                <div className="summary-row"><span>Empleados</span><span>{getDetallesRecalc().length}</span></div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const renderPrestamos = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.CreditCard /> Préstamos y Adelantos</span><button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.Plus /> Nuevo</button></div>
            <div className="card-body">
                {prestamos.length === 0 ? <div className="empty"><Icons.CreditCard /><h3>Sin préstamos</h3></div> : (
                    <div className="table-wrap">
                        <table>
                            <thead><tr><th>Empleado</th><th>Descripción</th><th>Monto</th><th>Cuota</th><th>Progreso</th><th>Saldo</th><th>Estado</th></tr></thead>
                            <tbody>
                                {prestamos.map(p => {
                                    const emp = empleados.find(e => e.id === p.empleadoId);
                                    return (
                                        <tr key={p.id}>
                                            <td><div className="emp-cell"><div className="emp-avatar" style={{background:'linear-gradient(135deg, var(--purple), #8e44ad)'}}>{emp ? getInitials(emp.nombre) : '?'}</div><div><div className="emp-name">{emp?.nombre || 'N/A'}</div></div></div></td>
                                            <td>{p.desc}</td>
                                            <td className="money">RD$ {formatMoney(p.monto)}</td>
                                            <td className="money">RD$ {formatMoney(p.cuotaMensual)}</td>
                                            <td style={{minWidth:'100px'}}><div style={{display:'flex',alignItems:'center',gap:'6px'}}><div className="progress" style={{flex:1}}><div className="progress-bar" style={{width:`${(p.cuotasPagadas/p.cuotas)*100}%`}}></div></div><span style={{fontSize:'9px'}}>{p.cuotasPagadas}/{p.cuotas}</span></div></td>
                                            <td className="money" style={{fontWeight:700}}>RD$ {formatMoney(p.saldo)}</td>
                                            <td><span className={`badge ${p.activo && p.saldo > 0 ? 'badge-warning' : 'badge-success'}`}>{p.activo && p.saldo > 0 ? 'Activo' : 'Pagado'}</span></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );

    const renderLicencias = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.Calendar /> Licencias y Permisos</span><button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Plus /> Nueva</button></div>
            <div className="card-body">
                <div className="alert alert-info"><Icons.Info /><span><strong>Licencias RD:</strong> Maternidad (14 semanas), Paternidad (2 días), Vacaciones (14 días mín. después de 1 año), Duelo (3 días), Matrimonio (5 días).</span></div>
                {licencias.length === 0 ? <div className="empty"><Icons.Calendar /><h3>Sin licencias registradas</h3></div> : (
                    <div className="table-wrap">
                        <table>
                            <thead><tr><th>Empleado</th><th>Tipo</th><th>Inicio</th><th>Fin</th><th>Con Pago</th><th>Notas</th><th>Estado</th></tr></thead>
                            <tbody>
                                {licencias.map(l => {
                                    const emp = empleados.find(e => e.id === l.empleadoId);
                                    const activa = new Date(l.fechaFin) >= new Date();
                                    return (
                                        <tr key={l.id}>
                                            <td><div className="emp-cell"><div className="emp-avatar">{emp ? getInitials(emp.nombre) : '?'}</div><div className="emp-name">{emp?.nombre || 'N/A'}</div></div></td>
                                            <td><span className="badge badge-info">{l.tipo}</span></td>
                                            <td>{formatDate(l.fechaInicio)}</td>
                                            <td>{formatDate(l.fechaFin)}</td>
                                            <td>{l.conPago ? <span className="badge badge-success">Sí</span> : <span className="badge badge-danger">No</span>}</td>
                                            <td style={{fontSize:'10px'}}>{l.notas || '-'}</td>
                                            <td><span className={`badge ${activa ? 'badge-warning' : 'badge-secondary'}`}>{activa ? 'Activa' : 'Finalizada'}</span></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );

    const renderHistorial = () => (
        <div className="card">
            <div className="card-header"><span className="card-title"><Icons.Clock /> Historial de Nóminas</span></div>
            <div className="card-body">
                {nominas.length === 0 ? <div className="empty"><Icons.Clock /><h3>Sin historial</h3><p>Las nóminas guardadas aparecerán aquí</p></div> : (
                    <div className="table-wrap">
                        <table>
                            <thead><tr><th>Período</th><th>Fecha</th><th>Empleados</th><th>Total Ded.</th><th>Total Neto</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody>
                                {nominas.map(n => (
                                    <tr key={n.id}>
                                        <td>{n.periodo.tipo === 'quincenal' ? `Q${n.periodo.quincena} ` : ''}{MESES[n.periodo.mes]} {n.periodo.año}</td>
                                        <td>{formatDate(n.fecha)}</td>
                                        <td>{n.detalles.length}</td>
                                        <td className="money neg">RD$ {formatMoney(n.detalles.reduce((s,d) => s + d.totalDed, 0))}</td>
                                        <td className="money pos">RD$ {formatMoney(n.detalles.reduce((s,d) => s + d.neto, 0))}</td>
                                        <td><span className={`badge ${n.estado === 'guardada' ? 'badge-success' : 'badge-warning'}`}>{n.estado === 'guardada' ? 'Guardada' : 'Borrador'}</span></td>
                                        <td><div className="btn-group"><button className="btn btn-xs btn-secondary" onClick={() => { setCurrentNomina(n); setView('nomina'); }}>Ver</button>{n.estado === 'guardada' && <button className="btn btn-xs btn-purple" onClick={() => { setCurrentNomina(n); setSelectedVolante(null); openModal('volantes'); }}><Icons.Receipt /></button>}</div></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );

    const renderConfig = () => (
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'16px'}}>
            <div className="card">
                <div className="card-header"><span className="card-title"><Icons.Settings /> Tasas TSS</span></div>
                <div className="card-body">
                    <div className="config-section">
                        <div className="config-title">Aportes del Empleado</div>
                        <div className="config-row"><span>AFP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.afpEmpleado} onChange={e => setConfig(c => ({...c, tss: {...c.tss, afpEmpleado: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>SFS</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.sfsEmpleado} onChange={e => setConfig(c => ({...c, tss: {...c.tss, sfsEmpleado: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Aportes del Empleador</div>
                        <div className="config-row"><span>AFP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.afpEmpleador} onChange={e => setConfig(c => ({...c, tss: {...c.tss, afpEmpleador: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>SFS</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.sfsEmpleador} onChange={e => setConfig(c => ({...c, tss: {...c.tss, sfsEmpleador: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>INFOTEP</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.infotep} onChange={e => setConfig(c => ({...c, tss: {...c.tss, infotep: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>Riesgo Laboral</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" step="0.01" value={config.tss.riesgoLaboral} onChange={e => setConfig(c => ({...c, tss: {...c.tss, riesgoLaboral: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Topes Cotizables</div>
                        <div className="config-row"><span>Tope AFP</span><input className="config-input" style={{width:'100px'}} type="number" value={config.tss.topeAfp} onChange={e => setConfig(c => ({...c, tss: {...c.tss, topeAfp: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Tope SFS</span><input className="config-input" style={{width:'100px'}} type="number" value={config.tss.topeSfs} onChange={e => setConfig(c => ({...c, tss: {...c.tss, topeSfs: +e.target.value}}))} /></div>
                    </div>
                </div>
            </div>
            <div className="card">
                <div className="card-header"><span className="card-title"><Icons.FileText /> Parámetros Generales</span></div>
                <div className="card-body">
                    <div className="config-section">
                        <div className="config-title">Cálculos</div>
                        <div className="config-row"><span>Días laborables/mes</span><input className="config-input" type="number" step="0.01" value={config.general.diasMes} onChange={e => setConfig(c => ({...c, general: {...c.general, diasMes: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Salario mínimo</span><input className="config-input" style={{width:'90px'}} type="number" value={config.general.salarioMinimo} onChange={e => setConfig(c => ({...c, general: {...c.general, salarioMinimo: +e.target.value}}))} /></div>
                        <div className="config-row"><span>Días vacaciones (mín)</span><input className="config-input" type="number" value={config.general.vacacionesDias} onChange={e => setConfig(c => ({...c, general: {...c.general, vacacionesDias: +e.target.value}}))} /></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Horas Extras</div>
                        <div className="config-row"><span>Horas 9-44 semanal</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" value={config.general.horasExtra35} onChange={e => setConfig(c => ({...c, general: {...c.general, horasExtra35: +e.target.value}}))} />%</div></div>
                        <div className="config-row"><span>+44, feriados, domingos</span><div style={{display:'flex',alignItems:'center',gap:'4px'}}><input className="config-input" type="number" value={config.general.horasExtra100} onChange={e => setConfig(c => ({...c, general: {...c.general, horasExtra100: +e.target.value}}))} />%</div></div>
                    </div>
                    <div className="config-section">
                        <div className="config-title">Empresa</div>
                        <div style={{marginBottom:'8px'}}><label className="form-label">Nombre</label><input className="form-control sm" value={config.empresa.nombre} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, nombre: e.target.value}}))} /></div>
                        <div style={{marginBottom:'8px'}}><label className="form-label">RNC</label><input className="form-control sm" value={config.empresa.rnc} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, rnc: e.target.value}}))} /></div>
                        <div><label className="form-label">Dirección</label><input className="form-control sm" value={config.empresa.direccion} onChange={e => setConfig(c => ({...c, empresa: {...c.empresa, direccion: e.target.value}}))} /></div>
                    </div>
                    <button className="btn btn-primary" style={{width:'100%',marginTop:'12px'}} onClick={() => toast('Configuración guardada', 'success')}><Icons.Save /> Guardar Configuración</button>
                </div>
            </div>
        </div>
    );

    const renderContent = () => {
        switch(view) {
            case 'dashboard': return renderDashboard();
            case 'empleados': return renderEmpleados();
            case 'nomina': return renderNomina();
            case 'prestamos': return renderPrestamos();
            case 'licencias': return renderLicencias();
            case 'historial': return renderHistorial();
            case 'config': return renderConfig();
            default: return renderDashboard();
        }
    };

    return (
        <div className="app">
            {/* Sidebar */}
            <aside className="sidebar no-print">
                <div className="sidebar-header"><div className="logo"><div className="logo-icon">NT</div><div><h1>Nómina Tehui</h1><span>Sistema v3.0</span></div></div></div>
                <nav className="nav">
                    <div className="nav-group"><div className="nav-label">Principal</div>
                        <div className={`nav-item ${view === 'dashboard' ? 'active' : ''}`} onClick={() => setView('dashboard')}><Icons.Dashboard /><span>Dashboard</span></div>
                        <div className={`nav-item ${view === 'empleados' ? 'active' : ''}`} onClick={() => setView('empleados')}><Icons.Users /><span>Empleados</span></div>
                        <div className={`nav-item ${view === 'nomina' ? 'active' : ''}`} onClick={() => setView('nomina')}><Icons.Dollar /><span>Nómina</span></div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Gestión</div>
                        <div className={`nav-item ${view === 'prestamos' ? 'active' : ''}`} onClick={() => setView('prestamos')}><Icons.CreditCard /><span>Préstamos</span>{stats.prestamosActivos > 0 && <span className="nav-badge">{stats.prestamosActivos}</span>}</div>
                        <div className={`nav-item ${view === 'licencias' ? 'active' : ''}`} onClick={() => setView('licencias')}><Icons.Calendar /><span>Licencias</span>{stats.licenciasActivas > 0 && <span className="nav-badge">{stats.licenciasActivas}</span>}</div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Reportes</div>
                        <div className={`nav-item ${view === 'historial' ? 'active' : ''}`} onClick={() => setView('historial')}><Icons.Clock /><span>Historial</span></div>
                    </div>
                    <div className="nav-group"><div className="nav-label">Sistema</div>
                        <div className={`nav-item ${view === 'config' ? 'active' : ''}`} onClick={() => setView('config')}><Icons.Settings /><span>Configuración</span></div>
                    </div>
                    
                    {/* Sección SharePoint */}
                    <div className="nav-group" style={{marginTop:'auto', borderTop:'1px solid rgba(255,255,255,0.1)', paddingTop:'12px'}}>
                        <div className="nav-label">SharePoint</div>
                        {!spConnected ? (
                            <div className="nav-item" onClick={handleLogin} style={{background:'rgba(0,120,212,0.2)', color:'#4fc3f7'}}>
                                <Icons.LogIn /><span>Conectar Microsoft</span>
                            </div>
                        ) : (
                            <>
                                <div style={{padding:'6px 10px', fontSize:'10px', color:'rgba(255,255,255,0.7)'}}>
                                    <div style={{display:'flex', alignItems:'center', gap:'6px', marginBottom:'4px'}}>
                                        <span style={{width:'8px', height:'8px', borderRadius:'50%', background:'#4caf50'}}></span>
                                        <span>Conectado</span>
                                    </div>
                                    <div style={{fontSize:'9px', color:'rgba(255,255,255,0.5)', marginLeft:'14px'}}>
                                        {msUser?.username || msUser?.name || 'Usuario'}
                                    </div>
                                    {syncStatus.lastSync && (
                                        <div style={{fontSize:'9px', color:'rgba(255,255,255,0.4)', marginLeft:'14px', marginTop:'2px'}}>
                                            Último sync: {syncStatus.lastSync.toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                                <div className="nav-item" onClick={sincronizarConSharePoint} style={{color: syncStatus.syncing ? '#ffc107' : 'rgba(255,255,255,0.6)'}}>
                                    <Icons.Refresh style={syncStatus.syncing ? {animation:'spin 1s linear infinite'} : {}} /><span>{syncStatus.syncing ? 'Sincronizando...' : 'Sincronizar'}</span>
                                </div>
                                <div className="nav-item" onClick={handleLogout} style={{color:'rgba(255,255,255,0.5)'}}>
                                    <Icons.LogOut /><span>Desconectar</span>
                                </div>
                            </>
                        )}
                    </div>
                </nav>
            </aside>

            {/* Main */}
            <main className="main">
                <header className="topbar no-print">
                    <div className="topbar-left">
                        <h2>{view === 'dashboard' ? 'Dashboard' : view === 'empleados' ? 'Empleados' : view === 'nomina' ? 'Nómina' : view === 'prestamos' ? 'Préstamos' : view === 'licencias' ? 'Licencias' : view === 'historial' ? 'Historial' : 'Configuración'}</h2>
                        <p style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            {config.empresa.nombre}
                            {spConnected ? (
                                <span style={{display:'inline-flex', alignItems:'center', gap:'4px', background:'rgba(76,175,80,0.1)', color:'#4caf50', padding:'2px 8px', borderRadius:'10px', fontSize:'9px', fontWeight:'600'}}>
                                    <Icons.Cloud style={{width:'10px', height:'10px'}} /> SharePoint
                                </span>
                            ) : (
                                <span style={{display:'inline-flex', alignItems:'center', gap:'4px', background:'rgba(255,152,0,0.1)', color:'#ff9800', padding:'2px 8px', borderRadius:'10px', fontSize:'9px', fontWeight:'600'}}>
                                    <Icons.CloudOff style={{width:'10px', height:'10px'}} /> Local
                                </span>
                            )}
                        </p>
                    </div>
                    <div className="topbar-right">
                        {spConnected && (
                            <button className="btn btn-secondary btn-sm" onClick={sincronizarConSharePoint} disabled={syncStatus.syncing}>
                                <Icons.Refresh style={syncStatus.syncing ? {animation:'spin 1s linear infinite'} : {}} /> {syncStatus.syncing ? 'Sincronizando...' : 'Sincronizar'}
                            </button>
                        )}
                        {view === 'empleados' && <button className="btn btn-primary" onClick={() => { setEmpForm(empFormInit); setEditingEmp(null); openModal('empleado'); }}><Icons.Plus /> Empleado</button>}
                        {view === 'prestamos' && <button className="btn btn-purple" onClick={() => openModal('prestamo')}><Icons.Plus /> Préstamo</button>}
                        {view === 'licencias' && <button className="btn btn-info" onClick={() => openModal('licencia')}><Icons.Plus /> Licencia</button>}
                    </div>
                </header>
                <div className="page">{renderContent()}</div>
            </main>

            {/* Modal Empleado */}
            <Modal open={modals.empleado} onClose={() => { closeModal('empleado'); setEditingEmp(null); setEmpForm(empFormInit); }} title={editingEmp ? 'Editar Empleado' : 'Nuevo Empleado'} size="lg" footer={<><button className="btn btn-secondary" onClick={() => closeModal('empleado')}>Cancelar</button><button className="btn btn-primary" onClick={guardarEmpleado}><Icons.Check /> {editingEmp ? 'Actualizar' : 'Guardar'}</button></>}>
                <div className="form-grid">
                    <div className="form-group span-2"><label className="form-label">Nombre Completo *</label><input className="form-control" value={empForm.nombre} onChange={e => setEmpForm(f => ({...f, nombre: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Cédula</label><input className="form-control" value={empForm.cedula} onChange={e => setEmpForm(f => ({...f, cedula: e.target.value}))} placeholder="000-0000000-0" /></div>
                    <div className="form-group"><label className="form-label">Departamento *</label><select className="form-control" value={empForm.departamento} onChange={e => setEmpForm(f => ({...f, departamento: e.target.value}))}>{DEPARTAMENTOS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Cargo</label><input className="form-control" value={empForm.cargo} onChange={e => setEmpForm(f => ({...f, cargo: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Salario Mensual *</label><input className="form-control" type="number" value={empForm.salarioBase} onChange={e => setEmpForm(f => ({...f, salarioBase: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Fecha Ingreso</label><input className="form-control" type="date" value={empForm.fechaIngreso} onChange={e => setEmpForm(f => ({...f, fechaIngreso: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Tipo Contrato</label><select className="form-control" value={empForm.tipoContrato} onChange={e => setEmpForm(f => ({...f, tipoContrato: e.target.value}))}>{TIPOS_CONTRATO.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                </div>
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>Deducciones Fijas Mensuales</h4>
                <div className="form-grid">
                    <div className="form-group"><label className="form-label">PDSS Per Cápita</label><input className="form-control" type="number" value={empForm.pdss} onChange={e => setEmpForm(f => ({...f, pdss: e.target.value}))} placeholder="0" /><div className="form-help">Por dependientes adicionales</div></div>
                    <div className="form-group"><label className="form-label">Cooperativa</label><input className="form-control" type="number" value={empForm.cooperativa} onChange={e => setEmpForm(f => ({...f, cooperativa: e.target.value}))} placeholder="0" /></div>
                    <div className="form-group"><label className="form-label">Seguro Médico</label><input className="form-control" type="number" value={empForm.seguroPrivado} onChange={e => setEmpForm(f => ({...f, seguroPrivado: e.target.value}))} placeholder="0" /><div className="form-help">Seguro privado adicional</div></div>
                    <div className="form-group"><label className="form-label">Embargo/Pensión</label><input className="form-control" type="number" value={empForm.embargo} onChange={e => setEmpForm(f => ({...f, embargo: e.target.value}))} placeholder="0" /><div className="form-help">Deducciones judiciales</div></div>
                </div>
                <h4 style={{margin:'16px 0 12px', fontSize:'12px', color:'var(--text-secondary)'}}>Datos Bancarios</h4>
                <div className="form-grid form-grid-3">
                    <div className="form-group"><label className="form-label">Banco</label><select className="form-control" value={empForm.banco} onChange={e => setEmpForm(f => ({...f, banco: e.target.value}))}><option value="">Seleccionar...</option>{BANCOS.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">No. Cuenta</label><input className="form-control" value={empForm.cuenta} onChange={e => setEmpForm(f => ({...f, cuenta: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Estado</label><select className="form-control" value={empForm.activo} onChange={e => setEmpForm(f => ({...f, activo: e.target.value === 'true'}))}><option value="true">Activo</option><option value="false">Inactivo</option></select></div>
                </div>
            </Modal>

            {/* Modal Préstamo */}
            <Modal open={modals.prestamo} onClose={() => { closeModal('prestamo'); setPrestamoForm({empleadoId:'',monto:'',cuotas:'',desc:'',fecha:''}); }} title="Nuevo Préstamo" footer={<><button className="btn btn-secondary" onClick={() => closeModal('prestamo')}>Cancelar</button><button className="btn btn-purple" onClick={guardarPrestamo}><Icons.Check /> Registrar</button></>}>
                <div className="form-grid form-grid-2">
                    <div className="form-group full"><label className="form-label">Empleado *</label><select className="form-control" value={prestamoForm.empleadoId} onChange={e => setPrestamoForm(f => ({...f, empleadoId: e.target.value}))}><option value="">Seleccionar...</option>{empleados.filter(e => e.activo).map(e => <option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Monto Total *</label><input className="form-control" type="number" value={prestamoForm.monto} onChange={e => setPrestamoForm(f => ({...f, monto: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Cuotas *</label><input className="form-control" type="number" min="1" value={prestamoForm.cuotas} onChange={e => setPrestamoForm(f => ({...f, cuotas: e.target.value}))} /></div>
                    {prestamoForm.monto && prestamoForm.cuotas && <div className="form-group full"><div className="alert alert-success"><Icons.Info /><span>Cuota mensual: <strong>RD$ {formatMoney(+prestamoForm.monto / +prestamoForm.cuotas)}</strong></span></div></div>}
                    <div className="form-group"><label className="form-label">Fecha Inicio</label><input className="form-control" type="date" value={prestamoForm.fecha} onChange={e => setPrestamoForm(f => ({...f, fecha: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Descripción</label><input className="form-control" value={prestamoForm.desc} onChange={e => setPrestamoForm(f => ({...f, desc: e.target.value}))} placeholder="Préstamo personal..." /></div>
                </div>
            </Modal>

            {/* Modal Licencia */}
            <Modal open={modals.licencia} onClose={() => closeModal('licencia')} title="Nueva Licencia" footer={<><button className="btn btn-secondary" onClick={() => closeModal('licencia')}>Cancelar</button><button className="btn btn-info" onClick={guardarLicencia}><Icons.Check /> Registrar</button></>}>
                <div className="form-grid form-grid-2">
                    <div className="form-group full"><label className="form-label">Empleado *</label><select className="form-control" value={licenciaForm.empleadoId} onChange={e => setLicenciaForm(f => ({...f, empleadoId: e.target.value}))}><option value="">Seleccionar...</option>{empleados.filter(e => e.activo).map(e => <option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Tipo</label><select className="form-control" value={licenciaForm.tipo} onChange={e => setLicenciaForm(f => ({...f, tipo: e.target.value}))}>{TIPOS_LICENCIA.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div className="form-group"><label className="form-label">Con Pago</label><select className="form-control" value={licenciaForm.conPago} onChange={e => setLicenciaForm(f => ({...f, conPago: e.target.value === 'true'}))}><option value="true">Sí</option><option value="false">No</option></select></div>
                    <div className="form-group"><label className="form-label">Fecha Inicio *</label><input className="form-control" type="date" value={licenciaForm.fechaInicio} onChange={e => setLicenciaForm(f => ({...f, fechaInicio: e.target.value}))} /></div>
                    <div className="form-group"><label className="form-label">Fecha Fin</label><input className="form-control" type="date" value={licenciaForm.fechaFin} onChange={e => setLicenciaForm(f => ({...f, fechaFin: e.target.value}))} /></div>
                    <div className="form-group full"><label className="form-label">Notas</label><input className="form-control" value={licenciaForm.notas} onChange={e => setLicenciaForm(f => ({...f, notas: e.target.value}))} /></div>
                </div>
            </Modal>

            {/* Modal Liquidación */}
            <Modal open={modals.liquidacion} onClose={() => closeModal('liquidacion')} title="Cálculo de Liquidación" size="md">
                {liquidacionData && (
                    <div>
                        <div className="alert alert-info"><Icons.UserMinus /><span><strong>{liquidacionData.emp.nombre}</strong> - Antigüedad: {calcularAntiguedad(liquidacionData.emp.fechaIngreso).años} años, {calcularAntiguedad(liquidacionData.emp.fechaIngreso).meses % 12} meses</span></div>
                        <div className="config-section">
                            <div className="config-title">Desglose de Liquidación (Despido)</div>
                            <div className="config-row"><span>Preaviso ({liquidacionData.preaviso.dias} días)</span><span className="money">RD$ {formatMoney(liquidacionData.preaviso.monto)}</span></div>
                            <div className="config-row"><span>Cesantía ({round2(liquidacionData.cesantia.dias)} días)</span><span className="money">RD$ {formatMoney(liquidacionData.cesantia.monto)}</span></div>
                            <div className="config-row"><span>Vacaciones no disfrutadas</span><span className="money">RD$ {formatMoney(liquidacionData.vacaciones)}</span></div>
                            <div className="config-row"><span>Salario pendiente</span><span className="money">RD$ {formatMoney(liquidacionData.salarioPendiente)}</span></div>
                            <div className="config-row"><span>Regalía proporcional</span><span className="money">RD$ {formatMoney(liquidacionData.regalia)}</span></div>
                            <div className="config-row" style={{fontWeight:700, borderTop:'2px solid var(--border)', paddingTop:'8px', marginTop:'8px'}}><span>TOTAL LIQUIDACIÓN</span><span className="money pos" style={{fontSize:'14px'}}>RD$ {formatMoney(liquidacionData.total)}</span></div>
                        </div>
                        <button className="btn btn-primary" style={{width:'100%', marginTop:'12px'}} onClick={() => { toast('Liquidación exportada', 'success'); closeModal('liquidacion'); }}><Icons.Download /> Exportar Liquidación</button>
                    </div>
                )}
            </Modal>

            {/* Modal Volantes */}
            <Modal open={modals.volantes} onClose={() => { closeModal('volantes'); setSelectedVolante(null); }} title="Volantes de Pago" size="xl" footer={<><button className="btn btn-secondary" onClick={() => closeModal('volantes')}>Cerrar</button><button className="btn btn-primary" onClick={() => window.print()}><Icons.Printer /> Imprimir</button></>}>
                <div className="print-area">
                    {volantesData.map((v, i) => <Volante key={i} emp={v.emp} det={v.det} periodo={currentNomina?.periodo} config={config} />)}
                </div>
            </Modal>

            {/* Modal Constancia */}
            <Modal open={modals.constancia} onClose={() => closeModal('constancia')} title="Constancia de Trabajo" size="md">
                {selectedEmp && (
                    <div style={{fontFamily:'serif', lineHeight:1.8}}>
                        <div style={{textAlign:'center', marginBottom:'20px'}}>
                            <h2 style={{fontSize:'16px'}}>{config.empresa.nombre}</h2>
                            <p style={{fontSize:'11px', color:'var(--text-secondary)'}}>{config.empresa.direccion}<br/>RNC: {config.empresa.rnc}</p>
                        </div>
                        <h3 style={{textAlign:'center', margin:'20px 0', textDecoration:'underline'}}>CONSTANCIA DE TRABAJO</h3>
                        <p style={{textAlign:'justify', fontSize:'12px'}}>
                            Por medio de la presente hacemos constar que el/la Sr(a). <strong>{selectedEmp.nombre}</strong>, 
                            portador(a) de la cédula de identidad No. <strong>{selectedEmp.cedula}</strong>, 
                            labora en nuestra institución desde el <strong>{formatDate(selectedEmp.fechaIngreso)}</strong>, 
                            desempeñando el cargo de <strong>{selectedEmp.cargo || selectedEmp.departamento}</strong>, 
                            devengando un salario mensual de <strong>RD$ {formatMoney(selectedEmp.salarioBase)}</strong>.
                        </p>
                        <p style={{fontSize:'12px', marginTop:'16px'}}>
                            Se expide la presente constancia a solicitud de la parte interesada, para los fines que considere pertinentes.
                        </p>
                        <p style={{fontSize:'12px', marginTop:'20px'}}>
                            Dado en Santiago de los Caballeros, República Dominicana, a los {new Date().getDate()} días del mes de {MESES[new Date().getMonth() + 1]} del {new Date().getFullYear()}.
                        </p>
                        <div style={{marginTop:'50px', textAlign:'center'}}>
                            <div style={{borderTop:'1px solid #333', width:'200px', margin:'0 auto', paddingTop:'8px', fontSize:'11px'}}>Firma y Sello</div>
                        </div>
                        <button className="btn btn-primary no-print" style={{width:'100%', marginTop:'20px'}} onClick={() => window.print()}><Icons.Printer /> Imprimir</button>
                    </div>
                )}
            </Modal>

            {/* Toasts */}
            <div className="toasts">{toasts.map(t => <Toast key={t.id} msg={t.msg} type={t.type} onClose={() => removeToast(t.id)} />)}</div>
            
            {/* Loading */}
            {loading && <div className="loading"><div className="spinner"></div></div>}
        </div>
    );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
